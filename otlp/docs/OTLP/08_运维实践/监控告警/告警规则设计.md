# 告警规则设计

## 目录

- [告警规则设计](#告警规则设计)
  - [目录](#目录)
  - [概述](#概述)
  - [告警设计原则](#告警设计原则)
    - [1. 可操作性](#1-可操作性)
    - [2. 避免误报](#2-避免误报)
    - [3. 分级告警](#3-分级告警)
  - [告警级别定义](#告警级别定义)
  - [OTLP 告警规则](#otlp-告警规则)
    - [Prometheus 告警配置](#prometheus-告警配置)
  - [告警模板](#告警模板)
    - [告警通知模板](#告警通知模板)
    - [告警消息模板](#告警消息模板)
  - [完整告警规则库](#完整告警规则库)
    - [1. 服务可用性告警](#1-服务可用性告警)
    - [2. 性能告警](#2-性能告警)
    - [3. 错误率告警](#3-错误率告警)
    - [4. 资源使用告警](#4-资源使用告警)
    - [5. SLO 告警](#5-slo-告警)
  - [告警规则最佳实践](#告警规则最佳实践)
    - [1. 告警阈值设置](#1-告警阈值设置)
    - [2. 告警分组](#2-告警分组)
    - [3. 告警抑制](#3-告警抑制)
    - [4. 告警路由](#4-告警路由)
  - [告警测试](#告警测试)
    - [单元测试](#单元测试)
    - [集成测试](#集成测试)
  - [告警文档化](#告警文档化)
    - [Runbook 模板](#runbook-模板)

## 概述

良好的告警规则设计能够及时发现问题，同时避免告警疲劳。

## 告警设计原则

### 1. 可操作性

每个告警都应该有明确的处理步骤。

### 2. 避免误报

使用适当的阈值和时间窗口。

### 3. 分级告警

根据严重程度分级，避免所有告警都是紧急的。

## 告警级别定义

| 级别 | 描述 | 响应时间 | 示例 |
|------|------|----------|------|
| Critical | 服务完全不可用 | 立即 | 所有实例宕机 |
| Warning | 服务降级 | 30分钟内 | P99延迟超标 |
| Info | 需要关注 | 工作时间内 | 磁盘使用率>70% |

## OTLP 告警规则

### Prometheus 告警配置

```yaml
groups:
  - name: otlp_critical
    interval: 30s
    rules:
      # 服务不可用
      - alert: OtlpServiceDown
        expr: up{job="otlp-collector"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "OTLP Collector is down"
          description: "Instance {{ $labels.instance }} is unreachable"

      # 高错误率
      - alert: OtlpHighErrorRate
        expr: |
          rate(otlp_export_errors_total[5m]) 
          / rate(otlp_export_total[5m]) > 0.05
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value | humanizePercentage }}"

  - name: otlp_warning
    interval: 1m
    rules:
      # 高延迟
      - alert: OtlpHighLatency
        expr: |
          histogram_quantile(0.99, 
            rate(otlp_export_duration_seconds_bucket[5m])
          ) > 1.0
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "High P99 latency"
          description: "P99 latency is {{ $value }}s"

      # CPU 使用率高
      - alert: OtlpHighCPU
        expr: |
          rate(process_cpu_seconds_total{job="otlp-collector"}[5m]) * 100 > 80
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: "High CPU usage"
          description: "CPU usage is {{ $value }}%"
```

## 告警模板

### 告警通知模板

```yaml
# alertmanager.yml
templates:
  - '/etc/alertmanager/templates/*.tmpl'

route:
  group_by: ['alertname', 'cluster']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 12h
  receiver: 'default'

receivers:
  - name: 'default'
    webhook_configs:
      - url: 'http://alertmanager-webhook:8080/alert'
```

### 告警消息模板

```go
{{ define "slack.title" }}
[{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] 
{{ .GroupLabels.alertname }}
{{ end }}

{{ define "slack.text" }}
{{ range .Alerts }}
*Alert:* {{ .Labels.alertname }}
*Severity:* {{ .Labels.severity }}
*Description:* {{ .Annotations.description }}
*Details:*
{{ range .Labels.SortedPairs }} • *{{ .Name }}:* `{{ .Value }}`
{{ end }}
{{ end }}
{{ end }}
```

## 完整告警规则库

### 1. 服务可用性告警

```yaml
groups:
  - name: otlp_availability
    rules:
      # 服务完全不可用
      - alert: OtlpServiceDown
        expr: up{job="otlp-collector"} == 0
        for: 1m
        labels:
          severity: critical
          category: availability
        annotations:
          summary: "OTLP Collector 服务不可用"
          description: "实例 {{ $labels.instance }} 已宕机超过 1 分钟"
          runbook_url: "https://runbook.example.com/OtlpServiceDown"
          action: "1. 检查进程状态\n2. 查看系统日志\n3. 尝试重启服务"

      # 部分实例不可用
      - alert: OtlpPartialOutage
        expr: |
          (count(up{job="otlp-collector"} == 0) / count(up{job="otlp-collector"})) > 0.3
        for: 5m
        labels:
          severity: critical
          category: availability
        annotations:
          summary: "OTLP Collector 部分实例不可用"
          description: "{{ $value | humanizePercentage }} 的实例不可用"

      # 实例频繁重启
      - alert: OtlpFrequentRestarts
        expr: |
          rate(process_start_time_seconds{job="otlp-collector"}[15m]) > 0.1
        for: 5m
        labels:
          severity: warning
          category: stability
        annotations:
          summary: "OTLP Collector 频繁重启"
          description: "实例 {{ $labels.instance }} 在过去 15 分钟内重启了 {{ $value }} 次"
```

### 2. 性能告警

```yaml
groups:
  - name: otlp_performance
    rules:
      # P99 延迟过高
      - alert: OtlpHighP99Latency
        expr: |
          histogram_quantile(0.99, 
            rate(otlp_export_duration_seconds_bucket[5m])
          ) > 1.0
        for: 10m
        labels:
          severity: warning
          category: performance
        annotations:
          summary: "OTLP 导出延迟过高"
          description: "P99 延迟为 {{ $value }}s，超过阈值 1s"
          impact: "用户可能感受到明显的延迟"

      # P50 延迟异常
      - alert: OtlpHighP50Latency
        expr: |
          histogram_quantile(0.50, 
            rate(otlp_export_duration_seconds_bucket[5m])
          ) > 0.5
        for: 15m
        labels:
          severity: warning
          category: performance
        annotations:
          summary: "OTLP 中位延迟异常"
          description: "P50 延迟为 {{ $value }}s"

      # 吞吐量下降
      - alert: OtlpLowThroughput
        expr: |
          rate(otlp_spans_exported_total[5m]) < 1000
        for: 10m
        labels:
          severity: warning
          category: performance
        annotations:
          summary: "OTLP 吞吐量下降"
          description: "当前 QPS 为 {{ $value }}，低于正常水平"

      # 队列积压
      - alert: OtlpQueueBacklog
        expr: otlp_queue_size > 10000
        for: 5m
        labels:
          severity: warning
          category: performance
        annotations:
          summary: "OTLP 队列积压"
          description: "队列大小为 {{ $value }}，可能导致数据延迟"
```

### 3. 错误率告警

```yaml
groups:
  - name: otlp_errors
    rules:
      # 高错误率
      - alert: OtlpHighErrorRate
        expr: |
          (
            rate(otlp_export_errors_total[5m]) 
            / rate(otlp_export_total[5m])
          ) > 0.05
        for: 5m
        labels:
          severity: critical
          category: errors
        annotations:
          summary: "OTLP 错误率过高"
          description: "错误率为 {{ $value | humanizePercentage }}，超过 5% 阈值"
          action: "检查错误日志，定位失败原因"

      # 特定错误类型激增
      - alert: OtlpConnectionErrors
        expr: |
          rate(otlp_connection_errors_total[5m]) > 10
        for: 5m
        labels:
          severity: warning
          category: errors
        annotations:
          summary: "OTLP 连接错误增加"
          description: "连接错误率为 {{ $value }}/s"

      # 数据丢失
      - alert: OtlpDataLoss
        expr: |
          rate(otlp_spans_dropped_total[5m]) > 100
        for: 5m
        labels:
          severity: critical
          category: data_loss
        annotations:
          summary: "OTLP 数据丢失"
          description: "丢弃 Span 速率为 {{ $value }}/s"
          impact: "可能导致追踪数据不完整"
```

### 4. 资源使用告警

```yaml
groups:
  - name: otlp_resources
    rules:
      # CPU 使用率高
      - alert: OtlpHighCPU
        expr: |
          rate(process_cpu_seconds_total{job="otlp-collector"}[5m]) * 100 > 80
        for: 15m
        labels:
          severity: warning
          category: resources
        annotations:
          summary: "OTLP CPU 使用率过高"
          description: "CPU 使用率为 {{ $value }}%"
          action: "1. 检查是否有性能瓶颈\n2. 考虑扩容"

      # 内存使用率高
      - alert: OtlpHighMemory
        expr: |
          (process_resident_memory_bytes{job="otlp-collector"} 
          / node_memory_MemTotal_bytes) * 100 > 85
        for: 10m
        labels:
          severity: warning
          category: resources
        annotations:
          summary: "OTLP 内存使用率过高"
          description: "内存使用率为 {{ $value }}%"

      # 内存泄漏检测
      - alert: OtlpMemoryLeak
        expr: |
          deriv(process_resident_memory_bytes{job="otlp-collector"}[1h]) > 10485760
        for: 2h
        labels:
          severity: warning
          category: resources
        annotations:
          summary: "OTLP 可能存在内存泄漏"
          description: "内存持续增长，增长率为 {{ $value | humanize }}B/s"

      # 磁盘空间不足
      - alert: OtlpLowDiskSpace
        expr: |
          (node_filesystem_avail_bytes{mountpoint="/data"} 
          / node_filesystem_size_bytes{mountpoint="/data"}) * 100 < 15
        for: 5m
        labels:
          severity: critical
          category: resources
        annotations:
          summary: "OTLP 磁盘空间不足"
          description: "可用空间仅剩 {{ $value }}%"
          action: "立即清理日志或扩容"

      # 文件描述符不足
      - alert: OtlpHighFileDescriptors
        expr: |
          (process_open_fds{job="otlp-collector"} 
          / process_max_fds{job="otlp-collector"}) * 100 > 80
        for: 10m
        labels:
          severity: warning
          category: resources
        annotations:
          summary: "OTLP 文件描述符使用率过高"
          description: "使用率为 {{ $value }}%"
```

### 5. SLO 告警

```yaml
groups:
  - name: otlp_slo
    rules:
      # SLO 违反
      - alert: OtlpSLOViolation
        expr: |
          (
            sum(rate(otlp_requests_total[30m])) 
            - sum(rate(otlp_errors_total[30m]))
          ) / sum(rate(otlp_requests_total[30m])) < 0.999
        for: 5m
        labels:
          severity: critical
          category: slo
        annotations:
          summary: "OTLP SLO 违反"
          description: "30分钟可用性为 {{ $value | humanizePercentage }}，低于 99.9% SLO"

      # 错误预算耗尽
      - alert: OtlpErrorBudgetExhausted
        expr: |
          otlp_error_budget_remaining < 0
        for: 1m
        labels:
          severity: critical
          category: slo
        annotations:
          summary: "OTLP 错误预算耗尽"
          description: "错误预算已用完，需要立即采取行动"
          action: "1. 停止非紧急变更\n2. 专注于稳定性改进"

      # 错误预算消耗过快
      - alert: OtlpErrorBudgetBurnRateFast
        expr: |
          (
            rate(otlp_errors_total[1h]) 
            / (1 - 0.999) * 30 * 24
          ) > 1
        for: 5m
        labels:
          severity: warning
          category: slo
        annotations:
          summary: "OTLP 错误预算消耗过快"
          description: "按当前速率，错误预算将在 {{ $value }} 天内耗尽"
```

## 告警规则最佳实践

### 1. 告警阈值设置

**原则**：

- 基于历史数据设置
- 考虑业务影响
- 留有缓冲空间

**示例**：

```yaml
# 不好的阈值
expr: cpu_usage > 50  # 太敏感，会产生大量误报

# 好的阈值
expr: cpu_usage > 80  # 合理阈值
for: 15m              # 持续时间过滤
```

### 2. 告警分组

```yaml
route:
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 30s      # 等待同组告警
  group_interval: 5m   # 同组告警间隔
  repeat_interval: 4h  # 重复通知间隔
```

### 3. 告警抑制

```yaml
inhibit_rules:
  # 服务宕机时抑制性能告警
  - source_match:
      alertname: 'OtlpServiceDown'
    target_match_re:
      alertname: '(OtlpHighLatency|OtlpHighCPU)'
    equal: ['instance']
```

### 4. 告警路由

```yaml
route:
  routes:
    # Critical 告警立即通知
    - match:
        severity: critical
      receiver: 'pagerduty'
      group_wait: 10s
      repeat_interval: 1h
    
    # Warning 告警延迟通知
    - match:
        severity: warning
      receiver: 'slack'
      group_wait: 5m
      repeat_interval: 12h
```

## 告警测试

### 单元测试

```bash
# 测试告警规则语法
promtool check rules /etc/prometheus/rules/*.yml

# 测试特定告警
promtool test rules /etc/prometheus/rules/test.yml
```

### 集成测试

```yaml
# test.yml
rule_files:
  - otlp_alerts.yml

evaluation_interval: 1m

tests:
  - interval: 1m
    input_series:
      - series: 'up{job="otlp-collector",instance="localhost:8080"}'
        values: '0+0x10'  # 10分钟内值为0
    
    alert_rule_test:
      - eval_time: 2m
        alertname: OtlpServiceDown
        exp_alerts:
          - exp_labels:
              severity: critical
              instance: localhost:8080
            exp_annotations:
              summary: "OTLP Collector 服务不可用"
```

## 告警文档化

### Runbook 模板

```markdown
# OtlpHighErrorRate Runbook

## 概述
当 OTLP 导出错误率超过 5% 时触发此告警。

## 影响
- 用户数据可能丢失
- 追踪完整性受影响

## 诊断步骤
1. 检查错误日志
    ```bash
    kubectl logs -l app=otlp-collector --tail=100 | grep ERROR
    ```

2. 查看错误类型分布

    ```promql
    sum by (error_type) (rate(otlp_export_errors_total[5m]))
    ```

3. 检查下游服务状态

    ```bash
    curl -I http://backend-service:8080/health
    ```

## 解决方案

- 如果是网络问题：检查网络连接
- 如果是认证问题：更新凭证
- 如果是容量问题：扩容 Collector

## 升级路径

如果 15 分钟内无法解决，升级到 P1 并通知架构师团队。

```

---

**相关文档**：

- [告警疲劳管理](./告警疲劳管理.md)
- [SLO_SLA管理](./SLO_SLA管理.md)
- [可观测性最佳实践](./可观测性最佳实践.md)
