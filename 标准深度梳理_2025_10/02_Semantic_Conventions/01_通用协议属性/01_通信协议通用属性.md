# 通信协议通用属性

> **标准版本**: v1.27.0  
> **状态**: Stable  
> **最后更新**: 2025年10月8日

---

## 目录

- [通信协议通用属性](#通信协议通用属性)
  - [目录](#目录)
  - [1. 概述](#1-概述)
  - [2. 网络传输属性](#2-网络传输属性)
    - [2.1 基本传输属性](#21-基本传输属性)
    - [2.2 Go示例](#22-go示例)
  - [3. 协议标识属性](#3-协议标识属性)
    - [3.1 应用层协议属性](#31-应用层协议属性)
    - [3.2 完整示例](#32-完整示例)
  - [4. 连接属性](#4-连接属性)
    - [4.1 对等点（Peer）属性](#41-对等点peer属性)
    - [4.2 主机（Host）属性](#42-主机host属性)
    - [4.3 Socket属性（详细级别）](#43-socket属性详细级别)
  - [5. 完整示例](#5-完整示例)
    - [5.1 HTTP客户端完整属性](#51-http客户端完整属性)
    - [5.2 数据库连接完整属性](#52-数据库连接完整属性)
    - [5.3 消息队列完整属性](#53-消息队列完整属性)
    - [5.4 gRPC完整属性](#54-grpc完整属性)
  - [6. 参考资源](#6-参考资源)
    - [官方文档](#官方文档)
    - [相关标准](#相关标准)

---

## 1. 概述

**通信协议通用属性**定义了适用于所有网络通信协议的标准化属性，包括HTTP、gRPC、数据库、消息队列等。

**核心原则**:

```text
✅ 协议无关性 - 适用于所有通信协议
✅ 层次化设计 - 从传输层到应用层
✅ 向后兼容性 - 保持稳定的API
```

---

## 2. 网络传输属性

### 2.1 基本传输属性

| 属性名 | 类型 | 描述 | 示例 |
|--------|------|------|------|
| `net.transport` | string | 网络传输协议 | `ip_tcp`, `ip_udp`, `pipe`, `inproc`, `unix` |
| `net.sock.family` | string | Socket协议族 | `inet` (IPv4), `inet6` (IPv6), `unix` |

**传输协议枚举**:

```text
ip_tcp:   TCP over IP (最常用)
ip_udp:   UDP over IP
pipe:     Named or anonymous pipe
inproc:   进程内通信（同一进程）
unix:     Unix Domain Socket
other:    其他传输方式
```

### 2.2 Go示例

```go
span.SetAttributes(
    attribute.String("net.transport", "ip_tcp"),
    attribute.String("net.sock.family", "inet"),
)
```

---

## 3. 协议标识属性

### 3.1 应用层协议属性

| 属性名 | 类型 | 描述 | 示例 |
|--------|------|------|------|
| `net.protocol.name` | string | 应用层协议名称 | `http`, `grpc`, `amqp`, `mqtt` |
| `net.protocol.version` | string | 协议版本 | `1.1`, `2.0`, `3.0`, `0.9.1` |

**常见协议标识**:

| 协议类型 | protocol.name | 常见version |
|----------|---------------|-------------|
| HTTP | `http` | `1.0`, `1.1`, `2.0`, `3.0` |
| gRPC | `grpc` | - |
| AMQP | `amqp` | `0.9.1`, `1.0` |
| MQTT | `mqtt` | `3.1.1`, `5.0` |
| Redis | `redis` | `6.0`, `7.0` |
| MongoDB | `mongodb` | `4.4`, `5.0`, `6.0` |

### 3.2 完整示例

**HTTP/1.1**:

```go
span.SetAttributes(
    attribute.String("net.transport", "ip_tcp"),
    attribute.String("net.protocol.name", "http"),
    attribute.String("net.protocol.version", "1.1"),
)
```

**HTTP/2**:

```go
span.SetAttributes(
    attribute.String("net.transport", "ip_tcp"),
    attribute.String("net.protocol.name", "http"),
    attribute.String("net.protocol.version", "2.0"),
)
```

**MQTT over TCP**:

```go
span.SetAttributes(
    attribute.String("net.transport", "ip_tcp"),
    attribute.String("net.protocol.name", "mqtt"),
    attribute.String("net.protocol.version", "5.0"),
)
```

---

## 4. 连接属性

### 4.1 对等点（Peer）属性

用于CLIENT Span，描述远程端点。

| 属性名 | 类型 | 描述 | 示例 |
|--------|------|------|------|
| `net.peer.name` | string | 远程主机名或域名 | `api.example.com` |
| `net.peer.port` | int | 远程端口 | `443`, `8080` |
| `net.peer.ip` | string | 远程IP地址 | `203.0.113.42` |

### 4.2 主机（Host）属性

用于SERVER Span，描述本地端点。

| 属性名 | 类型 | 描述 | 示例 |
|--------|------|------|------|
| `net.host.name` | string | 本地主机名 | `web-server-01.prod` |
| `net.host.port` | int | 本地监听端口 | `8080`, `443` |
| `net.host.ip` | string | 本地IP地址 | `10.0.1.5` |

### 4.3 Socket属性（详细级别）

| 属性名 | 类型 | 描述 | 示例 |
|--------|------|------|------|
| `net.sock.peer.addr` | string | 远程socket地址 | `192.168.0.1`, `::1` |
| `net.sock.peer.port` | int | 远程socket端口 | `54321` |
| `net.sock.peer.name` | string | 远程socket名称 | `/var/run/mysql.sock` |
| `net.sock.host.addr` | string | 本地socket地址 | `10.0.0.5` |
| `net.sock.host.port` | int | 本地socket端口 | `8080` |

**使用场景**:

```text
net.peer.*:      逻辑层（DNS名称、服务端口）
net.sock.peer.*: 物理层（实际连接的IP和端口）
```

**示例**:

```go
// 场景：通过负载均衡器连接
span.SetAttributes(
    // 逻辑目标
    attribute.String("net.peer.name", "api.example.com"),
    attribute.Int("net.peer.port", 443),
    
    // 实际连接的服务器
    attribute.String("net.sock.peer.addr", "10.0.1.42"),
    attribute.Int("net.sock.peer.port", 8443),
)
```

---

## 5. 完整示例

### 5.1 HTTP客户端完整属性

```go
package main

import (
    "go.opentelemetry.io/otel/attribute"
    "go.opentelemetry.io/otel/trace"
)

func SetHTTPClientAttributes(span trace.Span) {
    span.SetAttributes(
        // 传输层
        attribute.String("net.transport", "ip_tcp"),
        attribute.String("net.sock.family", "inet"),
        
        // 协议层
        attribute.String("net.protocol.name", "http"),
        attribute.String("net.protocol.version", "1.1"),
        
        // 对等点（逻辑）
        attribute.String("net.peer.name", "api.example.com"),
        attribute.Int("net.peer.port", 443),
        
        // 对等点（物理）
        attribute.String("net.sock.peer.addr", "203.0.113.42"),
        attribute.Int("net.sock.peer.port", 443),
    )
}
```

### 5.2 数据库连接完整属性

```go
func SetDatabaseClientAttributes(span trace.Span) {
    span.SetAttributes(
        // 传输层
        attribute.String("net.transport", "ip_tcp"),
        
        // 协议层
        attribute.String("net.protocol.name", "mysql"),
        attribute.String("net.protocol.version", "8.0"),
        
        // 对等点
        attribute.String("net.peer.name", "mysql-primary.prod"),
        attribute.Int("net.peer.port", 3306),
        attribute.String("net.sock.peer.addr", "10.0.2.100"),
    )
}
```

### 5.3 消息队列完整属性

```python
def set_kafka_producer_attributes(span):
    span.set_attributes({
        # 传输层
        "net.transport": "ip_tcp",
        
        # 协议层
        "net.protocol.name": "kafka",
        "net.protocol.version": "2.8.0",
        
        # 对等点
        "net.peer.name": "kafka-broker-01",
        "net.peer.port": 9092,
    })
```

### 5.4 gRPC完整属性

```java
span.setAttributes(
    // 传输层
    AttributeKey.stringKey("net.transport").set("ip_tcp"),
    
    // 协议层
    AttributeKey.stringKey("net.protocol.name").set("grpc"),
    AttributeKey.stringKey("net.protocol.version").set(""), // gRPC没有单独版本号
    
    // 对等点
    AttributeKey.stringKey("net.peer.name").set("service.example.com"),
    AttributeKey.intKey("net.peer.port").set(50051)
);
```

---

## 6. 参考资源

### 官方文档

- **OpenTelemetry General Network Attributes**: <https://opentelemetry.io/docs/specs/semconv/general/attributes/>
- **Network Semantic Conventions**: <https://opentelemetry.io/docs/specs/semconv/general/network/>

### 相关标准

- **IANA Protocol Numbers**: <https://www.iana.org/assignments/protocol-numbers/>
- **IANA Service Names and Port Numbers**: <https://www.iana.org/assignments/service-names-port-numbers/>

---

**文档维护**: OTLP深度梳理项目组  
**最后更新**: 2025年10月8日  
**文档版本**: v1.0  
**质量等级**: ⭐⭐⭐⭐⭐
