# OTLP核心流程时序图与状态机

> **可视化指南**: OpenTelemetry关键流程的时序图与状态机  
> **最后更新**: 2025年10月8日

---

## 目录

- [OTLP核心流程时序图与状态机](#otlp核心流程时序图与状态机)
  - [目录](#目录)
  - [1. 数据采集与导出时序图](#1-数据采集与导出时序图)
    - [1.1 完整Trace采集流程](#11-完整trace采集流程)
    - [1.2 批处理导出流程](#12-批处理导出流程)
    - [1.3 重试机制时序](#13-重试机制时序)
  - [2. Context传播时序图](#2-context传播时序图)
    - [2.1 HTTP跨服务传播](#21-http跨服务传播)
    - [2.2 Kafka异步传播](#22-kafka异步传播)
    - [2.3 失败场景分析](#23-失败场景分析)
  - [3. Collector处理时序图](#3-collector处理时序图)
    - [3.1 Agent模式处理流程](#31-agent模式处理流程)
    - [3.2 Gateway模式处理流程](#32-gateway模式处理流程)
    - [3.3 Tail采样决策流程](#33-tail采样决策流程)
  - [4. 状态机图](#4-状态机图)
    - [4.1 Span生命周期状态机](#41-span生命周期状态机)
    - [4.2 Exporter状态机](#42-exporter状态机)
    - [4.3 Collector Pipeline状态机](#43-collector-pipeline状态机)
  - [5. 故障场景时序图](#5-故障场景时序图)
    - [5.1 连接失败与重试](#51-连接失败与重试)
    - [5.2 背压与限流](#52-背压与限流)
    - [5.3 降级与恢复](#53-降级与恢复)
  - [6. 高级场景](#6-高级场景)
    - [6.1 分布式采样决策](#61-分布式采样决策)
    - [6.2 多租户数据隔离](#62-多租户数据隔离)
    - [6.3 A/B测试追踪](#63-ab测试追踪)

---

## 1. 数据采集与导出时序图

### 1.1 完整Trace采集流程

```text
完整的Trace采集与导出时序图

┌─────────┐   ┌──────────┐   ┌───────────┐   ┌───────────┐   ┌─────────┐
│ 应用代码 │   │   SDK    │   │ Exporter  │   │ Collector │   │ Backend │
└────┬────┘   └────┬─────┘   └─────┬─────┘   └─────┬─────┘   └────┬────┘
     │             │                │               │              │
     │─┐           │                │               │              │
     │ │ 业务操作   │                │               │              │
     │<┘           │                │               │              │
     │             │                │               │              │
     │ StartSpan() │                │               │              │
     │────────────>│                │               │              │
     │             │                │               │              │
     │             │─┐              │               │              │
     │             │ │ 创建Span     │               │              │
     │             │ │ 生成TraceID  │               │              │
     │             │ │ 采样决策     │               │              │
     │             │<┘              │               │              │
     │             │                │               │              │
     │ Span对象    │                │               │              │
     │<────────────│                │               │              │
     │             │                │               │              │
     │─┐           │                │               │              │
     │ │ 设置属性   │                │               │              │
     │ │ 记录事件   │                │               │              │
     │<┘           │                │               │              │
     │             │                │               │              │
     │ SetAttributes()              │               │              │
     │────────────>│                │               │              │
     │             │─┐              │               │              │
     │             │ │ 更新Span     │               │              │
     │             │<┘              │               │              │
     │             │                │               │              │
     │ End()       │                │               │              │
     │────────────>│                │               │              │
     │             │                │               │              │
     │             │─┐              │               │              │
     │             │ │ 设置结束时间  │               │              │
     │             │ │ 加入队列      │               │              │
     │             │<┘              │               │              │
     │             │                │               │              │
     │             ╞════════════════╡               │              │
     │             ║ 批处理周期      ║               │              │
     │             ╞════════════════╡               │              │
     │             │                │               │              │
     │             │ Export(batch)  │               │              │
     │             │───────────────>│               │              │
     │             │                │               │              │
     │             │                │─┐             │              │
     │             │                │ │ 序列化      │              │
     │             │                │ │ Protobuf    │              │
     │             │                │ │ gzip压缩    │              │
     │             │                │<┘             │              │
     │             │                │               │              │
     │             │                │ Export Request│              │
     │             │                │──────────────>│              │
     │             │                │               │              │
     │             │                │               │─┐            │
     │             │                │               │ │ 接收数据    │
     │             │                │               │ │ 解压/解析   │
     │             │                │               │ │ Processor  │
     │             │                │               │<┘            │
     │             │                │               │              │
     │             │                │               │ Export       │
     │             │                │               │─────────────>│
     │             │                │               │              │
     │             │                │               │              │─┐
     │             │                │               │              │ │ 存储
     │             │                │               │              │<┘
     │             │                │               │              │
     │             │                │               │ Success      │
     │             │                │               │<─────────────│
     │             │                │               │              │
     │             │                │ Success       │              │
     │             │                │<──────────────│              │
     │             │                │               │              │
     │             │ Success        │               │              │
     │             │<───────────────│               │              │
     │             │                │               │              │
     ▼             ▼                ▼               ▼              ▼

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

关键节点:
1. StartSpan: 2-5μs (内存操作)
2. SetAttributes: 1-3μs per call
3. End: 1-2μs (加入队列)
4. Export: 5-50ms (网络延迟)
5. Backend存储: 10-100ms

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 1.2 批处理导出流程

```text
批处理器内部时序图

┌─────────────┐  ┌──────────────┐  ┌──────────────┐
│ SpanProcessor│  │ BatchProcessor│ │   Exporter  │
└──────┬──────┘  └──────┬───────┘  └──────┬───────┘
       │                │                  │
       │ OnEnd(span)    │                  │
       │───────────────>│                  │
       │                │                  │
       │                │─┐                │
       │                │ │ 加入队列        │
       │                │ │ queue.add()    │
       │                │<┘                │
       │                │                  │
       │ Success        │                  │
       │<───────────────│                  │
       │                │                  │
       │                ╞══════════════════╡
       │                ║ 等待触发条件      ║
       │                ║ - 队列满         ║
       │                ║ - 超时           ║
       │                ╞══════════════════╡
       │                │                  │
       │                │─┐                │
       │                │ │ 检查条件        │
       │                │ │ size >= 512?   │
       │                │ │ 或timeout?     │
       │                │<┘                │
       │                │                  │
       │                │─┐                │
       │                │ │ 创建batch      │
       │                │ │ batch = []     │
       │                │<┘                │
       │                │                  │
       │                │─┐                │
       │                │ │ 从队列取出      │
       │                │ │ min(512, size) │
       │                │<┘                │
       │                │                  │
       │                │ ExportSpans(batch)│
       │                │─────────────────>│
       │                │                  │
       │                │                  │─┐
       │                │                  │ │ 发送到Collector
       │                │                  │<┘
       │                │                  │
       │                │ Success          │
       │                │<─────────────────│
       │                │                  │
       │                │─┐                │
       │                │ │ 更新统计        │
       │                │ │ exported++     │
       │                │<┘                │
       │                │                  │
       ▼                ▼                  ▼

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

触发条件优先级:
1. 队列满 (size >= MaxQueueSize)    → 立即导出
2. 批大小达到 (size >= BatchSize)   → 立即导出
3. 超时 (time >= BatchTimeout)      → 定时导出

配置示例:
- MaxQueueSize: 2048
- BatchSize: 512
- BatchTimeout: 5s

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 1.3 重试机制时序

```text
导出失败重试时序图

┌──────────┐  ┌───────────┐  ┌───────────┐
│ Exporter │  │ Collector │  │ Backend   │
└────┬─────┘  └─────┬─────┘  └─────┬─────┘
     │              │              │
     │ Export(batch)│              │
     │─────────────>│              │
     │              │              │
     │              │ Export       │
     │              │─────────────>│
     │              │              │
     │              │              │ ✗
     │              │ Error (503)  │
     │              │<─────────────│
     │              │              │
     │ Error (503)  │              │
     │<─────────────│              │
     │              │              │
     │─┐            │              │
     │ │ 检查重试策略│              │
     │ │ attempt=1  │              │
     │ │ wait=5s    │              │
     │<┘            │              │
     │              │              │
     ╞══════════════╡              │
     ║ 等待5秒      ║              │
     ╞══════════════╡              │
     │              │              │
     │ Retry Export │              │
     │─────────────>│              │
     │              │              │
     │              │ Export       │
     │              │─────────────>│
     │              │              │
     │              │              │ ✗
     │              │ Error (503)  │
     │              │<─────────────│
     │              │              │
     │ Error (503)  │              │
     │<─────────────│              │
     │              │              │
     │─┐            │              │
     │ │ 检查重试策略│              │
     │ │ attempt=2  │              │
     │ │ wait=10s   │              │
     │<┘            │              │
     │              │              │
     ╞══════════════╡              │
     ║ 等待10秒     ║              │
     ╞══════════════╡              │
     │              │              │
     │ Retry Export │              │
     │─────────────>│              │
     │              │              │
     │              │ Export       │
     │              │─────────────>│
     │              │              │
     │              │              │ ✓
     │              │ Success      │
     │              │<─────────────│
     │              │              │
     │ Success      │              │
     │<─────────────│              │
     │              │              │
     │─┐            │              │
     │ │ 重置重试计数│              │
     │<┘            │              │
     │              │              │
     ▼              ▼              ▼

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

重试策略 (Exponential Backoff):

Attempt | Wait Time | Total Wait
--------|-----------|------------
   1    |    5s     |     5s
   2    |   10s     |    15s
   3    |   20s     |    35s
   4    |   30s     |    65s (Max)
   5    |   30s     |    95s
   ...  |   30s     |    ...

配置:
- MaxRetries: 5
- InitialInterval: 5s
- MaxInterval: 30s
- MaxElapsedTime: 5min

失败处理:
- 达到MaxRetries → 丢弃数据 + 记录日志
- 超过MaxElapsedTime → 丢弃数据
- 5xx错误 → 重试
- 4xx错误 → 不重试 (客户端错误)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## 2. Context传播时序图

### 2.1 HTTP跨服务传播

```text
HTTP Context传播完整时序图

┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐
│Service A│  │  SDK A  │  │   网络   │  │  SDK B  │  │Service B│
└────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘
     │            │             │            │            │
     │ StartSpan()│             │            │            │
     │───────────>│             │            │            │
     │            │             │            │            │
     │            │─┐           │            │            │
     │            │ │ TraceID=abc123        │            │
     │            │ │ SpanID=span001         │            │
     │            │<┘           │            │            │
     │            │             │            │            │
     │ HTTP Request             │            │            │
     │───────────>│             │            │            │
     │            │             │            │            │
     │            │─┐           │            │            │
     │            │ │ Inject Context         │            │
     │            │ │ traceparent:           │            │
     │            │ │  00-abc123-span001-01  │            │
     │            │ │ tracestate:            │            │
     │            │ │  vendor=value          │            │
     │            │<┘           │            │            │
     │            │             │            │            │
     │            │ HTTP + Headers           │            │
     │            │────────────>│            │            │
     │            │             │            │            │
     │            │             │ HTTP + Headers          │
     │            │             │───────────>│            │
     │            │             │            │            │
     │            │             │            │ Extract Context
     │            │             │            │───────────>│
     │            │             │            │            │
     │            │             │            │            │─┐
     │            │             │            │            │ │ 解析Header
     │            │             │            │            │ │ TraceID=abc123
     │            │             │            │            │ │ ParentSpanID=span001
     │            │             │            │            │<┘
     │            │             │            │            │
     │            │             │            │            │ StartSpan()
     │            │             │            │<───────────│
     │            │             │            │            │
     │            │             │            │─┐          │
     │            │             │            │ │ 创建子Span
     │            │             │            │ │ TraceID=abc123
     │            │             │            │ │ SpanID=span002
     │            │             │            │ │ ParentSpanID=span001
     │            │             │            │<┘          │
     │            │             │            │            │
     │            │             │            │ Span对象   │
     │            │             │            │───────────>│
     │            │             │            │            │
     │            │             │            │            │─┐
     │            │             │            │            │ │ 处理请求
     │            │             │            │            │<┘
     │            │             │            │            │
     │            │             │            │            │ End()
     │            │             │            │            │────>│
     │            │             │            │            │     │
     │            │             │            │<───────────┘     │
     │            │             │            │ Export Span002   │
     │            │             │            │                  │
     │            │             │ HTTP Response                 │
     │            │             │<───────────│                  │
     │            │             │                               │
     │            │ HTTP Response                               │
     │            │<────────────│                               │
     │            │                                             │
     │ Response   │                                             │
     │<───────────│                                             │
     │            │                                             │
     │ End()      │                                             │
     │───────────>│                                             │
     │            │                                             │
     │            │ Export Span001                              │
     │            │                                             │
     ▼            ▼                                             ▼

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

W3C Trace Context Headers:

traceparent: 00-abc123456789abcdef0123456789abcd-span0000001-01
             │  │                              │           │
             │  └─ TraceID (32 hex chars)     │           │
             │                                 │           │
             └─ Version                        │           │
                                               │           │
                                SpanID (16 hex)┘           │
                                                           │
                                              Flags (8 bit)┘
                                              01 = sampled

tracestate: vendor1=value1,vendor2=value2

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 2.2 Kafka异步传播

```text
Kafka消息队列Context传播时序图

┌──────────┐  ┌────────┐  ┌────────┐  ┌────────┐  ┌──────────┐
│Producer  │  │ SDK P  │  │ Kafka  │  │ SDK C  │  │Consumer  │
│Service   │  │        │  │        │  │        │  │Service   │
└────┬─────┘  └───┬────┘  └───┬────┘  └───┬────┘  └────┬─────┘
     │            │            │            │            │
     │ 业务事件    │            │            │            │
     │───────────>│            │            │            │
     │            │            │            │            │
     │            │─┐          │            │            │
     │            │ │ StartSpan│            │            │
     │            │ │ TraceID=xyz789        │            │
     │            │ │ SpanID=producer001    │            │
     │            │<┘          │            │            │
     │            │            │            │            │
     │            │─┐          │            │            │
     │            │ │ Inject   │            │            │
     │            │ │ 创建Headers            │            │
     │            │<┘          │            │            │
     │            │            │            │            │
     │            │ Produce Message         │            │
     │            │  + Headers              │            │
     │            │───────────>│            │            │
     │            │            │            │            │
     │            │            │─┐          │            │
     │            │            │ │ 存储消息  │            │
     │            │            │ │ + Headers │            │
     │            │            │<┘          │            │
     │            │            │            │            │
     │            │ Ack        │            │            │
     │            │<───────────│            │            │
     │            │            │            │            │
     │            │ End Producer Span       │            │
     │            │            │            │            │
     │            │            │            │            │
     │            │            ╞════════════╡            │
     │            │            ║ 异步传输   ║            │
     │            │            ╞════════════╡            │
     │            │            │            │            │
     │            │            │ Poll       │            │
     │            │            │<───────────│            │
     │            │            │            │            │
     │            │            │ Message    │            │
     │            │            │ + Headers  │            │
     │            │            │───────────>│            │
     │            │            │            │            │
     │            │            │            │─┐          │
     │            │            │            │ │ Extract  │
     │            │            │            │ │ TraceID=xyz789
     │            │            │            │ │ ParentSpanID=
     │            │            │            │ │  producer001
     │            │            │            │<┘          │
     │            │            │            │            │
     │            │            │            │ 创建Context │
     │            │            │            │───────────>│
     │            │            │            │            │
     │            │            │            │            │─┐
     │            │            │            │            │ │ StartSpan
     │            │            │            │            │ │ TraceID=xyz789
     │            │            │            │            │ │ SpanID=consumer001
     │            │            │            │            │ │ ParentSpanID=
     │            │            │            │            │ │  producer001
     │            │            │            │            │<┘
     │            │            │            │            │
     │            │            │            │            │─┐
     │            │            │            │            │ │ 处理消息
     │            │            │            │            │<┘
     │            │            │            │            │
     │            │            │            │            │ End()
     │            │            │            │            │────>│
     │            │            │            │<───────────┘     │
     │            │            │            │ Export consumer001
     │            │            │            │                  │
     │            │            │ Commit     │                  │
     │            │            │<───────────│                  │
     │            │            │            │                  │
     ▼            ▼            ▼            ▼                  ▼

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Kafka Headers示例:

Key: traceparent
Value: 00-xyz789...-producer001-01

Key: tracestate
Value: vendor=value

SpanKind:
- Producer Span: PRODUCER
- Consumer Span: CONSUMER

时间差分析:
- Producer End → Consumer Start: 消息延迟
- 可能数百ms到数秒
- Trace可以跨越时间边界

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 2.3 失败场景分析

```text
Context传播失败场景时序图

场景1: Header丢失

┌─────────┐  ┌─────────┐  ┌─────────┐
│Service A│  │ 中间件  │  │Service B│
└────┬────┘  └────┬────┘  └────┬────┘
     │            │            │
     │ Request +  │            │
     │ traceparent│            │
     │───────────>│            │
     │            │            │
     │            │─┐          │
     │            │ │ ✗ 过滤Header
     │            │<┘          │
     │            │            │
     │            │ Request    │
     │            │ 无Header   │
     │            │───────────>│
     │            │            │
     │            │            │─┐
     │            │            │ │ ✗ 无法Extract
     │            │            │ │ 创建新TraceID
     │            │            │ │ Trace断裂!
     │            │            │<┘
     │            │            │
     ▼            ▼            ▼

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

场景2: 采样决策不一致

┌─────────┐  ┌─────────┐
│Service A│  │Service B│
└────┬────┘  └────┬────┘
     │            │
     │─┐          │
     │ │ 采样: OFF │
     │<┘          │
     │            │
     │ Request +  │
     │ sampled=00 │
     │───────────>│
     │            │
     │            │─┐
     │            │ │ 采样: ON
     │            │ │ 但父级未采样
     │            │ │ ✗ Trace不完整
     │            │<┘
     │            │
     ▼            ▼

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

修复方案:

1. Header丢失:
   - 使用白名单中间件
   - 配置Header透传
   - 监控Header存在率

2. 采样不一致:
   - 使用ParentBased采样器
   - 遵循父级决策
   - 强制采样关键路径

3. 验证工具:
   - 检查Trace完整性
   - 监控孤立Span
   - 告警Trace断裂

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## 3. Collector处理时序图

### 3.1 Agent模式处理流程

```text
Collector Agent模式处理时序图

┌─────┐  ┌──────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐
│ SDK │  │ Receiver │  │Processor│  │Exporter │  │ Gateway │
└──┬──┘  └────┬─────┘  └────┬────┘  └────┬────┘  └────┬────┘
   │          │              │            │            │
   │ Export   │              │            │            │
   │─────────>│              │            │            │
   │          │              │            │            │
   │          │─┐            │            │            │
   │          │ │ 接收Spans   │            │            │
   │          │ │ gRPC解析    │            │            │
   │          │<┘            │            │            │
   │          │              │            │            │
   │          │ ProcessSpans │            │            │
   │          │─────────────>│            │            │
   │          │              │            │            │
   │          │              │─┐          │            │
   │          │              │ │ MemoryLimiter         │
   │          │              │ │ 检查内存   │            │
   │          │              │<┘          │            │
   │          │              │            │            │
   │          │              │─┐          │            │
   │          │              │ │ Attributes│            │
   │          │              │ │ 添加node.id            │
   │          │              │<┘          │            │
   │          │              │            │            │
   │          │              │─┐          │            │
   │          │              │ │ Batch    │            │
   │          │              │ │ 批处理    │            │
   │          │              │<┘          │            │
   │          │              │            │            │
   │          │              │ ExportSpans│            │
   │          │              │───────────>│            │
   │          │              │            │            │
   │          │              │            │─┐          │
   │          │              │            │ │ 压缩     │
   │          │              │            │<┘          │
   │          │              │            │            │
   │          │              │            │ Export     │
   │          │              │            │───────────>│
   │          │              │            │            │
   │          │              │            │            │─┐
   │          │              │            │            │ │ 聚合数据
   │          │              │            │            │<┘
   │          │              │            │            │
   │          │              │            │ Success    │
   │          │              │            │<───────────│
   │          │              │            │            │
   │          │              │ Success    │            │
   │          │              │<───────────│            │
   │          │              │            │            │
   │          │ Success      │            │            │
   │          │<─────────────│            │            │
   │          │              │            │            │
   │ Success  │              │            │            │
   │<─────────│              │            │            │
   │          │              │            │            │
   ▼          ▼              ▼            ▼            ▼

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Processor链:
1. memory_limiter → 限制内存使用
2. attributes → 添加node metadata
3. resource → 检测资源信息
4. batch → 批处理优化

性能指标:
- 接收延迟: < 5ms
- 处理延迟: < 10ms
- 端到端: < 20ms (本地)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 3.2 Gateway模式处理流程

```text
Collector Gateway模式高级处理时序图

┌─────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌─────────┐
│  Agent  │  │ Receiver │  │Processors│  │Exporter  │  │ Backend │
└────┬────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬────┘
     │            │              │             │             │
     │ Export     │              │             │             │
     │───────────>│              │             │             │
     │            │              │             │             │
     │            │─┐            │             │             │
     │            │ │ 接收       │             │             │
     │            │<┘            │             │             │
     │            │              │             │             │
     │            │ Process      │             │             │
     │            │─────────────>│             │             │
     │            │              │             │             │
     │            │              │─┐           │             │
     │            │              │ │ MemoryLimiter          │
     │            │              │<┘           │             │
     │            │              │             │             │
     │            │              │─┐           │             │
     │            │              │ │ Attributes│             │
     │            │              │ │ 脱敏PII   │             │
     │            │              │<┘           │             │
     │            │              │             │             │
     │            │              │─┐           │             │
     │            │              │ │ TailSampling           │
     │            │              │ │ 等待决策...│             │
     │            │              │<┘           │             │
     │            │              │             │             │
     │            │              ╞═════════════╡             │
     │            │              ║ 10秒等待    ║             │
     │            │              ╞═════════════╡             │
     │            │              │             │             │
     │            │              │─┐           │             │
     │            │              │ │ 采样决策: │             │
     │            │              │ │ - 错误Trace: ✓         │
     │            │              │ │ - 慢Trace: ✓           │
     │            │              │ │ - 正常: ✗              │
     │            │              │<┘           │             │
     │            │              │             │             │
     │            │              │─┐           │             │
     │            │              │ │ Batch     │             │
     │            │              │<┘           │             │
     │            │              │             │             │
     │            │              │ Export      │             │
     │            │              │────────────>│             │
     │            │              │             │             │
     │            │              │             │─┐           │
     │            │              │             │ │ 负载均衡  │
     │            │              │             │<┘           │
     │            │              │             │             │
     │            │              │             │ Export      │
     │            │              │             │────────────>│
     │            │              │             │             │
     │            │              │             │             │─┐
     │            │              │             │             │ │ 存储
     │            │              │             │             │<┘
     │            │              │             │             │
     │            │              │             │ Success     │
     │            │              │             │<────────────│
     │            │              │             │             │
     │            │              │ Success     │             │
     │            │              │<────────────│             │
     │            │              │             │             │
     │            │ Success      │             │             │
     │            │<─────────────│             │             │
     │            │              │             │             │
     │ Success    │              │             │             │
     │<───────────│              │             │             │
     │            │              │             │             │
     ▼            ▼              ▼             ▼             ▼

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Gateway Processor链:
1. memory_limiter → 限制内存
2. attributes → PII脱敏
3. tail_sampling → 智能采样
4. batch → 批处理
5. load_balancing → 负载均衡

高级功能:
- 智能采样 (90%↓数据量)
- PII自动脱敏
- 多Backend负载均衡
- 高可用 (3+副本)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 3.3 Tail采样决策流程

```text
Tail Sampling决策时序图

┌─────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐
│ Span In │  │TailSampler│ │PolicyEngine││Decision  │
└────┬────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘
     │            │              │             │
     │ Span1      │              │             │
     │───────────>│              │             │
     │            │              │             │
     │            │─┐            │             │
     │            │ │ 按TraceID  │             │
     │            │ │ 分组存储    │             │
     │            │<┘            │             │
     │            │              │             │
     │ Span2      │              │             │
     │ (同Trace)  │              │             │
     │───────────>│              │             │
     │            │              │             │
     │            │─┐            │             │
     │            │ │ 添加到组    │             │
     │            │<┘            │             │
     │            │              │             │
     │ Span3      │              │             │
     │ (同Trace)  │              │             │
     │───────────>│              │             │
     │            │              │             │
     │            ╞══════════════╡             │
     │            ║ 等待10秒    ║             │
     │            ╞══════════════╡             │
     │            │              │             │
     │            │─┐            │             │
     │            │ │ 超时触发   │             │
     │            │ │ 决策流程    │             │
     │            │<┘            │             │
     │            │              │             │
     │            │ Evaluate Trace             │
     │            │─────────────>│             │
     │            │              │             │
     │            │              │─┐           │
     │            │              │ │ Policy1:  │
     │            │              │ │ ErrorTrace?
     │            │              │ │ → NO      │
     │            │              │<┘           │
     │            │              │             │
     │            │              │─┐           │
     │            │              │ │ Policy2:  │
     │            │              │ │ SlowTrace?│
     │            │              │ │ Duration>1s?
     │            │              │ │ → YES ✓   │
     │            │              │<┘           │
     │            │              │             │
     │            │              │ Decision: SAMPLE
     │            │              │────────────>│
     │            │              │             │
     │            │ SAMPLE       │             │
     │            │<─────────────│             │
     │            │              │             │
     │            │─┐            │             │
     │            │ │ 导出Trace  │             │
     │            │<┘            │             │
     │            │              │             │
     │            │ Export Spans │             │
     │            │───────> (Exporter)         │
     │            │              │             │
     ▼            ▼              ▼             ▼

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

采样策略优先级:

1. ErrorTrace (status=ERROR)     → 100% 保留
2. SlowTrace (duration > 1s)     → 100% 保留
3. CriticalService               → 100% 保留
4. HighValueUser (vip)           → 50% 保留
5. Random                        → 10% 保留

决策逻辑: OR (任一匹配即保留)

性能影响:
- 内存: ~1MB per 1000 Traces
- 延迟: +10s (decision_wait)
- CPU: 中等

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## 4. 状态机图

### 4.1 Span生命周期状态机

```text
Span生命周期完整状态机

           ┌──────────┐
           │  创建中   │ (StartSpan调用)
           └────┬─────┘
                │
                │ 创建成功
                ▼
           ┌──────────┐
      ┌───>│  活跃中   │<───┐
      │    └────┬─────┘    │
      │         │          │
      │         │SetAttributes
      │         │RecordEvent
      │         │          │
      │         └──────────┘
      │
      │ End()
      │
      ▼
 ┌──────────┐
 │  已结束   │
 └────┬─────┘
      │
      │ 导出时机到达
      ▼
 ┌──────────┐
 │ 待导出队列 │
 └────┬─────┘
      │
      │ 批处理触发
      ▼
 ┌──────────┐
 │  导出中   │
 └────┬─────┘
      │
      ├─────────────┬──────────────┐
      │             │              │
      │ 成功        │ 失败         │ 丢弃
      ▼             ▼              ▼
 ┌──────────┐ ┌──────────┐  ┌──────────┐
 │  已导出   │ │ 重试队列  │  │  已丢弃   │
 └────┬─────┘ └────┬─────┘  └──────────┘
      │            │
      │            │ 重试
      │            └────┐
      │                 │
      │                 ▼
      │            ┌──────────┐
      │            │ 重试导出  │
      │            └────┬─────┘
      │                 │
      │                 ├───> 成功 ──┐
      │                 │            │
      │                 └───> 失败 ──┤
      │                              │
      └──────────────────────────────┘

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

状态转换事件:

1. 创建 → 活跃:     StartSpan()
2. 活跃 → 活跃:     SetAttributes(), RecordEvent()
3. 活跃 → 已结束:   End()
4. 已结束 → 待导出:  加入队列
5. 待导出 → 导出中:  批处理触发
6. 导出中 → 已导出:  成功
7. 导出中 → 重试:    失败 (可重试)
8. 导出中 → 已丢弃:  失败 (不可重试)
9. 重试 → 已导出:    重试成功

异常路径:
- 队列满 → 直接丢弃 + 记录dropped_spans
- 超过MaxRetries → 丢弃 + 记录
- 内存不足 → 丢弃最老的Span

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 4.2 Exporter状态机

```text
Exporter连接状态机

       ┌──────────┐
  ┌───>│  空闲中   │<────┐
  │    └────┬─────┘     │
  │         │           │
  │         │ Export()  │
  │         ▼           │
  │    ┌──────────┐     │
  │    │ 连接建立中 │     │
  │    └────┬─────┘     │
  │         │           │
  │         ├──────┬────┤
  │         │      │    │
  │  成功   │      │失败│ 完成
  │         ▼      ▼    │
  │    ┌──────────┐     │
  │    │  发送中   │     │
  │    └────┬─────┘     │
  │         │           │
  │         ├──────┬────┤
  │         │      │    │
  │  成功   │      │失败│
  │         ▼      ▼    │
  │    ┌──────────┐     │
  │    │  完成     │─────┘
  │    └──────────┘
  │         │
  │         │ 失败且可重试
  │         ▼
  │    ┌──────────┐
  │    │ 退避等待  │
  │    └────┬─────┘
  │         │
  │         │ 超时
  │         └──────┐
  │                │
  │                ▼
  │           ┌──────────┐
  │           │  重试中   │
  │           └────┬─────┘
  │                │
  │                ├──────┬────┐
  │                │      │    │
  │  成功          │      │失败│
  └────────────────┘      │    │
                          │    │ 超过MaxRetries
                          │    ▼
                          │ ┌──────────┐
                          │ │ 永久失败  │
                          │ └──────────┘
                          │
                          │ 仍可重试
                          └────> 返回"退避等待"

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

错误分类:

可重试错误 (Retryable):
- 503 Service Unavailable
- 429 Too Many Requests
- 网络超时
- 连接中断

不可重试错误 (Non-Retryable):
- 400 Bad Request
- 401 Unauthorized
- 403 Forbidden
- 数据格式错误

重试策略:
- 指数退避: 5s → 10s → 20s → 30s (max)
- 最大重试次数: 5
- 总超时: 5分钟

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 4.3 Collector Pipeline状态机

```text
Collector Pipeline状态机

           ┌──────────┐
           │  初始化   │
           └────┬─────┘
                │
                │ Start()
                ▼
           ┌──────────┐
           │  启动中   │
           └────┬─────┘
                │
                ├──────┬────┐
                │      │    │
         成功   │      │失败│
                ▼      ▼    │
           ┌──────────┐     │
      ┌───>│  运行中   │     │
      │    └────┬─────┘     │
      │         │           │
      │         ├───────────┼────┐
      │         │           │    │
      │  接收数据│   Shutdown│错误│
      │         │           │    │
      │         ▼           ▼    ▼
      │    ┌──────────┐ ┌──────────┐
      │    │ 处理数据  │ │ 关闭中   │
      │    └────┬─────┘ └────┬─────┘
      │         │            │
      │  处理完成│            │ 完成
      │         │            ▼
      │         │       ┌──────────┐
      └─────────┘       │  已停止   │
                        └────┬─────┘
                             │
                             │ 资源清理
                             ▼
                        ┌──────────┐
                        │  已清理   │
                        └──────────┘

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

健康检查状态:

运行中状态细分:
┌──────────────┐
│   Healthy    │ - 正常运行
├──────────────┤
│   Degraded   │ - 部分功能受损
├──────────────┤
│ Unhealthy    │ - 严重问题
└──────────────┘

健康检查指标:
- 接收速率 > 0
- 队列未满 (< 90%)
- CPU < 80%
- 内存 < memory_limit
- 导出成功率 > 95%

状态转换触发:
- Healthy → Degraded:
  * 队列 > 80%
  * 导出成功率 < 99%

- Degraded → Unhealthy:
  * 队列满
  * 导出失败 > 50%
  * 内存超限

- Unhealthy → 关闭:
  * 连续失败 > 5分钟
  * 内存泄漏

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## 5. 故障场景时序图

### 5.1 连接失败与重试

```text
连接失败完整恢复时序图

┌─────┐  ┌──────────┐  ┌───────────┐  ┌─────────┐
│ SDK │  │ Exporter │  │ Collector │  │ Backend │
└──┬──┘  └────┬─────┘  └─────┬─────┘  └────┬────┘
   │          │               │             │
   │ Export   │               │             │
   │─────────>│               │             │
   │          │               │             │
   │          │ Connect       │             │
   │          │──────────────>│             │
   │          │               │ ✗ 拒绝连接  │
   │          │ Error         │             │
   │          │<──────────────│             │
   │          │               │             │
   │          │─┐             │             │
   │          │ │ 重试计数=1  │             │
   │          │ │ 等待5s      │             │
   │          │<┘             │             │
   │          │               │             │
   │          ╞═══════════════╡             │
   │          ║ 5秒退避      ║             │
   │          ╞═══════════════╡             │
   │          │               │             │
   │          │ Retry Connect │             │
   │          │──────────────>│             │
   │          │               │ ✗ 拒绝连接  │
   │          │ Error         │             │
   │          │<──────────────│             │
   │          │               │             │
   │          │─┐             │             │
   │          │ │ 重试计数=2  │             │
   │          │ │ 等待10s     │             │
   │          │<┘             │             │
   │          │               │             │
   │          ╞═══════════════╡             │
   │          ║ 10秒退避     ║             │
   │          ╞═══════════════╡             │
   │          │               │             │
   │          │               ╞═════════════╡
   │          │               ║ Collector  ║
   │          │               ║ 重启恢复    ║
   │          │               ╞═════════════╡
   │          │               │             │
   │          │ Retry Connect │             │
   │          │──────────────>│             │
   │          │               │ ✓ 成功      │
   │          │ Success       │             │
   │          │<──────────────│             │
   │          │               │             │
   │          │─┐             │             │
   │          │ │ 重置重试计数│             │
   │          │ │ 恢复正常    │             │
   │          │<┘             │             │
   │          │               │             │
   │          │ Export Data   │             │
   │          │──────────────>│             │
   │          │               │             │
   │          │               │ Export      │
   │          │               │────────────>│
   │          │               │             │
   │          │               │ Success     │
   │          │               │<────────────│
   │          │               │             │
   │          │ Success       │             │
   │          │<──────────────│             │
   │          │               │             │
   │ Success  │               │             │
   │<─────────│               │             │
   │          │               │             │
   ▼          ▼               ▼             ▼

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

重试时间线:

T=0s    尝试1  ✗ 失败
T=5s    尝试2  ✗ 失败  
T=15s   尝试3  ✓ 成功

累计影响:
- 数据延迟: 15秒
- 本地缓存: 积压15秒数据
- 恢复后: 批量发送

熔断机制:
- 连续失败5次 → 暂停1分钟
- 1分钟后重试 → 成功则恢复
- 失败则再暂停5分钟

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 5.2 背压与限流

```text
背压处理时序图

┌──────┐  ┌──────────┐  ┌───────────┐  ┌─────────┐
│ SDK  │  │ Collector │  │Processor  │  │ Backend │
└──┬───┘  └────┬─────┘  └─────┬─────┘  └────┬────┘
   │           │               │             │
   │           │               │             │ ✗ 慢
   │           │               │             │
   │ Export    │               │             │
   │──────────>│               │             │
   │           │               │             │
   │           │─┐             │             │
   │           │ │ 接收       │             │
   │           │<┘             │             │
   │           │               │             │
   │           │ Process       │             │
   │           │──────────────>│             │
   │           │               │             │
   │           │               │─┐           │
   │           │               │ │ 处理     │
   │           │               │<┘           │
   │           │               │             │
   │           │               │ Export      │
   │           │               │────────────>│
   │           │               │             │
   │           │               │             │─┐
   │           │               │             │ │ 慢
   │           │               │             │ │ 200ms
   │           │               │             │<┘
   │           │               │             │
   │           │               ╞═════════════╡
   │           │               ║ 队列积压   ║
   │           │               ║ 80% 满     ║
   │           │               ╞═════════════╡
   │           │               │             │
   │ Export    │               │             │
   │──────────>│               │             │
   │           │               │             │
   │           │─┐             │             │
   │           │ │ 检测背压   │             │
   │           │<┘             │             │
   │           │               │             │
   │           │ 429 Too Many  │             │
   │           │ Requests      │             │
   │<──────────│               │             │
   │           │               │             │
   │─┐         │               │             │
   │ │ 本地限流│               │             │
   │ │ 等待1s  │               │             │
   │<┘         │               │             │
   │           │               │             │
   │           │               ╞═════════════╡
   │           │               ║ Backend恢复║
   │           │               ╞═════════════╡
   │           │               │             │
   │           │               │             │ ✓ 快
   │           │               │             │
   ╞═══════════╡               │             │
   ║ 1秒等待  ║               │             │
   ╞═══════════╡               │             │
   │           │               │             │
   │ Retry     │               │             │
   │──────────>│               │             │
   │           │               │             │
   │           │ Success       │             │
   │<──────────│               │             │
   │           │               │             │
   ▼           ▼               ▼             ▼

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

背压触发阈值:

Collector队列状态:
- < 50%: 正常 (绿色)
- 50-80%: 警告 (黄色)
- 80-95%: 背压 (橙色) → 返回429
- > 95%: 拒绝 (红色) → 返回503

SDK限流策略:
- 收到429 → 等待1秒
- 收到503 → 等待5秒
- Token Bucket: 100 req/s

Collector限流:
- memory_limiter: 拒绝新请求
- 优先级队列: 保留高优先级

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 5.3 降级与恢复

```text
系统降级与恢复时序图

┌─────────┐  ┌───────────┐  ┌───────────┐
│ System  │  │ Collector │  │ Monitoring│
└────┬────┘  └─────┬─────┘  └─────┬─────┘
     │             │               │
     │             │─┐             │
     │             │ │ 正常运行   │
     │             │ │ CPU: 30%    │
     │             │ │ Mem: 40%    │
     │             │<┘             │
     │             │               │
     │             ╞═══════════════╡
     │             ║ 流量突增     ║
     │             ╞═══════════════╡
     │             │               │
     │             │─┐             │
     │             │ │ 检测压力   │
     │             │ │ CPU: 85%    │
     │             │ │ Mem: 80%    │
     │             │ │ Queue: 90%  │
     │             │<┘             │
     │             │               │
     │             │ Alert         │
     │             │──────────────>│
     │             │               │
     │             │               │─┐
     │             │               │ │ 触发降级
     │             │               │<┘
     │             │               │
     │             │ 降级指令      │
     │             │<──────────────│
     │             │               │
     │             │─┐             │
     │             │ │ 执行降级:  │
     │             │ │ 1.关闭tail_sampling
     │             │ │ 2.增加采样率→1%
     │             │ │ 3.禁用非关键processor
     │             │ │ 4.增加批大小
     │             │<┘             │
     │             │               │
     │─┐           │               │
     │ │ 应用层感知│               │
     │ │ 降低流量  │               │
     │<┘           │               │
     │             │               │
     │             │─┐             │
     │             │ │ 压力下降   │
     │             │ │ CPU: 60%    │
     │             │ │ Mem: 55%    │
     │             │ │ Queue: 40%  │
     │             │<┘             │
     │             │               │
     │             ╞═══════════════╡
     │             ║ 稳定5分钟    ║
     │             ╞═══════════════╡
     │             │               │
     │             │ 恢复指令      │
     │             │<──────────────│
     │             │               │
     │             │─┐             │
     │             │ │ 逐步恢复:  │
     │             │ │ 1.启用processor
     │             │ │ 2.降低采样率→5%
     │             │ │ 3.启用tail_sampling
     │             │<┘             │
     │             │               │
     │             │─┐             │
     │             │ │ 观察5分钟  │
     │             │<┘             │
     │             │               │
     │             │─┐             │
     │             │ │ 完全恢复   │
     │             │<┘             │
     │             │               │
     │             │ 恢复完成      │
     │             │──────────────>│
     │             │               │
     ▼             ▼               ▼

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

降级策略级别:

Level 1 (轻度):
- 增加批大小
- 减少processor

Level 2 (中度):
- 禁用tail_sampling
- 采样率 10% → 5%

Level 3 (重度):
- 采样率 5% → 1%
- 禁用非关键功能

Level 4 (紧急):
- 采样率 1% → 0.1%
- 只保留错误trace

恢复策略:
- 逐级恢复 (反向Level 4→1)
- 每级观察5分钟
- 异常立即回退

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## 6. 高级场景

### 6.1 分布式采样决策

```text
分布式采样决策协调时序图

┌─────────┐  ┌─────────┐  ┌─────────┐  ┌──────────┐
│Gateway  │  │Service A│  │Service B│  │Service C │
└────┬────┘  └────┬────┘  └────┬────┘  └────┬─────┘
     │            │             │             │
     │ Request    │             │             │
     │───────────>│             │             │
     │            │             │             │
     │            │─┐           │             │
     │            │ │ StartSpan │             │
     │            │ │ 采样决策: │             │
     │            │ │ TraceIDRatio=10%       │
     │            │ │ TraceID=0x123456...     │
     │            │ │ Decision: SAMPLE ✓     │
     │            │<┘           │             │
     │            │             │             │
     │            │ Call B      │             │
     │            │ sampled=01  │             │
     │            │────────────>│             │
     │            │             │             │
     │            │             │─┐           │
     │            │             │ │ Extract   │
     │            │             │ │ ParentSampled=true
     │            │             │ │ Decision: SAMPLE ✓
     │            │             │<┘           │
     │            │             │             │
     │            │             │ Call C      │
     │            │             │ sampled=01  │
     │            │             │────────────>│
     │            │             │             │
     │            │             │             │─┐
     │            │             │             │ │ Extract
     │            │             │             │ │ ParentSampled=true
     │            │             │             │ │ Decision: SAMPLE ✓
     │            │             │             │<┘
     │            │             │             │
     │            │             │             │ End()
     │            │             │             │ Export Span
     │            │             │             │
     │            │             │ End()       │
     │            │             │ Export Span │
     │            │             │             │
     │            │ End()       │             │
     │            │ Export Span │             │
     │            │             │             │
     │            ◀──────────────────────────┘
     │            │ (所有Span同属一个TraceID)
     │            │             │             │
     │            ╞═════════════╡             │
     │            ║ Collector  ║             │
     │            ║ 汇总Trace  ║             │
     │            ╞═════════════╡             │
     │            │             │             │
     │            │ 完整Trace   │             │
     │<───────────┤             │             │
     │            │             │             │
     │─┐          │             │             │
     │ │ Tail采样决策:          │             │
     │ │ - 有错误? NO           │             │
     │ │ - 慢请求? NO           │             │
     │ │ - 随机10%? YES ✓       │             │
     │ │ Final: KEEP            │             │
     │<┘          │             │             │
     │            │             │             │
     │ Export完整Trace          │             │
     │─> Backend  │             │             │
     │            │             │             │
     ▼            ▼             ▼             ▼

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

采样一致性保证:

Head-based采样:
- 根节点决策: sampled=01
- 传播给所有子节点
- ParentBased采样器遵循父决策

Tail-based采样:
- 收集完整Trace
- Gateway统一决策
- 可以覆盖Head决策

混合策略:
1. Head: 10%概率采样
2. Tail: 错误/慢请求强制保留
3. 最终采样率: ~15% (10% + 5%强制)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 6.2 多租户数据隔离

```text
多租户数据隔离时序图

┌──────────┐  ┌───────────┐  ┌───────────┐  ┌─────────┐
│Tenant A  │  │ Collector │  │ Processor │  │Backend A│
│Request   │  │           │  │           │  │         │
└────┬─────┘  └─────┬─────┘  └─────┬─────┘  └────┬────┘
     │              │               │             │
     │ Export       │               │             │
     │ tenant=A     │               │             │
     │─────────────>│               │             │
     │              │               │             │
     │              │─┐             │             │
     │              │ │ 识别租户   │             │
     │              │ │ tenant.id=A │             │
     │              │<┘             │             │
     │              │               │             │
     │              │ Process       │             │
     │              │──────────────>│             │
     │              │               │             │
     │              │               │─┐           │
     │              │               │ │ 租户过滤  │
     │              │               │ │ 添加标签  │
     │              │               │<┘           │
     │              │               │             │
     │              │               │ Export A    │
     │              │               │────────────>│
     │              │               │             │
     │              │               │             │─┐
     │              │               │             │ │ 存储
     │              │               │             │<┘
     │              │               │             │
┌──────────┐       │               │        ┌─────────┐
│Tenant B  │       │               │        │Backend B│
│Request   │       │               │        │         │
└────┬─────┘       │               │        └────┬────┘
     │              │               │             │
     │ Export       │               │             │
     │ tenant=B     │               │             │
     │─────────────>│               │             │
     │              │               │             │
     │              │─┐             │             │
     │              │ │ 识别租户   │             │
     │              │ │ tenant.id=B │             │
     │              │<┘             │             │
     │              │               │             │
     │              │ Process       │             │
     │              │──────────────>│             │
     │              │               │             │
     │              │               │─┐           │
     │              │               │ │ 租户过滤  │
     │              │               │ │ 路由到B   │
     │              │               │<┘           │
     │              │               │             │
     │              │               │ Export B    │
     │              │               │────────────>│
     │              │               │             │
     │              │               │             │─┐
     │              │               │             │ │ 存储
     │              │               │             │<┘
     │              │               │             │
     ▼              ▼               ▼             ▼

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

租户隔离配置:

1. 识别租户:
   - HTTP Header: X-Tenant-ID
   - Resource Attribute: tenant.id
   - Baggage: tenant

2. 路由策略:
    ```yaml
    processors:
        routing:
        from_attribute: tenant.id
        table:
            - value: tenant-a
            exporters: [otlp/backend-a]
            - value: tenant-b
            exporters: [otlp/backend-b]
    ```

3. 资源配额:
   - Tenant A: 1000 spans/s
   - Tenant B: 500 spans/s

4. 存储隔离:
   - 不同Backend
   - 不同索引
   - 不同权限

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 6.3 A/B测试追踪

```text
A/B测试追踪时序图

┌──────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌──────────┐
│User  │  │Gateway  │  │Service A│  │Service B│  │Collector │
└──┬───┘  └────┬────┘  └────┬────┘  └────┬────┘  └────┬─────┘
   │           │             │             │            │
   │ Request   │             │             │            │
   │──────────>│             │             │            │
   │           │             │             │            │
   │           │─┐           │             │            │
   │           │ │ A/B分流:  │             │            │
   │           │ │ user_id=123             │            │
   │           │ │ hash % 100 = 45         │            │
   │           │ │ → Group B (实验组)      │            │
   │           │<┘           │             │            │
   │           │             │             │            │
   │           │─┐           │             │            │
   │           │ │ StartSpan │             │            │
   │           │ │ experiment.id=exp-001   │            │
   │           │ │ experiment.variant=B    │            │
   │           │ │ Baggage: variant=B      │            │
   │           │<┘           │             │            │
   │           │             │             │            │
   │           │ Call A      │             │            │
   │           │ Baggage:    │             │            │
   │           │ variant=B   │             │            │
   │           │────────────>│             │            │
   │           │             │             │            │
   │           │             │─┐           │            │
   │           │             │ │ 读取Baggage            │
   │           │             │ │ variant=B │            │
   │           │             │ │ 使用新算法 │            │
   │           │             │<┘           │            │
   │           │             │             │            │
   │           │             │ Call B      │            │
   │           │             │ Baggage:    │            │
   │           │             │ variant=B   │            │
   │           │             │────────────>│            │
   │           │             │             │            │
   │           │             │             │─┐          │
   │           │             │             │ │ 读取Baggage
   │           │             │             │ │ variant=B
   │           │             │             │ │ 特性开关ON
   │           │             │             │<┘          │
   │           │             │             │            │
   │           │             │             │ End()      │
   │           │             │             │ Attributes:│
   │           │             │             │  variant=B │
   │           │             │             │───────────>│
   │           │             │             │            │
   │           │             │ End()       │            │
   │           │             │ Attributes: │            │
   │           │             │  variant=B  │            │
   │           │             │───────────>│            │
   │           │             │             │            │
   │           │ End()       │             │            │
   │           │ Attributes: │             │            │
   │           │  variant=B  │             │            │
   │           │───────────>│             │            │
   │           │             │             │            │
   │           │             │             │            │─┐
   │           │             │             │            │ │ 聚合分析
   │           │             │             │            │ │ 按variant分组
   │           │             │             │            │ │ - Group A平均延迟
   │           │             │             │            │ │ - Group B平均延迟
   │           │             │             │            │ │ - 成功率对比
   │           │             │             │            │<┘
   │           │             │             │            │
   ▼           ▼             ▼             ▼            ▼

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

A/B测试追踪配置:

1. 实验标识:
   - experiment.id: 实验ID
   - experiment.variant: A/B/C
   - experiment.name: 实验名称

2. Baggage传播:
   - variant: A or B
   - user_segment: vip/normal
   - feature_flag: enabled/disabled

3. 分析维度:
   - 按variant聚合延迟
   - 按variant计算成功率
   - 按variant统计错误率

4. 查询示例:
    ```sql
    SELECT 
        experiment.variant,
        AVG(duration_ms),
        COUNT(*) as total,
        SUM(CASE WHEN status=ERROR THEN 1 ELSE 0 END) as errors
    FROM traces
    WHERE experiment.id = 'exp-001'
    GROUP BY experiment.variant
    ```

结果对比:

- Variant A: 平均120ms, 成功率99.5%
- Variant B: 平均95ms, 成功率99.7%
- 结论: B版本性能更好 ✓

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

```

---

**文档状态**: ✅ 完成  
**图表类型**: 时序图、状态机  
**适用场景**: 架构设计、故障排查、系统理解  
**持续更新**: 根据实际场景持续补充
