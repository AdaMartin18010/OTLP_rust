# 📘 OpenTelemetry安全配置速查手册

> **最后更新**: 2025年10月9日  
> **用途**: 快速配置OpenTelemetry安全防护

---

## 🎯 速查目录

- [📘 OpenTelemetry安全配置速查手册](#-opentelemetry安全配置速查手册)
  - [🎯 速查目录](#-速查目录)
  - [🚨 安全威胁](#-安全威胁)
    - [OTLP常见安全风险](#otlp常见安全风险)
  - [🔒 传输加密](#-传输加密)
    - [1. TLS配置 (必须!)](#1-tls配置-必须)
      - [Collector服务端配置](#collector服务端配置)
      - [SDK客户端配置](#sdk客户端配置)
    - [2. 证书管理](#2-证书管理)
      - [生成自签名证书 (开发/测试环境)](#生成自签名证书-开发测试环境)
      - [证书轮换策略](#证书轮换策略)
  - [🔑 认证授权](#-认证授权)
    - [1. Bearer Token认证](#1-bearer-token认证)
      - [Collector配置](#collector配置)
      - [SDK配置](#sdk配置)
    - [2. API Key认证](#2-api-key认证)
    - [3. OAuth 2.0认证](#3-oauth-20认证)
    - [4. mTLS (双向TLS,最安全)](#4-mtls-双向tls最安全)
  - [🛡️ 数据脱敏](#️-数据脱敏)
    - [1. 删除敏感字段](#1-删除敏感字段)
    - [2. 哈希脱敏](#2-哈希脱敏)
    - [3. 日志脱敏](#3-日志脱敏)
    - [4. SDK层脱敏 (推荐)](#4-sdk层脱敏-推荐)
  - [🌐 网络隔离](#-网络隔离)
    - [1. VPC部署 (推荐)](#1-vpc部署-推荐)
    - [2. Kubernetes NetworkPolicy](#2-kubernetes-networkpolicy)
    - [3. 防火墙规则](#3-防火墙规则)
  - [🚪 访问控制](#-访问控制)
    - [1. RBAC (Kubernetes)](#1-rbac-kubernetes)
    - [2. Pod Security Policy](#2-pod-security-policy)
  - [📝 审计日志](#-审计日志)
    - [1. 启用Collector审计日志](#1-启用collector审计日志)
    - [2. 记录认证事件](#2-记录认证事件)
  - [🔐 密钥管理](#-密钥管理)
    - [1. 环境变量 (基础)](#1-环境变量-基础)
    - [2. Kubernetes Secrets](#2-kubernetes-secrets)
    - [3. Vault集成 (企业级)](#3-vault集成-企业级)
  - [✅ 安全清单](#-安全清单)
    - [生产环境安全基线](#生产环境安全基线)
  - [🎯 安全等级](#-安全等级)
    - [Level 1: 基础安全 (开发环境)](#level-1-基础安全-开发环境)
    - [Level 2: 增强安全 (测试环境)](#level-2-增强安全-测试环境)
    - [Level 3: 高安全 (生产环境)](#level-3-高安全-生产环境)
  - [📚 参考资源](#-参考资源)
  - [🎯 最佳实践](#-最佳实践)

---

## 🚨 安全威胁

### OTLP常见安全风险

| 威胁 | 影响 | 严重程度 | 缓解措施 |
|-----|------|---------|---------|
| **中间人攻击 (MITM)** | 数据窃取/篡改 | 🔴 高 | TLS加密 |
| **未授权访问** | 数据泄露 | 🔴 高 | 认证/授权 |
| **敏感数据泄露** | 隐私泄露 | 🔴 高 | 数据脱敏 |
| **DDoS攻击** | 服务中断 | 🟡 中 | 速率限制 |
| **数据注入** | 污染数据 | 🟡 中 | 输入验证 |
| **配置泄露** | 凭证泄露 | 🔴 高 | 密钥管理 |

---

## 🔒 传输加密

### 1. TLS配置 (必须!)

#### Collector服务端配置

```yaml
receivers:
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
        tls:
          cert_file: /etc/ssl/certs/server.crt
          key_file: /etc/ssl/private/server.key
          # 可选: 客户端证书验证 (mTLS)
          client_ca_file: /etc/ssl/certs/ca.crt
          # 要求客户端证书
          require_client_auth: true
      
      http:
        endpoint: 0.0.0.0:4318
        tls:
          cert_file: /etc/ssl/certs/server.crt
          key_file: /etc/ssl/private/server.key
```

#### SDK客户端配置

```go
// Go SDK - TLS配置
import (
    "crypto/tls"
    "crypto/x509"
    "go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracegrpc"
    "google.golang.org/grpc/credentials"
)

func initSecureTracer() (*trace.TracerProvider, error) {
    // 加载CA证书
    caCert, _ := os.ReadFile("/etc/ssl/certs/ca.crt")
    caCertPool := x509.NewCertPool()
    caCertPool.AppendCertsFromPEM(caCert)
    
    // 加载客户端证书 (mTLS)
    clientCert, _ := tls.LoadX509KeyPair(
        "/etc/ssl/certs/client.crt",
        "/etc/ssl/private/client.key",
    )
    
    // TLS配置
    tlsConfig := &tls.Config{
        RootCAs:      caCertPool,
        Certificates: []tls.Certificate{clientCert},
        MinVersion:   tls.VersionTLS13,  // 强制TLS 1.3
    }
    
    exporter, err := otlptracegrpc.New(
        context.Background(),
        otlptracegrpc.WithEndpoint("collector.example.com:4317"),
        otlptracegrpc.WithTLSCredentials(credentials.NewTLS(tlsConfig)),
    )
    
    tp := trace.NewTracerProvider(
        trace.WithBatcher(exporter),
    )
    return tp, nil
}
```

```python
# Python SDK - TLS配置
from opentelemetry.exporter.otlp.proto.grpc.trace_exporter import OTLPSpanExporter

exporter = OTLPSpanExporter(
    endpoint="collector.example.com:4317",
    credentials=grpc.ssl_channel_credentials(
        root_certificates=open('/etc/ssl/certs/ca.crt', 'rb').read(),
        private_key=open('/etc/ssl/private/client.key', 'rb').read(),
        certificate_chain=open('/etc/ssl/certs/client.crt', 'rb').read(),
    ),
)
```

---

### 2. 证书管理

#### 生成自签名证书 (开发/测试环境)

```bash
# 1. 生成CA密钥和证书
openssl req -x509 -newkey rsa:4096 -keyout ca.key -out ca.crt \
  -days 365 -nodes -subj "/CN=My CA"

# 2. 生成服务端密钥
openssl genrsa -out server.key 4096

# 3. 生成服务端证书签名请求 (CSR)
openssl req -new -key server.key -out server.csr \
  -subj "/CN=collector.example.com"

# 4. 使用CA签名服务端证书
openssl x509 -req -in server.csr -CA ca.crt -CAkey ca.key \
  -CAcreateserial -out server.crt -days 365

# 5. 生成客户端证书 (mTLS)
openssl genrsa -out client.key 4096
openssl req -new -key client.key -out client.csr \
  -subj "/CN=client"
openssl x509 -req -in client.csr -CA ca.crt -CAkey ca.key \
  -CAcreateserial -out client.crt -days 365
```

#### 证书轮换策略

```yaml
# 使用cert-manager自动轮换 (Kubernetes)
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: otel-collector-cert
spec:
  secretName: otel-collector-tls
  duration: 2160h  # 90天
  renewBefore: 360h  # 提前15天续期
  issuerRef:
    name: ca-issuer
    kind: ClusterIssuer
  dnsNames:
    - collector.example.com
    - collector.otel-system.svc.cluster.local
```

---

## 🔑 认证授权

### 1. Bearer Token认证

#### Collector配置

```yaml
receivers:
  otlp:
    protocols:
      http:
        endpoint: 0.0.0.0:4318

extensions:
  bearertokenauth:
    scheme: "Bearer"
    token: "${OTEL_API_TOKEN}"  # 从环境变量读取

service:
  extensions: [bearertokenauth]
  pipelines:
    traces:
      receivers: [otlp]
```

#### SDK配置

```go
// Go SDK
exporter, _ := otlptracegrpc.New(
    ctx,
    otlptracegrpc.WithEndpoint("collector:4317"),
    otlptracegrpc.WithHeaders(map[string]string{
        "Authorization": "Bearer " + os.Getenv("OTEL_API_TOKEN"),
    }),
)
```

```python
# Python SDK
exporter = OTLPSpanExporter(
    endpoint="collector:4317",
    headers={
        "Authorization": f"Bearer {os.getenv('OTEL_API_TOKEN')}"
    },
)
```

---

### 2. API Key认证

```yaml
# Collector配置
extensions:
  headers_setter:
    headers:
      - key: X-API-Key
        from_context: api_key

processors:
  attributes:
    actions:
      - key: api.key
        action: delete  # 处理后删除敏感字段

receivers:
  otlp:
    protocols:
      http:
        endpoint: 0.0.0.0:4318

service:
  extensions: [headers_setter]
  pipelines:
    traces:
      receivers: [otlp]
      processors: [attributes]
```

---

### 3. OAuth 2.0认证

```yaml
# Collector导出到需要OAuth的后端
exporters:
  otlphttp:
    endpoint: https://api.observability-platform.com/v1/traces
    auth:
      authenticator: oauth2client

extensions:
  oauth2client:
    client_id: ${OAUTH_CLIENT_ID}
    client_secret: ${OAUTH_CLIENT_SECRET}
    token_url: https://auth.example.com/oauth/token
    scopes:
      - telemetry.write
    timeout: 30s

service:
  extensions: [oauth2client]
  pipelines:
    traces:
      exporters: [otlphttp]
```

---

### 4. mTLS (双向TLS,最安全)

```yaml
# Collector配置
receivers:
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
        tls:
          cert_file: /etc/ssl/certs/server.crt
          key_file: /etc/ssl/private/server.key
          client_ca_file: /etc/ssl/certs/ca.crt
          # 强制要求客户端证书
          require_client_auth: true
```

**优势**:

- ✅ 最高安全级别
- ✅ 双向身份验证
- ✅ 防止未授权访问
- ⚠️ 配置复杂度高

---

## 🛡️ 数据脱敏

### 1. 删除敏感字段

```yaml
processors:
  attributes:
    actions:
      # 删除敏感HTTP头
      - key: http.request.header.authorization
        action: delete
      - key: http.request.header.cookie
        action: delete
      - key: http.request.header.x-api-key
        action: delete
      
      # 删除敏感查询参数
      - key: http.url
        pattern: '(token|key|password|secret)=[^&]*'
        action: extract
        extract_pattern: '(token|key|password|secret)=REDACTED'
      
      # 删除PII数据
      - key: user.email
        action: delete
      - key: user.phone
        action: delete
      - key: user.ssn
        action: delete
```

---

### 2. 哈希脱敏

```yaml
processors:
  transform:
    trace_statements:
      - context: span
        statements:
          # 对敏感字段进行哈希
          - set(attributes["user.id"], SHA256(attributes["user.id"]))
          - set(attributes["client.ip"], SHA256(attributes["client.ip"]))
```

---

### 3. 日志脱敏

```yaml
processors:
  logstransform:
    operators:
      # 使用正则替换敏感信息
      - type: regex_parser
        regex: '(?P<log>.*)(password|token|secret)=(?P<value>\S+)'
        output: |
          {{ .log }}password=***REDACTED***
```

---

### 4. SDK层脱敏 (推荐)

```go
// Go SDK - 自定义Span处理器
type RedactingProcessor struct {
    next trace.SpanProcessor
}

func (p *RedactingProcessor) OnStart(parent context.Context, s sdktrace.ReadWriteSpan) {
    // 在Span创建时就脱敏
    attrs := s.Attributes()
    for _, attr := range attrs {
        if strings.Contains(attr.Key, "password") ||
           strings.Contains(attr.Key, "token") {
            s.SetAttributes(attribute.String(attr.Key, "***REDACTED***"))
        }
    }
    p.next.OnStart(parent, s)
}

// 使用
tp := trace.NewTracerProvider(
    trace.WithSpanProcessor(&RedactingProcessor{
        next: trace.NewBatchSpanProcessor(exporter),
    }),
)
```

---

## 🌐 网络隔离

### 1. VPC部署 (推荐)

```text
┌─────────────────────────────────────────┐
│              Public Internet            │
└───────────────────┬─────────────────────┘
                    │ ❌ 不可直接访问
         ┌──────────▼──────────┐
         │    Load Balancer    │ (可选, HTTPS)
         │   (公网暴露点)       │
         └──────────┬──────────┘
                    │
┌───────────────────▼───────────────────────┐
│              Private VPC                   │
│  ┌─────────────┐      ┌─────────────┐    │
│  │     App     │─────>│  Collector  │    │
│  │  (私有IP)   │      │  (私有IP)   │    │
│  └─────────────┘      └──────┬──────┘    │
│                               │            │
│                               ▼            │
│                     ┌─────────────┐       │
│                     │   Backend   │       │
│                     │  (私有IP)   │       │
│                     └─────────────┘       │
└───────────────────────────────────────────┘
```

---

### 2. Kubernetes NetworkPolicy

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: otel-collector-policy
  namespace: otel-system
spec:
  podSelector:
    matchLabels:
      app: otel-collector
  policyTypes:
    - Ingress
    - Egress
  
  ingress:
    # 仅允许同命名空间的应用访问
    - from:
      - namespaceSelector:
          matchLabels:
            name: production
      ports:
      - protocol: TCP
        port: 4317
      - protocol: TCP
        port: 4318
  
  egress:
    # 仅允许访问后端
    - to:
      - podSelector:
          matchLabels:
            app: observability-backend
      ports:
      - protocol: TCP
        port: 4317
```

---

### 3. 防火墙规则

```bash
# iptables规则示例
# 仅允许内网访问Collector
iptables -A INPUT -p tcp --dport 4317 -s 10.0.0.0/8 -j ACCEPT
iptables -A INPUT -p tcp --dport 4317 -j DROP

iptables -A INPUT -p tcp --dport 4318 -s 10.0.0.0/8 -j ACCEPT
iptables -A INPUT -p tcp --dport 4318 -j DROP
```

---

## 🚪 访问控制

### 1. RBAC (Kubernetes)

```yaml
# ServiceAccount
apiVersion: v1
kind: ServiceAccount
metadata:
  name: otel-collector
  namespace: otel-system

---
# Role - 仅读取ConfigMap和Secret
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: otel-collector-role
  namespace: otel-system
rules:
  - apiGroups: [""]
    resources: ["configmaps", "secrets"]
    verbs: ["get", "list", "watch"]

---
# RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: otel-collector-rolebinding
  namespace: otel-system
subjects:
  - kind: ServiceAccount
    name: otel-collector
roleRef:
  kind: Role
  name: otel-collector-role
  apiGroup: rbac.authorization.k8s.io
```

---

### 2. Pod Security Policy

```yaml
apiVersion: policy/v1beta1
kind: PodSecurityPolicy
metadata:
  name: otel-collector-psp
spec:
  privileged: false
  allowPrivilegeEscalation: false
  requiredDropCapabilities:
    - ALL
  volumes:
    - 'configMap'
    - 'secret'
    - 'emptyDir'
  runAsUser:
    rule: 'MustRunAsNonRoot'
  seLinux:
    rule: 'RunAsAny'
  fsGroup:
    rule: 'RunAsAny'
  readOnlyRootFilesystem: true
```

---

## 📝 审计日志

### 1. 启用Collector审计日志

```yaml
service:
  telemetry:
    logs:
      level: info
      encoding: json
      output_paths:
        - stdout
        - /var/log/otel/audit.log
      error_output_paths:
        - stderr
    # 记录详细的请求日志
    metrics:
      level: detailed
      address: 0.0.0.0:8888
```

---

### 2. 记录认证事件

```yaml
processors:
  attributes:
    actions:
      # 记录请求来源
      - key: audit.client.ip
        from_context: X-Forwarded-For
        action: upsert
      - key: audit.timestamp
        value: ${timestamp}
        action: insert
      - key: audit.api_key_hash
        value: ${hash(api_key)}
        action: insert
```

---

## 🔐 密钥管理

### 1. 环境变量 (基础)

```yaml
# ❌ 不要在配置文件中硬编码
exporters:
  otlp:
    headers:
      Authorization: "Bearer secret-token-12345"  # ❌

# ✅ 使用环境变量
exporters:
  otlp:
    headers:
      Authorization: "Bearer ${OTEL_API_TOKEN}"  # ✅
```

---

### 2. Kubernetes Secrets

```yaml
# Secret
apiVersion: v1
kind: Secret
metadata:
  name: otel-secrets
  namespace: otel-system
type: Opaque
data:
  api-token: <base64-encoded-token>
  tls-cert: <base64-encoded-cert>
  tls-key: <base64-encoded-key>

---
# Deployment使用Secret
apiVersion: apps/v1
kind: Deployment
metadata:
  name: otel-collector
spec:
  template:
    spec:
      containers:
      - name: otel-collector
        env:
          - name: OTEL_API_TOKEN
            valueFrom:
              secretKeyRef:
                name: otel-secrets
                key: api-token
        volumeMounts:
          - name: tls-certs
            mountPath: /etc/ssl/certs
            readOnly: true
      volumes:
        - name: tls-certs
          secret:
            secretName: otel-secrets
```

---

### 3. Vault集成 (企业级)

```yaml
extensions:
  vault:
    endpoint: https://vault.example.com
    path: secret/otel
    auth:
      kubernetes:
        role: otel-collector
        token_path: /var/run/secrets/kubernetes.io/serviceaccount/token

exporters:
  otlp:
    headers:
      Authorization: "Bearer ${vault:api_token}"
```

---

## ✅ 安全清单

### 生产环境安全基线

```text
✅ 传输安全
  □ 启用TLS 1.3 (所有连接)
  □ 使用有效证书 (Let's Encrypt或企业CA)
  □ 启用mTLS (高安全场景)
  □ 禁用insecure模式

✅ 认证授权
  □ 启用API Key或Bearer Token认证
  □ 使用最小权限原则 (RBAC)
  □ 定期轮换密钥 (30-90天)
  □ 记录所有认证事件

✅ 数据保护
  □ 脱敏敏感HTTP头 (Authorization, Cookie)
  □ 脱敏PII数据 (email, phone, SSN)
  □ 删除或哈希高基数标识符
  □ 审查所有导出的数据

✅ 网络安全
  □ 部署在私有网络 (VPC)
  □ 配置防火墙规则
  □ 启用NetworkPolicy (K8s)
  □ 使用负载均衡器分发流量

✅ 密钥管理
  □ 不在代码中硬编码密钥
  □ 使用环境变量或Secrets
  □ 集成密钥管理系统 (Vault)
  □ 加密存储密钥

✅ 审计与监控
  □ 启用审计日志
  □ 监控异常访问模式
  □ 设置安全告警
  □ 定期安全审计

✅ 运维安全
  □ 使用非root用户运行
  □ 只读根文件系统
  □ 限制容器权限 (capabilities)
  □ 定期更新Collector版本
```

---

## 🎯 安全等级

### Level 1: 基础安全 (开发环境)

```yaml
receivers:
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        endpoint: 0.0.0.0:4318

# ✅ 基础配置,无安全防护
```

---

### Level 2: 增强安全 (测试环境)

```yaml
receivers:
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
        tls:
          cert_file: /etc/ssl/certs/server.crt
          key_file: /etc/ssl/private/server.key

extensions:
  bearertokenauth:
    token: "${OTEL_API_TOKEN}"

# ✅ TLS加密 + API Token认证
```

---

### Level 3: 高安全 (生产环境)

```yaml
receivers:
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
        tls:
          cert_file: /etc/ssl/certs/server.crt
          key_file: /etc/ssl/private/server.key
          client_ca_file: /etc/ssl/certs/ca.crt
          require_client_auth: true  # mTLS

processors:
  attributes:
    actions:
      - key: http.request.header.authorization
        action: delete
      - key: user.email
        action: delete

extensions:
  oauth2client:
    client_id: ${OAUTH_CLIENT_ID}
    client_secret: ${OAUTH_CLIENT_SECRET}
    token_url: https://auth.example.com/oauth/token

# ✅ mTLS + OAuth 2.0 + 数据脱敏
```

---

## 📚 参考资源

| 资源 | 链接 |
|------|------|
| **安全最佳实践** | <https://opentelemetry.io/docs/specs/otel/security/> |
| **TLS配置** | <https://opentelemetry.io/docs/collector/configuration/#tls-configuration> |
| **认证扩展** | <https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/extension> |
| **数据脱敏** | <https://opentelemetry.io/docs/specs/otel/common/attribute-naming/> |

---

## 🎯 最佳实践

```text
✅ 生产环境必须启用TLS
✅ 使用mTLS实现最高安全级别
✅ 在SDK层就进行数据脱敏
✅ 定期轮换证书和密钥
✅ 使用密钥管理系统 (Vault)
✅ 最小权限原则 (RBAC)
✅ 启用审计日志
✅ 监控异常访问模式
✅ 定期安全审计
✅ 及时更新到最新稳定版
```

---

**最后更新**: 2025年10月9日  
**上一篇**: [性能优化速查手册](./05_性能优化速查手册.md)  
**系列完成**: 返回[OTLP协议速查手册](./01_OTLP协议速查手册.md)
