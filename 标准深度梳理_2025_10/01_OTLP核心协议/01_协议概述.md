# OTLP协议概述

> **标准版本**: v1.0.0 (Stable)  
> **发布日期**: 2023年2月  
> **状态**: Stable (向后兼容保证至2026年2月)  
> **最后更新**: 2025年10月8日

---

## 目录

- [OTLP协议概述](#otlp协议概述)
  - [目录](#目录)
  - [1. 概念定义](#1-概念定义)
    - [1.1 正式定义](#11-正式定义)
    - [1.2 通俗解释](#12-通俗解释)
    - [1.3 标准引用](#13-标准引用)
  - [2. 核心特性](#2-核心特性)
    - [2.1 信号支持](#21-信号支持)
    - [2.2 传输协议](#22-传输协议)
      - [2.2.1 gRPC (默认)](#221-grpc-默认)
      - [2.2.2 HTTP/1.1 + Protobuf](#222-http11--protobuf)
    - [2.3 编码格式](#23-编码格式)
  - [3. 协议架构](#3-协议架构)
    - [3.1 数据流架构](#31-数据流架构)
    - [3.2 协议栈](#32-协议栈)
  - [4. 关键概念](#4-关键概念)
    - [4.1 Request/Response模型](#41-requestresponse模型)
      - [gRPC模型](#grpc模型)
      - [HTTP模型](#http模型)
    - [4.2 错误处理](#42-错误处理)
    - [4.3 重试策略](#43-重试策略)
  - [5. 形式化规范](#5-形式化规范)
    - [5.1 协议属性](#51-协议属性)
    - [5.2 性能模型](#52-性能模型)
  - [6. 版本与兼容性](#6-版本与兼容性)
    - [6.1 版本策略](#61-版本策略)
    - [6.2 向后兼容保证](#62-向后兼容保证)
    - [6.3 协商机制](#63-协商机制)
  - [7. 安全性](#7-安全性)
    - [7.1 传输层安全 (TLS)](#71-传输层安全-tls)
    - [7.2 认证机制](#72-认证机制)
    - [7.3 数据隐私](#73-数据隐私)
  - [8. 性能特性](#8-性能特性)
    - [8.1 批处理 (Batching)](#81-批处理-batching)
    - [8.2 压缩 (Compression)](#82-压缩-compression)
    - [8.3 并发控制](#83-并发控制)
  - [9. 实现要求](#9-实现要求)
    - [9.1 客户端要求](#91-客户端要求)
    - [9.2 服务器要求](#92-服务器要求)
  - [10. 对比分析](#10-对比分析)
    - [10.1 OTLP vs Jaeger Protocol](#101-otlp-vs-jaeger-protocol)
    - [10.2 OTLP vs Zipkin Protocol](#102-otlp-vs-zipkin-protocol)
    - [10.3 OTLP vs Prometheus Remote Write](#103-otlp-vs-prometheus-remote-write)
  - [11. 标准演进路线图](#11-标准演进路线图)
    - [11.1 历史版本](#111-历史版本)
    - [11.2 未来特性 (Roadmap)](#112-未来特性-roadmap)
  - [12. 参考资源](#12-参考资源)
    - [12.1 官方资源](#121-官方资源)
    - [12.2 实现参考](#122-实现参考)
    - [12.3 学习资源](#123-学习资源)

## 1. 概念定义

### 1.1 正式定义

**OpenTelemetry Protocol (OTLP)** 是一种**通用的遥测数据传输协议**，定义为：

```text
OTLP = (T, E, S)

其中:
- T: Transport = {gRPC, HTTP/1.1}  传输协议集合
- E: Encoding = {Protocol Buffers v3}  编码格式
- S: Signals = {Traces, Metrics, Logs, Profiles}  信号类型集合

协议映射:
OTLP: Telemetry → Wire_Format
Wire_Format = T(E(S))
```

### 1.2 通俗解释

OTLP是OpenTelemetry定义的标准化数据传输协议，用于：

- 在可观测性组件之间传输遥测数据
- 统一Traces、Metrics、Logs的传输格式
- 提供厂商中立、语言无关的互操作性

**类比**: 如同HTTP是网页传输的标准协议，OTLP是可观测性数据传输的标准协议。

### 1.3 标准引用

- **OTLP Specification**: <https://github.com/open-telemetry/opentelemetry-proto>
- **Protocol Buffers**: <https://github.com/open-telemetry/opentelemetry-proto/tree/main/opentelemetry/proto>
- **版本演进**: <https://github.com/open-telemetry/opentelemetry-specification/blob/main/specification/protocol/otlp.md>

---

## 2. 核心特性

### 2.1 信号支持

| 信号类型 | 状态 | Protocol Buffers定义 | 端点 |
|---------|------|---------------------|------|
| **Traces** | Stable | `trace/v1/trace.proto` | `/v1/traces` |
| **Metrics** | Stable | `metrics/v1/metrics.proto` | `/v1/metrics` |
| **Logs** | Stable | `logs/v1/logs.proto` | `/v1/logs` |
| **Profiles** | Experimental | `profiles/v1experimental/profiles.proto` | `/v1/profiles` |

### 2.2 传输协议

#### 2.2.1 gRPC (默认)

```text
特性:
- 默认端口: 4317
- 双向流式传输
- HTTP/2
- 原生Protocol Buffers支持
- 高性能、低延迟

服务定义:
service TraceService {
  rpc Export(ExportTraceServiceRequest) 
    returns (ExportTraceServiceResponse);
}
```

#### 2.2.2 HTTP/1.1 + Protobuf

```text
特性:
- 默认端口: 4318
- 单向请求-响应
- HTTP/1.1
- Protocol Buffers over HTTP
- 广泛兼容性

端点:
POST /v1/traces
POST /v1/metrics
POST /v1/logs
Content-Type: application/x-protobuf
```

### 2.3 编码格式

**Protocol Buffers v3**:

```protobuf
syntax = "proto3";

package opentelemetry.proto.trace.v1;

message TracesData {
  repeated ResourceSpans resource_spans = 1;
}

message ResourceSpans {
  opentelemetry.proto.resource.v1.Resource resource = 1;
  repeated ScopeSpans scope_spans = 2;
  string schema_url = 3;
}
```

---

## 3. 协议架构

### 3.1 数据流架构

```text
┌─────────────┐
│ Application │
└──────┬──────┘
       │ Instrumentation
       ↓
┌─────────────┐
│ OTLP SDK    │
│ - Tracer    │
│ - Meter     │
│ - Logger    │
└──────┬──────┘
       │ Export
       ↓
┌─────────────┐
│ OTLP        │  ← 协议层
│ Exporter    │
│ - gRPC      │
│ - HTTP      │
└──────┬──────┘
       │ Wire Protocol
       ↓
┌─────────────┐
│ OTLP        │
│ Collector   │
│ - Receiver  │
│ - Processor │
│ - Exporter  │
└──────┬──────┘
       │ Backend Protocol
       ↓
┌─────────────┐
│ Backend     │
│ (Jaeger/    │
│  Prometheus)│
└─────────────┘
```

### 3.2 协议栈

```text
Layer 7: Application  │ Telemetry SDK
Layer 6: Presentation │ Protocol Buffers Serialization
Layer 5: Session      │ OTLP Request/Response
Layer 4: Transport    │ gRPC (HTTP/2) or HTTP/1.1
Layer 3: Network      │ TCP/IP
Layer 2: Data Link    │ Ethernet
Layer 1: Physical     │ Physical Media
```

---

## 4. 关键概念

### 4.1 Request/Response模型

#### gRPC模型

```text
Request:
ExportTraceServiceRequest {
  resource_spans: [ResourceSpans]
}

Response:
ExportTraceServiceResponse {
  partial_success: PartialSuccess {
    rejected_spans: int64
    error_message: string
  }
}
```

#### HTTP模型

```text
Request:
POST /v1/traces HTTP/1.1
Host: collector:4318
Content-Type: application/x-protobuf
Content-Length: <length>

<binary protobuf data>

Response:
HTTP/1.1 200 OK
Content-Type: application/x-protobuf
Content-Length: <length>

<binary protobuf response>
```

### 4.2 错误处理

| HTTP状态码 | gRPC状态码 | 含义 | 处理策略 |
|-----------|-----------|------|---------|
| 200 | OK | 成功 | 继续 |
| 400 | INVALID_ARGUMENT | 请求无效 | 不重试 |
| 401 | UNAUTHENTICATED | 未认证 | 检查凭证 |
| 429 | RESOURCE_EXHAUSTED | 限流 | 指数退避重试 |
| 500 | INTERNAL | 服务器错误 | 重试 |
| 503 | UNAVAILABLE | 服务不可用 | 重试 |

### 4.3 重试策略

```text
重试策略 (Exponential Backoff):

Initial_Delay = 1s
Max_Delay = 30s
Multiplier = 2
Max_Retries = 5

Delay(n) = min(Initial_Delay × Multiplier^n, Max_Delay)

示例:
Attempt 1: 立即
Attempt 2: 1s后
Attempt 3: 2s后
Attempt 4: 4s后
Attempt 5: 8s后
Attempt 6: 16s后
```

---

## 5. 形式化规范

### 5.1 协议属性

**定理1: 幂等性 (Idempotency)**:

```text
定理: OTLP导出操作在正确实现下应该是幂等的。

形式化:
∀ request R, ∀ n ∈ ℕ⁺:
  Export(R) ∘ Export(R) ∘ ... ∘ Export(R) ≡ Export(R)
         └────────── n次 ──────────┘

证明:
1. OTLP使用唯一标识符（Span ID, Trace ID）
2. 后端存储应基于ID去重
3. 重复导出相同ID的数据不改变最终状态
∴ 操作是幂等的
```

**定理2: 顺序无关性 (Order Independence)**:

```text
定理: Spans的导出顺序不影响最终追踪结果。

形式化:
∀ spans S = {s₁, s₂, ..., sₙ}, ∀ 排列 π:
  Export({sπ(1), sπ(2), ..., sπ(n)}) ≡ Export({s₁, s₂, ..., sₙ})

原因:
- Trace重建基于parent_span_id关系
- 不依赖导出顺序
```

### 5.2 性能模型

**吞吐量模型**:

```text
Throughput = f(Protocol, Batch_Size, Compression)

gRPC:
T_gRPC = (N × S) / (T_serial + T_network + T_decode)

其中:
- N: Batch中的Span数量
- S: 单个Span平均大小
- T_serial: 序列化时间
- T_network: 网络传输时间
- T_decode: 反序列化时间

HTTP:
T_HTTP = T_gRPC × 0.7  (经验值，因HTTP/1.1头部开销)
```

**延迟模型**:

```text
Latency = T_client + T_network + T_server

T_client = T_batch_wait + T_serialize
T_network = RTT + T_transfer
T_server = T_deserialize + T_process

典型值 (gRPC):
- T_batch_wait: 0-1000ms (可配置)
- T_serialize: 0.1-1ms (取决于batch大小)
- RTT: 1-100ms (取决于网络)
- T_transfer: 0.1-10ms (取决于数据量和带宽)
- T_deserialize: 0.1-1ms
- T_process: 1-10ms (取决于Collector负载)

总延迟: 典型 5-50ms (不含batch等待)
```

---

## 6. 版本与兼容性

### 6.1 版本策略

```text
OTLP版本号: v<major>.<minor>.<patch>

语义化版本 (Semantic Versioning):
- Major: 不兼容的API变更
- Minor: 向后兼容的功能新增
- Patch: 向后兼容的问题修复

当前: v1.0.0 (Stable since 2023-02)
```

### 6.2 向后兼容保证

```text
稳定性保证 (Stability Guarantee):

1. Protocol Buffers字段编号永不改变
2. 必需字段永不移除
3. 字段语义永不改变
4. 新字段仅以optional添加

兼容性窗口:
- v1.0.0发布: 2023年2月
- 向后兼容保证: 至少3年
- 预计v2.0.0: 不早于2026年2月
```

### 6.3 协商机制

```text
版本协商 (Version Negotiation):

gRPC Metadata:
"otlp-version": "1.0.0"

HTTP Header:
OTLP-Version: 1.0.0

客户端策略:
1. 发送当前支持的最高版本
2. 服务器返回支持的版本范围
3. 客户端降级到兼容版本
```

---

## 7. 安全性

### 7.1 传输层安全 (TLS)

```text
gRPC + TLS:
- 默认端口: 4317
- TLS端口: 通常4317 (same)
- 证书验证: 必须
- 最低TLS版本: TLS 1.2
- 推荐: TLS 1.3

HTTP + TLS:
- HTTPS端口: 通常4318 (same)
- 要求同gRPC
```

### 7.2 认证机制

| 机制 | gRPC | HTTP | 描述 |
|------|------|------|------|
| **API Key** | Metadata | Header | `Authorization: Bearer <token>` |
| **mTLS** | ✅ | ✅ | 双向证书认证 |
| **OAuth2** | Metadata | Header | Bearer token |
| **Basic Auth** | ❌ | Header | `Authorization: Basic <base64>` |

### 7.3 数据隐私

```text
敏感数据处理:
1. SDK层过滤 (AttributeProcessor)
2. Collector层脱敏 (RedactionProcessor)
3. 传输加密 (TLS)
4. 访问控制 (RBAC)

GDPR合规:
- 支持数据最小化
- 支持数据脱敏
- 支持数据删除
- 支持访问日志
```

---

## 8. 性能特性

### 8.1 批处理 (Batching)

```text
批处理策略:
- 时间窗口: 1-10秒 (可配置)
- 批大小: 100-10000 spans (可配置)
- 内存限制: 100MB-1GB (可配置)

效果:
- 减少网络往返次数
- 提高吞吐量 (10-100倍)
- 增加延迟 (秒级)
```

### 8.2 压缩 (Compression)

| 算法 | gRPC | HTTP | 压缩率 | CPU开销 |
|------|------|------|--------|--------|
| **gzip** | ✅ | ✅ | 60-80% | 中等 |
| **zstd** | ✅ | ✅ | 65-85% | 低 |
| **snappy** | ✅ | ❌ | 40-60% | 极低 |
| **无压缩** | ✅ | ✅ | 0% | 无 |

```text
推荐:
- 高吞吐场景: zstd
- 低延迟场景: snappy
- 通用场景: gzip
```

### 8.3 并发控制

```text
并发模型:
- 客户端: 多个导出器并发
- Collector: 多个Pipeline并发
- 后端: 无状态并发处理

并发限制:
- 客户端: 通常1-10个连接
- Collector: 通常100-1000个连接
- 负载均衡: Round-robin/Least-connection
```

---

## 9. 实现要求

### 9.1 客户端要求

```text
必须 (MUST):
✅ 支持gRPC或HTTP/1.1
✅ 支持Protocol Buffers编码
✅ 实现重试和退避
✅ 支持TLS

应该 (SHOULD):
✅ 支持批处理
✅ 支持压缩
✅ 支持认证

可以 (MAY):
✅ 支持多端点负载均衡
✅ 支持本地缓冲
```

### 9.2 服务器要求

```text
必须 (MUST):
✅ 支持gRPC或HTTP/1.1
✅ 正确解析Protocol Buffers
✅ 返回正确的状态码
✅ 支持TLS

应该 (SHOULD):
✅ 支持部分成功响应
✅ 实现限流
✅ 提供健康检查端点

可以 (MAY):
✅ 支持多版本
✅ 提供指标和日志
```

---

## 10. 对比分析

### 10.1 OTLP vs Jaeger Protocol

| 特性 | OTLP | Jaeger |
|------|------|--------|
| **传输** | gRPC/HTTP | gRPC/HTTP/UDP |
| **编码** | Protobuf | Protobuf/Thrift |
| **信号** | Traces/Metrics/Logs | Traces only |
| **标准化** | OpenTelemetry官方 | Jaeger特定 |
| **演进** | 活跃维护 | 逐步迁移到OTLP |

### 10.2 OTLP vs Zipkin Protocol

| 特性 | OTLP | Zipkin |
|------|------|--------|
| **传输** | gRPC/HTTP | HTTP/Kafka/RabbitMQ |
| **编码** | Protobuf | JSON/Protobuf/Thrift |
| **信号** | Traces/Metrics/Logs | Traces only |
| **性能** | 高 (二进制) | 中 (JSON为主) |
| **采用率** | 增长快 | 成熟稳定 |

### 10.3 OTLP vs Prometheus Remote Write

| 特性 | OTLP (Metrics) | Prometheus Remote Write |
|------|---------------|------------------------|
| **协议** | gRPC/HTTP | HTTP |
| **编码** | Protobuf | Snappy压缩Protobuf |
| **数据模型** | OpenTelemetry | Prometheus |
| **信号** | Metrics/Traces/Logs | Metrics only |
| **用途** | 通用可观测性 | Prometheus生态 |

---

## 11. 标准演进路线图

### 11.1 历史版本

```text
Timeline:
2019-05: OTLP初始提案
2020-11: v0.5.0 (Alpha)
2021-07: v0.9.0 (Release Candidate)
2023-02: v1.0.0 (Stable) ← 当前
2024-09: Semantic Conventions v1.27.0
2025-10: 评估时间点
```

### 11.2 未来特性 (Roadmap)

**短期 (2025-2026)**:

- ✅ OTLP Arrow (高性能列式编码)
- ✅ Profiles信号 (从Experimental到Stable)
- ✅ GenAI语义约定扩展

**中期 (2026-2027)**:

- ⏳ OTLP v1.1 (向后兼容的增强)
- ⏳ 更强的压缩算法支持
- ⏳ 原生eBPF支持

**长期 (2027+)**:

- 🔮 OTLP v2.0 (可能的重大更新)
- 🔮 新的信号类型
- 🔮 更多云原生集成

---

## 12. 参考资源

### 12.1 官方资源

- **GitHub仓库**: <https://github.com/open-telemetry/opentelemetry-proto>
- **规范文档**: <https://github.com/open-telemetry/opentelemetry-specification>
- **社区论坛**: <https://github.com/open-telemetry/community>

### 12.2 实现参考

- **Go SDK**: <https://github.com/open-telemetry/opentelemetry-go>
- **Java SDK**: <https://github.com/open-telemetry/opentelemetry-java>
- **Python SDK**: <https://github.com/open-telemetry/opentelemetry-python>
- **Collector**: <https://github.com/open-telemetry/opentelemetry-collector>

### 12.3 学习资源

- **官方文档**: <https://opentelemetry.io/docs/>
- **CNCF博客**: <https://www.cncf.io/blog/tag/opentelemetry/>
- **演讲视频**: KubeCon/CloudNativeCon

---

**文档状态**: ✅ 完成  
**审核状态**: 待审核  
**下一步**: [02_传输层_gRPC.md](./02_传输层_gRPC.md)
