# OpenTelemetry é—®é¢˜è¯Šæ–­å†³ç­–æ ‘æ‰‹å†Œ

> **æœ€åæ›´æ–°**: 2025å¹´10æœˆ8æ—¥  
> **é€‚ç”¨ç‰ˆæœ¬**: OpenTelemetry v1.27.0+  
> **ç”¨é€”**: ç³»ç»ŸåŒ–æ•…éšœè¯Šæ–­ä¸é—®é¢˜è§£å†³

---

## ğŸ“‹ ç›®å½•

- [OpenTelemetry é—®é¢˜è¯Šæ–­å†³ç­–æ ‘æ‰‹å†Œ](#opentelemetry-é—®é¢˜è¯Šæ–­å†³ç­–æ ‘æ‰‹å†Œ)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [ä½¿ç”¨æŒ‡å—](#ä½¿ç”¨æŒ‡å—)
    - [å¦‚ä½•ä½¿ç”¨æœ¬æ‰‹å†Œ](#å¦‚ä½•ä½¿ç”¨æœ¬æ‰‹å†Œ)
    - [ç¬¦å·è¯´æ˜](#ç¬¦å·è¯´æ˜)
  - [å†³ç­–æ ‘æ€»è§ˆ](#å†³ç­–æ ‘æ€»è§ˆ)
  - [1. æ•°æ®æœªä¸ŠæŠ¥é—®é¢˜è¯Šæ–­](#1-æ•°æ®æœªä¸ŠæŠ¥é—®é¢˜è¯Šæ–­)
    - [ç—‡çŠ¶è¯†åˆ«](#ç—‡çŠ¶è¯†åˆ«)
    - [å†³ç­–æ ‘](#å†³ç­–æ ‘)
    - [è¯¦ç»†æ£€æŸ¥æ­¥éª¤](#è¯¦ç»†æ£€æŸ¥æ­¥éª¤)
      - [æ­¥éª¤1: éªŒè¯SDKåˆå§‹åŒ–](#æ­¥éª¤1-éªŒè¯sdkåˆå§‹åŒ–)
      - [æ­¥éª¤2: æ£€æŸ¥Exporteré…ç½®](#æ­¥éª¤2-æ£€æŸ¥exporteré…ç½®)
      - [æ­¥éª¤3: æ£€æŸ¥Collector](#æ­¥éª¤3-æ£€æŸ¥collector)
      - [æ­¥éª¤4: éªŒè¯ç«¯åˆ°ç«¯æµç¨‹](#æ­¥éª¤4-éªŒè¯ç«¯åˆ°ç«¯æµç¨‹)
    - [å¸¸è§è§£å†³æ–¹æ¡ˆ](#å¸¸è§è§£å†³æ–¹æ¡ˆ)
      - [è§£å†³æ–¹æ¡ˆ1: æ­£ç¡®åˆå§‹åŒ–SDK](#è§£å†³æ–¹æ¡ˆ1-æ­£ç¡®åˆå§‹åŒ–sdk)
      - [è§£å†³æ–¹æ¡ˆ2: é‡‡æ ·é…ç½®](#è§£å†³æ–¹æ¡ˆ2-é‡‡æ ·é…ç½®)
      - [è§£å†³æ–¹æ¡ˆ3: Collectoré…ç½®ä¿®å¤](#è§£å†³æ–¹æ¡ˆ3-collectoré…ç½®ä¿®å¤)
      - [è§£å†³æ–¹æ¡ˆ4: åç«¯é…ç½®æ£€æŸ¥](#è§£å†³æ–¹æ¡ˆ4-åç«¯é…ç½®æ£€æŸ¥)
  - [2. æ€§èƒ½é—®é¢˜è¯Šæ–­](#2-æ€§èƒ½é—®é¢˜è¯Šæ–­)
    - [ç—‡çŠ¶è¯†åˆ«2](#ç—‡çŠ¶è¯†åˆ«2)
    - [å†³ç­–æ ‘2](#å†³ç­–æ ‘2)
    - [æ€§èƒ½è¯Šæ–­æ£€æŸ¥æ¸…å•](#æ€§èƒ½è¯Šæ–­æ£€æŸ¥æ¸…å•)
      - [SDKæ€§èƒ½æ£€æŸ¥](#sdkæ€§èƒ½æ£€æŸ¥)
      - [Collectoræ€§èƒ½æ£€æŸ¥](#collectoræ€§èƒ½æ£€æŸ¥)
    - [æ€§èƒ½ä¼˜åŒ–è§£å†³æ–¹æ¡ˆ](#æ€§èƒ½ä¼˜åŒ–è§£å†³æ–¹æ¡ˆ)
      - [è§£å†³æ–¹æ¡ˆ1: SDKæ€§èƒ½ä¼˜åŒ–](#è§£å†³æ–¹æ¡ˆ1-sdkæ€§èƒ½ä¼˜åŒ–)
      - [è§£å†³æ–¹æ¡ˆ2: å†…å­˜ä¼˜åŒ–](#è§£å†³æ–¹æ¡ˆ2-å†…å­˜ä¼˜åŒ–)
      - [è§£å†³æ–¹æ¡ˆ3: Collectorååé‡ä¼˜åŒ–](#è§£å†³æ–¹æ¡ˆ3-collectorååé‡ä¼˜åŒ–)
      - [è§£å†³æ–¹æ¡ˆ4: Collectorå†…å­˜ä¼˜åŒ–](#è§£å†³æ–¹æ¡ˆ4-collectorå†…å­˜ä¼˜åŒ–)
      - [è§£å†³æ–¹æ¡ˆ5: ç½‘ç»œä¼˜åŒ–](#è§£å†³æ–¹æ¡ˆ5-ç½‘ç»œä¼˜åŒ–)
  - [3. è¿æ¥ä¸ç½‘ç»œé—®é¢˜è¯Šæ–­](#3-è¿æ¥ä¸ç½‘ç»œé—®é¢˜è¯Šæ–­)
    - [ç—‡çŠ¶è¯†åˆ«3](#ç—‡çŠ¶è¯†åˆ«3)
    - [å†³ç­–æ ‘3](#å†³ç­–æ ‘3)
    - [è¿æ¥è¯Šæ–­å‘½ä»¤](#è¿æ¥è¯Šæ–­å‘½ä»¤)
    - [è¿æ¥é—®é¢˜è§£å†³æ–¹æ¡ˆ](#è¿æ¥é—®é¢˜è§£å†³æ–¹æ¡ˆ)
      - [è§£å†³æ–¹æ¡ˆ1: é˜²ç«å¢™é…ç½®](#è§£å†³æ–¹æ¡ˆ1-é˜²ç«å¢™é…ç½®)
      - [è§£å†³æ–¹æ¡ˆ2: ç«¯å£é…ç½®](#è§£å†³æ–¹æ¡ˆ2-ç«¯å£é…ç½®)
      - [è§£å†³æ–¹æ¡ˆ3: TLSé…ç½®](#è§£å†³æ–¹æ¡ˆ3-tlsé…ç½®)
      - [è§£å†³æ–¹æ¡ˆ4: åŸºç¡€é…ç½®ä¿®å¤](#è§£å†³æ–¹æ¡ˆ4-åŸºç¡€é…ç½®ä¿®å¤)
  - [4. æ•°æ®è´¨é‡é—®é¢˜è¯Šæ–­](#4-æ•°æ®è´¨é‡é—®é¢˜è¯Šæ–­)
    - [ç—‡çŠ¶è¯†åˆ«4](#ç—‡çŠ¶è¯†åˆ«4)
    - [å†³ç­–æ ‘4](#å†³ç­–æ ‘4)
    - [æ•°æ®è´¨é‡æ£€æŸ¥æ¸…å•](#æ•°æ®è´¨é‡æ£€æŸ¥æ¸…å•)
    - [æ•°æ®è´¨é‡ä¿®å¤æ–¹æ¡ˆ](#æ•°æ®è´¨é‡ä¿®å¤æ–¹æ¡ˆ)
      - [è§£å†³æ–¹æ¡ˆ1: Traceå®Œæ•´æ€§ä¿®å¤](#è§£å†³æ–¹æ¡ˆ1-traceå®Œæ•´æ€§ä¿®å¤)
      - [è§£å†³æ–¹æ¡ˆ2: Contextä¼ æ’­ä¿®å¤](#è§£å†³æ–¹æ¡ˆ2-contextä¼ æ’­ä¿®å¤)
      - [è§£å†³æ–¹æ¡ˆ3: å±æ€§è¡¥å……](#è§£å†³æ–¹æ¡ˆ3-å±æ€§è¡¥å……)
      - [è§£å†³æ–¹æ¡ˆ4: ä½¿ç”¨Processorä¿®å¤å±æ€§](#è§£å†³æ–¹æ¡ˆ4-ä½¿ç”¨processorä¿®å¤å±æ€§)
  - [5. Collectoré—®é¢˜è¯Šæ–­](#5-collectoré—®é¢˜è¯Šæ–­)
  - [å¿«é€Ÿç´¢å¼•](#å¿«é€Ÿç´¢å¼•)
    - [æŒ‰ç—‡çŠ¶æŸ¥æ‰¾](#æŒ‰ç—‡çŠ¶æŸ¥æ‰¾)
    - [æŒ‰ç»„ä»¶æŸ¥æ‰¾](#æŒ‰ç»„ä»¶æŸ¥æ‰¾)
  - [ç›¸å…³æ–‡æ¡£](#ç›¸å…³æ–‡æ¡£)

---

## ä½¿ç”¨æŒ‡å—

### å¦‚ä½•ä½¿ç”¨æœ¬æ‰‹å†Œ

1. **è¯†åˆ«ç—‡çŠ¶** - æ ¹æ®é—®é¢˜è¡¨ç°é€‰æ‹©å¯¹åº”çš„å†³ç­–æ ‘
2. **æŒ‰æ­¥éª¤è¯Šæ–­** - æŒ‰ç…§å†³ç­–æ ‘ä»ä¸Šåˆ°ä¸‹é€æ­¥æ£€æŸ¥
3. **è®°å½•ç»“æœ** - è®°å½•æ¯æ­¥æ£€æŸ¥çš„ç»“æœ
4. **åº”ç”¨è§£å†³æ–¹æ¡ˆ** - æ ¹æ®è¯Šæ–­ç»“æœåº”ç”¨å¯¹åº”çš„è§£å†³æ–¹æ¡ˆ
5. **éªŒè¯ä¿®å¤** - ç¡®è®¤é—®é¢˜å·²è§£å†³

### ç¬¦å·è¯´æ˜

```text
â—† å†³ç­–ç‚¹ - éœ€è¦åˆ¤æ–­æ˜¯/å¦
â–¡ æ£€æŸ¥ç‚¹ - éœ€è¦æ‰§è¡Œæ£€æŸ¥
â†’ ä¸‹ä¸€æ­¥ - å¯¼å‘ä¸‹ä¸€ä¸ªæ­¥éª¤
âœ“ è§£å†³æ–¹æ¡ˆ - é—®é¢˜è§£å†³æ–¹æ³•
âš  æ³¨æ„äº‹é¡¹ - éœ€è¦ç‰¹åˆ«æ³¨æ„çš„ç‚¹
ğŸ“„ å‚è€ƒæ–‡æ¡£ - ç›¸å…³è¯¦ç»†æ–‡æ¡£é“¾æ¥
```

---

## å†³ç­–æ ‘æ€»è§ˆ

| å†³ç­–æ ‘ç¼–å· | é—®é¢˜ç±»åˆ« | å¸¸è§ç—‡çŠ¶ | ä¼˜å…ˆçº§ |
|-----------|---------|---------|--------|
| **1** | æ•°æ®æœªä¸ŠæŠ¥ | åç«¯çœ‹ä¸åˆ°trace/metrics/logs | ğŸ”´ é«˜ |
| **2** | æ€§èƒ½é—®é¢˜ | å»¶è¿Ÿé«˜ã€ååé‡ä½ã€èµ„æºæ¶ˆè€—å¤§ | ğŸŸ¡ ä¸­ |
| **3** | è¿æ¥ä¸ç½‘ç»œ | è¿æ¥è¶…æ—¶ã€è¿æ¥æ‹’ç»ã€TLSé”™è¯¯ | ğŸ”´ é«˜ |
| **4** | æ•°æ®è´¨é‡ | æ•°æ®ä¸å®Œæ•´ã€å±æ€§ç¼ºå¤±ã€ä¹±ç  | ğŸŸ¡ ä¸­ |
| **5** | Collectoré—®é¢˜ | Collectorå´©æºƒã€å†…å­˜æº¢å‡ºã€ä¸¢æ•°æ® | ğŸ”´ é«˜ |
| **6** | SDKé›†æˆ | SDKæŠ¥é”™ã€åˆå§‹åŒ–å¤±è´¥ã€æ•°æ®æ ¼å¼é”™è¯¯ | ğŸŸ¡ ä¸­ |
| **7** | äº‘å¹³å°é›†æˆ | IAMæƒé™ã€ç«¯ç‚¹é…ç½®ã€åŒºåŸŸé—®é¢˜ | ğŸŸ¡ ä¸­ |

---

## 1. æ•°æ®æœªä¸ŠæŠ¥é—®é¢˜è¯Šæ–­

### ç—‡çŠ¶è¯†åˆ«

```text
âœ— åç«¯çœ‹ä¸åˆ°ä»»ä½•trace/metrics/logs
âœ— éƒ¨åˆ†æ•°æ®ä¸¢å¤±
âœ— æ•°æ®å»¶è¿Ÿè¿‡å¤§
```

### å†³ç­–æ ‘

```text
ã€æ•°æ®æœªä¸ŠæŠ¥ã€‘
    â”‚
    â—† åº”ç”¨æœ‰ç”Ÿæˆtraceå—ï¼Ÿ
    â”œâ”€ å¦ â†’
    â”‚     â–¡ æ£€æŸ¥SDKæ˜¯å¦æ­£ç¡®åˆå§‹åŒ–
    â”‚     â–¡ æ£€æŸ¥TracerProvideræ˜¯å¦è®¾ç½®
    â”‚     â–¡ æ£€æŸ¥æ˜¯å¦åˆ›å»ºäº†Tracerå’ŒSpan
    â”‚     âœ“ è§£å†³æ–¹æ¡ˆ1: æ­£ç¡®åˆå§‹åŒ–SDK
    â”‚     ğŸ“„ å‚è€ƒ: [SDKæ¦‚è¿°](./04_æ ¸å¿ƒç»„ä»¶/01_SDKæ¦‚è¿°.md)
    â”‚
    â””â”€ æ˜¯ â†’
          â—† SDKæ˜¯å¦å°è¯•å¯¼å‡ºï¼Ÿ
          â”œâ”€ å¦ â†’
          â”‚     â–¡ æ£€æŸ¥Exporteræ˜¯å¦é…ç½®
          â”‚     â–¡ æ£€æŸ¥é‡‡æ ·é…ç½®(sampler)
          â”‚     â–¡ æ£€æŸ¥æ˜¯å¦è°ƒç”¨shutdown()
          â”‚     âœ“ è§£å†³æ–¹æ¡ˆ2: é…ç½®Exporterå’Œé‡‡æ ·
          â”‚     ğŸ“„ å‚è€ƒ: [é‡‡æ ·ç­–ç•¥](./05_é‡‡æ ·ä¸æ€§èƒ½/01_é‡‡æ ·ç­–ç•¥.md)
          â”‚
          â””â”€ æ˜¯ â†’
                â—† SDKå¯¼å‡ºæ—¶æœ‰é”™è¯¯å—ï¼Ÿ
                â”œâ”€ æ˜¯ â†’
                â”‚     â–¡ æ£€æŸ¥æ—¥å¿—ä¸­çš„å¯¼å‡ºé”™è¯¯
                â”‚     â–¡ æ£€æŸ¥ç½‘ç»œè¿æ¥
                â”‚     â–¡ æ£€æŸ¥ç«¯ç‚¹é…ç½®
                â”‚     â””â†’ è½¬ã€è¿æ¥ä¸ç½‘ç»œé—®é¢˜è¯Šæ–­ã€‘
                â”‚
                â””â”€ å¦ â†’
                      â—† Collectoræ”¶åˆ°æ•°æ®äº†å—ï¼Ÿ
                      â”œâ”€ å¦ â†’
                      â”‚     â–¡ æ£€æŸ¥Collectoræ˜¯å¦è¿è¡Œ
                      â”‚     â–¡ æ£€æŸ¥Collectorç«¯ç‚¹é…ç½®
                      â”‚     â–¡ æ£€æŸ¥é˜²ç«å¢™/å®‰å…¨ç»„
                      â”‚     âœ“ è§£å†³æ–¹æ¡ˆ3: ä¿®å¤Collectoré…ç½®
                      â”‚     ğŸ“„ å‚è€ƒ: [Collectoré…ç½®](./04_æ ¸å¿ƒç»„ä»¶/06_Collectorç”Ÿäº§ç¯å¢ƒå®Œæ•´é…ç½®ç¤ºä¾‹.md)
                      â”‚
                      â””â”€ æ˜¯ â†’
                            â—† CollectoræˆåŠŸå¯¼å‡ºäº†å—ï¼Ÿ
                            â”œâ”€ å¦ â†’
                            â”‚     â–¡ æ£€æŸ¥Collectoræ—¥å¿—
                            â”‚     â–¡ æ£€æŸ¥åç«¯è¿æ¥
                            â”‚     â–¡ æ£€æŸ¥exporteré…ç½®
                            â”‚     â””â†’ è½¬ã€Collectoré—®é¢˜è¯Šæ–­ã€‘
                            â”‚
                            â””â”€ æ˜¯ â†’
                                  â—† åç«¯é…ç½®æ­£ç¡®å—ï¼Ÿ
                                  â””â”€ æ£€æŸ¥åç«¯æ—¥å¿—
                                     æ£€æŸ¥æ•°æ®ä¿ç•™ç­–ç•¥
                                     æ£€æŸ¥æŸ¥è¯¢æ¡ä»¶
                                     âœ“ è§£å†³æ–¹æ¡ˆ4: ä¿®å¤åç«¯é…ç½®
```

### è¯¦ç»†æ£€æŸ¥æ­¥éª¤

#### æ­¥éª¤1: éªŒè¯SDKåˆå§‹åŒ–

**Goç¤ºä¾‹**:

```go
// æ£€æŸ¥TracerProvideræ˜¯å¦è®¾ç½®
tp := otel.GetTracerProvider()
if tp == nil || reflect.TypeOf(tp).String() == "*global.tracerProvider" {
    log.Fatal("TracerProvideræœªæ­£ç¡®è®¾ç½®")
}

// å¯ç”¨è°ƒè¯•æ—¥å¿—
otel.SetLogger(logr.New(logSink).WithName("otel"))
otel.SetErrorHandler(otel.ErrorHandlerFunc(func(err error) {
    log.Printf("OTEL Error: %v", err)
}))
```

**Pythonç¤ºä¾‹**:

```python
from opentelemetry import trace

# æ£€æŸ¥TracerProvider
tracer_provider = trace.get_tracer_provider()
print(f"TracerProvider: {type(tracer_provider)}")

# å¯ç”¨è°ƒè¯•æ—¥å¿—
import logging
logging.basicConfig(level=logging.DEBUG)
```

**æ£€æŸ¥æ¸…å•**:

```text
â–¡ TracerProviderå·²åˆ›å»ºå¹¶è®¾ç½®
â–¡ Exporterå·²æ·»åŠ åˆ°TracerProvider
â–¡ Resourceå±æ€§å·²é…ç½®(service.nameç­‰)
â–¡ é‡‡æ ·å™¨å·²é…ç½®
â–¡ Spanå·²æ­£ç¡®åˆ›å»ºå’Œç»“æŸ
```

#### æ­¥éª¤2: æ£€æŸ¥Exporteré…ç½®

```bash
# ç¯å¢ƒå˜é‡æ£€æŸ¥
echo $OTEL_EXPORTER_OTLP_ENDPOINT
echo $OTEL_EXPORTER_OTLP_PROTOCOL

# æµ‹è¯•ç«¯ç‚¹è¿é€šæ€§
curl http://${OTEL_EXPORTER_OTLP_ENDPOINT}/v1/traces

# æ£€æŸ¥å¯¼å‡ºæ—¥å¿—(å¯ç”¨debug)
export OTEL_LOG_LEVEL=debug
```

#### æ­¥éª¤3: æ£€æŸ¥Collector

```bash
# æ£€æŸ¥Collectorè¿è¡ŒçŠ¶æ€
curl http://localhost:13133/

# æ£€æŸ¥Collector metrics
curl http://localhost:8888/metrics | grep -E "(receiver_accepted|exporter_sent|refused)"

# æŸ¥çœ‹Collectoræ—¥å¿—
kubectl logs -f deployment/otel-collector | grep -i error
```

**å…³é”®æŒ‡æ ‡**:

```text
otelcol_receiver_accepted_spans > 0   # æ”¶åˆ°æ•°æ®
otelcol_receiver_refused_spans = 0    # æ— æ‹’ç»
otelcol_exporter_sent_spans > 0       # æˆåŠŸå¯¼å‡º
otelcol_exporter_send_failed_spans = 0 # æ— å¤±è´¥
```

#### æ­¥éª¤4: éªŒè¯ç«¯åˆ°ç«¯æµç¨‹

**ä½¿ç”¨telemetrygenç”Ÿæˆæµ‹è¯•æ•°æ®**:

```bash
# ç”Ÿæˆæµ‹è¯•trace
docker run --rm -it ghcr.io/open-telemetry/opentelemetry-collector-contrib/telemetrygen:latest \
    traces --otlp-insecure --otlp-endpoint localhost:4317 --traces 10

# åœ¨åç«¯æŸ¥è¯¢
# Jaeger: http://localhost:16686
# Tempo: tempo-query:3100
```

### å¸¸è§è§£å†³æ–¹æ¡ˆ

#### è§£å†³æ–¹æ¡ˆ1: æ­£ç¡®åˆå§‹åŒ–SDK

```go
package main

import (
    "context"
    "log"

    "go.opentelemetry.io/otel"
    "go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracehttp"
    "go.opentelemetry.io/otel/sdk/resource"
    sdktrace "go.opentelemetry.io/otel/sdk/trace"
    semconv "go.opentelemetry.io/otel/semconv/v1.21.0"
)

func initTracer() func() {
    ctx := context.Background()

    // 1. åˆ›å»ºExporter
    exporter, err := otlptracehttp.New(ctx,
        otlptracehttp.WithEndpoint("localhost:4318"),
        otlptracehttp.WithInsecure(),
    )
    if err != nil {
        log.Fatal(err)
    }

    // 2. åˆ›å»ºResource
    res, err := resource.New(ctx,
        resource.WithAttributes(
            semconv.ServiceName("my-service"),
            semconv.ServiceVersion("1.0.0"),
        ),
    )
    if err != nil {
        log.Fatal(err)
    }

    // 3. åˆ›å»ºTracerProvider
    tp := sdktrace.NewTracerProvider(
        sdktrace.WithBatcher(exporter),
        sdktrace.WithResource(res),
        sdktrace.WithSampler(sdktrace.AlwaysOn()),
    )

    // 4. è®¾ç½®å…¨å±€TracerProvider
    otel.SetTracerProvider(tp)

    // è¿”å›cleanupå‡½æ•°
    return func() {
        if err := tp.Shutdown(ctx); err != nil {
            log.Printf("Error shutting down tracer provider: %v", err)
        }
    }
}

func main() {
    cleanup := initTracer()
    defer cleanup()

    // ä½¿ç”¨tracer
    tracer := otel.Tracer("my-app")
    ctx, span := tracer.Start(context.Background(), "main")
    defer span.End()

    // ä¸šåŠ¡é€»è¾‘...
}
```

#### è§£å†³æ–¹æ¡ˆ2: é‡‡æ ·é…ç½®

**ç”Ÿäº§ç¯å¢ƒé‡‡æ ·é…ç½®**:

```go
// 10%é‡‡æ ·ç‡
sampler := sdktrace.ParentBased(
    sdktrace.TraceIDRatioBased(0.1),
)

tp := sdktrace.NewTracerProvider(
    sdktrace.WithSampler(sampler),
    // ... å…¶ä»–é…ç½®
)
```

**ç¯å¢ƒå˜é‡æ–¹å¼**:

```bash
export OTEL_TRACES_SAMPLER=parentbased_traceidratio
export OTEL_TRACES_SAMPLER_ARG=0.1
```

#### è§£å†³æ–¹æ¡ˆ3: Collectoré…ç½®ä¿®å¤

**æœ€å°å¯ç”¨Collectoré…ç½®**:

```yaml
receivers:
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        endpoint: 0.0.0.0:4318

processors:
  batch:

exporters:
  logging:
    loglevel: debug
  otlp:
    endpoint: jaeger:4317
    tls:
      insecure: true

service:
  pipelines:
    traces:
      receivers: [otlp]
      processors: [batch]
      exporters: [logging, otlp]  # loggingç”¨äºè°ƒè¯•
```

#### è§£å†³æ–¹æ¡ˆ4: åç«¯é…ç½®æ£€æŸ¥

**Jaegeræ£€æŸ¥**:

```bash
# æ£€æŸ¥Jaegerè¿è¡ŒçŠ¶æ€
curl http://localhost:16686/api/services

# æ£€æŸ¥æ•°æ®ä¿ç•™
# æŸ¥çœ‹Jaegeré…ç½®ä¸­çš„ --span-storage.cassandra.max-traces-ttl
```

**Tempoæ£€æŸ¥**:

```yaml
# tempo.yaml
storage:
  trace:
    backend: local
    local:
      path: /tmp/tempo/traces
    wal:
      path: /tmp/tempo/wal

# æ£€æŸ¥å­˜å‚¨è·¯å¾„
ls -lh /tmp/tempo/traces
```

---

## 2. æ€§èƒ½é—®é¢˜è¯Šæ–­

### ç—‡çŠ¶è¯†åˆ«2

```text
âœ— åº”ç”¨å»¶è¿Ÿå¢åŠ 
âœ— CPU/å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜
âœ— Collectorååé‡ä¸è¶³
âœ— æ•°æ®å¯¼å‡ºå»¶è¿Ÿå¤§
```

### å†³ç­–æ ‘2

```text
ã€æ€§èƒ½é—®é¢˜ã€‘
    â”‚
    â—† é—®é¢˜å‘ç”Ÿåœ¨å“ªé‡Œï¼Ÿ
    â”œâ”€ SDKå±‚ â†’
    â”‚     â—† CPUä½¿ç”¨ç‡é«˜ï¼Ÿ
    â”‚     â”œâ”€ æ˜¯ â†’
    â”‚     â”‚     â–¡ æ£€æŸ¥é‡‡æ ·ç‡é…ç½®
    â”‚     â”‚     â–¡ æ£€æŸ¥Spanåˆ›å»ºé¢‘ç‡
    â”‚     â”‚     â–¡ æ£€æŸ¥å±æ€§æ•°é‡
    â”‚     â”‚     âœ“ è§£å†³æ–¹æ¡ˆ1: SDKæ€§èƒ½ä¼˜åŒ–
    â”‚     â”‚
    â”‚     â””â”€ å†…å­˜ä½¿ç”¨ç‡é«˜ï¼Ÿ
    â”‚           â–¡ æ£€æŸ¥é˜Ÿåˆ—å¤§å°é…ç½®
    â”‚           â–¡ æ£€æŸ¥æ‰¹å¤„ç†é…ç½®
    â”‚           â–¡ æ£€æŸ¥å¯¼å‡ºé¢‘ç‡
    â”‚           âœ“ è§£å†³æ–¹æ¡ˆ2: å†…å­˜ä¼˜åŒ–
    â”‚
    â”œâ”€ Collectorå±‚ â†’
    â”‚     â—† ååé‡ä¸è¶³ï¼Ÿ
    â”‚     â”œâ”€ æ˜¯ â†’
    â”‚     â”‚     â–¡ æ£€æŸ¥batch processoré…ç½®
    â”‚     â”‚     â–¡ æ£€æŸ¥å¹¶å‘å¯¼å‡ºæ•°
    â”‚     â”‚     â–¡ æ£€æŸ¥èµ„æºé™åˆ¶
    â”‚     â”‚     âœ“ è§£å†³æ–¹æ¡ˆ3: Collectoræ€§èƒ½ä¼˜åŒ–
    â”‚     â”‚
    â”‚     â””â”€ å†…å­˜æº¢å‡ºï¼Ÿ
    â”‚           â–¡ æ£€æŸ¥memory_limiteré…ç½®
    â”‚           â–¡ æ£€æŸ¥é˜Ÿåˆ—å¤§å°
    â”‚           â–¡ æ£€æŸ¥æ•°æ®å †ç§¯
    â”‚           âœ“ è§£å†³æ–¹æ¡ˆ4: Collectorå†…å­˜ä¼˜åŒ–
    â”‚
    â””â”€ ç½‘ç»œå±‚ â†’
          â–¡ æ£€æŸ¥å¸¦å®½ä½¿ç”¨
          â–¡ æ£€æŸ¥å‹ç¼©é…ç½®
          â–¡ æ£€æŸ¥åè®®é€‰æ‹©(gRPC vs HTTP)
          âœ“ è§£å†³æ–¹æ¡ˆ5: ç½‘ç»œä¼˜åŒ–
```

### æ€§èƒ½è¯Šæ–­æ£€æŸ¥æ¸…å•

#### SDKæ€§èƒ½æ£€æŸ¥

```text
â–¡ é‡‡æ ·ç‡åˆç†(ç”Ÿäº§ç¯å¢ƒ1-10%)
â–¡ æ‰¹å¤„ç†å·²å¯ç”¨
  - batch_timeout: 5s
  - max_export_batch_size: 512
  - max_queue_size: 2048
â–¡ å¼‚æ­¥å¯¼å‡º(ä¸é˜»å¡ä¸šåŠ¡)
â–¡ å‹ç¼©å·²å¯ç”¨(gzip)
â–¡ Spanå±æ€§æ•°é‡åˆç†(< 20ä¸ª)
â–¡ é¿å…é«˜é¢‘Span(< 1000/s per instance)
```

#### Collectoræ€§èƒ½æ£€æŸ¥

```text
â–¡ Batch Processoré…ç½®
  - send_batch_size: 8192
  - timeout: 200ms
  - send_batch_max_size: 10000
â–¡ å¹¶å‘å¯¼å‡ºé…ç½®
  - sending_queue.num_consumers: 10
â–¡ å†…å­˜é™åˆ¶å™¨
  - limit_mib: 1500 (å®¹å™¨2GBæ—¶)
  - check_interval: 1s
â–¡ èµ„æºåˆ†é…å……è¶³
  - CPU: è‡³å°‘2 cores
  - Memory: è‡³å°‘2GB
â–¡ æŒä¹…åŒ–é˜Ÿåˆ—(é«˜å¯ç”¨åœºæ™¯)
```

### æ€§èƒ½ä¼˜åŒ–è§£å†³æ–¹æ¡ˆ

#### è§£å†³æ–¹æ¡ˆ1: SDKæ€§èƒ½ä¼˜åŒ–

```go
// ä¼˜åŒ–çš„SDKé…ç½®
exporter, _ := otlptracehttp.New(ctx,
    otlptracehttp.WithCompression(otlptracehttp.GzipCompression), // å¯ç”¨å‹ç¼©
    otlptracehttp.WithTimeout(10*time.Second),
)

tp := sdktrace.NewTracerProvider(
    // ä¼˜åŒ–çš„æ‰¹å¤„ç†é…ç½®
    sdktrace.WithBatcher(exporter,
        sdktrace.WithBatchTimeout(5*time.Second),        // 5ç§’æ‰¹å¤„ç†
        sdktrace.WithMaxExportBatchSize(512),            // æ‰¹æ¬¡å¤§å°512
        sdktrace.WithMaxQueueSize(2048),                 // é˜Ÿåˆ—2048
    ),
    // åˆç†é‡‡æ ·ç‡
    sdktrace.WithSampler(sdktrace.ParentBased(
        sdktrace.TraceIDRatioBased(0.01), // 1%é‡‡æ ·
    )),
    sdktrace.WithResource(res),
)
```

#### è§£å†³æ–¹æ¡ˆ2: å†…å­˜ä¼˜åŒ–

```go
// æ§åˆ¶é˜Ÿåˆ—å¤§å°
tp := sdktrace.NewTracerProvider(
    sdktrace.WithBatcher(exporter,
        sdktrace.WithMaxQueueSize(1024),  // å‡å°é˜Ÿåˆ—
        sdktrace.WithExportTimeout(5*time.Second), // å‡å°‘è¶…æ—¶
    ),
)

// å®šæœŸå¼ºåˆ¶GC (ä»…åœ¨å¿…è¦æ—¶)
import "runtime"
runtime.GC()
```

#### è§£å†³æ–¹æ¡ˆ3: Collectorååé‡ä¼˜åŒ–

```yaml
processors:
  batch:
    # ä¼˜åŒ–æ‰¹å¤„ç†
    timeout: 200ms
    send_batch_size: 8192
    send_batch_max_size: 10000

  # é™æµä¿æŠ¤
  memory_limiter:
    check_interval: 1s
    limit_mib: 1500
    spike_limit_mib: 512

exporters:
  otlp:
    endpoint: backend:4317
    # ä¼˜åŒ–å¹¶å‘å¯¼å‡º
    sending_queue:
      enabled: true
      num_consumers: 10
      queue_size: 5000
    # é‡è¯•é…ç½®
    retry_on_failure:
      enabled: true
      initial_interval: 1s
      max_interval: 30s
      max_elapsed_time: 5m
```

#### è§£å†³æ–¹æ¡ˆ4: Collectorå†…å­˜ä¼˜åŒ–

```yaml
extensions:
  memory_ballast:
    size_mib: 512  # é¢„åˆ†é…å†…å­˜

processors:
  memory_limiter:
    check_interval: 1s
    limit_mib: 1500      # å®¹å™¨2GBæ—¶ï¼Œè®¾ç½®ä¸º75%
    spike_limit_mib: 512

receivers:
  otlp:
    protocols:
      grpc:
        max_recv_msg_size_mib: 4
```

**Kubernetesèµ„æºé™åˆ¶**:

```yaml
resources:
  requests:
    cpu: 500m
    memory: 1Gi
  limits:
    cpu: 1000m
    memory: 2Gi
```

#### è§£å†³æ–¹æ¡ˆ5: ç½‘ç»œä¼˜åŒ–

```yaml
receivers:
  otlp:
    protocols:
      grpc:
        max_recv_msg_size_mib: 4
        max_concurrent_streams: 100
        # å¯ç”¨å‹ç¼©
        compression: gzip

exporters:
  otlp:
    # ä½¿ç”¨gRPC (æ€§èƒ½æœ€ä½³)
    endpoint: backend:4317
    compression: gzip
    # è¿æ¥æ± 
    balancer_name: round_robin
```

**SDKç«¯ä½¿ç”¨gRPC**:

```go
import "go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracegrpc"

exporter, _ := otlptracegrpc.New(ctx,
    otlptracegrpc.WithEndpoint("collector:4317"),
    otlptracegrpc.WithInsecure(),
    otlptracegrpc.WithCompressor("gzip"),
)
```

---

## 3. è¿æ¥ä¸ç½‘ç»œé—®é¢˜è¯Šæ–­

### ç—‡çŠ¶è¯†åˆ«3

```text
âœ— connection refused
âœ— connection timeout
âœ— TLS handshake failed
âœ— DNS resolution failed
```

### å†³ç­–æ ‘3

```text
ã€è¿æ¥é—®é¢˜ã€‘
    â”‚
    â—† èƒ½pingé€šç›®æ ‡ä¸»æœºå—ï¼Ÿ
    â”œâ”€ å¦ â†’
    â”‚     â–¡ æ£€æŸ¥ç½‘ç»œè¿é€šæ€§
    â”‚     â–¡ æ£€æŸ¥é˜²ç«å¢™è§„åˆ™
    â”‚     â–¡ æ£€æŸ¥å®‰å…¨ç»„é…ç½®
    â”‚     âœ“ è§£å†³æ–¹æ¡ˆ1: ä¿®å¤ç½‘ç»œé…ç½®
    â”‚
    â””â”€ æ˜¯ â†’
          â—† ç«¯å£æ˜¯å¦å¼€æ”¾ï¼Ÿ
          â”œâ”€ å¦ â†’
          â”‚     â–¡ ä½¿ç”¨telnet/ncæµ‹è¯•ç«¯å£
          â”‚     â–¡ æ£€æŸ¥æœåŠ¡æ˜¯å¦ç›‘å¬
          â”‚     â–¡ æ£€æŸ¥ç«¯å£é…ç½®
          â”‚     âœ“ è§£å†³æ–¹æ¡ˆ2: ä¿®å¤ç«¯å£é…ç½®
          â”‚
          â””â”€ æ˜¯ â†’
                â—† ä½¿ç”¨TLSå—ï¼Ÿ
                â”œâ”€ æ˜¯ â†’
                â”‚     â—† TLSæ¡æ‰‹æˆåŠŸï¼Ÿ
                â”‚     â”œâ”€ å¦ â†’
                â”‚     â”‚     â–¡ æ£€æŸ¥è¯ä¹¦æœ‰æ•ˆæ€§
                â”‚     â”‚     â–¡ æ£€æŸ¥è¯ä¹¦é“¾å®Œæ•´æ€§
                â”‚     â”‚     â–¡ æ£€æŸ¥åŸŸååŒ¹é…
                â”‚     â”‚     â””â†’ è½¬ã€TLSé—®é¢˜è¯Šæ–­ã€‘
                â”‚     â”‚
                â”‚     â””â”€ æ˜¯ â†’
                â”‚           â–¡ æ£€æŸ¥è®¤è¯é…ç½®
                â”‚           â–¡ æ£€æŸ¥æˆæƒç­–ç•¥
                â”‚           âœ“ è§£å†³æ–¹æ¡ˆ3: ä¿®å¤è®¤è¯é…ç½®
                â”‚
                â””â”€ å¦ â†’
                      â–¡ æ£€æŸ¥DNSè§£æ
                      â–¡ æ£€æŸ¥ç«¯ç‚¹URLæ ¼å¼
                      â–¡ æ£€æŸ¥åè®®åŒ¹é…(gRPC vs HTTP)
                      âœ“ è§£å†³æ–¹æ¡ˆ4: ä¿®å¤åŸºç¡€é…ç½®
```

### è¿æ¥è¯Šæ–­å‘½ä»¤

```bash
# 1. ç½‘ç»œè¿é€šæ€§æµ‹è¯•
ping collector.example.com

# 2. ç«¯å£è¿é€šæ€§æµ‹è¯•
telnet collector.example.com 4317
nc -zv collector.example.com 4317

# 3. DNSè§£ææµ‹è¯•
nslookup collector.example.com
dig collector.example.com

# 4. TLSè¿æ¥æµ‹è¯•
openssl s_client -connect collector.example.com:4317 -servername collector.example.com

# 5. HTTPç«¯ç‚¹æµ‹è¯•
curl -v http://collector.example.com:4318/

# 6. gRPCå¥åº·æ£€æŸ¥
grpcurl -plaintext collector.example.com:4317 list
```

### è¿æ¥é—®é¢˜è§£å†³æ–¹æ¡ˆ

#### è§£å†³æ–¹æ¡ˆ1: é˜²ç«å¢™é…ç½®

**Linux iptables**:

```bash
# å…è®¸OTLPç«¯å£
sudo iptables -A INPUT -p tcp --dport 4317 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 4318 -j ACCEPT

# ä¿å­˜è§„åˆ™
sudo iptables-save > /etc/iptables/rules.v4
```

**AWSå®‰å…¨ç»„**:

```bash
# æ·»åŠ å…¥ç«™è§„åˆ™
aws ec2 authorize-security-group-ingress \
    --group-id sg-xxxxxxxxx \
    --protocol tcp \
    --port 4317 \
    --cidr 0.0.0.0/0
```

**Kubernetes NetworkPolicy**:

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-otlp
spec:
  podSelector:
    matchLabels:
      app: otel-collector
  ingress:
  - from:
    - podSelector: {}
    ports:
    - protocol: TCP
      port: 4317
    - protocol: TCP
      port: 4318
```

#### è§£å†³æ–¹æ¡ˆ2: ç«¯å£é…ç½®

**æ£€æŸ¥Collectorç›‘å¬**:

```bash
# æ£€æŸ¥ç«¯å£ç›‘å¬
netstat -tlnp | grep 4317
ss -tlnp | grep 4317

# æ£€æŸ¥è¿›ç¨‹
ps aux | grep otelcol
```

**Collectoré…ç½®**:

```yaml
receivers:
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317  # ç›‘å¬æ‰€æœ‰æ¥å£
      http:
        endpoint: 0.0.0.0:4318
```

**Kubernetes Service**:

```yaml
apiVersion: v1
kind: Service
metadata:
  name: otel-collector
spec:
  type: ClusterIP  # æˆ– LoadBalancer
  ports:
  - name: otlp-grpc
    port: 4317
    targetPort: 4317
    protocol: TCP
  - name: otlp-http
    port: 4318
    targetPort: 4318
    protocol: TCP
  selector:
    app: otel-collector
```

#### è§£å†³æ–¹æ¡ˆ3: TLSé…ç½®

**ç”Ÿæˆè‡ªç­¾åè¯ä¹¦(æµ‹è¯•ç”¨)**:

```bash
# ç”ŸæˆCA
openssl genrsa -out ca.key 2048
openssl req -new -x509 -days 365 -key ca.key -out ca.crt \
    -subj "/CN=OpenTelemetry CA"

# ç”ŸæˆæœåŠ¡å™¨è¯ä¹¦
openssl genrsa -out server.key 2048
openssl req -new -key server.key -out server.csr \
    -subj "/CN=collector.example.com"
openssl x509 -req -in server.csr -CA ca.crt -CAkey ca.key \
    -CAcreateserial -out server.crt -days 365
```

**Collector TLSé…ç½®**:

```yaml
receivers:
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
        tls:
          cert_file: /etc/otel/server.crt
          key_file: /etc/otel/server.key
          client_ca_file: /etc/otel/ca.crt  # mTLS
```

**SDK TLSé…ç½® (Go)**:

```go
import (
    "crypto/tls"
    "crypto/x509"
    "io/ioutil"
    "google.golang.org/grpc/credentials"
)

// åŠ è½½CAè¯ä¹¦
caCert, _ := ioutil.ReadFile("/etc/otel/ca.crt")
caCertPool := x509.NewCertPool()
caCertPool.AppendCertsFromPEM(caCert)

// åˆ›å»ºTLSé…ç½®
tlsConfig := &tls.Config{
    RootCAs: caCertPool,
    ServerName: "collector.example.com",
}

// åˆ›å»ºexporter
exporter, _ := otlptracegrpc.New(ctx,
    otlptracegrpc.WithEndpoint("collector.example.com:4317"),
    otlptracegrpc.WithTLSCredentials(credentials.NewTLS(tlsConfig)),
)
```

#### è§£å†³æ–¹æ¡ˆ4: åŸºç¡€é…ç½®ä¿®å¤

**ç«¯ç‚¹æ ¼å¼æ£€æŸ¥**:

```bash
# æ­£ç¡®æ ¼å¼
OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4318       # HTTP
OTEL_EXPORTER_OTLP_ENDPOINT=localhost:4317              # gRPC

# é”™è¯¯æ ¼å¼
OTEL_EXPORTER_OTLP_ENDPOINT=grpc://localhost:4317       # âœ— ä¸éœ€è¦åè®®å‰ç¼€
OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4317       # âœ— gRPCä¸éœ€è¦http://
```

**DNSè§£æä¿®å¤**:

```bash
# /etc/hosts
127.0.0.1   localhost
10.0.1.100  otel-collector

# Kubernetes DNS
otel-collector.default.svc.cluster.local
```

---

## 4. æ•°æ®è´¨é‡é—®é¢˜è¯Šæ–­

### ç—‡çŠ¶è¯†åˆ«4

```text
âœ— Traceä¸å®Œæ•´(ç¼ºå°‘span)
âœ— å±æ€§ç¼ºå¤±æˆ–é”™è¯¯
âœ— æ—¶é—´æˆ³å¼‚å¸¸
âœ— Traceæ–­é“¾
```

### å†³ç­–æ ‘4

```text
ã€æ•°æ®è´¨é‡é—®é¢˜ã€‘
    â”‚
    â—† Traceå®Œæ•´å—ï¼Ÿ
    â”œâ”€ å¦ â†’
    â”‚     â—† éƒ¨åˆ†Spanä¸¢å¤±ï¼Ÿ
    â”‚     â”œâ”€ æ˜¯ â†’
    â”‚     â”‚     â–¡ æ£€æŸ¥é‡‡æ ·é…ç½®
    â”‚     â”‚     â–¡ æ£€æŸ¥Contextä¼ æ’­
    â”‚     â”‚     â–¡ æ£€æŸ¥Spanæ˜¯å¦æ­£ç¡®å…³é—­
    â”‚     â”‚     âœ“ è§£å†³æ–¹æ¡ˆ1: ä¿®å¤Traceå®Œæ•´æ€§
    â”‚     â”‚
    â”‚     â””â”€ Traceæ–­é“¾ï¼Ÿ
    â”‚           â–¡ æ£€æŸ¥Propagatoré…ç½®
    â”‚           â–¡ æ£€æŸ¥è·¨æœåŠ¡ä¼ æ’­
    â”‚           â–¡ æ£€æŸ¥å¼‚æ­¥è°ƒç”¨å¤„ç†
    â”‚           âœ“ è§£å†³æ–¹æ¡ˆ2: ä¿®å¤Contextä¼ æ’­
    â”‚
    â””â”€ å±æ€§æ­£ç¡®å—ï¼Ÿ
          â—† å±æ€§ç¼ºå¤±ï¼Ÿ
          â”œâ”€ æ˜¯ â†’
          â”‚     â–¡ æ£€æŸ¥SDKç‰ˆæœ¬
          â”‚     â–¡ æ£€æŸ¥Semantic Conventions
          â”‚     â–¡ æ£€æŸ¥è‡ªå®šä¹‰å±æ€§è®¾ç½®
          â”‚     âœ“ è§£å†³æ–¹æ¡ˆ3: è¡¥å……å±æ€§
          â”‚
          â””â”€ å±æ€§å€¼é”™è¯¯ï¼Ÿ
                â–¡ æ£€æŸ¥å±æ€§ç±»å‹
                â–¡ æ£€æŸ¥å±æ€§è½¬æ¢
                â–¡ æ£€æŸ¥Processoré…ç½®
                âœ“ è§£å†³æ–¹æ¡ˆ4: ä¿®å¤å±æ€§å€¼
```

### æ•°æ®è´¨é‡æ£€æŸ¥æ¸…å•

```text
â–¡ Traceå®Œæ•´æ€§
  â–¡ æ‰€æœ‰é¢„æœŸSpanéƒ½å­˜åœ¨
  â–¡ Parent-Childå…³ç³»æ­£ç¡®
  â–¡ Root Spanå­˜åœ¨
  â–¡ SpanID/TraceIDæœ‰æ•ˆ

â–¡ å±æ€§å®Œæ•´æ€§
  â–¡ å¿…éœ€çš„Resourceå±æ€§(service.nameç­‰)
  â–¡ HTTP/gRPC/DBç­‰åè®®å±æ€§
  â–¡ è‡ªå®šä¹‰ä¸šåŠ¡å±æ€§
  â–¡ å±æ€§ç±»å‹æ­£ç¡®

â–¡ æ—¶é—´æˆ³å‡†ç¡®æ€§
  â–¡ Spanå¼€å§‹æ—¶é—´ < ç»“æŸæ—¶é—´
  â–¡ Child Spanæ—¶é—´åœ¨ParentèŒƒå›´å†…
  â–¡ æ—¶é—´æˆ³å•ä½æ­£ç¡®(çº³ç§’)

â–¡ Contextä¼ æ’­
  â–¡ TraceIDåœ¨æ•´ä¸ªé“¾è·¯ä¿æŒä¸€è‡´
  â–¡ Baggageæ­£ç¡®ä¼ æ’­
  â–¡ Propagatoré…ç½®æ­£ç¡®
```

### æ•°æ®è´¨é‡ä¿®å¤æ–¹æ¡ˆ

#### è§£å†³æ–¹æ¡ˆ1: Traceå®Œæ•´æ€§ä¿®å¤

**ç¡®ä¿æ‰€æœ‰Spanæ­£ç¡®åˆ›å»ºå’Œå…³é—­**:

```go
func processRequest(ctx context.Context) error {
    tracer := otel.Tracer("my-service")
    
    // åˆ›å»ºSpan
    ctx, span := tracer.Start(ctx, "processRequest")
    defer span.End()  // âœ“ ç¡®ä¿è°ƒç”¨End()
    
    // å­æ“ä½œ
    if err := subOperation(ctx); err != nil {
        span.RecordError(err)  // âœ“ è®°å½•é”™è¯¯
        span.SetStatus(codes.Error, err.Error())
        return err
    }
    
    return nil
}
```

**å¼‚æ­¥æ“ä½œçš„Spanå¤„ç†**:

```go
func asyncOperation(ctx context.Context) {
    tracer := otel.Tracer("my-service")
    ctx, span := tracer.Start(ctx, "asyncOperation")
    
    go func() {
        defer span.End()  // âœ“ åœ¨goroutineä¸­End
        
        // å¼‚æ­¥é€»è¾‘...
    }()
}
```

#### è§£å†³æ–¹æ¡ˆ2: Contextä¼ æ’­ä¿®å¤

**HTTPæœåŠ¡ç«¯**:

```go
import (
    "go.opentelemetry.io/contrib/instrumentation/net/http/otelhttp"
)

// è‡ªåŠ¨ä¼ æ’­Context
http.Handle("/api", otelhttp.NewHandler(
    http.HandlerFunc(apiHandler),
    "api",
))
```

**HTTPå®¢æˆ·ç«¯**:

```go
import (
    "go.opentelemetry.io/otel/propagation"
    "go.opentelemetry.io/contrib/instrumentation/net/http/otelhttp"
)

// é…ç½®Propagator
otel.SetTextMapPropagator(propagation.NewCompositeTextMapPropagator(
    propagation.TraceContext{},
    propagation.Baggage{},
))

// ä½¿ç”¨instrumented client
client := http.Client{
    Transport: otelhttp.NewTransport(http.DefaultTransport),
}

req, _ := http.NewRequestWithContext(ctx, "GET", url, nil)
resp, _ := client.Do(req)  // Contextè‡ªåŠ¨ä¼ æ’­
```

**gRPCä¼ æ’­**:

```go
import (
    "go.opentelemetry.io/contrib/instrumentation/google.golang.org/grpc/otelgrpc"
)

// gRPC Server
grpcServer := grpc.NewServer(
    grpc.UnaryInterceptor(otelgrpc.UnaryServerInterceptor()),
    grpc.StreamInterceptor(otelgrpc.StreamServerInterceptor()),
)

// gRPC Client
conn, _ := grpc.Dial(addr,
    grpc.WithUnaryInterceptor(otelgrpc.UnaryClientInterceptor()),
    grpc.WithStreamInterceptor(otelgrpc.StreamClientInterceptor()),
)
```

#### è§£å†³æ–¹æ¡ˆ3: å±æ€§è¡¥å……

**Resourceå±æ€§**:

```go
res, _ := resource.New(ctx,
    resource.WithAttributes(
        // å¿…éœ€å±æ€§
        semconv.ServiceName("my-service"),
        semconv.ServiceVersion("1.0.0"),
        semconv.DeploymentEnvironment("production"),
        
        // æ¨èå±æ€§
        semconv.ServiceNamespace("ecommerce"),
        semconv.ServiceInstanceID("instance-1"),
        
        // Kuberneteså±æ€§
        semconv.K8SPodName("my-pod-abc123"),
        semconv.K8SNamespaceName("default"),
        semconv.K8SDeploymentName("my-deployment"),
    ),
)
```

**Spanå±æ€§**:

```go
span.SetAttributes(
    // HTTPå±æ€§
    semconv.HTTPMethod("GET"),
    semconv.HTTPTarget("/api/users"),
    semconv.HTTPStatusCode(200),
    
    // æ•°æ®åº“å±æ€§
    semconv.DBSystem("postgresql"),
    semconv.DBName("users_db"),
    semconv.DBStatement("SELECT * FROM users WHERE id = $1"),
    
    // è‡ªå®šä¹‰å±æ€§
    attribute.String("user.id", "12345"),
    attribute.Int64("items.count", 10),
)
```

#### è§£å†³æ–¹æ¡ˆ4: ä½¿ç”¨Processorä¿®å¤å±æ€§

**Collector Attributes Processor**:

```yaml
processors:
  attributes:
    actions:
      # æ·»åŠ ç¼ºå¤±å±æ€§
      - key: deployment.environment
        value: production
        action: insert
      
      # ä¿®å¤é”™è¯¯å€¼
      - key: http.status_code
        action: convert
        converted_type: int
      
      # åˆ é™¤æ•æ„Ÿå±æ€§
      - key: http.request.header.authorization
        action: delete
      
      # é‡å‘½åå±æ€§
      - key: old_attribute
        action: update
        new_key: new_attribute
```

---

## 5. Collectoré—®é¢˜è¯Šæ–­

[ç»§ç»­...]

---

## å¿«é€Ÿç´¢å¼•

### æŒ‰ç—‡çŠ¶æŸ¥æ‰¾

| ç—‡çŠ¶ | å†³ç­–æ ‘ | å¿«é€Ÿè§£å†³æ–¹æ¡ˆ |
|------|-------|-------------|
| åç«¯æ— æ•°æ® | [æ•°æ®æœªä¸ŠæŠ¥](#1-æ•°æ®æœªä¸ŠæŠ¥é—®é¢˜è¯Šæ–­) | æ£€æŸ¥SDKâ†’Collectorâ†’åç«¯é“¾è·¯ |
| åº”ç”¨å»¶è¿Ÿé«˜ | [æ€§èƒ½é—®é¢˜](#2-æ€§èƒ½é—®é¢˜è¯Šæ–­) | ä¼˜åŒ–é‡‡æ ·ç‡+æ‰¹å¤„ç†é…ç½® |
| è¿æ¥è¶…æ—¶ | [è¿æ¥é—®é¢˜](#3-è¿æ¥ä¸ç½‘ç»œé—®é¢˜è¯Šæ–­) | æ£€æŸ¥ç½‘ç»œ+é˜²ç«å¢™+ç«¯å£ |
| Traceæ–­é“¾ | [æ•°æ®è´¨é‡](#4-æ•°æ®è´¨é‡é—®é¢˜è¯Šæ–­) | ä¿®å¤Contextä¼ æ’­ |
| Collectorå´©æºƒ | [Collectoré—®é¢˜](#5-collectoré—®é¢˜è¯Šæ–­) | æ·»åŠ memory_limiter |
| SDKæŠ¥é”™ | [SDKé›†æˆ](#6-sdké›†æˆé—®é¢˜è¯Šæ–­) | æ£€æŸ¥SDKç‰ˆæœ¬+é…ç½® |
| äº‘å¹³å°è®¤è¯å¤±è´¥ | [äº‘å¹³å°é›†æˆ](#7-äº‘å¹³å°é›†æˆé—®é¢˜è¯Šæ–­) | æ£€æŸ¥IAMæƒé™ |

### æŒ‰ç»„ä»¶æŸ¥æ‰¾

- **SDK**: [SDKé›†æˆé—®é¢˜](#6-sdké›†æˆé—®é¢˜è¯Šæ–­)
- **Collector**: [Collectoré—®é¢˜](#5-collectoré—®é¢˜è¯Šæ–­)
- **Network**: [è¿æ¥é—®é¢˜](#3-è¿æ¥ä¸ç½‘ç»œé—®é¢˜è¯Šæ–­)
- **Backend**: [æ•°æ®æœªä¸ŠæŠ¥](#1-æ•°æ®æœªä¸ŠæŠ¥é—®é¢˜è¯Šæ–­)

---

## ç›¸å…³æ–‡æ¡£

- ğŸ“„ [ç»¼åˆå¿«é€Ÿå‚è€ƒæ‰‹å†Œ](./00_ç»¼åˆå¿«é€Ÿå‚è€ƒæ‰‹å†Œ.md)
- ğŸ“„ [æ•…éšœæ’æŸ¥å®Œæ•´æ‰‹å†Œ](./16_æ•…éšœæ’æŸ¥æ‰‹å†Œ/01_OpenTelemetryæ•…éšœæ’æŸ¥å®Œæ•´æ‰‹å†Œ.md)
- ğŸ“„ [æœ€ä½³å®è·µæ¸…å•](./17_æœ€ä½³å®è·µæ¸…å•/01_OpenTelemetryæœ€ä½³å®è·µå®Œæ•´æ¸…å•.md)

---

**æœ€åæ›´æ–°**: 2025å¹´10æœˆ8æ—¥  
**ç»´æŠ¤è€…**: OTLPæ·±åº¦æ¢³ç†é¡¹ç›®ç»„  
**ç‰ˆæœ¬**: v1.0

[ğŸ  è¿”å›é¦–é¡µ](./README.md) | [ğŸ—ºï¸ å®æˆ˜åœºæ™¯å¿«é€ŸæŸ¥æ‰¾](./19_ç»¼åˆå®æˆ˜æ‰‹å†Œ/01_OpenTelemetryå®æˆ˜åœºæ™¯å¿«é€ŸæŸ¥æ‰¾æŒ‡å—.md)
