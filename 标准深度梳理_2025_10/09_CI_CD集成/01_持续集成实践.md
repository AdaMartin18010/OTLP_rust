# OpenTelemetry CI/CD 集成实践

> **最后更新**: 2025年10月8日  
> **目标读者**: DevOps工程师、CI/CD工程师

---

## 目录

- [OpenTelemetry CI/CD 集成实践](#opentelemetry-cicd-集成实践)
  - [目录](#目录)
  - [1. CI/CD可观测性概述](#1-cicd可观测性概述)
    - [1.1 为什么需要CI/CD可观测性](#11-为什么需要cicd可观测性)
    - [1.2 关键指标](#12-关键指标)
  - [2. GitHub Actions集成](#2-github-actions集成)
    - [2.1 基础集成](#21-基础集成)
    - [2.2 完整工作流](#22-完整工作流)
  - [3. GitLab CI集成](#3-gitlab-ci集成)
  - [4. Jenkins集成](#4-jenkins集成)
  - [5. 容器构建追踪](#5-容器构建追踪)
  - [6. 部署追踪](#6-部署追踪)
    - [6.1 Kubernetes部署](#61-kubernetes部署)
    - [6.2 部署验证](#62-部署验证)
  - [7. 测试追踪](#7-测试追踪)
  - [8. 性能基准测试](#8-性能基准测试)
  - [9. 告警与通知](#9-告警与通知)
  - [10. 最佳实践](#10-最佳实践)
  - [11. 参考资源](#11-参考资源)

---

## 1. CI/CD可观测性概述

### 1.1 为什么需要CI/CD可观测性

**价值**：

```text
1. 流水线性能
   - 识别慢步骤
   - 优化构建时间
   - 提高开发效率

2. 故障定位
   - 快速定位失败原因
   - 追踪部署问题
   - 回滚决策支持

3. 质量保证
   - 测试覆盖率
   - 测试失败趋势
   - 性能回归检测

4. 合规审计
   - 部署历史
   - 变更追踪
   - 审批流程

5. DevOps指标
   - 部署频率
   - 变更前置时间
   - MTTR
   - 变更失败率

示例:
部署失败 → 查看Trace → 发现是镜像拉取超时 → 优化镜像仓库
```

### 1.2 关键指标

```text
CI/CD关键指标:

1. 构建指标
   - build_duration: 构建时长
   - build_success_rate: 成功率
   - build_queue_time: 排队时间

2. 测试指标
   - test_duration: 测试时长
   - test_pass_rate: 通过率
   - test_coverage: 覆盖率

3. 部署指标
   - deployment_duration: 部署时长
   - deployment_frequency: 部署频率
   - deployment_success_rate: 成功率

4. DORA指标
   - Deployment Frequency
   - Lead Time for Changes
   - Time to Restore Service
   - Change Failure Rate

5. 资源指标
   - cpu_usage: CPU使用
   - memory_usage: 内存使用
   - artifact_size: 产物大小
```

---

## 2. GitHub Actions集成

### 2.1 基础集成

**设置OpenTelemetry**：

```yaml
# .github/workflows/ci.yml
name: CI with OpenTelemetry

on: [push, pull_request]

env:
  OTEL_EXPORTER_OTLP_ENDPOINT: ${{ secrets.OTEL_COLLECTOR_ENDPOINT }}
  OTEL_EXPORTER_OTLP_HEADERS: ${{ secrets.OTEL_AUTH_HEADER }}
  OTEL_SERVICE_NAME: my-app-ci
  OTEL_RESOURCE_ATTRIBUTES: service.version=${{ github.sha }},deployment.environment=ci

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup OpenTelemetry
        run: |
          # 下载otel CLI
          curl -L https://github.com/equinix-labs/otel-cli/releases/download/v0.4.0/otel-cli_0.4.0_linux_amd64.tar.gz | tar xz
          sudo mv otel-cli /usr/local/bin/
      
      - name: Build with tracing
        run: |
          otel-cli exec \
            --name "Build application" \
            --kind internal \
            --service my-app-ci \
            --attrs "build.branch=${{ github.ref }}" \
            --attrs "build.commit=${{ github.sha }}" \
            -- make build
      
      - name: Run tests with tracing
        run: |
          otel-cli exec \
            --name "Run tests" \
            --kind internal \
            --service my-app-ci \
            -- make test
```

### 2.2 完整工作流

**生产级CI配置**：

```yaml
# .github/workflows/full-ci.yml
name: Full CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  OTEL_EXPORTER_OTLP_ENDPOINT: https://otel-collector.example.com:4317
  OTEL_EXPORTER_OTLP_HEADERS: "authorization=Bearer ${{ secrets.OTEL_TOKEN }}"
  OTEL_SERVICE_NAME: my-app-ci
  OTEL_RESOURCE_ATTRIBUTES: >
    service.version=${{ github.sha }},
    deployment.environment=ci,
    vcs.repository.url=${{ github.repositoryUrl }},
    vcs.ref=${{ github.ref }},
    ci.pipeline.name=${{ github.workflow }},
    ci.pipeline.run.id=${{ github.run_id }}

jobs:
  # ========== 阶段1: 准备 ==========
  setup:
    runs-on: ubuntu-latest
    steps:
      - name: Start Pipeline Trace
        id: start-trace
        run: |
          # 创建根Trace
          TRACE_ID=$(openssl rand -hex 16)
          SPAN_ID=$(openssl rand -hex 8)
          echo "TRACE_ID=$TRACE_ID" >> $GITHUB_OUTPUT
          echo "ROOT_SPAN_ID=$SPAN_ID" >> $GITHUB_OUTPUT
          
          # 发送Span
          curl -X POST $OTEL_EXPORTER_OTLP_ENDPOINT/v1/traces \
            -H "Content-Type: application/json" \
            -H "$OTEL_EXPORTER_OTLP_HEADERS" \
            -d '{
              "resourceSpans": [{
                "resource": {
                  "attributes": [
                    {"key": "service.name", "value": {"stringValue": "my-app-ci"}},
                    {"key": "deployment.environment", "value": {"stringValue": "ci"}}
                  ]
                },
                "scopeSpans": [{
                  "spans": [{
                    "traceId": "'$TRACE_ID'",
                    "spanId": "'$SPAN_ID'",
                    "name": "CI Pipeline",
                    "kind": 1,
                    "startTimeUnixNano": '$(date +%s%N)'
                  }]
                }]
              }]
            }'
    
    outputs:
      trace_id: ${{ steps.start-trace.outputs.TRACE_ID }}
      root_span_id: ${{ steps.start-trace.outputs.ROOT_SPAN_ID }}
  
  # ========== 阶段2: 构建 ==========
  build:
    needs: setup
    runs-on: ubuntu-latest
    env:
      TRACE_PARENT: "00-${{ needs.setup.outputs.trace_id }}-${{ needs.setup.outputs.root_span_id }}-01"
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'
      
      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
      
      - name: Download dependencies
        run: |
          START=$(date +%s%N)
          go mod download
          END=$(date +%s%N)
          DURATION=$((($END - $START) / 1000000))
          echo "::notice::Dependencies downloaded in ${DURATION}ms"
      
      - name: Build application
        run: |
          otel-cli exec \
            --name "go build" \
            --kind internal \
            --service my-app-ci \
            --tp-carrier "$TRACE_PARENT" \
            --attrs "build.language=go" \
            --attrs "build.version=1.21" \
            -- go build -o app ./cmd/server
      
      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: app-binary
          path: app
  
  # ========== 阶段3: 测试 ==========
  test:
    needs: [setup, build]
    runs-on: ubuntu-latest
    env:
      TRACE_PARENT: "00-${{ needs.setup.outputs.trace_id }}-${{ needs.setup.outputs.root_span_id }}-01"
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'
      
      - name: Run unit tests
        run: |
          otel-cli exec \
            --name "Unit Tests" \
            --kind internal \
            --tp-carrier "$TRACE_PARENT" \
            --attrs "test.type=unit" \
            -- go test -v -cover ./... -coverprofile=coverage.out
      
      - name: Run integration tests
        run: |
          otel-cli exec \
            --name "Integration Tests" \
            --kind internal \
            --tp-carrier "$TRACE_PARENT" \
            --attrs "test.type=integration" \
            -- go test -v -tags=integration ./...
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.out
  
  # ========== 阶段4: 安全扫描 ==========
  security:
    needs: [setup, build]
    runs-on: ubuntu-latest
    env:
      TRACE_PARENT: "00-${{ needs.setup.outputs.trace_id }}-${{ needs.setup.outputs.root_span_id }}-01"
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Run Trivy scan
        run: |
          otel-cli exec \
            --name "Security Scan" \
            --kind internal \
            --tp-carrier "$TRACE_PARENT" \
            --attrs "scan.tool=trivy" \
            -- trivy fs --security-checks vuln,config .
  
  # ========== 阶段5: Docker构建 ==========
  docker:
    needs: [setup, build, test, security]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    env:
      TRACE_PARENT: "00-${{ needs.setup.outputs.trace_id }}-${{ needs.setup.outputs.root_span_id }}-01"
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Download artifact
        uses: actions/download-artifact@v3
        with:
          name: app-binary
      
      - name: Build Docker image
        run: |
          otel-cli exec \
            --name "Docker Build" \
            --kind internal \
            --tp-carrier "$TRACE_PARENT" \
            --attrs "docker.image=my-app:${{ github.sha }}" \
            -- docker build -t my-app:${{ github.sha }} .
      
      - name: Push to registry
        run: |
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
          docker push my-app:${{ github.sha }}
  
  # ========== 阶段6: 部署 ==========
  deploy:
    needs: [setup, docker]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    env:
      TRACE_PARENT: "00-${{ needs.setup.outputs.trace_id }}-${{ needs.setup.outputs.root_span_id }}-01"
    
    steps:
      - name: Deploy to Kubernetes
        run: |
          otel-cli exec \
            --name "Deploy to Production" \
            --kind client \
            --tp-carrier "$TRACE_PARENT" \
            --attrs "deployment.target=production" \
            --attrs "deployment.version=${{ github.sha }}" \
            -- kubectl set image deployment/my-app \
                my-app=my-app:${{ github.sha }} \
                -n production
      
      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/my-app -n production --timeout=5m
      
      - name: Smoke test
        run: |
          otel-cli exec \
            --name "Smoke Test" \
            --kind internal \
            --tp-carrier "$TRACE_PARENT" \
            -- curl -f https://api.example.com/health
```

---

## 3. GitLab CI集成

```yaml
# .gitlab-ci.yml
variables:
  OTEL_EXPORTER_OTLP_ENDPOINT: ${OTEL_COLLECTOR_ENDPOINT}
  OTEL_EXPORTER_OTLP_HEADERS: ${OTEL_AUTH_HEADER}
  OTEL_SERVICE_NAME: my-app-ci
  OTEL_RESOURCE_ATTRIBUTES: >
    service.version=${CI_COMMIT_SHA},
    deployment.environment=ci,
    ci.pipeline.id=${CI_PIPELINE_ID},
    ci.job.name=${CI_JOB_NAME}

stages:
  - build
  - test
  - deploy

before_script:
  - |
    # 安装otel-cli
    curl -L https://github.com/equinix-labs/otel-cli/releases/download/v0.4.0/otel-cli_0.4.0_linux_amd64.tar.gz | tar xz
    mv otel-cli /usr/local/bin/

build:
  stage: build
  script:
    - |
      otel-cli exec \
        --name "Build ${CI_JOB_NAME}" \
        --kind internal \
        --service my-app-ci \
        --attrs "ci.pipeline.id=${CI_PIPELINE_ID}" \
        --attrs "ci.commit=${CI_COMMIT_SHA}" \
        -- make build
  artifacts:
    paths:
      - build/

test:unit:
  stage: test
  script:
    - |
      otel-cli exec \
        --name "Unit Tests" \
        --kind internal \
        --attrs "test.type=unit" \
        -- make test
  coverage: '/Coverage: \d+\.\d+%/'

deploy:production:
  stage: deploy
  only:
    - main
  script:
    - |
      otel-cli exec \
        --name "Deploy to Production" \
        --kind client \
        --attrs "deployment.target=production" \
        --attrs "deployment.version=${CI_COMMIT_SHA}" \
        -- kubectl set image deployment/my-app my-app=my-app:${CI_COMMIT_SHA}
```

---

## 4. Jenkins集成

```groovy
// Jenkinsfile
pipeline {
    agent any
    
    environment {
        OTEL_EXPORTER_OTLP_ENDPOINT = credentials('otel-collector-endpoint')
        OTEL_EXPORTER_OTLP_HEADERS = credentials('otel-auth-header')
        OTEL_SERVICE_NAME = 'my-app-ci'
        TRACE_ID = sh(script: 'openssl rand -hex 16', returnStdout: true).trim()
    }
    
    stages {
        stage('Setup') {
            steps {
                script {
                    // 安装otel-cli
                    sh '''
                        curl -L https://github.com/equinix-labs/otel-cli/releases/download/v0.4.0/otel-cli_0.4.0_linux_amd64.tar.gz | tar xz
                        chmod +x otel-cli
                    '''
                }
            }
        }
        
        stage('Build') {
            steps {
                script {
                    sh '''
                        ./otel-cli exec \
                          --name "Build ${JOB_NAME}" \
                          --kind internal \
                          --service my-app-ci \
                          --attrs "build.number=${BUILD_NUMBER}" \
                          --attrs "build.url=${BUILD_URL}" \
                          -- make build
                    '''
                }
            }
        }
        
        stage('Test') {
            parallel {
                stage('Unit Tests') {
                    steps {
                        sh '''
                            ./otel-cli exec \
                              --name "Unit Tests" \
                              --kind internal \
                              --attrs "test.type=unit" \
                              -- make test:unit
                        '''
                    }
                }
                
                stage('Integration Tests') {
                    steps {
                        sh '''
                            ./otel-cli exec \
                              --name "Integration Tests" \
                              --kind internal \
                              --attrs "test.type=integration" \
                              -- make test:integration
                        '''
                    }
                }
            }
        }
        
        stage('Deploy') {
            when {
                branch 'main'
            }
            steps {
                sh '''
                    ./otel-cli exec \
                      --name "Deploy to Production" \
                      --kind client \
                      --attrs "deployment.target=production" \
                      -- kubectl set image deployment/my-app my-app=my-app:${GIT_COMMIT}
                '''
            }
        }
    }
    
    post {
        always {
            script {
                // 发送Pipeline完成事件
                sh '''
                    ./otel-cli span event \
                      --name "Pipeline ${currentBuild.result}" \
                      --attrs "build.result=${currentBuild.result}" \
                      --attrs "build.duration=${currentBuild.duration}"
                '''
            }
        }
    }
}
```

---

## 5. 容器构建追踪

**Docker Build追踪**：

```bash
#!/bin/bash
# build-with-tracing.sh

# 开始Build Span
SPAN_START=$(date +%s%N)

# 构建镜像
otel-cli exec \
  --name "Docker Build" \
  --kind internal \
  --service docker-build \
  --attrs "docker.image=${IMAGE_NAME}:${VERSION}" \
  --attrs "docker.file=Dockerfile" \
  -- docker build \
    --progress=plain \
    --tag ${IMAGE_NAME}:${VERSION} \
    --build-arg VERSION=${VERSION} \
    .

BUILD_RESULT=$?
SPAN_END=$(date +%s%N)
DURATION=$((($SPAN_END - $SPAN_START) / 1000000))

# 记录构建指标
echo "Build duration: ${DURATION}ms"
echo "Build result: $BUILD_RESULT"

# 如果构建成功，推送镜像
if [ $BUILD_RESULT -eq 0 ]; then
    otel-cli exec \
      --name "Docker Push" \
      --kind client \
      --attrs "docker.registry=${REGISTRY}" \
      -- docker push ${IMAGE_NAME}:${VERSION}
fi

exit $BUILD_RESULT
```

**多阶段构建追踪**：

```dockerfile
# Dockerfile with build stages
FROM golang:1.21 AS builder
WORKDIR /app
COPY . .

# 这些命令会被追踪
RUN go mod download
RUN CGO_ENABLED=0 go build -o app ./cmd/server

FROM alpine:latest
COPY --from=builder /app/app /usr/local/bin/app
ENTRYPOINT ["app"]
```

---

## 6. 部署追踪

### 6.1 Kubernetes部署

```bash
#!/bin/bash
# deploy-with-tracing.sh

DEPLOYMENT_NAME="my-app"
NAMESPACE="production"
IMAGE_TAG=$1

# 创建部署Span
otel-cli span \
  --name "Deploy ${DEPLOYMENT_NAME}" \
  --kind client \
  --service deployment \
  --attrs "deployment.name=${DEPLOYMENT_NAME}" \
  --attrs "deployment.namespace=${NAMESPACE}" \
  --attrs "deployment.image.tag=${IMAGE_TAG}" \
  --attrs "deployment.strategy=rolling" \
  --start

# 更新镜像
kubectl set image deployment/${DEPLOYMENT_NAME} \
  ${DEPLOYMENT_NAME}=${IMAGE_NAME}:${IMAGE_TAG} \
  -n ${NAMESPACE}

# 等待rollout完成
kubectl rollout status deployment/${DEPLOYMENT_NAME} \
  -n ${NAMESPACE} \
  --timeout=5m

ROLLOUT_RESULT=$?

# 结束Span
otel-cli span \
  --end \
  --attrs "deployment.result=$([[ $ROLLOUT_RESULT -eq 0 ]] && echo success || echo failure)"

# 验证部署
if [ $ROLLOUT_RESULT -eq 0 ]; then
    otel-cli exec \
      --name "Verify Deployment" \
      --kind internal \
      -- curl -f https://api.example.com/health
fi

exit $ROLLOUT_RESULT
```

### 6.2 部署验证

```bash
# smoke-test.sh
#!/bin/bash

ENDPOINTS=(
    "https://api.example.com/health"
    "https://api.example.com/ready"
    "https://api.example.com/metrics"
)

otel-cli span --name "Smoke Tests" --start

for endpoint in "${ENDPOINTS[@]}"; do
    otel-cli exec \
      --name "Test ${endpoint}" \
      --kind client \
      --attrs "http.url=${endpoint}" \
      -- curl -f -s -o /dev/null -w "%{http_code}" ${endpoint}
    
    if [ $? -ne 0 ]; then
        echo "❌ Failed: ${endpoint}"
        otel-cli span event --name "Test failed" --attrs "endpoint=${endpoint}"
        exit 1
    else
        echo "✅ Passed: ${endpoint}"
    fi
done

otel-cli span --end
echo "✅ All smoke tests passed"
```

---

## 7. 测试追踪

**Go测试追踪**：

```go
// test_helper.go
package main

import (
    "context"
    "testing"
    "go.opentelemetry.io/otel"
    "go.opentelemetry.io/otel/trace"
)

func TestWithTracing(t *testing.T, fn func(ctx context.Context, t *testing.T)) {
    tracer := otel.Tracer("test")
    ctx, span := tracer.Start(context.Background(), t.Name(),
        trace.WithSpanKind(trace.SpanKindInternal),
    )
    defer span.End()
    
    fn(ctx, t)
    
    if t.Failed() {
        span.RecordError(errors.New("test failed"))
        span.SetStatus(codes.Error, "Test failed")
    }
}

// 使用示例
func TestUserService(t *testing.T) {
    TestWithTracing(t, func(ctx context.Context, t *testing.T) {
        // 测试代码
        service := NewUserService()
        user, err := service.GetUser(ctx, "user-123")
        
        if err != nil {
            t.Fatal(err)
        }
        
        if user.Name == "" {
            t.Error("User name is empty")
        }
    })
}
```

---

## 8. 性能基准测试

```bash
# benchmark.sh
#!/bin/bash

echo "Running performance benchmarks..."

otel-cli exec \
  --name "Performance Benchmark" \
  --kind internal \
  --service benchmark \
  -- go test -bench=. -benchtime=10s -benchmem ./...

# 解析结果并发送为Metric
go test -bench=. -benchtime=10s -benchmem ./... | \
  grep -E "^Benchmark" | \
  while read line; do
    NAME=$(echo $line | awk '{print $1}')
    OPS=$(echo $line | awk '{print $3}')
    NS_OP=$(echo $line | awk '{print $5}')
    
    # 发送Metric到OTLP
    curl -X POST ${OTEL_EXPORTER_OTLP_ENDPOINT}/v1/metrics \
      -H "Content-Type: application/json" \
      -d '{
        "resourceMetrics": [{
          "scopeMetrics": [{
            "metrics": [{
              "name": "benchmark.'${NAME}'",
              "gauge": {
                "dataPoints": [{
                  "asDouble": '${NS_OP}',
                  "timeUnixNano": '$(date +%s%N)'
                }]
              }
            }]
          }]
        }]
      }'
  done
```

---

## 9. 告警与通知

**Slack通知**：

```bash
# notify-slack.sh
#!/bin/bash

PIPELINE_URL="${CI_PIPELINE_URL}"
TRACE_URL="https://jaeger.example.com/trace/${TRACE_ID}"

if [ "$BUILD_STATUS" == "success" ]; then
    COLOR="good"
    EMOJI=":white_check_mark:"
else
    COLOR="danger"
    EMOJI=":x:"
fi

curl -X POST $SLACK_WEBHOOK_URL \
  -H 'Content-Type: application/json' \
  -d '{
    "attachments": [{
      "color": "'${COLOR}'",
      "title": "'${EMOJI}' Pipeline '${BUILD_STATUS}'",
      "fields": [
        {
          "title": "Pipeline",
          "value": "<'${PIPELINE_URL}'|#'${BUILD_NUMBER}'>",
          "short": true
        },
        {
          "title": "Trace",
          "value": "<'${TRACE_URL}'|View Trace>",
          "short": true
        },
        {
          "title": "Commit",
          "value": "'${GIT_COMMIT:0:7}'",
          "short": true
        },
        {
          "title": "Duration",
          "value": "'${BUILD_DURATION}'",
          "short": true
        }
      ]
    }]
  }'
```

---

## 10. 最佳实践

```text
✅ DO (推荐)
1. 每个Pipeline创建一个根Trace
2. 每个Job/Stage创建子Span
3. 记录关键属性 (commit, branch, version)
4. 追踪慢步骤并优化
5. 失败时记录详细错误
6. 记录部署版本和环境
7. 实施smoke tests
8. 监控DORA指标

❌ DON'T (避免)
1. 不要在日志中记录敏感信息
2. 不要阻塞Pipeline (异步发送)
3. 不要忽略追踪失败
4. 不要过度追踪 (< 5% overhead)

性能优化:
- 使用缓存加速构建
- 并行执行独立任务
- 优化Docker层缓存
- 使用轻量级基础镜像

监控建议:
- Pipeline duration趋势
- 失败率趋势
- 热点步骤识别
- 部署频率
- 前置时间
```

---

## 11. 参考资源

- **otel-cli**: <https://github.com/equinix-labs/otel-cli>
- **GitHub Actions**: <https://docs.github.com/actions>
- **GitLab CI**: <https://docs.gitlab.com/ee/ci/>
- **DORA Metrics**: <https://cloud.google.com/blog/products/devops-sre/using-the-four-keys-to-measure-your-devops-performance>

---

**文档状态**: ✅ 完成  
**审核状态**: 待审核  
**相关文档**: [故障排查](../08_故障排查/01_常见问题与解决方案.md), [性能优化](../05_采样与性能/02_性能优化实践.md)
