# 📦 Rust 依赖管理与安全更新指南 (2025)

> **作者**: Rust 安全专家团队  
> **版本**: v2.5  
> **Rust 版本**: 1.90+ (Edition 2024)  
> **最后更新**: 2025年10月11日  
> **安全等级**: 🔒 生产级

---

## 📋 目录

- [📦 Rust 依赖管理与安全更新指南 (2025)](#-rust-依赖管理与安全更新指南-2025)
  - [📋 目录](#-目录)
  - [1. 现代依赖管理策略](#1-现代依赖管理策略)
    - [1.1 依赖选择原则](#11-依赖选择原则)
    - [1.2 依赖分类管理](#12-依赖分类管理)
  - [2. Cargo.toml 最佳实践](#2-cargotoml-最佳实践)
    - [2.1 版本约束策略](#21-版本约束策略)
    - [2.2 特性标志设计](#22-特性标志设计)
  - [3. 工作区依赖管理](#3-工作区依赖管理)
    - [3.1 工作区配置](#31-工作区配置)
    - [3.2 子 crate 配置](#32-子-crate-配置)
  - [4. 安全审计流程](#4-安全审计流程)
    - [4.1 cargo-audit 集成](#41-cargo-audit-集成)
    - [4.2 cargo-deny 配置](#42-cargo-deny-配置)
  - [5. 依赖更新策略](#5-依赖更新策略)
    - [5.1 自动更新工具](#51-自动更新工具)
    - [5.2 Renovate 配置](#52-renovate-配置)
  - [6. 供应链安全](#6-供应链安全)
    - [6.1 cargo-supply-chain 审计](#61-cargo-supply-chain-审计)
  - [7. 版本锁定与发布](#7-版本锁定与发布)
    - [7.1 Cargo.lock 管理](#71-cargolock-管理)
    - [7.2 语义化版本发布](#72-语义化版本发布)
  - [8. CI/CD 集成](#8-cicd-集成)
    - [8.1 GitHub Actions 工作流](#81-github-actions-工作流)
  - [9. 漏洞响应流程](#9-漏洞响应流程)
    - [9.1 应急响应脚本](#91-应急响应脚本)
  - [10. 工具链推荐](#10-工具链推荐)
    - [10.1 必备工具清单](#101-必备工具清单)
  - [📊 总结](#-总结)
    - [核心要点](#核心要点)
    - [最佳实践清单](#最佳实践清单)

---

## 1. 现代依赖管理策略

### 1.1 依赖选择原则

```toml
# Cargo.toml - 2025年最佳实践

[package]
name = "otlp-rust-service"
version = "2.0.0"
edition = "2024"
rust-version = "1.90"  # 最小支持的 Rust 版本 (MSRV)
license = "MIT OR Apache-2.0"
repository = "https://github.com/your-org/otlp-rust"
documentation = "https://docs.rs/otlp-rust-service"
readme = "README.md"
keywords = ["otlp", "opentelemetry", "observability", "tracing", "metrics"]
categories = ["development-tools::profiling", "asynchronous"]

[dependencies]
# ============================================================================
# 核心依赖 - 严格版本控制
# ============================================================================

# OpenTelemetry 生态 - 使用最新稳定版本
opentelemetry = { version = "0.31.0", features = ["trace", "metrics", "logs"] }
opentelemetry_sdk = { version = "0.31.0", features = ["rt-tokio"] }
opentelemetry-otlp = { version = "0.31.0", features = ["grpc-tonic", "http-json"] }

# 异步运行时 - Tokio 1.47+
tokio = { version = "1.47", features = [
    "rt-multi-thread",  # 多线程运行时
    "macros",           # async/await 宏
    "sync",             # 同步原语
    "time",             # 时间功能
    "signal",           # 信号处理
    "fs",               # 文件系统
    "io-util",          # I/O 工具
    "net",              # 网络
    "parking_lot",      # 高性能锁
] }

# gRPC 和序列化
tonic = { version = "0.14", features = ["tls-ring", "gzip", "zstd"] }
prost = "0.14"

# 错误处理
anyhow = "1.0"         # 通用错误处理
thiserror = "2.0"      # 自定义错误类型

# 日志和追踪
tracing = "0.1"
tracing-subscriber = { version = "0.3", features = ["env-filter", "json"] }

# 序列化
serde = { version = "1.0", features = ["derive"] }
serde_json = "1.0"

# ============================================================================
# 可选依赖 - 特性门控
# ============================================================================

[dependencies.metrics]
version = "0.24"
optional = true

[dependencies.prometheus]
version = "0.14"
optional = true

# ============================================================================
# 开发依赖
# ============================================================================

[dev-dependencies]
criterion = { version = "0.7", features = ["html_reports", "async_tokio"] }
mockall = "0.13"
proptest = "1.8"
tokio-test = "0.4"
tempfile = "3.23"

# ============================================================================
# 构建依赖
# ============================================================================

[build-dependencies]
tonic-build = "0.14"
prost-build = "0.14"

# ============================================================================
# 特性标志
# ============================================================================

[features]
default = ["grpc", "metrics-prometheus"]

# 导出器协议
grpc = ["opentelemetry-otlp/grpc-tonic", "tonic"]
http = ["opentelemetry-otlp/http-json"]

# 指标导出
metrics-prometheus = ["metrics", "prometheus"]

# TLS 支持
tls-rustls = ["tonic/tls-ring"]
tls-native = ["tonic/tls-native"]

# 完整特性集
full = ["grpc", "http", "metrics-prometheus", "tls-rustls"]
```

### 1.2 依赖分类管理

```toml
# Cargo.toml - 按用途分类

[dependencies]
# ============================================================================
# 第 1 层：核心运行时 (不可替换)
# ============================================================================
tokio = { version = "1.47", features = ["full"] }
futures = "0.3"

# ============================================================================
# 第 2 层：协议实现 (可替换，但需评估)
# ============================================================================
tonic = { version = "0.14", features = ["tls-ring"] }
hyper = { version = "1.7", features = ["full"] }

# 或者使用 reqwest
# reqwest = { version = "0.12", features = ["json", "rustls-tls"] }

# ============================================================================
# 第 3 层：工具库 (可灵活替换)
# ============================================================================
serde = { version = "1.0", features = ["derive"] }
serde_json = "1.0"

# 或者使用其他序列化库
# serde_yaml = "0.9"
# toml = "0.9"

# ============================================================================
# 第 4 层：可选扩展
# ============================================================================
# 性能分析
[dependencies.pprof]
version = "0.13"
optional = true
features = ["flamegraph", "protobuf"]

# ============================================================================
# 平台特定依赖
# ============================================================================

[target.'cfg(unix)'.dependencies]
nix = { version = "0.28", features = ["signal"] }

[target.'cfg(windows)'.dependencies]
winapi = { version = "0.3", features = ["handleapi", "processthreadsapi"] }

[target.'cfg(target_os = "linux")'.dependencies]
libc = "0.2"

# ============================================================================
# 目标架构特定优化
# ============================================================================

[target.'cfg(target_arch = "x86_64")'.dependencies]
# x86_64 特定的 SIMD 优化
packed_simd_2 = "0.3"

[target.'cfg(target_arch = "aarch64")'.dependencies]
# ARM 特定优化库
```

---

## 2. Cargo.toml 最佳实践

### 2.1 版本约束策略

```toml
# 版本约束指南

[dependencies]
# ============================================================================
# 严格版本 (=) - 仅用于关键依赖
# ============================================================================
opentelemetry = "=0.31.0"  # 精确版本，任何更新都需明确

# ============================================================================
# 兼容版本 (^) - 默认策略
# ============================================================================
tokio = "^1.47.0"  # 允许 >=1.47.0 <2.0.0
# 等同于: tokio = "1.47"

# ============================================================================
# 波浪号版本 (~) - 补丁级别更新
# ============================================================================
serde = "~1.0.228"  # 允许 >=1.0.228 <1.1.0

# ============================================================================
# 通配符版本 (*) - 避免使用
# ============================================================================
# some-crate = "*"  # ❌ 不推荐：过于宽松

# ============================================================================
# 版本范围 - 明确兼容性
# ============================================================================
anyhow = ">=1.0.100, <2.0.0"  # 显式范围

# ============================================================================
# Git 依赖 - 仅用于开发
# ============================================================================
[dependencies.custom-otlp-exporter]
git = "https://github.com/your-org/custom-exporter"
branch = "main"
# 生产环境使用 tag 或 rev
# tag = "v1.0.0"
# rev = "abc123def456"

# ============================================================================
# 本地路径依赖 - 仅用于开发
# ============================================================================
[dependencies.local-utils]
path = "../utils"
# 发布前必须替换为 crates.io 版本

# ============================================================================
# 版本继承（工作区）
# ============================================================================
[dependencies]
opentelemetry = { workspace = true }  # 继承工作区版本
tokio = { workspace = true, features = ["full"] }  # 可添加额外特性
```

### 2.2 特性标志设计

```toml
# 特性标志最佳实践

[features]
# ============================================================================
# 默认特性 - 最小可用集
# ============================================================================
default = ["grpc", "basic-metrics"]

# ============================================================================
# 协议支持
# ============================================================================
grpc = ["tonic", "opentelemetry-otlp/grpc-tonic"]
http = ["reqwest", "opentelemetry-otlp/http-json"]

# ============================================================================
# 指标导出器
# ============================================================================
basic-metrics = []
metrics-prometheus = ["metrics", "prometheus", "basic-metrics"]
metrics-statsd = ["metrics", "statsd", "basic-metrics"]
metrics-all = ["metrics-prometheus", "metrics-statsd"]

# ============================================================================
# TLS 实现
# ============================================================================
tls-rustls = ["tonic/tls-ring", "rustls"]
tls-native = ["tonic/tls-native", "native-tls"]
tls-vendored = ["tls-native", "native-tls/vendored"]

# ============================================================================
# 性能优化
# ============================================================================
performance = ["jemalloc", "mimalloc"]
jemalloc = ["jemallocator"]
mimalloc = ["mimalloc-rust"]

# ============================================================================
# 开发特性
# ============================================================================
dev-tools = ["pprof", "tokio-console"]

# ============================================================================
# 完整特性集
# ============================================================================
full = [
    "grpc",
    "http",
    "metrics-all",
    "tls-rustls",
    "performance",
]

# ============================================================================
# 互斥特性检查
# ============================================================================
# 在 build.rs 中实现

[package.metadata.docs.rs]
# docs.rs 构建配置
all-features = true
rustdoc-args = ["--cfg", "docsrs"]
```

---

## 3. 工作区依赖管理

### 3.1 工作区配置

```toml
# Cargo.toml (workspace root)

[workspace]
resolver = "3"  # Rust 1.90 推荐使用 resolver v3

members = [
    "crates/otlp-core",
    "crates/otlp-sdk",
    "crates/otlp-exporter-grpc",
    "crates/otlp-exporter-http",
    "crates/otlp-contrib",
]

# 排除目录
exclude = [
    "examples",
    "benches",
    "target",
]

# ============================================================================
# 工作区级别依赖 - 统一版本管理
# ============================================================================

[workspace.package]
version = "2.0.0"
edition = "2024"
rust-version = "1.90"
license = "MIT OR Apache-2.0"
repository = "https://github.com/your-org/otlp-rust"

[workspace.dependencies]
# OpenTelemetry 生态 - 2025年10月最新版本
opentelemetry = "0.31.0"
opentelemetry_sdk = "0.31.0"
opentelemetry-otlp = "0.31.0"
opentelemetry-semantic-conventions = "0.31.0"

# 异步运行时
tokio = { version = "1.47", features = ["full"] }
tokio-util = "0.7"
tokio-stream = "0.1"
futures = "0.3"

# gRPC 和序列化
tonic = "0.14"
prost = "0.14"
prost-types = "0.14"

# 错误处理
anyhow = "1.0"
thiserror = "2.0"

# 日志和追踪
tracing = "0.1"
tracing-subscriber = "0.3"

# 序列化
serde = { version = "1.0", features = ["derive"] }
serde_json = "1.0"

# 测试
criterion = "0.7"
mockall = "0.13"
proptest = "1.8"

# ============================================================================
# 工作区依赖补丁 - 临时修复
# ============================================================================

[patch.crates-io]
# 仅用于紧急安全修复
# 生产环境避免使用

# 示例：使用本地修复版本
# vulnerable-crate = { path = "./patches/vulnerable-crate" }

# 示例：使用 Git 修复版本
# vulnerable-crate = { git = "https://github.com/maintainer/fixed-version", branch = "security-fix" }

# ============================================================================
# 工作区配置
# ============================================================================

[workspace.metadata]
# 自定义元数据
min-supported-rust-version = "1.90"
security-contact = "security@example.com"
```

### 3.2 子 crate 配置

```toml
# crates/otlp-core/Cargo.toml

[package]
name = "otlp-core"
# 继承工作区配置
version.workspace = true
edition.workspace = true
rust-version.workspace = true
license.workspace = true
repository.workspace = true

description = "OTLP core types and traits"
keywords = ["otlp", "opentelemetry", "core"]

[dependencies]
# 继承工作区依赖
opentelemetry = { workspace = true }
serde = { workspace = true }
thiserror = { workspace = true }

# 本地工作区依赖
# (空 - 这是核心 crate)

[dev-dependencies]
criterion = { workspace = true }
proptest = { workspace = true }
```

```toml
# crates/otlp-exporter-grpc/Cargo.toml

[package]
name = "otlp-exporter-grpc"
version.workspace = true
edition.workspace = true
rust-version.workspace = true
license.workspace = true
repository.workspace = true

description = "OTLP gRPC exporter"
keywords = ["otlp", "grpc", "exporter"]

[dependencies]
# 继承工作区依赖
opentelemetry = { workspace = true }
opentelemetry-otlp = { workspace = true, features = ["grpc-tonic"] }
tonic = { workspace = true }
tokio = { workspace = true }

# 本地工作区依赖
otlp-core = { path = "../otlp-core", version = "2.0.0" }

[dev-dependencies]
tokio-test = { version = "0.4" }
mockall = { workspace = true }
```

---

## 4. 安全审计流程

### 4.1 cargo-audit 集成

```bash
#!/bin/bash
# scripts/security-audit.sh

set -euo pipefail

echo "🔒 开始安全审计..."

# 1. 安装 cargo-audit（如果未安装）
if ! command -v cargo-audit &> /dev/null; then
    echo "安装 cargo-audit..."
    cargo install cargo-audit --locked
fi

# 2. 更新漏洞数据库
echo "更新漏洞数据库..."
cargo audit fetch

# 3. 执行审计
echo "执行安全审计..."
cargo audit \
    --deny warnings \
    --deny unmaintained \
    --deny unsound \
    --deny yanked \
    --json > audit-report.json

# 4. 生成人类可读报告
cargo audit > audit-report.txt

# 5. 检查严重漏洞
CRITICAL_COUNT=$(jq '[.vulnerabilities.list[] | select(.advisory.severity == "critical")] | length' audit-report.json)

if [ "$CRITICAL_COUNT" -gt 0 ]; then
    echo "❌ 发现 ${CRITICAL_COUNT} 个严重漏洞！"
    jq '.vulnerabilities.list[] | select(.advisory.severity == "critical")' audit-report.json
    exit 1
else
    echo "✅ 未发现严重漏洞"
fi

# 6. 生成 SBOM（软件物料清单）
echo "生成 SBOM..."
cargo tree --format json > sbom.json

echo "✅ 安全审计完成！"
```

### 4.2 cargo-deny 配置

```toml
# deny.toml - 依赖策略配置

# ============================================================================
# 许可证检查
# ============================================================================

[licenses]
# 必须明确指定许可证
unlicensed = "deny"

# 允许的许可证列表
allow = [
    "MIT",
    "Apache-2.0",
    "BSD-2-Clause",
    "BSD-3-Clause",
    "ISC",
    "Unlicense",
]

# 拒绝的许可证
deny = [
    "GPL-2.0",
    "GPL-3.0",
    "AGPL-3.0",
]

# 需要审查的许可证
copyleft = "deny"

# ============================================================================
# 安全漏洞检查
# ============================================================================

[advisories]
# 数据库 URL
db-path = "~/.cargo/advisory-db"
db-urls = ["https://github.com/rustsec/advisory-db"]

# 漏洞严重性
vulnerability = "deny"  # 拒绝任何已知漏洞
unmaintained = "warn"   # 警告未维护的 crate
unsound = "deny"        # 拒绝不健全的代码
yanked = "deny"         # 拒绝已撤回的版本

# 忽略特定漏洞（仅用于临时豁免）
ignore = [
    # "RUSTSEC-2024-0001",  # 示例：已评估风险可接受
]

# ============================================================================
# 依赖源检查
# ============================================================================

[sources]
# 允许的源
allow-registry = ["https://github.com/rust-lang/crates.io-index"]

# Git 源必须明确允许
[sources.allow-org]
github = ["your-org"]

# ============================================================================
# 重复依赖检查
# ============================================================================

[bans]
# 检测多版本依赖
multiple-versions = "warn"

# 拒绝通配符依赖
wildcards = "deny"

# 拒绝使用的 crate
deny = [
    # 已知不安全的 crate
    { name = "unsafe-crate", version = "*" },
]

# 跳过特定依赖树
skip = []

# 允许的重复依赖（临时）
skip-tree = [
    # { name = "some-crate", version = "=0.1.0" },
]
```

---

## 5. 依赖更新策略

### 5.1 自动更新工具

```bash
#!/bin/bash
# scripts/update-dependencies.sh

set -euo pipefail

echo "📦 开始依赖更新流程..."

# 1. 安装必要工具
echo "安装工具..."
cargo install cargo-edit cargo-outdated --locked

# 2. 检查过时依赖
echo "检查过时依赖..."
cargo outdated --root-deps-only > outdated-report.txt
cat outdated-report.txt

# 3. 分类更新

echo "执行补丁级别更新..."
cargo update --precise-recursive

echo "执行次要版本更新（安全）..."
# 仅更新兼容版本
cargo upgrade --compatible

# 4. 执行主要版本更新（需人工审核）
echo "生成主要版本更新报告..."
cargo upgrade --incompatible --dry-run > major-updates.txt

# 5. 运行测试
echo "运行测试套件..."
cargo test --all-features

# 6. 运行基准测试
echo "运行基准测试..."
cargo bench --no-run

# 7. 安全审计
echo "执行安全审计..."
./scripts/security-audit.sh

# 8. 生成更新报告
cat << EOF > dependency-update-report.md
# 依赖更新报告 - $(date +%Y-%m-%d)

## 过时依赖
\`\`\`
$(cat outdated-report.txt)
\`\`\`

## 主要版本更新建议
\`\`\`
$(cat major-updates.txt)
\`\`\`

## 测试结果
✅ 所有测试通过

## 安全审计
$(cat audit-report.txt)

EOF

echo "✅ 依赖更新完成！请查看 dependency-update-report.md"
```

### 5.2 Renovate 配置

```json
{
  "extends": ["config:base"],
  "packageRules": [
    {
      "matchManagers": ["cargo"],
      "matchUpdateTypes": ["patch"],
      "automerge": true,
      "automergeType": "pr",
      "schedule": ["before 3am on Monday"]
    },
    {
      "matchManagers": ["cargo"],
      "matchUpdateTypes": ["minor"],
      "groupName": "Rust minor updates",
      "schedule": ["before 3am on the first day of the month"]
    },
    {
      "matchManagers": ["cargo"],
      "matchUpdateTypes": ["major"],
      "groupName": "Rust major updates",
      "enabled": false,
      "schedule": ["at any time"]
    },
    {
      "matchPackageNames": ["opentelemetry", "opentelemetry_sdk", "opentelemetry-otlp"],
      "groupName": "OpenTelemetry packages",
      "automerge": false
    },
    {
      "matchPackageNames": ["tokio", "tokio-util", "tokio-stream"],
      "groupName": "Tokio packages",
      "automerge": false
    }
  ],
  "prConcurrentLimit": 5,
  "prHourlyLimit": 2,
  "labels": ["dependencies", "rust"],
  "assignees": ["@security-team"],
  "reviewers": ["@rust-team"],
  "vulnerabilityAlerts": {
    "enabled": true,
    "labels": ["security", "urgent"],
    "assignees": ["@security-team"]
  },
  "lockFileMaintenance": {
    "enabled": true,
    "schedule": ["before 3am on Monday"]
  }
}
```

---

## 6. 供应链安全

### 6.1 cargo-supply-chain 审计

```bash
#!/bin/bash
# scripts/supply-chain-audit.sh

set -euo pipefail

echo "🔗 开始供应链审计..."

# 1. 安装工具
cargo install cargo-supply-chain --locked

# 2. 分析贡献者
echo "分析依赖贡献者..."
cargo supply-chain publishers > publishers-report.txt

# 3. 识别单一贡献者风险
echo "识别单一贡献者 crate..."
cargo supply-chain publishers --json | \
    jq '[.crates[] | select(.publishers | length == 1)]' > single-publisher-crates.json

# 4. 检查 crate 所有者
echo "分析 crate 所有者..."
cargo supply-chain update
cargo supply-chain crates > crates-report.txt

# 5. 生成供应链图
echo "生成依赖图..."
cargo tree --format "{p} {f}" > dependency-tree.txt

# 6. 识别高风险依赖
echo "识别高风险依赖..."
cat << 'SCRIPT' > analyze-risk.sh
#!/bin/bash
# 分析风险因素
jq -r '.crates[] | 
    select(
        (.publishers | length == 1) or 
        (.downloads < 1000) or 
        (.recent_downloads < 100)
    ) | 
    "\(.name):\n  Publishers: \(.publishers | length)\n  Downloads: \(.downloads)\n  Recent: \(.recent_downloads)\n"' \
    single-publisher-crates.json
SCRIPT

chmod +x analyze-risk.sh
./analyze-risk.sh > high-risk-crates.txt

echo "✅ 供应链审计完成！"
echo "查看 publishers-report.txt 和 high-risk-crates.txt"
```

---

## 7. 版本锁定与发布

### 7.1 Cargo.lock 管理

```bash
#!/bin/bash
# scripts/manage-lockfile.sh

# Cargo.lock 最佳实践

# 1. 库项目（library）：不提交 Cargo.lock
if [ -f "Cargo.lock" ] && grep -q "^crate-type.*lib" Cargo.toml; then
    echo "警告：库项目不应提交 Cargo.lock"
    echo "添加到 .gitignore:"
    echo "Cargo.lock" >> .gitignore
fi

# 2. 二进制项目（binary）：必须提交 Cargo.lock
if grep -q "^\[\[bin\]\]" Cargo.toml; then
    if [ ! -f "Cargo.lock" ]; then
        echo "生成 Cargo.lock..."
        cargo generate-lockfile
    fi
    
    # 验证 lock文件
    cargo verify-project --locked
    
    echo "✅ Cargo.lock 已就绪（二进制项目）"
fi

# 3. 更新 lock 文件（保持依赖版本）
update_lockfile_conservative() {
    echo "保守更新 Cargo.lock..."
    cargo update --precise-recursive
}

# 4. 完全重建 lock 文件
rebuild_lockfile() {
    echo "重建 Cargo.lock..."
    rm -f Cargo.lock
    cargo generate-lockfile
    cargo check --all-features
}
```

### 7.2 语义化版本发布

```bash
#!/bin/bash
# scripts/release.sh

set -euo pipefail

# 获取当前版本
CURRENT_VERSION=$(grep -m1 '^version' Cargo.toml | cut -d'"' -f2)

echo "当前版本: ${CURRENT_VERSION}"
echo "选择发布类型:"
echo "1. Patch (bug修复): ${CURRENT_VERSION} -> $(semver bump patch ${CURRENT_VERSION})"
echo "2. Minor (新特性): ${CURRENT_VERSION} -> $(semver bump minor ${CURRENT_VERSION})"
echo "3. Major (破坏性变更): ${CURRENT_VERSION} -> $(semver bump major ${CURRENT_VERSION})"

read -p "选择 (1/2/3): " choice

case $choice in
    1) NEW_VERSION=$(semver bump patch ${CURRENT_VERSION}) ;;
    2) NEW_VERSION=$(semver bump minor ${CURRENT_VERSION}) ;;
    3) NEW_VERSION=$(semver bump major ${CURRENT_VERSION}) ;;
    *) echo "无效选择"; exit 1 ;;
esac

echo "新版本: ${NEW_VERSION}"

# 1. 更新版本号
echo "更新版本号..."
sed -i "s/^version = \"${CURRENT_VERSION}\"/version = \"${NEW_VERSION}\"/" Cargo.toml

# 2. 运行完整测试
echo "运行测试..."
cargo test --all-features
cargo clippy -- -D warnings
cargo fmt -- --check

# 3. 更新 CHANGELOG
echo "更新 CHANGELOG.md..."
cat << EOF > CHANGELOG.md.new
# Changelog

## [${NEW_VERSION}] - $(date +%Y-%m-%d)

### Added
- 

### Changed
- 

### Fixed
- 

$(tail -n +2 CHANGELOG.md)
EOF
mv CHANGELOG.md.new CHANGELOG.md

# 4. 提交更改
git add Cargo.toml Cargo.lock CHANGELOG.md
git commit -m "chore: bump version to ${NEW_VERSION}"
git tag -a "v${NEW_VERSION}" -m "Release version ${NEW_VERSION}"

# 5. 发布到 crates.io
echo "发布到 crates.io..."
cargo publish --dry-run
read -p "确认发布? (y/n) " confirm
if [ "$confirm" = "y" ]; then
    cargo publish
    git push origin main
    git push origin "v${NEW_VERSION}"
    echo "✅ 发布完成！"
fi
```

---

## 8. CI/CD 集成

### 8.1 GitHub Actions 工作流

```yaml
# .github/workflows/dependency-check.yml

name: Dependency Security Check

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    # 每周一凌晨 3 点运行
    - cron: '0 3 * * 1'

env:
  RUST_VERSION: '1.90'
  CARGO_TERM_COLOR: always

jobs:
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: ${{ env.RUST_VERSION }}
      
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Install cargo-audit
        run: cargo install cargo-audit --locked
      
      - name: Run security audit
        run: cargo audit --deny warnings
      
      - name: Upload audit report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: audit-report
          path: audit-report.json
  
  dependency-check:
    name: Dependency Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: ${{ env.RUST_VERSION }}
      
      - name: Install cargo-deny
        run: cargo install cargo-deny --locked
      
      - name: Check licenses
        run: cargo deny check licenses
      
      - name: Check advisories
        run: cargo deny check advisories
      
      - name: Check bans
        run: cargo deny check bans
      
      - name: Check sources
        run: cargo deny check sources
  
  outdated-check:
    name: Check Outdated Dependencies
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: ${{ env.RUST_VERSION }}
      
      - name: Install cargo-outdated
        run: cargo install cargo-outdated --locked
      
      - name: Check outdated dependencies
        run: cargo outdated --root-deps-only --exit-code 1
        continue-on-error: true
      
      - name: Create issue for outdated deps
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '📦 发现过时的依赖',
              body: '自动依赖检查发现过时的依赖项。请运行 `cargo outdated` 查看详情。',
              labels: ['dependencies', 'maintenance']
            })
```

---

## 9. 漏洞响应流程

### 9.1 应急响应脚本

```bash
#!/bin/bash
# scripts/emergency-patch.sh

set -euo pipefail

VULNERABLE_CRATE=$1
SAFE_VERSION=$2

echo "🚨 紧急修复漏洞: ${VULNERABLE_CRATE}"

# 1. 创建修复分支
BRANCH_NAME="security/fix-${VULNERABLE_CRATE}-$(date +%Y%m%d)"
git checkout -b "${BRANCH_NAME}"

# 2. 更新到安全版本
echo "更新 ${VULNERABLE_CRATE} 到 ${SAFE_VERSION}..."
cargo update -p "${VULNERABLE_CRATE}" --precise "${SAFE_VERSION}"

# 3. 运行测试
echo "运行测试..."
cargo test --all-features || {
    echo "❌ 测试失败！需要手动修复"
    exit 1
}

# 4. 安全审计
echo "执行安全审计..."
cargo audit || {
    echo "⚠️  仍存在安全问题"
}

# 5. 提交更改
git add Cargo.lock Cargo.toml
git commit -m "security: update ${VULNERABLE_CRATE} to ${SAFE_VERSION}

Addresses security vulnerability RUSTSEC-XXXX-XXXX"

# 6. 创建 PR
gh pr create \
    --title "🔒 Security: Update ${VULNERABLE_CRATE} to ${SAFE_VERSION}" \
    --body "## Security Fix

Vulnerability: RUSTSEC-XXXX-XXXX
Affected Package: ${VULNERABLE_CRATE}
Safe Version: ${SAFE_VERSION}

### Changes
- Updated ${VULNERABLE_CRATE} to ${SAFE_VERSION}

### Testing
- [x] All tests pass
- [x] Security audit clean

**Priority: URGENT**" \
    --label "security,urgent" \
    --assignee "@security-team"

echo "✅ 紧急修复 PR 已创建！"
```

---

## 10. 工具链推荐

### 10.1 必备工具清单

```bash
#!/bin/bash
# scripts/install-tools.sh

echo "安装 Rust 依赖管理工具链..."

# 核心工具
cargo install --locked \
    cargo-audit \          # 安全审计
    cargo-deny \           # 依赖策略
    cargo-edit \           # 编辑依赖
    cargo-outdated \       # 检查过时依赖
    cargo-tree \           # 依赖树
    cargo-update \         # 更新工具
    cargo-supply-chain \   # 供应链审计
    cargo-geiger \         # unsafe 代码检测
    cargo-machete \        # 未使用依赖检测
    cargo-license          # 许可证审计

echo "✅ 工具安装完成！"
```

---

## 📊 总结

### 核心要点

1. **版本管理**: 使用工作区统一依赖版本
2. **安全审计**: 自动化 cargo-audit 和 cargo-deny
3. **供应链**: 定期审计贡献者和发布者
4. **CI/CD**: 完整的自动化检查流程
5. **应急响应**: 快速修复安全漏洞

### 最佳实践清单

✅ **推荐**:

- 工作区统一管理依赖版本
- CI/CD 中集成安全检查
- 定期更新依赖
- 使用语义化版本
- 提交 Cargo.lock（二进制项目）

❌ **避免**:

- 使用通配符版本
- Git 依赖在生产环境
- 忽略安全告警
- 手动管理多版本依赖

---

**文档版本**: v2.5  
**最后更新**: 2025年10月11日  
**维护**: <security@example.com>  
**许可证**: MIT OR Apache-2.0
