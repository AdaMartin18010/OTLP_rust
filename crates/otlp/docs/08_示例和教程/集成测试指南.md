# é›†æˆæµ‹è¯•æŒ‡å—

## EnhancedOtlpClient ä¸ OpenTelemetry Collector

---

## ğŸ“‹ ç›®å½•

1. [æµ‹è¯•ç¯å¢ƒè®¾ç½®](#-æµ‹è¯•ç¯å¢ƒè®¾ç½®)
2. [Docker Compose é…ç½®](#-docker-compose-é…ç½®)
3. [é›†æˆæµ‹è¯•ç¤ºä¾‹](#-é›†æˆæµ‹è¯•ç¤ºä¾‹)
4. [éªŒè¯ OTLP å…¼å®¹æ€§](#-éªŒè¯-otlp-å…¼å®¹æ€§)
5. [æ•…éšœæ’æŸ¥](#-æ•…éšœæ’æŸ¥)

---

## ğŸš€ æµ‹è¯•ç¯å¢ƒè®¾ç½®

### 1. å®‰è£… Docker

ç¡®ä¿å·²å®‰è£… Docker å’Œ Docker Composeã€‚

```bash
docker --version
docker-compose --version
```

### 2. åˆ›å»ºæµ‹è¯•ç›®å½•

```bash
mkdir -p otlp/tests/integration
cd otlp/tests/integration
```

---

## ğŸ³ Docker Compose é…ç½®

### åˆ›å»º `docker-compose.yml`

```yaml
version: '3.8'

services:
  # OpenTelemetry Collector
  otel-collector:
    image: otel/opentelemetry-collector:latest
    container_name: otlp-collector
    command: ["--config=/etc/otel-collector-config.yaml"]
    volumes:
      - ./otel-collector-config.yaml:/etc/otel-collector-config.yaml
    ports:
      - "4317:4317"  # OTLP gRPC
      - "4318:4318"  # OTLP HTTP
      - "8888:8888"  # Prometheus metrics
      - "13133:13133" # Health check
    networks:
      - otlp-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "http://localhost:13133/"]
      interval: 5s
      timeout: 3s
      retries: 5

  # Jaeger (ç”¨äºæŸ¥çœ‹ traces)
  jaeger:
    image: jaegertracing/all-in-one:latest
    container_name: otlp-jaeger
    ports:
      - "16686:16686"  # Jaeger UI
      - "14250:14250"  # gRPC
    environment:
      - COLLECTOR_OTLP_ENABLED=true
    networks:
      - otlp-network

networks:
  otlp-network:
    driver: bridge
```

### åˆ›å»º `otel-collector-config.yaml`

```yaml
receivers:
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        endpoint: 0.0.0.0:4318

processors:
  batch:
    timeout: 1s
    send_batch_size: 1024

exporters:
  logging:
    loglevel: debug

  jaeger:
    endpoint: jaeger:14250
    tls:
      insecure: true

  prometheus:
    endpoint: "0.0.0.0:8889"

service:
  pipelines:
    traces:
      receivers: [otlp]
      processors: [batch]
      exporters: [logging, jaeger]

    metrics:
      receivers: [otlp]
      processors: [batch]
      exporters: [logging, prometheus]

  telemetry:
    logs:
      level: debug
```

### å¯åŠ¨ç¯å¢ƒ

```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose up -d

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f otel-collector

# æ£€æŸ¥å¥åº·çŠ¶æ€
curl http://localhost:13133/
```

### åœæ­¢ç¯å¢ƒ

```bash
docker-compose down
```

---

## ğŸ§ª é›†æˆæµ‹è¯•ç¤ºä¾‹

### æµ‹è¯•æ–‡ä»¶: `otlp/tests/integration_test.rs`

```rust
//! é›†æˆæµ‹è¯• - éªŒè¯ä¸ OpenTelemetry Collector çš„äº’æ“ä½œæ€§
//!
//! è¿è¡Œå‰ç¡®ä¿:
//! 1. Docker Compose ç¯å¢ƒå·²å¯åŠ¨
//! 2. OpenTelemetry Collector è¿è¡Œåœ¨ localhost:4317

use otlp::core::EnhancedOtlpClient;
use opentelemetry::{
    trace::{Tracer, Status},
    KeyValue,
};
use std::time::Duration;

/// æµ‹è¯•åŸºæœ¬çš„ span å¯¼å‡º
#[tokio::test]
#[ignore] // é»˜è®¤è·³è¿‡ï¼Œéœ€è¦æ‰‹åŠ¨è¿è¡Œ
async fn test_basic_span_export() -> Result<(), Box<dyn std::error::Error>> {
    println!("ğŸ§ª æµ‹è¯•åŸºæœ¬ Span å¯¼å‡º...");

    // åˆ›å»ºå®¢æˆ·ç«¯
    let client = EnhancedOtlpClient::builder()
        .with_endpoint("http://localhost:4317")
        .with_service_name("integration-test")
        .with_timeout(Duration::from_secs(10))
        .build()
        .await?;

    println!("âœ… å®¢æˆ·ç«¯åˆ›å»ºæˆåŠŸ");

    // è·å– tracer
    let tracer = client.tracer("test-tracer");

    // åˆ›å»º span
    let span = tracer.start("test-operation");

    // æ¨¡æ‹Ÿå·¥ä½œ
    tokio::time::sleep(Duration::from_millis(100)).await;

    drop(span);

    println!("âœ… Span å·²åˆ›å»ºå’Œç»“æŸ");

    // ç­‰å¾…å¯¼å‡º
    tokio::time::sleep(Duration::from_secs(2)).await;

    // æ£€æŸ¥ç»Ÿè®¡
    let stats = client.stats().await;
    println!("ğŸ“Š ç»Ÿè®¡:");
    println!("  - å¯¼å‡ºçš„ spans: {}", stats.spans_exported);
    println!("  - å¯¼å‡ºé”™è¯¯: {}", stats.export_errors);

    // å…³é—­å®¢æˆ·ç«¯
    client.shutdown().await?;

    println!("âœ… æµ‹è¯•å®Œæˆ");

    Ok(())
}

/// æµ‹è¯•åµŒå¥— spans
#[tokio::test]
#[ignore]
async fn test_nested_spans() -> Result<(), Box<dyn std::error::Error>> {
    println!("ğŸ§ª æµ‹è¯•åµŒå¥— Spans...");

    let client = EnhancedOtlpClient::builder()
        .with_endpoint("http://localhost:4317")
        .with_service_name("nested-test")
        .build()
        .await?;

    let tracer = client.tracer("nested-tracer");

    // çˆ¶ span
    let parent = tracer.start("parent-operation");

    // å­ spans
    for i in 0..3 {
        let child = tracer.start(format!("child-operation-{}", i));
        tokio::time::sleep(Duration::from_millis(50)).await;
        drop(child);
    }

    drop(parent);

    println!("âœ… åµŒå¥— Spans åˆ›å»ºå®Œæˆ");

    tokio::time::sleep(Duration::from_secs(2)).await;

    let stats = client.stats().await;
    println!("ğŸ“Š å¯¼å‡ºçš„ spans: {}", stats.spans_exported);

    client.shutdown().await?;

    Ok(())
}

/// æµ‹è¯• span å±æ€§å’Œäº‹ä»¶
#[tokio::test]
#[ignore]
async fn test_span_attributes_and_events() -> Result<(), Box<dyn std::error::Error>> {
    println!("ğŸ§ª æµ‹è¯• Span å±æ€§å’Œäº‹ä»¶...");

    let client = EnhancedOtlpClient::builder()
        .with_endpoint("http://localhost:4317")
        .with_service_name("attributes-test")
        .build()
        .await?;

    let tracer = client.tracer("attributes-tracer");
    let mut span = tracer.start("operation-with-attributes");

    // æ·»åŠ å±æ€§
    span.set_attribute(KeyValue::new("user.id", "12345"));
    span.set_attribute(KeyValue::new("request.method", "GET"));
    span.set_attribute(KeyValue::new("response.status", 200));

    // æ·»åŠ äº‹ä»¶
    span.add_event("Processing started", vec![
        KeyValue::new("item.count", 10),
        KeyValue::new("batch.size", 100),
    ]);

    tokio::time::sleep(Duration::from_millis(50)).await;

    span.add_event("Processing completed", vec![
        KeyValue::new("items.processed", 10),
    ]);

    // è®¾ç½®çŠ¶æ€
    span.set_status(Status::Ok);

    drop(span);

    println!("âœ… å±æ€§å’Œäº‹ä»¶å·²æ·»åŠ ");

    tokio::time::sleep(Duration::from_secs(2)).await;

    client.shutdown().await?;

    Ok(())
}

/// æµ‹è¯•å¹¶å‘ spans
#[tokio::test]
#[ignore]
async fn test_concurrent_spans() -> Result<(), Box<dyn std::error::Error>> {
    println!("ğŸ§ª æµ‹è¯•å¹¶å‘ Spans...");

    use std::sync::Arc;

    let client = Arc::new(
        EnhancedOtlpClient::builder()
            .with_endpoint("http://localhost:4317")
            .with_service_name("concurrent-test")
            .build()
            .await?
    );

    let mut handles = vec![];

    // åˆ›å»º 10 ä¸ªå¹¶å‘ä»»åŠ¡
    for i in 0..10 {
        let client_clone = Arc::clone(&client);
        let handle = tokio::spawn(async move {
            let tracer = client_clone.tracer(format!("worker-{}", i));
            let span = tracer.start(format!("concurrent-task-{}", i));

            tokio::time::sleep(Duration::from_millis(100)).await;

            drop(span);
        });

        handles.push(handle);
    }

    // ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
    for handle in handles {
        handle.await?;
    }

    println!("âœ… æ‰€æœ‰å¹¶å‘ä»»åŠ¡å®Œæˆ");

    tokio::time::sleep(Duration::from_secs(2)).await;

    let stats = client.stats().await;
    println!("ğŸ“Š æ€»å…±å¯¼å‡º {} ä¸ª spans", stats.spans_exported);

    client.shutdown().await?;

    Ok(())
}

/// æµ‹è¯•é”™è¯¯å¤„ç†
#[tokio::test]
#[ignore]
async fn test_error_handling() -> Result<(), Box<dyn std::error::Error>> {
    println!("ğŸ§ª æµ‹è¯•é”™è¯¯å¤„ç†...");

    let client = EnhancedOtlpClient::builder()
        .with_endpoint("http://localhost:4317")
        .with_service_name("error-test")
        .build()
        .await?;

    let tracer = client.tracer("error-tracer");
    let mut span = tracer.start("operation-with-error");

    // æ¨¡æ‹Ÿé”™è¯¯
    span.set_attribute(KeyValue::new("error.type", "DatabaseError"));
    span.set_attribute(KeyValue::new("error.message", "Connection timeout"));
    span.set_status(Status::error("Database connection failed"));

    drop(span);

    println!("âœ… é”™è¯¯ Span å·²åˆ›å»º");

    tokio::time::sleep(Duration::from_secs(2)).await;

    client.shutdown().await?;

    Ok(())
}

/// æ€§èƒ½æµ‹è¯• - å¤§é‡ spans
#[tokio::test]
#[ignore]
async fn test_high_volume_spans() -> Result<(), Box<dyn std::error::Error>> {
    println!("ğŸ§ª æµ‹è¯•é«˜å®¹é‡ Spans (1000ä¸ª)...");

    let client = EnhancedOtlpClient::builder()
        .with_endpoint("http://localhost:4317")
        .with_service_name("high-volume-test")
        .with_performance_optimization(true)
        .build()
        .await?;

    let tracer = client.tracer("volume-tracer");

    let start = std::time::Instant::now();

    // åˆ›å»º 1000 ä¸ª spans
    for i in 0..1000 {
        let span = tracer.start(format!("span-{}", i));
        drop(span);
    }

    let duration = start.elapsed();
    println!("âœ… åˆ›å»º 1000 ä¸ª spans è€—æ—¶: {:?}", duration);

    tokio::time::sleep(Duration::from_secs(3)).await;

    let stats = client.stats().await;
    println!("ğŸ“Š å¯¼å‡ºçš„ spans: {}", stats.spans_exported);
    println!("ğŸ“Š å¹³å‡å¯¼å‡ºæ—¶é—´: {}ms", stats.avg_export_time_ms);

    client.shutdown().await?;

    Ok(())
}
```

### è¿è¡Œé›†æˆæµ‹è¯•

```bash
# å¯åŠ¨ Docker Compose ç¯å¢ƒ
docker-compose up -d

# è¿è¡Œæ‰€æœ‰é›†æˆæµ‹è¯• (åŒ…æ‹¬ ignored)
cargo test --test integration_test -- --ignored --nocapture

# è¿è¡Œå•ä¸ªæµ‹è¯•
cargo test --test integration_test test_basic_span_export -- --ignored --nocapture

# æŸ¥çœ‹ Jaeger UI ä¸­çš„ traces
# æ‰“å¼€æµè§ˆå™¨: http://localhost:16686
```

---

## âœ… éªŒè¯ OTLP å…¼å®¹æ€§

### 1. æ£€æŸ¥ Collector å¥åº·çŠ¶æ€

```bash
curl http://localhost:13133/
```

**é¢„æœŸè¾“å‡º**:

```json
{"status":"Server available","upSince":"..."}
```

### 2. æŸ¥çœ‹ Collector æ—¥å¿—

```bash
docker-compose logs -f otel-collector
```

**æŸ¥æ‰¾å…³é”®ä¿¡æ¯**:

```text
Traces received: X
Spans exported: Y
```

### 3. åœ¨ Jaeger UI ä¸­éªŒè¯

1. æ‰“å¼€ <http://localhost:16686>
2. é€‰æ‹©æœåŠ¡åç§° (å¦‚ `integration-test`)
3. ç‚¹å‡» "Find Traces"
4. æŸ¥çœ‹å¯¼å‡ºçš„ traces å’Œ spans

### 4. éªŒè¯ span æ•°æ®å®Œæ•´æ€§

æ£€æŸ¥ä»¥ä¸‹å­—æ®µ:

- âœ… Trace ID
- âœ… Span ID
- âœ… Parent Span ID (åµŒå¥— spans)
- âœ… Operation Name
- âœ… Start Time / End Time
- âœ… Duration
- âœ… Attributes
- âœ… Events
- âœ… Status

---

## ğŸ”§ æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: æ— æ³•è¿æ¥åˆ° Collector

**ç—‡çŠ¶**:

```text
Error: Failed to build exporter: Connection refused
```

**è§£å†³æ–¹æ¡ˆ**:

1. æ£€æŸ¥ Docker å®¹å™¨çŠ¶æ€:

   ```bash
   docker ps | grep otel-collector
   ```

2. æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨:

   ```bash
   netstat -an | grep 4317
   ```

3. é‡å¯å®¹å™¨:

   ```bash
   docker-compose restart otel-collector
   ```

### é—®é¢˜ 2: Spans æœªåœ¨ Jaeger ä¸­æ˜¾ç¤º

**æ£€æŸ¥æ­¥éª¤**:

1. **æŸ¥çœ‹ Collector æ—¥å¿—**:

   ```bash
   docker-compose logs otel-collector | grep "Traces received"
   ```

2. **éªŒè¯é…ç½®**:
   ç¡®ä¿ `otel-collector-config.yaml` ä¸­çš„ pipeline é…ç½®æ­£ç¡®

3. **æ£€æŸ¥ Jaeger è¿æ¥**:

   ```bash
   docker-compose logs jaeger
   ```

### é—®é¢˜ 3: æµ‹è¯•è¶…æ—¶

**è°ƒæ•´**:

```rust
let client = EnhancedOtlpClient::builder()
    .with_endpoint("http://localhost:4317")
    .with_timeout(Duration::from_secs(30))  // å¢åŠ è¶…æ—¶
    .build()
    .await?;
```

---

## ğŸ“Š æ€§èƒ½åŸºå‡†

### é¢„æœŸæŒ‡æ ‡

```text
æ“ä½œ                        é¢„æœŸæ€§èƒ½
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
åˆ›å»ºå•ä¸ª span              < 1ms
å¯¼å‡º 100 spans            < 100ms
å¯¼å‡º 1000 spans           < 1s
å¹¶å‘åˆ›å»º 10 spans          < 500ms
```

### ç›‘æ§æŒ‡æ ‡

```bash
# Prometheus metrics
curl http://localhost:8888/metrics
```

---

## ğŸ“– ç›¸å…³èµ„æº

- [OpenTelemetry Collector æ–‡æ¡£](https://opentelemetry.io/docs/collector/)
- [OTLP è§„èŒƒ](https://github.com/open-telemetry/opentelemetry-specification/blob/main/specification/protocol/otlp.md)
- [Jaeger æ–‡æ¡£](https://www.jaegertracing.io/docs/)

---

**æœ€åæ›´æ–°**: 2025-10-18
**ç‰ˆæœ¬**: 0.1.0

---
