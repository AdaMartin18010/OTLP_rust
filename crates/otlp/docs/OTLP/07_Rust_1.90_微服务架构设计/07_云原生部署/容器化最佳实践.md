# å®¹å™¨åŒ–æœ€ä½³å®è·µ

## ç›®å½•

- [å®¹å™¨åŒ–æœ€ä½³å®è·µ](#å®¹å™¨åŒ–æœ€ä½³å®è·µ)
  - [ç›®å½•](#ç›®å½•)
  - [ğŸ“‹ æ¦‚è¿°](#-æ¦‚è¿°)
  - [ğŸ³ Dockerfile ä¼˜åŒ–](#-dockerfile-ä¼˜åŒ–)
    - [1. å¤šé˜¶æ®µæ„å»º](#1-å¤šé˜¶æ®µæ„å»º)
    - [2. æœ€å°åŒ–é•œåƒå¤§å°](#2-æœ€å°åŒ–é•œåƒå¤§å°)
  - [ğŸ”’ å®‰å…¨åŠ å›º](#-å®‰å…¨åŠ å›º)
  - [âš¡ æ€§èƒ½ä¼˜åŒ–](#-æ€§èƒ½ä¼˜åŒ–)
  - [ğŸ¯ æœ€ä½³å®è·µ](#-æœ€ä½³å®è·µ)

## ğŸ“‹ æ¦‚è¿°

å®¹å™¨åŒ–æ˜¯äº‘åŸç”Ÿåº”ç”¨çš„åŸºç¡€,é€šè¿‡éµå¾ªæœ€ä½³å®è·µ,å¯ä»¥æ„å»ºå‡ºå®‰å…¨ã€é«˜æ•ˆã€å¯ç»´æŠ¤çš„å®¹å™¨é•œåƒã€‚

## ğŸ³ Dockerfile ä¼˜åŒ–

### 1. å¤šé˜¶æ®µæ„å»º

```dockerfile
# æ„å»ºé˜¶æ®µ
FROM rust:1.90 AS builder

WORKDIR /app

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY Cargo.toml Cargo.lock ./

# æ„å»ºä¾èµ– (ç¼“å­˜å±‚)
RUN mkdir src && \
    echo "fn main() {}" > src/main.rs && \
    cargo build --release && \
    rm -rf src

# å¤åˆ¶æºä»£ç 
COPY src ./src

# æ„å»ºåº”ç”¨
RUN cargo build --release

# è¿è¡Œé˜¶æ®µ
FROM debian:bookworm-slim

# å®‰è£…è¿è¡Œæ—¶ä¾èµ–
RUN apt-get update && \
    apt-get install -y ca-certificates libssl3 && \
    rm -rf /var/lib/apt/lists/*

# åˆ›å»ºé root ç”¨æˆ·
RUN useradd -m -u 1000 appuser

WORKDIR /app

# ä»æ„å»ºé˜¶æ®µå¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶
COPY --from=builder /app/target/release/my-service /app/my-service

# åˆ‡æ¢åˆ°é root ç”¨æˆ·
USER appuser

# æš´éœ²ç«¯å£
EXPOSE 8080

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD ["/app/my-service", "health-check"]

# å¯åŠ¨åº”ç”¨
ENTRYPOINT ["/app/my-service"]
```

### 2. æœ€å°åŒ–é•œåƒå¤§å°

```dockerfile
# ä½¿ç”¨ distroless é•œåƒ
FROM gcr.io/distroless/cc-debian12

COPY --from=builder /app/target/release/my-service /app/my-service

USER nonroot:nonroot

ENTRYPOINT ["/app/my-service"]
```

## ğŸ”’ å®‰å…¨åŠ å›º

```dockerfile
# 1. ä½¿ç”¨ç‰¹å®šç‰ˆæœ¬æ ‡ç­¾
FROM rust:1.90.0

# 2. æ‰«ææ¼æ´
RUN apt-get update && \
    apt-get upgrade -y && \
    apt-get install -y --no-install-recommends ca-certificates && \
    rm -rf /var/lib/apt/lists/*

# 3. ä¸ä»¥ root è¿è¡Œ
USER 1000:1000

# 4. åªè¯»æ–‡ä»¶ç³»ç»Ÿ
VOLUME ["/tmp"]

# 5. åˆ é™¤ä¸å¿…è¦çš„å·¥å…·
RUN rm -rf /usr/bin/wget /usr/bin/curl
```

## âš¡ æ€§èƒ½ä¼˜åŒ–

```rust
/// å®¹å™¨å¯åŠ¨ä¼˜åŒ–
pub struct ContainerOptimizer;

impl ContainerOptimizer {
    /// é¢„çƒ­ç¼“å­˜
    pub async fn warmup_cache() -> Result<(), OptimizerError> {
        // é¢„åŠ è½½é…ç½®
        let _ = load_config().await?;
        
        // é¢„å»ºç«‹æ•°æ®åº“è¿æ¥æ± 
        let _ = init_db_pool().await?;
        
        // é¢„ç¼–è¯‘æ­£åˆ™è¡¨è¾¾å¼
        let _ = compile_regexes()?;
        
        Ok(())
    }
    
    /// ä¼˜é›…å…³é—­
    pub async fn graceful_shutdown(signal: Signal) -> Result<(), OptimizerError> {
        tracing::info!("Received shutdown signal: {:?}", signal);
        
        // 1. åœæ­¢æ¥æ”¶æ–°è¯·æ±‚
        stop_accepting_requests().await?;
        
        // 2. ç­‰å¾…ç°æœ‰è¯·æ±‚å®Œæˆ (æœ€å¤š 30 ç§’)
        wait_for_active_requests(Duration::from_secs(30)).await?;
        
        // 3. å…³é—­æ•°æ®åº“è¿æ¥
        close_db_connections().await?;
        
        tracing::info!("Graceful shutdown completed");
        Ok(())
    }
}
```

## ğŸ¯ æœ€ä½³å®è·µ

1. **åˆ†å±‚ç¼“å­˜**: åˆç†å®‰æ’ Dockerfile æŒ‡ä»¤é¡ºåº,æœ€å¤§åŒ–ç¼“å­˜åˆ©ç”¨
2. **æœ€å°æƒé™**: ä½¿ç”¨é root ç”¨æˆ·è¿è¡Œå®¹å™¨
3. **å¥åº·æ£€æŸ¥**: é…ç½®å¥åº·æ£€æŸ¥ç«¯ç‚¹
4. **æ—¥å¿—è¾“å‡º**: æ—¥å¿—è¾“å‡ºåˆ° stdout/stderr
5. **é•œåƒæ‰«æ**: å®šæœŸæ‰«æé•œåƒæ¼æ´

---

**æ€»ç»“**: éµå¾ªå®¹å™¨åŒ–æœ€ä½³å®è·µ,å¯ä»¥æ„å»ºå‡ºå®‰å…¨ã€é«˜æ•ˆã€å¯ç»´æŠ¤çš„å®¹å™¨é•œåƒã€‚
