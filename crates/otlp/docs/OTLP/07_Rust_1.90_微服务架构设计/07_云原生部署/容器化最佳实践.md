# 容器化最佳实践

## 目录

- [容器化最佳实践](#容器化最佳实践)
  - [目录](#目录)
  - [📋 概述](#-概述)
  - [🐳 Dockerfile 优化](#-dockerfile-优化)
    - [1. 多阶段构建](#1-多阶段构建)
    - [2. 最小化镜像大小](#2-最小化镜像大小)
  - [🔒 安全加固](#-安全加固)
  - [⚡ 性能优化](#-性能优化)
  - [🎯 最佳实践](#-最佳实践)

## 📋 概述

容器化是云原生应用的基础,通过遵循最佳实践,可以构建出安全、高效、可维护的容器镜像。

## 🐳 Dockerfile 优化

### 1. 多阶段构建

```dockerfile
# 构建阶段
FROM rust:1.90 AS builder

WORKDIR /app

# 复制依赖文件
COPY Cargo.toml Cargo.lock ./

# 构建依赖 (缓存层)
RUN mkdir src && \
    echo "fn main() {}" > src/main.rs && \
    cargo build --release && \
    rm -rf src

# 复制源代码
COPY src ./src

# 构建应用
RUN cargo build --release

# 运行阶段
FROM debian:bookworm-slim

# 安装运行时依赖
RUN apt-get update && \
    apt-get install -y ca-certificates libssl3 && \
    rm -rf /var/lib/apt/lists/*

# 创建非 root 用户
RUN useradd -m -u 1000 appuser

WORKDIR /app

# 从构建阶段复制二进制文件
COPY --from=builder /app/target/release/my-service /app/my-service

# 切换到非 root 用户
USER appuser

# 暴露端口
EXPOSE 8080

# 健康检查
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD ["/app/my-service", "health-check"]

# 启动应用
ENTRYPOINT ["/app/my-service"]
```

### 2. 最小化镜像大小

```dockerfile
# 使用 distroless 镜像
FROM gcr.io/distroless/cc-debian12

COPY --from=builder /app/target/release/my-service /app/my-service

USER nonroot:nonroot

ENTRYPOINT ["/app/my-service"]
```

## 🔒 安全加固

```dockerfile
# 1. 使用特定版本标签
FROM rust:1.90.0

# 2. 扫描漏洞
RUN apt-get update && \
    apt-get upgrade -y && \
    apt-get install -y --no-install-recommends ca-certificates && \
    rm -rf /var/lib/apt/lists/*

# 3. 不以 root 运行
USER 1000:1000

# 4. 只读文件系统
VOLUME ["/tmp"]

# 5. 删除不必要的工具
RUN rm -rf /usr/bin/wget /usr/bin/curl
```

## ⚡ 性能优化

```rust
/// 容器启动优化
pub struct ContainerOptimizer;

impl ContainerOptimizer {
    /// 预热缓存
    pub async fn warmup_cache() -> Result<(), OptimizerError> {
        // 预加载配置
        let _ = load_config().await?;
        
        // 预建立数据库连接池
        let _ = init_db_pool().await?;
        
        // 预编译正则表达式
        let _ = compile_regexes()?;
        
        Ok(())
    }
    
    /// 优雅关闭
    pub async fn graceful_shutdown(signal: Signal) -> Result<(), OptimizerError> {
        tracing::info!("Received shutdown signal: {:?}", signal);
        
        // 1. 停止接收新请求
        stop_accepting_requests().await?;
        
        // 2. 等待现有请求完成 (最多 30 秒)
        wait_for_active_requests(Duration::from_secs(30)).await?;
        
        // 3. 关闭数据库连接
        close_db_connections().await?;
        
        tracing::info!("Graceful shutdown completed");
        Ok(())
    }
}
```

## 🎯 最佳实践

1. **分层缓存**: 合理安排 Dockerfile 指令顺序,最大化缓存利用
2. **最小权限**: 使用非 root 用户运行容器
3. **健康检查**: 配置健康检查端点
4. **日志输出**: 日志输出到 stdout/stderr
5. **镜像扫描**: 定期扫描镜像漏洞

---

**总结**: 遵循容器化最佳实践,可以构建出安全、高效、可维护的容器镜像。
