# æœåŠ¡ç½‘æ ¼ç›‘æ§

## ç›®å½•

- [æœåŠ¡ç½‘æ ¼ç›‘æ§](#æœåŠ¡ç½‘æ ¼ç›‘æ§)
  - [ç›®å½•](#ç›®å½•)
  - [ğŸ“‹ æ¦‚è¿°](#-æ¦‚è¿°)
  - [ğŸ¯ æœåŠ¡ç½‘æ ¼ç›‘æ§æ¶æ„](#-æœåŠ¡ç½‘æ ¼ç›‘æ§æ¶æ„)
  - [ğŸ“Š æ ¸å¿ƒç›‘æ§æŒ‡æ ‡](#-æ ¸å¿ƒç›‘æ§æŒ‡æ ‡)
    - [1. æµé‡æŒ‡æ ‡ (Golden Signals)](#1-æµé‡æŒ‡æ ‡-golden-signals)
    - [2. æœåŠ¡ç½‘æ ¼æ§åˆ¶å¹³é¢æŒ‡æ ‡](#2-æœåŠ¡ç½‘æ ¼æ§åˆ¶å¹³é¢æŒ‡æ ‡)
    - [3. æ•°æ®å¹³é¢æŒ‡æ ‡](#3-æ•°æ®å¹³é¢æŒ‡æ ‡)
  - [ğŸ” OTLP é›†æˆ](#-otlp-é›†æˆ)
    - [1. Envoy Sidecar OTLP å¯¼å‡º](#1-envoy-sidecar-otlp-å¯¼å‡º)
    - [2. Istio é¥æµ‹é›†æˆ](#2-istio-é¥æµ‹é›†æˆ)
  - [ğŸ“ˆ å¯è§†åŒ–ä¸å‘Šè­¦](#-å¯è§†åŒ–ä¸å‘Šè­¦)
  - [ğŸ¯ æœ€ä½³å®è·µ](#-æœ€ä½³å®è·µ)

## ğŸ“‹ æ¦‚è¿°

æœåŠ¡ç½‘æ ¼ç›‘æ§æ˜¯ç¡®ä¿å¾®æœåŠ¡ç³»ç»Ÿå¯è§‚æµ‹æ€§çš„å…³é”®ç»„ä»¶ã€‚é€šè¿‡ OTLP åè®®,æˆ‘ä»¬å¯ä»¥ç»Ÿä¸€æ”¶é›†æœåŠ¡ç½‘æ ¼çš„æŒ‡æ ‡ã€è¿½è¸ªå’Œæ—¥å¿—æ•°æ®,å®ç°å…¨é¢çš„å¯è§‚æµ‹æ€§ã€‚

## ğŸ¯ æœåŠ¡ç½‘æ ¼ç›‘æ§æ¶æ„

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æœåŠ¡ç½‘æ ¼ç›‘æ§æ¶æ„                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  Service A   â”‚    â”‚  Service B   â”‚    â”‚  Service C   â”‚       â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚       â”‚
â”‚  â”‚  â”‚  App   â”‚  â”‚    â”‚  â”‚  App   â”‚  â”‚    â”‚  â”‚  App   â”‚  â”‚       â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜  â”‚    â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜  â”‚    â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜  â”‚       â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”  â”‚    â”‚  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”  â”‚    â”‚  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”  â”‚       â”‚
â”‚  â”‚  â”‚ Envoy  â”‚â”€â”€â”¼â”€â”€â”€â”¼â”€â–¶â”‚ Envoy  â”‚â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â–¶â”‚ Envoy  â”‚  â”‚       â”‚
â”‚  â”‚  â”‚Sidecar â”‚  â”‚    â”‚  â”‚Sidecar â”‚  â”‚    â”‚  â”‚Sidecar â”‚  â”‚       â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜  â”‚    â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜  â”‚    â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜  â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚          â”‚ OTLP              â”‚ OTLP              â”‚ OTLP         â”‚
â”‚          â”‚                   â”‚                   â”‚              â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                              â”‚                                  â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚                    â”‚ OTLP Collector    â”‚                        â”‚
â”‚                    â”‚ (èšåˆ & å¤„ç†)      â”‚                        â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                              â”‚                                  â”‚
â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚          â”‚                   â”‚                   â”‚              â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”         â”‚
â”‚    â”‚  Jaeger   â”‚       â”‚Prometheus â”‚      â”‚    ELK    â”‚         â”‚
â”‚    â”‚ (Traces)  â”‚       â”‚ (Metrics) â”‚      â”‚  (Logs)   â”‚         â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“Š æ ¸å¿ƒç›‘æ§æŒ‡æ ‡

### 1. æµé‡æŒ‡æ ‡ (Golden Signals)

```rust
use prometheus::{Counter, Histogram, Gauge};

/// æœåŠ¡ç½‘æ ¼æµé‡æŒ‡æ ‡æ”¶é›†å™¨
pub struct ServiceMeshMetrics {
    /// è¯·æ±‚æ€»æ•°
    request_total: Counter,
    
    /// è¯·æ±‚å»¶è¿Ÿ
    request_duration: Histogram,
    
    /// é”™è¯¯ç‡
    error_rate: Counter,
    
    /// é¥±å’Œåº¦ (å¹¶å‘è¿æ¥æ•°)
    active_connections: Gauge,
}

impl ServiceMeshMetrics {
    pub fn new() -> Result<Self, prometheus::Error> {
        Ok(Self {
            request_total: Counter::new(
                "service_mesh_requests_total",
                "Total number of requests"
            )?,
            request_duration: Histogram::new(
                "service_mesh_request_duration_seconds",
                "Request duration in seconds"
            )?,
            error_rate: Counter::new(
                "service_mesh_errors_total",
                "Total number of errors"
            )?,
            active_connections: Gauge::new(
                "service_mesh_active_connections",
                "Number of active connections"
            )?,
        })
    }
    
    /// è®°å½•è¯·æ±‚
    pub fn record_request(&self, duration: Duration, status_code: u16) {
        self.request_total.inc();
        self.request_duration.observe(duration.as_secs_f64());
        
        if status_code >= 500 {
            self.error_rate.inc();
        }
    }
    
    /// æ›´æ–°æ´»è·ƒè¿æ¥æ•°
    pub fn update_active_connections(&self, count: i64) {
        self.active_connections.set(count as f64);
    }
}
```

### 2. æœåŠ¡ç½‘æ ¼æ§åˆ¶å¹³é¢æŒ‡æ ‡

```rust
/// Istio æ§åˆ¶å¹³é¢æŒ‡æ ‡
pub struct ControlPlaneMetrics {
    /// Pilot æ¨é€é…ç½®æ¬¡æ•°
    pilot_xds_pushes: Counter,
    
    /// Pilot è¿æ¥çš„ Envoy æ•°é‡
    pilot_proxy_connections: Gauge,
    
    /// Citadel è¯ä¹¦ç­¾å‘æ¬¡æ•°
    citadel_cert_issuances: Counter,
    
    /// Galley é…ç½®éªŒè¯é”™è¯¯
    galley_validation_errors: Counter,
}

impl ControlPlaneMetrics {
    /// å¯¼å‡ºä¸º OTLP æŒ‡æ ‡
    pub fn export_to_otlp(&self) -> Vec<OtlpMetric> {
        vec![
            OtlpMetric {
                name: "istio_pilot_xds_pushes_total".to_string(),
                description: "Total XDS pushes from Pilot".to_string(),
                unit: "1".to_string(),
                data: MetricData::Counter {
                    data_points: vec![NumberDataPoint {
                        value: self.pilot_xds_pushes.get(),
                        time_unix_nano: SystemTime::now()
                            .duration_since(UNIX_EPOCH)
                            .unwrap()
                            .as_nanos() as u64,
                        attributes: vec![],
                        start_time_unix_nano: 0,
                    }],
                },
            },
            // ... å…¶ä»–æŒ‡æ ‡
        ]
    }
}
```

### 3. æ•°æ®å¹³é¢æŒ‡æ ‡

```rust
/// Envoy Sidecar æŒ‡æ ‡
pub struct EnvoyMetrics {
    /// ä¸Šæ¸¸è¿æ¥æ•°
    upstream_connections: Gauge,
    
    /// ä¸Šæ¸¸è¯·æ±‚æ€»æ•°
    upstream_requests: Counter,
    
    /// ä¸Šæ¸¸è¯·æ±‚å»¶è¿Ÿ
    upstream_request_duration: Histogram,
    
    /// ä¸‹æ¸¸è¿æ¥æ•°
    downstream_connections: Gauge,
    
    /// ç†”æ–­è§¦å‘æ¬¡æ•°
    circuit_breaker_trips: Counter,
}

impl EnvoyMetrics {
    /// ä» Envoy ç»Ÿè®¡ä¿¡æ¯è§£ææŒ‡æ ‡
    pub fn parse_from_envoy_stats(stats: &EnvoyStats) -> Self {
        Self {
            upstream_connections: Gauge::from_value(stats.upstream_cx_active as f64),
            upstream_requests: Counter::from_value(stats.upstream_rq_total as f64),
            upstream_request_duration: Histogram::from_samples(
                &stats.upstream_rq_time_samples
            ),
            downstream_connections: Gauge::from_value(stats.downstream_cx_active as f64),
            circuit_breaker_trips: Counter::from_value(stats.circuit_breaker_trips as f64),
        }
    }
}
```

## ğŸ” OTLP é›†æˆ

### 1. Envoy Sidecar OTLP å¯¼å‡º

```yaml
# Envoy é…ç½® - OTLP å¯¼å‡º
static_resources:
  listeners:
  - name: listener_0
    address:
      socket_address:
        address: 0.0.0.0
        port_value: 10000
    filter_chains:
    - filters:
      - name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          stat_prefix: ingress_http
          tracing:
            provider:
              name: envoy.tracers.opentelemetry
              typed_config:
                "@type": type.googleapis.com/envoy.config.trace.v3.OpenTelemetryConfig
                grpc_service:
                  envoy_grpc:
                    cluster_name: otlp_collector
                  timeout: 0.250s
                service_name: my-service
```

```rust
/// Envoy OTLP è¿½è¸ªé…ç½®
pub struct EnvoyOtlpConfig {
    pub collector_endpoint: String,
    pub service_name: String,
    pub sampling_rate: f64,
}

impl EnvoyOtlpConfig {
    /// ç”Ÿæˆ Envoy é…ç½®
    pub fn to_envoy_config(&self) -> String {
        format!(r#"
tracing:
  provider:
    name: envoy.tracers.opentelemetry
    typed_config:
      "@type": type.googleapis.com/envoy.config.trace.v3.OpenTelemetryConfig
      grpc_service:
        envoy_grpc:
          cluster_name: otlp_collector
        timeout: 0.250s
      service_name: {}
      sampler:
        name: envoy.tracers.opentelemetry.samplers.always_on
        typed_config:
          "@type": type.googleapis.com/envoy.config.trace.v3.TraceServiceConfig
"#, self.service_name)
    }
}
```

### 2. Istio é¥æµ‹é›†æˆ

```rust
/// Istio é¥æµ‹é…ç½®
pub struct IstioTelemetryConfig {
    pub otlp_endpoint: String,
    pub metrics_enabled: bool,
    pub tracing_enabled: bool,
    pub logging_enabled: bool,
}

impl IstioTelemetryConfig {
    /// ç”Ÿæˆ Istio Telemetry CRD
    pub fn to_k8s_manifest(&self) -> String {
        format!(r#"
apiVersion: telemetry.istio.io/v1alpha1
kind: Telemetry
metadata:
  name: mesh-default
  namespace: istio-system
spec:
  tracing:
  - providers:
    - name: otlp
    customTags:
      service.name:
        literal:
          value: "{{.ServiceName}}"
  metrics:
  - providers:
    - name: prometheus
  accessLogging:
  - providers:
    - name: otlp
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: istio-otlp
  namespace: istio-system
data:
  mesh: |
    extensionProviders:
    - name: otlp
      opentelemetry:
        service: opentelemetry-collector.observability.svc.cluster.local
        port: 4317
"#)
    }
}
```

## ğŸ“ˆ å¯è§†åŒ–ä¸å‘Šè­¦

```rust
/// Grafana ä»ªè¡¨æ¿ç”Ÿæˆå™¨
pub struct ServiceMeshDashboard {
    panels: Vec<DashboardPanel>,
}

impl ServiceMeshDashboard {
    /// åˆ›å»ºæœåŠ¡ç½‘æ ¼ç›‘æ§ä»ªè¡¨æ¿
    pub fn create_mesh_dashboard() -> Self {
        Self {
            panels: vec![
                // Golden Signals
                DashboardPanel::graph("Request Rate", r#"
                    rate(service_mesh_requests_total[5m])
                "#),
                DashboardPanel::graph("Error Rate", r#"
                    rate(service_mesh_errors_total[5m]) / 
                    rate(service_mesh_requests_total[5m])
                "#),
                DashboardPanel::graph("Request Duration P99", r#"
                    histogram_quantile(0.99, 
                        rate(service_mesh_request_duration_seconds_bucket[5m])
                    )
                "#),
                DashboardPanel::gauge("Active Connections", r#"
                    service_mesh_active_connections
                "#),
                
                // æœåŠ¡æ‹“æ‰‘
                DashboardPanel::service_graph("Service Topology"),
                
                // è¿½è¸ª
                DashboardPanel::traces("Recent Traces"),
            ],
        }
    }
    
    /// å¯¼å‡ºä¸º JSON
    pub fn to_json(&self) -> String {
        serde_json::to_string_pretty(&self).unwrap()
    }
}

/// å‘Šè­¦è§„åˆ™
pub struct AlertRules {
    rules: Vec<AlertRule>,
}

impl AlertRules {
    /// åˆ›å»ºæœåŠ¡ç½‘æ ¼å‘Šè­¦è§„åˆ™
    pub fn create_mesh_alerts() -> Self {
        Self {
            rules: vec![
                AlertRule {
                    name: "HighErrorRate".to_string(),
                    expr: r#"
                        rate(service_mesh_errors_total[5m]) / 
                        rate(service_mesh_requests_total[5m]) > 0.05
                    "#.to_string(),
                    duration: Duration::from_secs(300),
                    severity: Severity::Critical,
                    annotations: vec![
                        ("summary".to_string(), "High error rate detected".to_string()),
                        ("description".to_string(), "Error rate is above 5%".to_string()),
                    ],
                },
                AlertRule {
                    name: "HighLatency".to_string(),
                    expr: r#"
                        histogram_quantile(0.99, 
                            rate(service_mesh_request_duration_seconds_bucket[5m])
                        ) > 1.0
                    "#.to_string(),
                    duration: Duration::from_secs(300),
                    severity: Severity::Warning,
                    annotations: vec![
                        ("summary".to_string(), "High latency detected".to_string()),
                        ("description".to_string(), "P99 latency is above 1s".to_string()),
                    ],
                },
            ],
        }
    }
}
```

## ğŸ¯ æœ€ä½³å®è·µ

1. **ç»Ÿä¸€é¥æµ‹æ ‡å‡†**: ä½¿ç”¨ OTLP åè®®ç»Ÿä¸€æ”¶é›†æ‰€æœ‰é¥æµ‹æ•°æ®
2. **åˆç†é‡‡æ ·**: å¯¹è¿½è¸ªæ•°æ®è¿›è¡Œæ™ºèƒ½é‡‡æ ·,å¹³è¡¡å¯è§‚æµ‹æ€§å’Œæ€§èƒ½
3. **å…³è”åˆ†æ**: å…³è”æŒ‡æ ‡ã€è¿½è¸ªå’Œæ—¥å¿—,å¿«é€Ÿå®šä½é—®é¢˜
4. **è‡ªåŠ¨åŒ–å‘Šè­¦**: åŸºäº SLO è®¾ç½®è‡ªåŠ¨åŒ–å‘Šè­¦è§„åˆ™
5. **æŒç»­ä¼˜åŒ–**: å®šæœŸå®¡æŸ¥ç›‘æ§æŒ‡æ ‡,ä¼˜åŒ–ç›‘æ§ç­–ç•¥

---

**æ€»ç»“**: é€šè¿‡ OTLP åè®®é›†æˆæœåŠ¡ç½‘æ ¼ç›‘æ§,å¯ä»¥å®ç°ç»Ÿä¸€ã€é«˜æ•ˆçš„å¯è§‚æµ‹æ€§å¹³å°,ä¸ºå¾®æœåŠ¡ç³»ç»Ÿçš„ç¨³å®šè¿è¡Œæä¾›ä¿éšœã€‚
