# 系统不变量证明

## 目录

- [系统不变量证明](#系统不变量证明)
  - [目录](#目录)
  - [概述](#概述)
  - [不变量定义](#不变量定义)
    - [安全性不变量](#安全性不变量)
    - [活性不变量](#活性不变量)
  - [不变量证明方法](#不变量证明方法)
    - [归纳法证明](#归纳法证明)
    - [Rust 实现：不变量检查](#rust-实现不变量检查)
  - [OTLP 系统不变量](#otlp-系统不变量)
    - [1. Span 完整性](#1-span-完整性)
    - [2. 父子关系一致性](#2-父子关系一致性)
    - [3. 时间戳单调性](#3-时间戳单调性)

## 概述

系统不变量是在系统执行过程中始终保持为真的性质。

## 不变量定义

### 安全性不变量

**定义**：坏事永远不会发生

示例：

- 数据不会丢失
- 不会产生重复数据
- TraceID 唯一性

### 活性不变量

**定义**：好事最终会发生

示例：

- 请求最终会被处理
- Span 最终会被导出

## 不变量证明方法

### 归纳法证明

**基础步骤**：初始状态满足不变量  
**归纳步骤**：如果状态 S 满足不变量，执行任意操作后的状态 S' 也满足不变量

### Rust 实现：不变量检查

```rust
pub struct SpanBatch {
    spans: Vec<Span>,
    trace_ids: std::collections::HashSet<Vec<u8>>,
}

impl SpanBatch {
    // 不变量：所有 Span 的 TraceID 都在 trace_ids 中
    fn check_invariant(&self) -> bool {
        self.spans.iter().all(|span| {
            self.trace_ids.contains(&span.trace_id)
        })
    }

    pub fn add_span(&mut self, span: Span) {
        self.trace_ids.insert(span.trace_id.clone());
        self.spans.push(span);
        
        debug_assert!(self.check_invariant());
    }
}

pub struct Span {
    trace_id: Vec<u8>,
    span_id: Vec<u8>,
}
```

## OTLP 系统不变量

### 1. Span 完整性

**不变量**：每个 Span 必须有有效的 TraceID 和 SpanID

```rust
impl Span {
    pub fn validate(&self) -> Result<(), ValidationError> {
        if self.trace_id.len() != 16 {
            return Err(ValidationError::InvalidTraceId);
        }
        if self.span_id.len() != 8 {
            return Err(ValidationError::InvalidSpanId);
        }
        Ok(())
    }
}

pub enum ValidationError {
    InvalidTraceId,
    InvalidSpanId,
}
```

### 2. 父子关系一致性

**不变量**：如果 Span A 是 Span B 的父节点，则 A.trace_id == B.trace_id

```rust
pub fn verify_parent_child_consistency(
    parent: &Span,
    child: &Span,
) -> bool {
    parent.trace_id == child.trace_id
}
```

### 3. 时间戳单调性

**不变量**：child.start_time >= parent.start_time

```rust
pub fn verify_timestamp_monotonicity(
    parent: &Span,
    child: &Span,
) -> bool {
    child.start_time >= parent.start_time &&
    child.end_time <= parent.end_time
}
```

---

**相关文档**：

- [协议形式化规范](./协议形式化规范.md)
- [并发安全性验证](./并发安全性验证.md)
