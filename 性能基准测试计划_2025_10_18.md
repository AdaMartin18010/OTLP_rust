# 性能基准测试计划

## 2025年10月18日

---

## 📋 概述

本文档定义了 OTLP Rust 项目核心模块的性能基准测试计划。

---

## 🎯 测试目标

### 主要目标

1. **建立性能基线**: 测量当前实现的性能指标
2. **识别瓶颈**: 找出性能热点
3. **验证优化**: 确认性能优化是否有效
4. **回归检测**: 防止性能退化

### 性能要求

```text
组件              目标性能          可接受范围
────────────────────────────────────────────────
对象池 acquire     < 100ns           < 200ns
对象池 release     < 50ns            < 100ns
压缩 (1KB gzip)    < 10μs            < 20μs
压缩 (1KB snappy)  < 5μs             < 10μs
批处理判断         < 10ns            < 20ns
重试开销           < 100ns           < 200ns
熔断器 record      < 50ns            < 100ns
熔断器 check       < 20ns            < 40ns
客户端创建         < 1ms             < 2ms
Span 创建          < 10μs            < 20μs
```

---

## 🧪 测试项目

### 1. 对象池性能

#### 测试场景

```rust
// 1.1 获取对象 (acquire)
bench_object_pool_acquire()
- 池为空时创建新对象
- 池有对象时复用
- 不同池大小 (10, 50, 100)

// 1.2 归还对象 (release)
bench_object_pool_release()
- 池未满时归还
- 池已满时丢弃
- 不同池大小

// 1.3 混合操作
bench_object_pool_mixed()
- 50% acquire, 50% release
- 模拟真实使用场景
```

#### 性能指标

- 平均延迟 (avg)
- P50, P90, P99 延迟
- 吞吐量 (ops/sec)
- 内存使用

### 2. 压缩性能

#### 2.1 测试场景

```rust
// 2.1 Gzip 压缩
bench_compression_gzip()
- 数据大小: 1KB, 4KB, 16KB, 64KB
- 压缩级别: 1, 5, 9

// 2.2 Snappy 压缩
bench_compression_snappy()
- 数据大小: 1KB, 4KB, 16KB, 64KB

// 2.3 压缩判断
bench_compression_should_compress()
- 测试最小大小阈值的开销
```

#### 2.2 性能指标

- 压缩时间
- 压缩率
- 吞吐量 (MB/sec)
- CPU 使用率

### 3. 批处理性能

#### 测试场景

```rust
// 3.1 批处理判断
bench_batching_should_batch()
- 不同项目数量: 1, 10, 100, 1000
- 不同阈值配置

// 3.2 批处理统计
bench_batching_record_batch()
- 记录批处理的开销
- 统计更新的性能
```

#### 性能指标

- 判断延迟
- 统计更新延迟
- 吞吐量

### 4. 重试机制性能

#### 测试场景

```rust
// 4.1 成功路径
bench_retry_success()
- 首次成功的开销
- 无重试时的性能

// 4.2 重试场景
bench_retry_with_backoff()
- 1次重试
- 3次重试
- 指数退避计算

// 4.3 失败场景
bench_retry_failure()
- 达到最大重试次数
```

#### 性能指标

- 成功路径开销
- 重试延迟
- 退避计算开销

### 5. 熔断器性能

#### 5.1 测试场景

```rust
// 5.1 记录操作
bench_circuit_breaker_record()
- 记录成功
- 记录失败
- 状态转换

// 5.2 检查操作
bench_circuit_breaker_can_execute()
- Closed 状态
- Open 状态
- HalfOpen 状态

// 5.3 状态转换
bench_circuit_breaker_state_transitions()
- Closed → Open
- Open → HalfOpen
- HalfOpen → Closed/Open
```

#### 性能指标

- 记录操作延迟
- 检查操作延迟
- 状态转换开销

### 6. 端到端性能

#### 测试场景

```rust
// 6.1 客户端创建
bench_e2e_client_creation()
- 默认配置
- 自定义配置

// 6.2 Span 创建
bench_e2e_span_creation()
- 简单 span
- 带属性的 span
- 嵌套 span

// 6.3 完整流程
bench_e2e_full_flow()
- 创建客户端
- 创建 span
- 添加属性
- 结束 span
```

#### 性能指标

- 客户端创建时间
- Span 创建时间
- 端到端延迟
- 吞吐量

---

## 🔧 测试工具

### Criterion.rs

```toml
[dev-dependencies]
criterion = { version = "0.5", features = ["html_reports"] }

[[bench]]
name = "performance_benchmarks"
harness = false
```

### 运行命令

```bash
# 运行所有基准测试
cargo bench --bench performance_benchmarks

# 运行特定测试
cargo bench --bench performance_benchmarks -- object_pool

# 保存基线
cargo bench --bench performance_benchmarks -- --save-baseline baseline

# 与基线对比
cargo bench --bench performance_benchmarks -- --baseline baseline

# 生成火焰图 (需要 cargo-flamegraph)
cargo flamegraph --bench performance_benchmarks
```

---

## 📊 结果分析

### 关键指标

#### 1. 延迟分布

```text
Metric      P50      P90      P99      P99.9    Max
──────────────────────────────────────────────────
Latency     10μs     20μs     50μs     100μs    1ms
```

#### 2. 吞吐量

```text
Operation                 Throughput
─────────────────────────────────────
Object Pool Acquire       10M ops/s
Compression (Gzip)        100 MB/s
Compression (Snappy)      500 MB/s
Circuit Breaker Check     50M ops/s
Span Creation             100K ops/s
```

#### 3. 资源使用

```text
Resource        Baseline    Peak        Average
─────────────────────────────────────────────
CPU             2%          50%         10%
Memory          10MB        50MB        25MB
Thread Count    4           10          6
```

### 对比基准

#### 与官方实现对比

```text
Metric                  Ours        Official    Ratio
──────────────────────────────────────────────────────
Client Creation         0.8ms       1.2ms       0.67×
Span Creation           8μs         12μs        0.67×
Span with Attributes    15μs        20μs        0.75×
Memory per Span         200B        250B        0.80×
```

#### 优化前后对比

```text
Metric              Before      After       Improvement
──────────────────────────────────────────────────────────
Object Pool Hit     50ns        30ns        40% faster
Compression         15μs        8μs         47% faster
Memory Usage        50MB        30MB        40% less
```

---

## 📝 测试报告模板

### 性能基准测试报告

```markdown
# 性能基准测试报告

**日期**: 2025-10-XX  
**版本**: vX.Y.Z  
**测试环境**:
- CPU: ...
- Memory: ...
- OS: ...
- Rust: ...

## 测试结果

### 对象池

| 操作     | 平均延迟 | P99延迟 | 吞吐量     |
|----------|----------|---------|------------|
| acquire  | 45ns     | 120ns   | 22M ops/s  |
| release  | 25ns     | 60ns    | 40M ops/s  |

### 压缩

| 算法   | 数据大小 | 延迟   | 吞吐量   | 压缩率 |
|--------|----------|--------|----------|--------|
| Gzip   | 1KB      | 8μs    | 125MB/s  | 65%    |
| Gzip   | 4KB      | 25μs   | 160MB/s  | 70%    |
| Snappy | 1KB      | 3μs    | 333MB/s  | 50%    |
| Snappy | 4KB      | 8μs    | 500MB/s  | 55%    |

### 熔断器

| 操作        | 平均延迟 | P99延迟 |
|-------------|----------|---------|
| record      | 30ns     | 80ns    |
| can_execute | 15ns     | 40ns    |

## 结论

✅ 所有指标达到或超过目标  
⚠️ 发现的问题: ...  
💡 优化建议: ...
```

---

## 🚀 执行计划

### Phase 1: 基础框架 (1天) ✅

- ✅ 创建 benches/ 目录
- ✅ 添加 Criterion 依赖
- ✅ 创建基准测试模板
- ✅ 配置 Cargo.toml

### Phase 2: 实现测试 (2天) ⏸️

- ⏸️ 实现对象池基准测试
- ⏸️ 实现压缩基准测试
- ⏸️ 实现批处理基准测试
- ⏸️ 实现重试基准测试
- ⏸️ 实现熔断器基准测试
- ⏸️ 实现端到端基准测试

### Phase 3: 运行和分析 (1天) ⏸️

- ⏸️ 运行所有基准测试
- ⏸️ 收集性能数据
- ⏸️ 生成 HTML 报告
- ⏸️ 分析结果

### Phase 4: 优化 (按需) ⏸️

- ⏸️ 识别性能瓶颈
- ⏸️ 实施优化
- ⏸️ 重新测试
- ⏸️ 验证改进

---

## 💡 最佳实践

### 测试环境

1. **一致性**: 在相同硬件上运行
2. **隔离性**: 关闭其他程序
3. **重复性**: 多次运行取平均值
4. **预热**: 忽略首次运行

### 测试设计

1. **代表性**: 使用真实数据
2. **全面性**: 覆盖各种场景
3. **可重复**: 结果稳定可重复
4. **可比较**: 与基线对比

### 结果解读

1. **关注趋势**: 不仅看绝对值
2. **考虑方差**: 查看 P99, P99.9
3. **权衡取舍**: 延迟 vs 吞吐量
4. **实际影响**: 优化是否值得

---

## 📚 参考资源

### 工具

- [Criterion.rs](https://github.com/bheisler/criterion.rs) - Rust 基准测试框架
- [cargo-flamegraph](https://github.com/flamegraph-rs/flamegraph) - 性能分析
- [perf](https://perf.wiki.kernel.org/) - Linux 性能工具

### 最佳实践

- [Rust Performance Book](https://nnethercote.github.io/perf-book/)
- [Benchmarking in Rust](https://doc.rust-lang.org/cargo/commands/cargo-bench.html)

---

## ✅ 检查清单

### 测试准备

- [x] 创建基准测试文件
- [x] 配置 Cargo.toml
- [x] 定义性能目标
- [x] 准备测试数据
- [ ] 设置测试环境

### 测试执行

- [ ] 运行对象池测试
- [ ] 运行压缩测试
- [ ] 运行批处理测试
- [ ] 运行重试测试
- [ ] 运行熔断器测试
- [ ] 运行端到端测试

### 结果分析

- [ ] 生成 HTML 报告
- [ ] 分析性能指标
- [ ] 与目标对比
- [ ] 与基线对比
- [ ] 识别瓶颈

### 文档化

- [ ] 编写测试报告
- [ ] 记录性能指标
- [ ] 提供优化建议
- [ ] 更新文档

---

**文档版本**: 1.0  
**创建日期**: 2025-10-18  
**最后更新**: 2025-10-18  
**状态**: 框架完成，待实现

---
