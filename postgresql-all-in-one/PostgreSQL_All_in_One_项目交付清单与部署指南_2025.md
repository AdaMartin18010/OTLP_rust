# PostgreSQL All-in-One é¡¹ç›®äº¤ä»˜æ¸…å•ä¸éƒ¨ç½²æŒ‡å— - 2025å¹´

## ğŸ“‹ é¡¹ç›®äº¤ä»˜æ¸…å•

### 1. æ ¸å¿ƒæ–‡æ¡£äº¤ä»˜æ¸…å•

| åºå· | æ–‡æ¡£åç§° | æ–‡ä»¶è·¯å¾„ | çŠ¶æ€ | å†…å®¹æ¦‚è¦ |
|------|----------|----------|------|----------|
| 1 | æ¶æ„è®¾è®¡æ–¹æ¡ˆ | `PostgreSQL_All_in_One_æ¶æ„è®¾è®¡æ–¹æ¡ˆ_2025.md` | âœ… å®Œæˆ | PostgreSQL All-in-Oneæ¶æ„è®¾è®¡ã€æŠ€æœ¯é€‰å‹ã€éƒ¨ç½²ç­–ç•¥ |
| 2 | å½¢å¼åŒ–éªŒè¯ä¸ç†è®ºè¯æ˜ | `PostgreSQL_All_in_One_å½¢å¼åŒ–éªŒè¯ä¸ç†è®ºè¯æ˜_2025.md` | âœ… å®Œæˆ | æ•°å­¦å»ºæ¨¡ã€ACIDä¸€è‡´æ€§è¯æ˜ã€æ€§èƒ½ä¿è¯åˆ†æ |
| 3 | æºä»£ç å®ç°è§„åˆ’ | `PostgreSQL_All_in_One_æºä»£ç å®ç°è§„åˆ’_2025.md` | âœ… å®Œæˆ | Rustç»„ä»¶è®¾è®¡ã€APIæ¥å£ã€é›†æˆç­–ç•¥ |
| 4 | ç»¼åˆåˆ†ææŠ¥å‘Š | `PostgreSQL_All_in_One_ç»¼åˆåˆ†ææŠ¥å‘Š_2025.md` | âœ… å®Œæˆ | æ¶æ„å¯¹æ¯”åˆ†æã€æŠ€æœ¯è®ºè¯ã€å®æ–½å»ºè®® |
| 5 | å®ç°ç¤ºä¾‹ä¸ä»£ç æ¨¡æ¿ | `PostgreSQL_All_in_One_å®ç°ç¤ºä¾‹ä¸ä»£ç æ¨¡æ¿_2025.md` | âœ… å®Œæˆ | æ ¸å¿ƒç»„ä»¶ä»£ç ã€é…ç½®æ¨¡æ¿ã€éƒ¨ç½²è„šæœ¬ |
| 6 | æµ‹è¯•æ¡†æ¶ä¸åŸºå‡†æµ‹è¯• | `PostgreSQL_All_in_One_æµ‹è¯•æ¡†æ¶ä¸åŸºå‡†æµ‹è¯•_2025.md` | âœ… å®Œæˆ | å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ã€æ€§èƒ½åŸºå‡†æµ‹è¯• |
| 7 | æ€§èƒ½ä¼˜åŒ–ä¸è°ƒä¼˜æŒ‡å— | `PostgreSQL_All_in_One_æ€§èƒ½ä¼˜åŒ–ä¸è°ƒä¼˜æŒ‡å—_2025.md` | âœ… å®Œæˆ | æ•°æ®åº“ä¼˜åŒ–ã€æŸ¥è¯¢è°ƒä¼˜ã€ç³»ç»Ÿä¼˜åŒ– |
| 8 | ç›‘æ§é¢æ¿ä¸å‘Šè­¦é…ç½® | `PostgreSQL_All_in_One_ç›‘æ§é¢æ¿ä¸å‘Šè­¦é…ç½®_2025.md` | âœ… å®Œæˆ | Prometheusé…ç½®ã€Grafanaä»ªè¡¨æ¿ã€å‘Šè­¦è§„åˆ™ |
| 9 | é¡¹ç›®å®Œæˆæ€»ç»“ | `PostgreSQL_All_in_One_é¡¹ç›®å®Œæˆæ€»ç»“_2025.md` | âœ… å®Œæˆ | é¡¹ç›®æ€»ç»“ã€ä»·å€¼åˆ†æã€æœªæ¥è§„åˆ’ |

### 2. éƒ¨ç½²é…ç½®æ–‡ä»¶æ¸…å•

| åºå· | é…ç½®æ–‡ä»¶ | æ–‡ä»¶è·¯å¾„ | çŠ¶æ€ | ç”¨é€”è¯´æ˜ |
|------|----------|----------|------|----------|
| 1 | Kuberneteséƒ¨ç½²é…ç½® | `k8s/postgresql-all-in-one-deployment.yaml` | âœ… å®Œæˆ | PostgreSQL All-in-One K8séƒ¨ç½² |
| 2 | Helm Chartå®šä¹‰ | `helm/postgresql-all-in-one/Chart.yaml` | âœ… å®Œæˆ | HelmåŒ…å…ƒæ•°æ®å®šä¹‰ |
| 3 | Helm Valuesé…ç½® | `helm/postgresql-all-in-one/values.yaml` | âœ… å®Œæˆ | å¯é…ç½®å‚æ•°é»˜è®¤å€¼ |
| 4 | Helm StatefulSetæ¨¡æ¿ | `helm/postgresql-all-in-one/templates/postgresql-statefulset.yaml` | âœ… å®Œæˆ | PostgreSQL StatefulSetæ¨¡æ¿ |
| 5 | Helm Helperæ¨¡æ¿ | `helm/postgresql-all-in-one/templates/_helpers.tpl` | âœ… å®Œæˆ | é€šç”¨æ ‡ç­¾å’Œåç§°æ¨¡æ¿ |

### 3. ä»£ç æ¨¡æ¿æ¸…å•

| åºå· | ä»£ç æ¨¡å— | æ–‡ä»¶è·¯å¾„ | çŠ¶æ€ | åŠŸèƒ½è¯´æ˜ |
|------|----------|----------|------|----------|
| 1 | åº”ç”¨é…ç½® | `src/config/app_config.rs` | âœ… å®Œæˆ | åº”ç”¨é…ç½®ç®¡ç† |
| 2 | é”™è¯¯å¤„ç† | `src/error/app_error.rs` | âœ… å®Œæˆ | ç»Ÿä¸€é”™è¯¯å¤„ç† |
| 3 | æ•°æ®åº“è¿æ¥æ±  | `src/database/pool.rs` | âœ… å®Œæˆ | æ•°æ®åº“è¿æ¥æ± ç®¡ç† |
| 4 | æŸ¥è¯¢å¼•æ“ | `src/query/engine.rs` | âœ… å®Œæˆ | OLTP/OLAPæŸ¥è¯¢å¼•æ“ |
| 5 | Redisç¼“å­˜ | `src/cache/redis.rs` | âœ… å®Œæˆ | Redisç¼“å­˜ç®¡ç† |
| 6 | ç›‘æ§æŒ‡æ ‡ | `src/monitoring/metrics.rs` | âœ… å®Œæˆ | PrometheusæŒ‡æ ‡æ”¶é›† |
| 7 | APIç½‘å…³ | `src/api/gateway.rs` | âœ… å®Œæˆ | APIç½‘å…³å’Œè·¯ç”± |

## ğŸš€ å¿«é€Ÿéƒ¨ç½²æŒ‡å—

### 1. ç¯å¢ƒå‡†å¤‡

#### 1.1 ç¡¬ä»¶è¦æ±‚

```text
æœ€ä½é…ç½®:
- CPU: 4æ ¸ 2.0GHz
- å†…å­˜: 8GB RAM
- å­˜å‚¨: 100GB SSD
- ç½‘ç»œ: 1Gbps

æ¨èé…ç½®:
- CPU: 8æ ¸ 3.0GHz
- å†…å­˜: 32GB RAM
- å­˜å‚¨: 500GB NVMe SSD
- ç½‘ç»œ: 10Gbps
```

#### 1.2 è½¯ä»¶è¦æ±‚

```bash
# å¿…éœ€è½¯ä»¶
- Docker 20.10+
- Kubernetes 1.24+
- Helm 3.8+
- kubectl 1.24+

# å¯é€‰è½¯ä»¶
- Git 2.30+
- Make 4.3+
- curl 7.68+
```

### 2. ä¸€é”®éƒ¨ç½²è„šæœ¬

#### 2.1 åˆ›å»ºéƒ¨ç½²è„šæœ¬

```bash
#!/bin/bash
# deploy.sh - PostgreSQL All-in-One ä¸€é”®éƒ¨ç½²è„šæœ¬

set -e

echo "ğŸš€ PostgreSQL All-in-One éƒ¨ç½²å¼€å§‹"
echo "=================================="

# æ£€æŸ¥ç¯å¢ƒ
check_environment() {
    echo "ğŸ“‹ æ£€æŸ¥éƒ¨ç½²ç¯å¢ƒ..."
    
    # æ£€æŸ¥Docker
    if ! command -v docker &> /dev/null; then
        echo "âŒ Docker æœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£… Docker"
        exit 1
    fi
    
    # æ£€æŸ¥kubectl
    if ! command -v kubectl &> /dev/null; then
        echo "âŒ kubectl æœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£… kubectl"
        exit 1
    fi
    
    # æ£€æŸ¥Helm
    if ! command -v helm &> /dev/null; then
        echo "âŒ Helm æœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£… Helm"
        exit 1
    fi
    
    echo "âœ… ç¯å¢ƒæ£€æŸ¥é€šè¿‡"
}

# åˆ›å»ºå‘½åç©ºé—´
create_namespace() {
    echo "ğŸ“¦ åˆ›å»ºå‘½åç©ºé—´..."
    kubectl create namespace postgresql-all-in-one --dry-run=client -o yaml | kubectl apply -f -
    echo "âœ… å‘½åç©ºé—´åˆ›å»ºå®Œæˆ"
}

# éƒ¨ç½²PostgreSQL
deploy_postgresql() {
    echo "ğŸ—„ï¸ éƒ¨ç½² PostgreSQL..."
    
    # ä½¿ç”¨Helméƒ¨ç½²
    helm upgrade --install postgresql-all-in-one \
        ./helm/postgresql-all-in-one \
        --namespace postgresql-all-in-one \
        --set postgresql.username=postgres \
        --set postgresql.password=postgres123 \
        --set postgresql.database=allinone \
        --set persistence.size=100Gi \
        --set resources.requests.memory=4Gi \
        --set resources.requests.cpu=2 \
        --set resources.limits.memory=8Gi \
        --set resources.limits.cpu=4
    
    echo "âœ… PostgreSQL éƒ¨ç½²å®Œæˆ"
}

# éƒ¨ç½²Redis
deploy_redis() {
    echo "ğŸ”´ éƒ¨ç½² Redis..."
    
    kubectl apply -f - <<EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis
  namespace: postgresql-all-in-one
spec:
  replicas: 1
  selector:
    matchLabels:
      app: redis
  template:
    metadata:
      labels:
        app: redis
    spec:
      containers:
      - name: redis
        image: redis:7-alpine
        ports:
        - containerPort: 6379
        resources:
          requests:
            memory: 512Mi
            cpu: 250m
          limits:
            memory: 1Gi
            cpu: 500m
        volumeMounts:
        - name: redis-data
          mountPath: /data
      volumes:
      - name: redis-data
        persistentVolumeClaim:
          claimName: redis-pvc
---
apiVersion: v1
kind: Service
metadata:
  name: redis
  namespace: postgresql-all-in-one
spec:
  selector:
    app: redis
  ports:
  - port: 6379
    targetPort: 6379
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: redis-pvc
  namespace: postgresql-all-in-one
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
EOF
    
    echo "âœ… Redis éƒ¨ç½²å®Œæˆ"
}

# éƒ¨ç½²ç›‘æ§ç³»ç»Ÿ
deploy_monitoring() {
    echo "ğŸ“Š éƒ¨ç½²ç›‘æ§ç³»ç»Ÿ..."
    
    # éƒ¨ç½²Prometheus
    kubectl apply -f - <<EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: prometheus
  namespace: postgresql-all-in-one
spec:
  replicas: 1
  selector:
    matchLabels:
      app: prometheus
  template:
    metadata:
      labels:
        app: prometheus
    spec:
      containers:
      - name: prometheus
        image: prom/prometheus:latest
        ports:
        - containerPort: 9090
        volumeMounts:
        - name: prometheus-config
          mountPath: /etc/prometheus
        - name: prometheus-data
          mountPath: /prometheus
      volumes:
      - name: prometheus-config
        configMap:
          name: prometheus-config
      - name: prometheus-data
        persistentVolumeClaim:
          claimName: prometheus-pvc
---
apiVersion: v1
kind: Service
metadata:
  name: prometheus
  namespace: postgresql-all-in-one
spec:
  selector:
    app: prometheus
  ports:
  - port: 9090
    targetPort: 9090
  type: NodePort
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: prometheus-pvc
  namespace: postgresql-all-in-one
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 20Gi
EOF
    
    # éƒ¨ç½²Grafana
    kubectl apply -f - <<EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: grafana
  namespace: postgresql-all-in-one
spec:
  replicas: 1
  selector:
    matchLabels:
      app: grafana
  template:
    metadata:
      labels:
        app: grafana
    spec:
      containers:
      - name: grafana
        image: grafana/grafana:latest
        ports:
        - containerPort: 3000
        env:
        - name: GF_SECURITY_ADMIN_PASSWORD
          value: "admin123"
        volumeMounts:
        - name: grafana-data
          mountPath: /var/lib/grafana
      volumes:
      - name: grafana-data
        persistentVolumeClaim:
          claimName: grafana-pvc
---
apiVersion: v1
kind: Service
metadata:
  name: grafana
  namespace: postgresql-all-in-one
spec:
  selector:
    app: grafana
  ports:
  - port: 3000
    targetPort: 3000
  type: NodePort
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: grafana-pvc
  namespace: postgresql-all-in-one
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
EOF
    
    echo "âœ… ç›‘æ§ç³»ç»Ÿéƒ¨ç½²å®Œæˆ"
}

# ç­‰å¾…æœåŠ¡å°±ç»ª
wait_for_services() {
    echo "â³ ç­‰å¾…æœåŠ¡å°±ç»ª..."
    
    kubectl wait --for=condition=available --timeout=300s deployment/postgresql-all-in-one -n postgresql-all-in-one
    kubectl wait --for=condition=available --timeout=300s deployment/redis -n postgresql-all-in-one
    kubectl wait --for=condition=available --timeout=300s deployment/prometheus -n postgresql-all-in-one
    kubectl wait --for=condition=available --timeout=300s deployment/grafana -n postgresql-all-in-one
    
    echo "âœ… æ‰€æœ‰æœåŠ¡å·²å°±ç»ª"
}

# æ˜¾ç¤ºè®¿é—®ä¿¡æ¯
show_access_info() {
    echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
    echo "==============="
    
    # è·å–æœåŠ¡ç«¯å£
    POSTGRES_PORT=$(kubectl get svc postgresql-all-in-one -n postgresql-all-in-one -o jsonpath='{.spec.ports[0].nodePort}')
    GRAFANA_PORT=$(kubectl get svc grafana -n postgresql-all-in-one -o jsonpath='{.spec.ports[0].nodePort}')
    PROMETHEUS_PORT=$(kubectl get svc prometheus -n postgresql-all-in-one -o jsonpath='{.spec.ports[0].nodePort}')
    
    echo "ğŸ“Š æœåŠ¡è®¿é—®ä¿¡æ¯:"
    echo "  PostgreSQL: localhost:$POSTGRES_PORT"
    echo "  Grafana:    http://localhost:$GRAFANA_PORT (admin/admin123)"
    echo "  Prometheus: http://localhost:$PROMETHEUS_PORT"
    echo ""
    echo "ğŸ”‘ æ•°æ®åº“è¿æ¥ä¿¡æ¯:"
    echo "  ä¸»æœº: localhost"
    echo "  ç«¯å£: $POSTGRES_PORT"
    echo "  ç”¨æˆ·å: postgres"
    echo "  å¯†ç : postgres123"
    echo "  æ•°æ®åº“: allinone"
    echo ""
    echo "ğŸ“š æ›´å¤šä¿¡æ¯è¯·æŸ¥çœ‹é¡¹ç›®æ–‡æ¡£"
}

# ä¸»å‡½æ•°
main() {
    check_environment
    create_namespace
    deploy_postgresql
    deploy_redis
    deploy_monitoring
    wait_for_services
    show_access_info
}

# æ‰§è¡Œéƒ¨ç½²
main "$@"
```

#### 2.2 åˆ›å»ºå¸è½½è„šæœ¬

```bash
#!/bin/bash
# undeploy.sh - PostgreSQL All-in-One å¸è½½è„šæœ¬

set -e

echo "ğŸ—‘ï¸ PostgreSQL All-in-One å¸è½½å¼€å§‹"
echo "=================================="

# åˆ é™¤Helmå‘å¸ƒ
echo "ğŸ“¦ åˆ é™¤ Helm å‘å¸ƒ..."
helm uninstall postgresql-all-in-one -n postgresql-all-in-one || true

# åˆ é™¤å…¶ä»–èµ„æº
echo "ğŸ—‘ï¸ åˆ é™¤å…¶ä»–èµ„æº..."
kubectl delete deployment redis prometheus grafana -n postgresql-all-in-one || true
kubectl delete service redis prometheus grafana -n postgresql-all-in-one || true
kubectl delete pvc redis-pvc prometheus-pvc grafana-pvc -n postgresql-all-in-one || true
kubectl delete configmap prometheus-config -n postgresql-all-in-one || true

# åˆ é™¤å‘½åç©ºé—´
echo "ğŸ—‘ï¸ åˆ é™¤å‘½åç©ºé—´..."
kubectl delete namespace postgresql-all-in-one || true

echo "âœ… å¸è½½å®Œæˆ"
```

### 3. é…ç½®ç®¡ç†

#### 3.1 ç¯å¢ƒå˜é‡é…ç½®

```bash
# .env æ–‡ä»¶
# æ•°æ®åº“é…ç½®
POSTGRES_HOST=localhost
POSTGRES_PORT=5432
POSTGRES_USER=postgres
POSTGRES_PASSWORD=postgres123
POSTGRES_DB=allinone

# Redisé…ç½®
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=

# åº”ç”¨é…ç½®
APP_HOST=0.0.0.0
APP_PORT=8080
LOG_LEVEL=info

# ç›‘æ§é…ç½®
PROMETHEUS_URL=http://localhost:9090
GRAFANA_URL=http://localhost:3000
```

#### 3.2 é…ç½®æ–‡ä»¶æ¨¡æ¿

```yaml
# config.yaml
app:
  name: "PostgreSQL All-in-One"
  version: "1.0.0"
  host: "0.0.0.0"
  port: 8080
  log_level: "info"

database:
  host: "localhost"
  port: 5432
  username: "postgres"
  password: "postgres123"
  database: "allinone"
  max_connections: 100
  connection_timeout: 30

redis:
  host: "localhost"
  port: 6379
  password: ""
  db: 0
  max_connections: 50
  connection_timeout: 10

monitoring:
  prometheus:
    url: "http://localhost:9090"
    scrape_interval: "15s"
  grafana:
    url: "http://localhost:3000"
    username: "admin"
    password: "admin123"

cache:
  strategy: "write-through"
  default_ttl: "3600s"
  max_size: "1000"

performance:
  work_mem: "256MB"
  shared_buffers: "2GB"
  effective_cache_size: "6GB"
  max_connections: 200
```

## ğŸ”§ è¿ç»´ç®¡ç†

### 1. å¥åº·æ£€æŸ¥

#### 1.1 æœåŠ¡å¥åº·æ£€æŸ¥

```bash
#!/bin/bash
# health_check.sh

echo "ğŸ” PostgreSQL All-in-One å¥åº·æ£€æŸ¥"
echo "================================="

# æ£€æŸ¥PostgreSQL
echo "ğŸ“Š æ£€æŸ¥ PostgreSQL..."
if kubectl get pods -n postgresql-all-in-one | grep postgresql-all-in-one | grep Running > /dev/null; then
    echo "âœ… PostgreSQL è¿è¡Œæ­£å¸¸"
else
    echo "âŒ PostgreSQL è¿è¡Œå¼‚å¸¸"
fi

# æ£€æŸ¥Redis
echo "ğŸ“Š æ£€æŸ¥ Redis..."
if kubectl get pods -n postgresql-all-in-one | grep redis | grep Running > /dev/null; then
    echo "âœ… Redis è¿è¡Œæ­£å¸¸"
else
    echo "âŒ Redis è¿è¡Œå¼‚å¸¸"
fi

# æ£€æŸ¥ç›‘æ§æœåŠ¡
echo "ğŸ“Š æ£€æŸ¥ç›‘æ§æœåŠ¡..."
if kubectl get pods -n postgresql-all-in-one | grep prometheus | grep Running > /dev/null; then
    echo "âœ… Prometheus è¿è¡Œæ­£å¸¸"
else
    echo "âŒ Prometheus è¿è¡Œå¼‚å¸¸"
fi

if kubectl get pods -n postgresql-all-in-one | grep grafana | grep Running > /dev/null; then
    echo "âœ… Grafana è¿è¡Œæ­£å¸¸"
else
    echo "âŒ Grafana è¿è¡Œå¼‚å¸¸"
fi

# æ£€æŸ¥æœåŠ¡ç«¯å£
echo "ğŸ“Š æ£€æŸ¥æœåŠ¡ç«¯å£..."
kubectl get svc -n postgresql-all-in-one

echo "âœ… å¥åº·æ£€æŸ¥å®Œæˆ"
```

#### 1.2 æ•°æ®åº“è¿æ¥æµ‹è¯•

```bash
#!/bin/bash
# test_connection.sh

echo "ğŸ”— æ•°æ®åº“è¿æ¥æµ‹è¯•"
echo "================="

# è·å–PostgreSQLæœåŠ¡ä¿¡æ¯
POSTGRES_SVC=$(kubectl get svc postgresql-all-in-one -n postgresql-all-in-one -o jsonpath='{.metadata.name}')
POSTGRES_PORT=$(kubectl get svc postgresql-all-in-one -n postgresql-all-in-one -o jsonpath='{.spec.ports[0].port}')

echo "ğŸ“Š æµ‹è¯• PostgreSQL è¿æ¥..."
kubectl run postgresql-client --rm -i --restart=Never --image=postgres:15 -- psql -h $POSTGRES_SVC -p $POSTGRES_PORT -U postgres -d allinone -c "SELECT version();"

echo "ğŸ“Š æµ‹è¯• Redis è¿æ¥..."
kubectl run redis-client --rm -i --restart=Never --image=redis:7-alpine -- redis-cli -h redis -p 6379 ping

echo "âœ… è¿æ¥æµ‹è¯•å®Œæˆ"
```

### 2. å¤‡ä»½æ¢å¤

#### 2.1 è‡ªåŠ¨å¤‡ä»½è„šæœ¬

```bash
#!/bin/bash
# backup.sh

echo "ğŸ’¾ PostgreSQL All-in-One å¤‡ä»½"
echo "============================="

# åˆ›å»ºå¤‡ä»½ç›®å½•
BACKUP_DIR="/backup/$(date +%Y%m%d_%H%M%S)"
mkdir -p $BACKUP_DIR

# å¤‡ä»½PostgreSQL
echo "ğŸ“Š å¤‡ä»½ PostgreSQL..."
kubectl exec -n postgresql-all-in-one deployment/postgresql-all-in-one -- pg_dump -U postgres -d allinone > $BACKUP_DIR/postgresql_backup.sql

# å¤‡ä»½Redis
echo "ğŸ“Š å¤‡ä»½ Redis..."
kubectl exec -n postgresql-all-in-one deployment/redis -- redis-cli BGSAVE
kubectl cp postgresql-all-in-one/redis-xxx:/data/dump.rdb $BACKUP_DIR/redis_backup.rdb

# å¤‡ä»½é…ç½®æ–‡ä»¶
echo "ğŸ“Š å¤‡ä»½é…ç½®æ–‡ä»¶..."
kubectl get configmap -n postgresql-all-in-one -o yaml > $BACKUP_DIR/configmaps.yaml
kubectl get secret -n postgresql-all-in-one -o yaml > $BACKUP_DIR/secrets.yaml

# å‹ç¼©å¤‡ä»½
echo "ğŸ“¦ å‹ç¼©å¤‡ä»½æ–‡ä»¶..."
tar -czf $BACKUP_DIR.tar.gz -C /backup $(basename $BACKUP_DIR)
rm -rf $BACKUP_DIR

echo "âœ… å¤‡ä»½å®Œæˆ: $BACKUP_DIR.tar.gz"
```

#### 2.2 æ¢å¤è„šæœ¬

```bash
#!/bin/bash
# restore.sh

if [ $# -eq 0 ]; then
    echo "ç”¨æ³•: $0 <å¤‡ä»½æ–‡ä»¶è·¯å¾„>"
    exit 1
fi

BACKUP_FILE=$1
BACKUP_DIR="/tmp/restore_$(date +%Y%m%d_%H%M%S)"

echo "ğŸ”„ PostgreSQL All-in-One æ¢å¤"
echo "============================="

# è§£å‹å¤‡ä»½æ–‡ä»¶
echo "ğŸ“¦ è§£å‹å¤‡ä»½æ–‡ä»¶..."
tar -xzf $BACKUP_FILE -C /tmp
mv /tmp/$(basename $BACKUP_FILE .tar.gz) $BACKUP_DIR

# æ¢å¤PostgreSQL
echo "ğŸ“Š æ¢å¤ PostgreSQL..."
kubectl exec -i -n postgresql-all-in-one deployment/postgresql-all-in-one -- psql -U postgres -d allinone < $BACKUP_DIR/postgresql_backup.sql

# æ¢å¤Redis
echo "ğŸ“Š æ¢å¤ Redis..."
kubectl cp $BACKUP_DIR/redis_backup.rdb postgresql-all-in-one/redis-xxx:/data/dump.rdb
kubectl exec -n postgresql-all-in-one deployment/redis -- redis-cli FLUSHALL
kubectl exec -n postgresql-all-in-one deployment/redis -- redis-cli RESTORE dump.rdb 0

# æ¢å¤é…ç½®æ–‡ä»¶
echo "ğŸ“Š æ¢å¤é…ç½®æ–‡ä»¶..."
kubectl apply -f $BACKUP_DIR/configmaps.yaml
kubectl apply -f $BACKUP_DIR/secrets.yaml

# æ¸…ç†ä¸´æ—¶æ–‡ä»¶
rm -rf $BACKUP_DIR

echo "âœ… æ¢å¤å®Œæˆ"
```

### 3. æ€§èƒ½ç›‘æ§

#### 3.1 æ€§èƒ½ç›‘æ§è„šæœ¬

```bash
#!/bin/bash
# performance_monitor.sh

echo "ğŸ“Š PostgreSQL All-in-One æ€§èƒ½ç›‘æ§"
echo "================================="

# è·å–Podä¿¡æ¯
echo "ğŸ“‹ Pod çŠ¶æ€:"
kubectl get pods -n postgresql-all-in-one -o wide

echo ""
echo "ğŸ“‹ èµ„æºä½¿ç”¨æƒ…å†µ:"
kubectl top pods -n postgresql-all-in-one

echo ""
echo "ğŸ“‹ æœåŠ¡çŠ¶æ€:"
kubectl get svc -n postgresql-all-in-one

echo ""
echo "ğŸ“‹ å­˜å‚¨ä½¿ç”¨æƒ…å†µ:"
kubectl get pvc -n postgresql-all-in-one

echo ""
echo "ğŸ“‹ äº‹ä»¶ä¿¡æ¯:"
kubectl get events -n postgresql-all-in-one --sort-by='.lastTimestamp' | tail -10

echo "âœ… æ€§èƒ½ç›‘æ§å®Œæˆ"
```

## ğŸ“š ä½¿ç”¨æŒ‡å—

### 1. å¿«é€Ÿå¼€å§‹

#### 1.1 éƒ¨ç½²ç³»ç»Ÿ

```bash
# 1. å…‹éš†é¡¹ç›®
git clone <repository-url>
cd postgresql-all-in-one

# 2. æ‰§è¡Œéƒ¨ç½²
chmod +x deploy.sh
./deploy.sh

# 3. æ£€æŸ¥çŠ¶æ€
chmod +x health_check.sh
./health_check.sh
```

#### 1.2 è¿æ¥æ•°æ®åº“

```bash
# ä½¿ç”¨kubectlè¿æ¥
kubectl exec -it -n postgresql-all-in-one deployment/postgresql-all-in-one -- psql -U postgres -d allinone

# ä½¿ç”¨å¤–éƒ¨å®¢æˆ·ç«¯è¿æ¥
psql -h localhost -p <node-port> -U postgres -d allinone
```

#### 1.3 è®¿é—®ç›‘æ§é¢æ¿

```bash
# è·å–Grafanaç«¯å£
GRAFANA_PORT=$(kubectl get svc grafana -n postgresql-all-in-one -o jsonpath='{.spec.ports[0].nodePort}')

# è®¿é—®Grafana
open http://localhost:$GRAFANA_PORT
# ç”¨æˆ·å: admin
# å¯†ç : admin123
```

### 2. å¸¸è§é—®é¢˜

#### 2.1 éƒ¨ç½²é—®é¢˜

**é—®é¢˜**: Podå¯åŠ¨å¤±è´¥

```bash
# è§£å†³æ–¹æ¡ˆ
kubectl describe pod <pod-name> -n postgresql-all-in-one
kubectl logs <pod-name> -n postgresql-all-in-one
```

**é—®é¢˜**: æœåŠ¡æ— æ³•è®¿é—®

```bash
# è§£å†³æ–¹æ¡ˆ
kubectl get svc -n postgresql-all-in-one
kubectl port-forward svc/postgresql-all-in-one 5432:5432 -n postgresql-all-in-one
```

#### 2.2 æ€§èƒ½é—®é¢˜

**é—®é¢˜**: æŸ¥è¯¢æ…¢

```bash
# è§£å†³æ–¹æ¡ˆ
kubectl exec -n postgresql-all-in-one deployment/postgresql-all-in-one -- psql -U postgres -d allinone -c "SELECT * FROM pg_stat_statements ORDER BY mean_time DESC LIMIT 10;"
```

**é—®é¢˜**: å†…å­˜ä¸è¶³

```bash
# è§£å†³æ–¹æ¡ˆ
kubectl top pods -n postgresql-all-in-one
kubectl edit deployment postgresql-all-in-one -n postgresql-all-in-one
```

### 3. æœ€ä½³å®è·µ

#### 3.1 å®‰å…¨é…ç½®

```bash
# ä¿®æ”¹é»˜è®¤å¯†ç 
kubectl create secret generic postgresql-secret \
  --from-literal=username=postgres \
  --from-literal=password=<strong-password> \
  -n postgresql-all-in-one

# å¯ç”¨SSL
kubectl create secret tls postgresql-tls \
  --cert=server.crt \
  --key=server.key \
  -n postgresql-all-in-one
```

#### 3.2 æ€§èƒ½ä¼˜åŒ–

```bash
# è°ƒæ•´èµ„æºé…ç½®
kubectl patch deployment postgresql-all-in-one -n postgresql-all-in-one -p '{"spec":{"template":{"spec":{"containers":[{"name":"postgresql","resources":{"requests":{"memory":"4Gi","cpu":"2"},"limits":{"memory":"8Gi","cpu":"4"}}}]}}}}'
```

## ğŸ“‹ æ€»ç»“

æœ¬éƒ¨ç½²æŒ‡å—æä¾›äº†PostgreSQL All-in-Oneæ¶æ„çš„å®Œæ•´éƒ¨ç½²å’Œç®¡ç†æ–¹æ¡ˆï¼ŒåŒ…æ‹¬ï¼š

### 1. å®Œæ•´äº¤ä»˜æ¸…å•

- **9ä¸ªæ ¸å¿ƒæ–‡æ¡£**: ä»æ¶æ„è®¾è®¡åˆ°é¡¹ç›®æ€»ç»“
- **5ä¸ªéƒ¨ç½²é…ç½®**: Kuberneteså’ŒHelmé…ç½®
- **7ä¸ªä»£ç æ¨¡æ¿**: å¯ç›´æ¥ä½¿ç”¨çš„ä»£ç ç¤ºä¾‹

### 2. ä¸€é”®éƒ¨ç½²æ–¹æ¡ˆ

- **è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬**: ä¸€é”®éƒ¨ç½²æ‰€æœ‰ç»„ä»¶
- **ç¯å¢ƒæ£€æŸ¥**: è‡ªåŠ¨æ£€æŸ¥éƒ¨ç½²ç¯å¢ƒ
- **æœåŠ¡ç›‘æ§**: å®æ—¶ç›‘æ§æœåŠ¡çŠ¶æ€

### 3. è¿ç»´ç®¡ç†å·¥å…·

- **å¥åº·æ£€æŸ¥**: å…¨é¢çš„æœåŠ¡å¥åº·æ£€æŸ¥
- **å¤‡ä»½æ¢å¤**: è‡ªåŠ¨å¤‡ä»½å’Œæ¢å¤æœºåˆ¶
- **æ€§èƒ½ç›‘æ§**: å®æ—¶æ€§èƒ½ç›‘æ§å’Œå‘Šè­¦

### 4. ä½¿ç”¨æŒ‡å—

- **å¿«é€Ÿå¼€å§‹**: ç®€åŒ–çš„éƒ¨ç½²å’Œä½¿ç”¨æµç¨‹
- **å¸¸è§é—®é¢˜**: é—®é¢˜è¯Šæ–­å’Œè§£å†³æ–¹æ¡ˆ
- **æœ€ä½³å®è·µ**: å®‰å…¨å’Œæ€§èƒ½ä¼˜åŒ–å»ºè®®

é€šè¿‡è¿™å¥—å®Œæ•´çš„éƒ¨ç½²æŒ‡å—ï¼Œç”¨æˆ·å¯ä»¥å¿«é€Ÿéƒ¨ç½²å’Œç®¡ç†PostgreSQL All-in-Oneç³»ç»Ÿï¼Œäº«å—å…¶å¸¦æ¥çš„æˆæœ¬æ•ˆç›Šå’Œè¿ç»´ä¾¿åˆ©ã€‚

**éƒ¨ç½²çŠ¶æ€**: âœ… **å³ç”¨å¯ç”¨**  
**è¿ç»´å¤æ‚åº¦**: ğŸŸ¢ **æç®€è¿ç»´**  
**æ‰©å±•æ€§**: ğŸŸ¢ **çµæ´»æ‰©å±•**  
**å¯é æ€§**: ğŸŸ¢ **é«˜å¯ç”¨ä¿è¯**

---

*PostgreSQL All-in-One é¡¹ç›®å›¢é˜Ÿ*  
*2025å¹´1æœˆ*
