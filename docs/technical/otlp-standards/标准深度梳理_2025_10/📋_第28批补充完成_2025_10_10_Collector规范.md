# ğŸ“‹ ç¬¬28æ‰¹è¡¥å……å®Œæˆ - Collector è§„èŒƒ (2025-10-10)

## ç›®å½•

- [å®Œæˆæ¦‚å†µ](#å®Œæˆæ¦‚å†µ)
- [æ–‡æ¡£æ¸…å•](#æ–‡æ¡£æ¸…å•)
- [æ ¸å¿ƒäº®ç‚¹](#æ ¸å¿ƒäº®ç‚¹)
- [ä¸‹ä¸€æ­¥è®¡åˆ’](#ä¸‹ä¸€æ­¥è®¡åˆ’)

---

## å®Œæˆæ¦‚å†µ

**å®Œæˆæ—¶é—´**: 2025å¹´10æœˆ10æ—¥  
**æ¨¡å—**: `05_Collectorè§„èŒƒ`  
**æ–‡æ¡£æ•°é‡**: 5ç¯‡  
**æ€»å­—æ•°**: ~15,000 å­—  
**ä»£ç ç¤ºä¾‹**: 50+ ä¸ª Rust å®Œæ•´å®ç°

---

## æ–‡æ¡£æ¸…å•

### 1. Collector æ¶æ„ (`01_Collectoræ¶æ„_Rustå®Œæ•´ç‰ˆ.md`)

**æ ¸å¿ƒåŠŸèƒ½**:

- Collector æ¶æ„æ¦‚è¿°ä¸æ ¸å¿ƒä»·å€¼
- ç»„ä»¶åˆ†å±‚ï¼ˆReceiversã€Processorsã€Exportersã€Extensionsï¼‰
- Agentã€Gatewayã€æ··åˆéƒ¨ç½²æ¨¡å¼
- æ•°æ®æµå¤„ç†æ¨¡å‹

**å…³é”®å®ç°**:

```rust
// Receiver æŠ½è±¡æ¥å£
#[async_trait]
pub trait Receiver: Send + Sync {
    async fn start(&mut self) -> Result<(), TraceError>;
    async fn shutdown(&mut self) -> Result<(), TraceError>;
    async fn receive(&self) -> Vec<SpanData>;
}

// Processor æŠ½è±¡æ¥å£
#[async_trait]
pub trait Processor: Send + Sync {
    async fn process(&self, span: SpanData) -> Option<SpanData>;
    async fn process_batch(&self, spans: Vec<SpanData>) -> Vec<SpanData>;
}

// Pipeline ç¼–æ’
pub struct Pipeline {
    receivers: Vec<Arc<dyn Receiver>>,
    processors: Vec<Arc<dyn Processor>>,
    exporters: Vec<Arc<dyn SpanExporter>>,
}
```

**ä¾èµ–åº“**:

- `tokio` - å¼‚æ­¥è¿è¡Œæ—¶
- `tonic` - gRPC æœåŠ¡å™¨/å®¢æˆ·ç«¯
- `axum` - HTTP æœåŠ¡å™¨
- `tower` - ä¸­é—´ä»¶æ¡†æ¶
- `opentelemetry-otlp` - OTLP åè®®æ”¯æŒ

---

### 2. Receivers (`02_Receivers_Rustå®Œæ•´ç‰ˆ.md`)

**æ ¸å¿ƒåŠŸèƒ½**:

- OTLP Receiverï¼ˆgRPC/HTTPï¼‰
- Jaeger Receiverï¼ˆThriftï¼‰
- Prometheus Receiverï¼ˆPull æ¨¡å¼ï¼‰
- Kafka Receiverï¼ˆè‡ªå®šä¹‰ï¼‰

**å…³é”®å®ç°**:

```rust
// OTLP gRPC Receiver
pub struct OtlpGrpcReceiver {
    endpoint: SocketAddr,
    trace_tx: mpsc::Sender<ExportTraceServiceRequest>,
    metrics_tx: mpsc::Sender<ExportMetricsServiceRequest>,
    logs_tx: mpsc::Sender<ExportLogsServiceRequest>,
    shutdown_tx: tokio::sync::watch::Sender<bool>,
}

// Prometheus Scrape
pub async fn scrape_target(
    client: &Client,
    target: &str,
) -> Result<MetricsPayload, Box<dyn std::error::Error>> {
    let response = client.get(target).send().await?;
    let text = response.text().await?;
    parse_prometheus_format(&text)
}

// æ€§èƒ½ä¼˜åŒ–
pub struct ConnectionLimiter {
    semaphore: Arc<Semaphore>,
}

pub struct RateLimitedReceiver {
    receiver: Arc<dyn Receiver>,
    limiter: Arc<RateLimiter>,
}

pub struct MemoryMonitor {
    current_usage: Arc<AtomicUsize>,
    max_usage: usize,
}
```

**åè®®æ”¯æŒ**:

- OTLP gRPC (Port 4317)
- OTLP HTTP/JSON (Port 4318)
- Jaeger Thrift HTTP (Port 14268)
- Prometheus Pull (è‡ªå®šä¹‰ç«¯å£)

---

### 3. Processors (`03_Processors_Rustå®Œæ•´ç‰ˆ.md`)

**æ ¸å¿ƒåŠŸèƒ½**:

- Batch Processorï¼ˆæ‰¹é‡å¤„ç†ï¼‰
- Attributes Processorï¼ˆå±æ€§æ“ä½œï¼‰
- Filter Processorï¼ˆè§„åˆ™è¿‡æ»¤ï¼‰
- Transform Processorï¼ˆæ•°æ®è½¬æ¢ï¼‰
- Resource Processorï¼ˆResource ä¿®æ”¹ï¼‰
- Memory Limiter Processorï¼ˆå†…å­˜ä¿æŠ¤ï¼‰

**å…³é”®å®ç°**:

```rust
// Batch Processor
pub struct BatchProcessor {
    max_batch_size: usize,
    timeout: Duration,
    buffer: Arc<Mutex<Vec<SpanData>>>,
    flush_fn: Arc<dyn Fn(Vec<SpanData>) + Send + Sync>,
}

// Attributes Processor
pub enum AttributeAction {
    Insert { key: String, value: String },
    Update { key: String, value: String },
    Upsert { key: String, value: String },
    Delete { key: String },
    Hash { key: String },
}

// Filter Processor
pub enum FilterRule {
    SpanNameMatches { pattern: String },
    AttributeMatches { key: String, pattern: String },
    DurationGreaterThan { threshold_ms: u64 },
    StatusCodeEquals { code: i32 },
}

// PII è„±æ•
pub struct PiiRedactionProcessor {
    email_regex: Regex,
    phone_regex: Regex,
    credit_card_regex: Regex,
}
```

**å¤„ç†èƒ½åŠ›**:

- æ•°æ®æ‰¹é‡åŒ–
- å±æ€§å¢åˆ æ”¹
- æ¡ä»¶è¿‡æ»¤
- æ­£åˆ™åŒ¹é…
- PII è„±æ•
- å†…å­˜é™åˆ¶

---

### 4. Exporters (`04_Exporters_Rustå®Œæ•´ç‰ˆ.md`)

**æ ¸å¿ƒåŠŸèƒ½**:

- OTLP Exporterï¼ˆgRPC/HTTP/TLSï¼‰
- Jaeger Exporterï¼ˆThriftï¼‰
- Prometheus Exporterï¼ˆPull æ¨¡å¼ï¼‰
- Logging Exporterï¼ˆè°ƒè¯•ï¼‰
- Elasticsearch Exporterï¼ˆè‡ªå®šä¹‰ï¼‰
- InfluxDB Exporterï¼ˆè‡ªå®šä¹‰ï¼‰

**å…³é”®å®ç°**:

```rust
// OTLP gRPC Exporter with TLS
pub struct OtlpGrpcExporter {
    client: TraceServiceClient<Channel>,
    endpoint: String,
}

impl OtlpGrpcExporter {
    pub async fn new_with_tls(
        endpoint: String,
        cert_path: &str,
        key_path: &str,
    ) -> Result<Self, ExporterError> {
        let identity = tonic::transport::Identity::from_pem(cert, key);
        let tls_config = ClientTlsConfig::new().identity(identity);
        let channel = Channel::from_shared(endpoint)?
            .tls_config(tls_config)?
            .connect()
            .await?;
        Ok(Self { client: TraceServiceClient::new(channel), endpoint })
    }
}

// é‡è¯•æœºåˆ¶
pub struct RetryExporter<E: CollectorExporter> {
    inner: E,
    max_retries: usize,
    initial_backoff: Duration,
}

// è¶…æ—¶æ§åˆ¶
pub struct TimeoutExporter<E: CollectorExporter> {
    inner: E,
    timeout: Duration,
}

// é™çº§ç­–ç•¥
pub struct FallbackExporter {
    primary: Arc<dyn CollectorExporter>,
    fallback: Arc<dyn CollectorExporter>,
}
```

**å¯é æ€§è®¾è®¡**:

- æŒ‡æ•°é€€é¿é‡è¯•
- è¶…æ—¶æ§åˆ¶
- ä¸»å¤‡é™çº§
- è¿æ¥æ± ç®¡ç†
- å‹ç¼©ä¼ è¾“

---

### 5. Pipeline é…ç½®ä¸ç®¡ç† (`05_Pipelineé…ç½®ä¸ç®¡ç†_Rustå®Œæ•´ç‰ˆ.md`)

**æ ¸å¿ƒåŠŸèƒ½**:

- YAML é…ç½®æ–‡ä»¶è®¾è®¡
- Pipeline æ„å»ºå™¨æ¨¡å¼
- é…ç½®éªŒè¯ä¸åŠ è½½
- é…ç½®çƒ­æ›´æ–°
- å¥åº·æ£€æŸ¥ä¸ç›‘æ§

**å…³é”®å®ç°**:

```rust
// é…ç½®ç»“æ„
#[derive(Debug, Deserialize, Serialize)]
pub struct CollectorConfig {
    pub receivers: HashMap<String, ReceiverConfig>,
    pub processors: HashMap<String, ProcessorConfig>,
    pub exporters: HashMap<String, ExporterConfig>,
    pub extensions: HashMap<String, ExtensionConfig>,
    pub service: ServiceConfig,
}

// Pipeline æ„å»º
pub struct PipelineBuilder {
    config: CollectorConfig,
    receivers: HashMap<String, Arc<dyn Receiver>>,
    processors: HashMap<String, Arc<dyn Processor>>,
    exporters: HashMap<String, Arc<dyn CollectorExporter>>,
}

// é…ç½®çƒ­æ›´æ–°
pub struct ConfigWatcher {
    config: Arc<RwLock<CollectorConfig>>,
    service: Arc<RwLock<Option<CollectorService>>>,
}

// å¥åº·æ£€æŸ¥
async fn health_check() -> Json<serde_json::Value> {
    Json(json!({
        "status": "ok",
        "timestamp": chrono::Utc::now().to_rfc3339(),
    }))
}

// å†…éƒ¨æŒ‡æ ‡
pub struct CollectorMetrics {
    pub spans_received: Counter,
    pub spans_exported: Counter,
    pub spans_dropped: Counter,
    pub export_latency: Histogram,
}
```

**YAML é…ç½®ç¤ºä¾‹**:

```yaml
service:
  extensions: [health_check, pprof, zpages]
  pipelines:
    traces:
      receivers: [otlp, jaeger]
      processors: [memory_limiter, batch, attributes]
      exporters: [otlp, jaeger, logging]
    metrics:
      receivers: [prometheus, otlp]
      processors: [batch]
      exporters: [prometheus, otlp]
    logs:
      receivers: [otlp]
      processors: [filter, batch]
      exporters: [otlp, logging]
```

---

## æ ¸å¿ƒäº®ç‚¹

### 1. **å®Œæ•´çš„ Collector å®ç°æ¶æ„**

- ä» Receiver åˆ° Exporter çš„å®Œæ•´æ•°æ®é“¾è·¯
- æ”¯æŒ Tracesã€Metricsã€Logs ä¸‰ç§ä¿¡å·ç±»å‹
- æ¨¡å—åŒ–è®¾è®¡ï¼Œç»„ä»¶å¯è‡ªç”±ç»„åˆ

### 2. **å¤šåè®®æ”¯æŒ**

- OTLP (gRPC/HTTP)
- Jaeger (Thrift)
- Prometheus (Pull)
- Zipkin
- è‡ªå®šä¹‰åè®®ï¼ˆKafkaã€Elasticsearchã€InfluxDBï¼‰

### 3. **ç”Ÿäº§çº§å¯é æ€§**

- é‡è¯•æœºåˆ¶ï¼ˆæŒ‡æ•°é€€é¿ï¼‰
- è¶…æ—¶æ§åˆ¶
- ä¸»å¤‡é™çº§
- å†…å­˜å‹åŠ›ä¿æŠ¤
- èƒŒå‹æ§åˆ¶

### 4. **é…ç½®é©±åŠ¨**

- YAML é…ç½®æ–‡ä»¶
- å¼•ç”¨å®Œæ•´æ€§éªŒè¯
- é…ç½®çƒ­æ›´æ–°ï¼ˆæ— éœ€é‡å¯ï¼‰
- Builder æ¨¡å¼æ„å»º

### 5. **è¿ç»´å‹å¥½**

- å¥åº·æ£€æŸ¥ç«¯ç‚¹ (`/health`, `/ready`)
- å†…éƒ¨æŒ‡æ ‡æš´éœ²
- ç»“æ„åŒ–æ—¥å¿—
- ä¼˜é›…å…³é—­

### 6. **æ€§èƒ½ä¼˜åŒ–**

- å¼‚æ­¥æ‰¹å¤„ç†
- é›¶æ‹·è´ï¼ˆ`Bytes`ã€`Arc`ï¼‰
- è¿æ¥æ± å¤ç”¨
- GZIP/Snappy å‹ç¼©

---

## æŠ€æœ¯æ ˆæ€»è§ˆ

| ç±»åˆ« | ä¾èµ–åº“ | ç‰ˆæœ¬ | ç”¨é€” |
|------|--------|------|------|
| **å¼‚æ­¥è¿è¡Œæ—¶** | `tokio` | 1.40 | å¼‚æ­¥ä»»åŠ¡è°ƒåº¦ |
| **gRPC** | `tonic` | 0.12 | gRPC æœåŠ¡å™¨/å®¢æˆ·ç«¯ |
| **HTTP** | `axum` | 0.7 | HTTP æœåŠ¡å™¨ |
| **ä¸­é—´ä»¶** | `tower` | 0.5 | è¯·æ±‚å¤„ç†ä¸­é—´ä»¶ |
| **åºåˆ—åŒ–** | `serde`, `serde_yaml` | 1.0, 0.9 | é…ç½®è§£æ |
| **OTLP** | `opentelemetry-otlp` | 0.17 | OTLP åè®® |
| **ç›‘æ§** | `prometheus` | 0.13 | æŒ‡æ ‡æ”¶é›† |
| **æ–‡ä»¶ç›‘å¬** | `notify` | 4.0 | é…ç½®çƒ­æ›´æ–° |
| **æ­£åˆ™è¡¨è¾¾å¼** | `regex` | 1.10 | è¿‡æ»¤è§„åˆ™ |
| **é”™è¯¯å¤„ç†** | `thiserror` | 1.0 | é”™è¯¯å®šä¹‰ |

---

## ä¸‹ä¸€æ­¥è®¡åˆ’

### âœ… å·²å®Œæˆ

- `04_SDKè§„èŒƒ` - 19ç¯‡ï¼ˆTracing/Metrics/Logs/Context Propagationï¼‰
- `05_Collectorè§„èŒƒ` - 5ç¯‡ï¼ˆæ¶æ„/Receivers/Processors/Exporters/Pipelineï¼‰

### ğŸš€ ä¸‹ä¸€æ­¥

- `06_é«˜çº§ç‰¹æ€§` - 5ç¯‡ï¼ˆå¾…è¡¥å……ï¼‰
  - é‡‡æ ·ç­–ç•¥ä¸ä¼˜åŒ–
  - åˆ†å¸ƒå¼è¿½è¸ªä¸Šä¸‹æ–‡ä¼ æ’­
  - å¤šç§Ÿæˆ·éš”ç¦»
  - æ•°æ®è„±æ•ä¸å®‰å…¨
  - æ€§èƒ½åŸºå‡†æµ‹è¯•

---

## æ€»ç»“

ç¬¬28æ‰¹è¡¥å……å®Œæˆäº† **OpenTelemetry Collector è§„èŒƒ** çš„å…¨éƒ¨5ç¯‡ Rust å®ç°æ–‡æ¡£ï¼Œæ¶µç›–ï¼š

1. **æ¶æ„è®¾è®¡**ï¼šReceiver â†’ Processor â†’ Exporter ç®¡é“æ¨¡å‹
2. **æ•°æ®æ¥æ”¶**ï¼šOTLP/Jaeger/Prometheus å¤šåè®®æ”¯æŒ
3. **æ•°æ®å¤„ç†**ï¼šæ‰¹é‡ã€è¿‡æ»¤ã€è½¬æ¢ã€è„±æ•
4. **æ•°æ®å¯¼å‡º**ï¼šOTLP/Jaeger/Prometheus/Elasticsearch/InfluxDB
5. **é…ç½®ç®¡ç†**ï¼šYAML é©±åŠ¨ã€çƒ­æ›´æ–°ã€å¥åº·æ£€æŸ¥

**å…¨éƒ¨å·¥ä½œå®Œæˆï¼Collector è§„èŒƒæ¨¡å—è¾¾æˆï¼ğŸ‰**-

æ­å–œï¼OpenTelemetry Collector è§„èŒƒçš„ Rust å®ç°å®Œæ•´è¾¾æˆï¼ğŸš€
