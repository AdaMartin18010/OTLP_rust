# ğŸ“¦ Rust ä¾èµ–ç®¡ç†ä¸å®‰å…¨æ›´æ–°æŒ‡å— (2025)

> **ä½œè€…**: Rust å®‰å…¨ä¸“å®¶å›¢é˜Ÿ  
> **ç‰ˆæœ¬**: v2.5  
> **Rust ç‰ˆæœ¬**: 1.90+ (Edition 2024)  
> **æœ€åæ›´æ–°**: 2025å¹´10æœˆ11æ—¥  
> **å®‰å…¨ç­‰çº§**: ğŸ”’ ç”Ÿäº§çº§

---

## ğŸ“‹ ç›®å½•

- [ğŸ“¦ Rust ä¾èµ–ç®¡ç†ä¸å®‰å…¨æ›´æ–°æŒ‡å— (2025)](#-rust-ä¾èµ–ç®¡ç†ä¸å®‰å…¨æ›´æ–°æŒ‡å—-2025)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. ç°ä»£ä¾èµ–ç®¡ç†ç­–ç•¥](#1-ç°ä»£ä¾èµ–ç®¡ç†ç­–ç•¥)
    - [1.1 ä¾èµ–é€‰æ‹©åŸåˆ™](#11-ä¾èµ–é€‰æ‹©åŸåˆ™)
    - [1.2 ä¾èµ–åˆ†ç±»ç®¡ç†](#12-ä¾èµ–åˆ†ç±»ç®¡ç†)
  - [2. Cargo.toml æœ€ä½³å®è·µ](#2-cargotoml-æœ€ä½³å®è·µ)
    - [2.1 ç‰ˆæœ¬çº¦æŸç­–ç•¥](#21-ç‰ˆæœ¬çº¦æŸç­–ç•¥)
    - [2.2 ç‰¹æ€§æ ‡å¿—è®¾è®¡](#22-ç‰¹æ€§æ ‡å¿—è®¾è®¡)
  - [3. å·¥ä½œåŒºä¾èµ–ç®¡ç†](#3-å·¥ä½œåŒºä¾èµ–ç®¡ç†)
    - [3.1 å·¥ä½œåŒºé…ç½®](#31-å·¥ä½œåŒºé…ç½®)
    - [3.2 å­ crate é…ç½®](#32-å­-crate-é…ç½®)
  - [4. å®‰å…¨å®¡è®¡æµç¨‹](#4-å®‰å…¨å®¡è®¡æµç¨‹)
    - [4.1 cargo-audit é›†æˆ](#41-cargo-audit-é›†æˆ)
    - [4.2 cargo-deny é…ç½®](#42-cargo-deny-é…ç½®)
  - [5. ä¾èµ–æ›´æ–°ç­–ç•¥](#5-ä¾èµ–æ›´æ–°ç­–ç•¥)
    - [5.1 è‡ªåŠ¨æ›´æ–°å·¥å…·](#51-è‡ªåŠ¨æ›´æ–°å·¥å…·)
    - [5.2 Renovate é…ç½®](#52-renovate-é…ç½®)
  - [6. ä¾›åº”é“¾å®‰å…¨](#6-ä¾›åº”é“¾å®‰å…¨)
    - [6.1 cargo-supply-chain å®¡è®¡](#61-cargo-supply-chain-å®¡è®¡)
  - [7. ç‰ˆæœ¬é”å®šä¸å‘å¸ƒ](#7-ç‰ˆæœ¬é”å®šä¸å‘å¸ƒ)
    - [7.1 Cargo.lock ç®¡ç†](#71-cargolock-ç®¡ç†)
    - [7.2 è¯­ä¹‰åŒ–ç‰ˆæœ¬å‘å¸ƒ](#72-è¯­ä¹‰åŒ–ç‰ˆæœ¬å‘å¸ƒ)
  - [8. CI/CD é›†æˆ](#8-cicd-é›†æˆ)
    - [8.1 GitHub Actions å·¥ä½œæµ](#81-github-actions-å·¥ä½œæµ)
  - [9. æ¼æ´å“åº”æµç¨‹](#9-æ¼æ´å“åº”æµç¨‹)
    - [9.1 åº”æ€¥å“åº”è„šæœ¬](#91-åº”æ€¥å“åº”è„šæœ¬)
  - [10. å·¥å…·é“¾æ¨è](#10-å·¥å…·é“¾æ¨è)
    - [10.1 å¿…å¤‡å·¥å…·æ¸…å•](#101-å¿…å¤‡å·¥å…·æ¸…å•)
  - [ğŸ“Š æ€»ç»“](#-æ€»ç»“)
    - [æ ¸å¿ƒè¦ç‚¹](#æ ¸å¿ƒè¦ç‚¹)
    - [æœ€ä½³å®è·µæ¸…å•](#æœ€ä½³å®è·µæ¸…å•)

---

## 1. ç°ä»£ä¾èµ–ç®¡ç†ç­–ç•¥

### 1.1 ä¾èµ–é€‰æ‹©åŸåˆ™

```toml
# Cargo.toml - 2025å¹´æœ€ä½³å®è·µ

[package]
name = "otlp-rust-service"
version = "2.0.0"
edition = "2024"
rust-version = "1.90"  # æœ€å°æ”¯æŒçš„ Rust ç‰ˆæœ¬ (MSRV)
license = "MIT OR Apache-2.0"
repository = "https://github.com/your-org/otlp-rust"
documentation = "https://docs.rs/otlp-rust-service"
readme = "README.md"
keywords = ["otlp", "opentelemetry", "observability", "tracing", "metrics"]
categories = ["development-tools::profiling", "asynchronous"]

[dependencies]
# ============================================================================
# æ ¸å¿ƒä¾èµ– - ä¸¥æ ¼ç‰ˆæœ¬æ§åˆ¶
# ============================================================================

# OpenTelemetry ç”Ÿæ€ - ä½¿ç”¨æœ€æ–°ç¨³å®šç‰ˆæœ¬
opentelemetry = { version = "0.31.0", features = ["trace", "metrics", "logs"] }
opentelemetry_sdk = { version = "0.31.0", features = ["rt-tokio"] }
opentelemetry-otlp = { version = "0.31.0", features = ["grpc-tonic", "http-json"] }

# å¼‚æ­¥è¿è¡Œæ—¶ - Tokio 1.47+
tokio = { version = "1.47", features = [
    "rt-multi-thread",  # å¤šçº¿ç¨‹è¿è¡Œæ—¶
    "macros",           # async/await å®
    "sync",             # åŒæ­¥åŸè¯­
    "time",             # æ—¶é—´åŠŸèƒ½
    "signal",           # ä¿¡å·å¤„ç†
    "fs",               # æ–‡ä»¶ç³»ç»Ÿ
    "io-util",          # I/O å·¥å…·
    "net",              # ç½‘ç»œ
    "parking_lot",      # é«˜æ€§èƒ½é”
] }

# gRPC å’Œåºåˆ—åŒ–
tonic = { version = "0.14", features = ["tls-ring", "gzip", "zstd"] }
prost = "0.14"

# é”™è¯¯å¤„ç†
anyhow = "1.0"         # é€šç”¨é”™è¯¯å¤„ç†
thiserror = "2.0"      # è‡ªå®šä¹‰é”™è¯¯ç±»å‹

# æ—¥å¿—å’Œè¿½è¸ª
tracing = "0.1"
tracing-subscriber = { version = "0.3", features = ["env-filter", "json"] }

# åºåˆ—åŒ–
serde = { version = "1.0", features = ["derive"] }
serde_json = "1.0"

# ============================================================================
# å¯é€‰ä¾èµ– - ç‰¹æ€§é—¨æ§
# ============================================================================

[dependencies.metrics]
version = "0.24"
optional = true

[dependencies.prometheus]
version = "0.14"
optional = true

# ============================================================================
# å¼€å‘ä¾èµ–
# ============================================================================

[dev-dependencies]
criterion = { version = "0.7", features = ["html_reports", "async_tokio"] }
mockall = "0.13"
proptest = "1.8"
tokio-test = "0.4"
tempfile = "3.23"

# ============================================================================
# æ„å»ºä¾èµ–
# ============================================================================

[build-dependencies]
tonic-build = "0.14"
prost-build = "0.14"

# ============================================================================
# ç‰¹æ€§æ ‡å¿—
# ============================================================================

[features]
default = ["grpc", "metrics-prometheus"]

# å¯¼å‡ºå™¨åè®®
grpc = ["opentelemetry-otlp/grpc-tonic", "tonic"]
http = ["opentelemetry-otlp/http-json"]

# æŒ‡æ ‡å¯¼å‡º
metrics-prometheus = ["metrics", "prometheus"]

# TLS æ”¯æŒ
tls-rustls = ["tonic/tls-ring"]
tls-native = ["tonic/tls-native"]

# å®Œæ•´ç‰¹æ€§é›†
full = ["grpc", "http", "metrics-prometheus", "tls-rustls"]
```

### 1.2 ä¾èµ–åˆ†ç±»ç®¡ç†

```toml
# Cargo.toml - æŒ‰ç”¨é€”åˆ†ç±»

[dependencies]
# ============================================================================
# ç¬¬ 1 å±‚ï¼šæ ¸å¿ƒè¿è¡Œæ—¶ (ä¸å¯æ›¿æ¢)
# ============================================================================
tokio = { version = "1.47", features = ["full"] }
futures = "0.3"

# ============================================================================
# ç¬¬ 2 å±‚ï¼šåè®®å®ç° (å¯æ›¿æ¢ï¼Œä½†éœ€è¯„ä¼°)
# ============================================================================
tonic = { version = "0.14", features = ["tls-ring"] }
hyper = { version = "1.7", features = ["full"] }

# æˆ–è€…ä½¿ç”¨ reqwest
# reqwest = { version = "0.12", features = ["json", "rustls-tls"] }

# ============================================================================
# ç¬¬ 3 å±‚ï¼šå·¥å…·åº“ (å¯çµæ´»æ›¿æ¢)
# ============================================================================
serde = { version = "1.0", features = ["derive"] }
serde_json = "1.0"

# æˆ–è€…ä½¿ç”¨å…¶ä»–åºåˆ—åŒ–åº“
# serde_yaml = "0.9"
# toml = "0.9"

# ============================================================================
# ç¬¬ 4 å±‚ï¼šå¯é€‰æ‰©å±•
# ============================================================================
# æ€§èƒ½åˆ†æ
[dependencies.pprof]
version = "0.13"
optional = true
features = ["flamegraph", "protobuf"]

# ============================================================================
# å¹³å°ç‰¹å®šä¾èµ–
# ============================================================================

[target.'cfg(unix)'.dependencies]
nix = { version = "0.28", features = ["signal"] }

[target.'cfg(windows)'.dependencies]
winapi = { version = "0.3", features = ["handleapi", "processthreadsapi"] }

[target.'cfg(target_os = "linux")'.dependencies]
libc = "0.2"

# ============================================================================
# ç›®æ ‡æ¶æ„ç‰¹å®šä¼˜åŒ–
# ============================================================================

[target.'cfg(target_arch = "x86_64")'.dependencies]
# x86_64 ç‰¹å®šçš„ SIMD ä¼˜åŒ–
packed_simd_2 = "0.3"

[target.'cfg(target_arch = "aarch64")'.dependencies]
# ARM ç‰¹å®šä¼˜åŒ–åº“
```

---

## 2. Cargo.toml æœ€ä½³å®è·µ

### 2.1 ç‰ˆæœ¬çº¦æŸç­–ç•¥

```toml
# ç‰ˆæœ¬çº¦æŸæŒ‡å—

[dependencies]
# ============================================================================
# ä¸¥æ ¼ç‰ˆæœ¬ (=) - ä»…ç”¨äºå…³é”®ä¾èµ–
# ============================================================================
opentelemetry = "=0.31.0"  # ç²¾ç¡®ç‰ˆæœ¬ï¼Œä»»ä½•æ›´æ–°éƒ½éœ€æ˜ç¡®

# ============================================================================
# å…¼å®¹ç‰ˆæœ¬ (^) - é»˜è®¤ç­–ç•¥
# ============================================================================
tokio = "^1.47.0"  # å…è®¸ >=1.47.0 <2.0.0
# ç­‰åŒäº: tokio = "1.47"

# ============================================================================
# æ³¢æµªå·ç‰ˆæœ¬ (~) - è¡¥ä¸çº§åˆ«æ›´æ–°
# ============================================================================
serde = "~1.0.228"  # å…è®¸ >=1.0.228 <1.1.0

# ============================================================================
# é€šé…ç¬¦ç‰ˆæœ¬ (*) - é¿å…ä½¿ç”¨
# ============================================================================
# some-crate = "*"  # âŒ ä¸æ¨èï¼šè¿‡äºå®½æ¾

# ============================================================================
# ç‰ˆæœ¬èŒƒå›´ - æ˜ç¡®å…¼å®¹æ€§
# ============================================================================
anyhow = ">=1.0.100, <2.0.0"  # æ˜¾å¼èŒƒå›´

# ============================================================================
# Git ä¾èµ– - ä»…ç”¨äºå¼€å‘
# ============================================================================
[dependencies.custom-otlp-exporter]
git = "https://github.com/your-org/custom-exporter"
branch = "main"
# ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ tag æˆ– rev
# tag = "v1.0.0"
# rev = "abc123def456"

# ============================================================================
# æœ¬åœ°è·¯å¾„ä¾èµ– - ä»…ç”¨äºå¼€å‘
# ============================================================================
[dependencies.local-utils]
path = "../utils"
# å‘å¸ƒå‰å¿…é¡»æ›¿æ¢ä¸º crates.io ç‰ˆæœ¬

# ============================================================================
# ç‰ˆæœ¬ç»§æ‰¿ï¼ˆå·¥ä½œåŒºï¼‰
# ============================================================================
[dependencies]
opentelemetry = { workspace = true }  # ç»§æ‰¿å·¥ä½œåŒºç‰ˆæœ¬
tokio = { workspace = true, features = ["full"] }  # å¯æ·»åŠ é¢å¤–ç‰¹æ€§
```

### 2.2 ç‰¹æ€§æ ‡å¿—è®¾è®¡

```toml
# ç‰¹æ€§æ ‡å¿—æœ€ä½³å®è·µ

[features]
# ============================================================================
# é»˜è®¤ç‰¹æ€§ - æœ€å°å¯ç”¨é›†
# ============================================================================
default = ["grpc", "basic-metrics"]

# ============================================================================
# åè®®æ”¯æŒ
# ============================================================================
grpc = ["tonic", "opentelemetry-otlp/grpc-tonic"]
http = ["reqwest", "opentelemetry-otlp/http-json"]

# ============================================================================
# æŒ‡æ ‡å¯¼å‡ºå™¨
# ============================================================================
basic-metrics = []
metrics-prometheus = ["metrics", "prometheus", "basic-metrics"]
metrics-statsd = ["metrics", "statsd", "basic-metrics"]
metrics-all = ["metrics-prometheus", "metrics-statsd"]

# ============================================================================
# TLS å®ç°
# ============================================================================
tls-rustls = ["tonic/tls-ring", "rustls"]
tls-native = ["tonic/tls-native", "native-tls"]
tls-vendored = ["tls-native", "native-tls/vendored"]

# ============================================================================
# æ€§èƒ½ä¼˜åŒ–
# ============================================================================
performance = ["jemalloc", "mimalloc"]
jemalloc = ["jemallocator"]
mimalloc = ["mimalloc-rust"]

# ============================================================================
# å¼€å‘ç‰¹æ€§
# ============================================================================
dev-tools = ["pprof", "tokio-console"]

# ============================================================================
# å®Œæ•´ç‰¹æ€§é›†
# ============================================================================
full = [
    "grpc",
    "http",
    "metrics-all",
    "tls-rustls",
    "performance",
]

# ============================================================================
# äº’æ–¥ç‰¹æ€§æ£€æŸ¥
# ============================================================================
# åœ¨ build.rs ä¸­å®ç°

[package.metadata.docs.rs]
# docs.rs æ„å»ºé…ç½®
all-features = true
rustdoc-args = ["--cfg", "docsrs"]
```

---

## 3. å·¥ä½œåŒºä¾èµ–ç®¡ç†

### 3.1 å·¥ä½œåŒºé…ç½®

```toml
# Cargo.toml (workspace root)

[workspace]
resolver = "3"  # Rust 1.90 æ¨èä½¿ç”¨ resolver v3

members = [
    "crates/otlp-core",
    "crates/otlp-sdk",
    "crates/otlp-exporter-grpc",
    "crates/otlp-exporter-http",
    "crates/otlp-contrib",
]

# æ’é™¤ç›®å½•
exclude = [
    "examples",
    "benches",
    "target",
]

# ============================================================================
# å·¥ä½œåŒºçº§åˆ«ä¾èµ– - ç»Ÿä¸€ç‰ˆæœ¬ç®¡ç†
# ============================================================================

[workspace.package]
version = "2.0.0"
edition = "2024"
rust-version = "1.90"
license = "MIT OR Apache-2.0"
repository = "https://github.com/your-org/otlp-rust"

[workspace.dependencies]
# OpenTelemetry ç”Ÿæ€ - 2025å¹´10æœˆæœ€æ–°ç‰ˆæœ¬
opentelemetry = "0.31.0"
opentelemetry_sdk = "0.31.0"
opentelemetry-otlp = "0.31.0"
opentelemetry-semantic-conventions = "0.31.0"

# å¼‚æ­¥è¿è¡Œæ—¶
tokio = { version = "1.47", features = ["full"] }
tokio-util = "0.7"
tokio-stream = "0.1"
futures = "0.3"

# gRPC å’Œåºåˆ—åŒ–
tonic = "0.14"
prost = "0.14"
prost-types = "0.14"

# é”™è¯¯å¤„ç†
anyhow = "1.0"
thiserror = "2.0"

# æ—¥å¿—å’Œè¿½è¸ª
tracing = "0.1"
tracing-subscriber = "0.3"

# åºåˆ—åŒ–
serde = { version = "1.0", features = ["derive"] }
serde_json = "1.0"

# æµ‹è¯•
criterion = "0.7"
mockall = "0.13"
proptest = "1.8"

# ============================================================================
# å·¥ä½œåŒºä¾èµ–è¡¥ä¸ - ä¸´æ—¶ä¿®å¤
# ============================================================================

[patch.crates-io]
# ä»…ç”¨äºç´§æ€¥å®‰å…¨ä¿®å¤
# ç”Ÿäº§ç¯å¢ƒé¿å…ä½¿ç”¨

# ç¤ºä¾‹ï¼šä½¿ç”¨æœ¬åœ°ä¿®å¤ç‰ˆæœ¬
# vulnerable-crate = { path = "./patches/vulnerable-crate" }

# ç¤ºä¾‹ï¼šä½¿ç”¨ Git ä¿®å¤ç‰ˆæœ¬
# vulnerable-crate = { git = "https://github.com/maintainer/fixed-version", branch = "security-fix" }

# ============================================================================
# å·¥ä½œåŒºé…ç½®
# ============================================================================

[workspace.metadata]
# è‡ªå®šä¹‰å…ƒæ•°æ®
min-supported-rust-version = "1.90"
security-contact = "security@example.com"
```

### 3.2 å­ crate é…ç½®

```toml
# crates/otlp-core/Cargo.toml

[package]
name = "otlp-core"
# ç»§æ‰¿å·¥ä½œåŒºé…ç½®
version.workspace = true
edition.workspace = true
rust-version.workspace = true
license.workspace = true
repository.workspace = true

description = "OTLP core types and traits"
keywords = ["otlp", "opentelemetry", "core"]

[dependencies]
# ç»§æ‰¿å·¥ä½œåŒºä¾èµ–
opentelemetry = { workspace = true }
serde = { workspace = true }
thiserror = { workspace = true }

# æœ¬åœ°å·¥ä½œåŒºä¾èµ–
# (ç©º - è¿™æ˜¯æ ¸å¿ƒ crate)

[dev-dependencies]
criterion = { workspace = true }
proptest = { workspace = true }
```

```toml
# crates/otlp-exporter-grpc/Cargo.toml

[package]
name = "otlp-exporter-grpc"
version.workspace = true
edition.workspace = true
rust-version.workspace = true
license.workspace = true
repository.workspace = true

description = "OTLP gRPC exporter"
keywords = ["otlp", "grpc", "exporter"]

[dependencies]
# ç»§æ‰¿å·¥ä½œåŒºä¾èµ–
opentelemetry = { workspace = true }
opentelemetry-otlp = { workspace = true, features = ["grpc-tonic"] }
tonic = { workspace = true }
tokio = { workspace = true }

# æœ¬åœ°å·¥ä½œåŒºä¾èµ–
otlp-core = { path = "../otlp-core", version = "2.0.0" }

[dev-dependencies]
tokio-test = { version = "0.4" }
mockall = { workspace = true }
```

---

## 4. å®‰å…¨å®¡è®¡æµç¨‹

### 4.1 cargo-audit é›†æˆ

```bash
#!/bin/bash
# scripts/security-audit.sh

set -euo pipefail

echo "ğŸ”’ å¼€å§‹å®‰å…¨å®¡è®¡..."

# 1. å®‰è£… cargo-auditï¼ˆå¦‚æœæœªå®‰è£…ï¼‰
if ! command -v cargo-audit &> /dev/null; then
    echo "å®‰è£… cargo-audit..."
    cargo install cargo-audit --locked
fi

# 2. æ›´æ–°æ¼æ´æ•°æ®åº“
echo "æ›´æ–°æ¼æ´æ•°æ®åº“..."
cargo audit fetch

# 3. æ‰§è¡Œå®¡è®¡
echo "æ‰§è¡Œå®‰å…¨å®¡è®¡..."
cargo audit \
    --deny warnings \
    --deny unmaintained \
    --deny unsound \
    --deny yanked \
    --json > audit-report.json

# 4. ç”Ÿæˆäººç±»å¯è¯»æŠ¥å‘Š
cargo audit > audit-report.txt

# 5. æ£€æŸ¥ä¸¥é‡æ¼æ´
CRITICAL_COUNT=$(jq '[.vulnerabilities.list[] | select(.advisory.severity == "critical")] | length' audit-report.json)

if [ "$CRITICAL_COUNT" -gt 0 ]; then
    echo "âŒ å‘ç° ${CRITICAL_COUNT} ä¸ªä¸¥é‡æ¼æ´ï¼"
    jq '.vulnerabilities.list[] | select(.advisory.severity == "critical")' audit-report.json
    exit 1
else
    echo "âœ… æœªå‘ç°ä¸¥é‡æ¼æ´"
fi

# 6. ç”Ÿæˆ SBOMï¼ˆè½¯ä»¶ç‰©æ–™æ¸…å•ï¼‰
echo "ç”Ÿæˆ SBOM..."
cargo tree --format json > sbom.json

echo "âœ… å®‰å…¨å®¡è®¡å®Œæˆï¼"
```

### 4.2 cargo-deny é…ç½®

```toml
# deny.toml - ä¾èµ–ç­–ç•¥é…ç½®

# ============================================================================
# è®¸å¯è¯æ£€æŸ¥
# ============================================================================

[licenses]
# å¿…é¡»æ˜ç¡®æŒ‡å®šè®¸å¯è¯
unlicensed = "deny"

# å…è®¸çš„è®¸å¯è¯åˆ—è¡¨
allow = [
    "MIT",
    "Apache-2.0",
    "BSD-2-Clause",
    "BSD-3-Clause",
    "ISC",
    "Unlicense",
]

# æ‹’ç»çš„è®¸å¯è¯
deny = [
    "GPL-2.0",
    "GPL-3.0",
    "AGPL-3.0",
]

# éœ€è¦å®¡æŸ¥çš„è®¸å¯è¯
copyleft = "deny"

# ============================================================================
# å®‰å…¨æ¼æ´æ£€æŸ¥
# ============================================================================

[advisories]
# æ•°æ®åº“ URL
db-path = "~/.cargo/advisory-db"
db-urls = ["https://github.com/rustsec/advisory-db"]

# æ¼æ´ä¸¥é‡æ€§
vulnerability = "deny"  # æ‹’ç»ä»»ä½•å·²çŸ¥æ¼æ´
unmaintained = "warn"   # è­¦å‘Šæœªç»´æŠ¤çš„ crate
unsound = "deny"        # æ‹’ç»ä¸å¥å…¨çš„ä»£ç 
yanked = "deny"         # æ‹’ç»å·²æ’¤å›çš„ç‰ˆæœ¬

# å¿½ç•¥ç‰¹å®šæ¼æ´ï¼ˆä»…ç”¨äºä¸´æ—¶è±å…ï¼‰
ignore = [
    # "RUSTSEC-2024-0001",  # ç¤ºä¾‹ï¼šå·²è¯„ä¼°é£é™©å¯æ¥å—
]

# ============================================================================
# ä¾èµ–æºæ£€æŸ¥
# ============================================================================

[sources]
# å…è®¸çš„æº
allow-registry = ["https://github.com/rust-lang/crates.io-index"]

# Git æºå¿…é¡»æ˜ç¡®å…è®¸
[sources.allow-org]
github = ["your-org"]

# ============================================================================
# é‡å¤ä¾èµ–æ£€æŸ¥
# ============================================================================

[bans]
# æ£€æµ‹å¤šç‰ˆæœ¬ä¾èµ–
multiple-versions = "warn"

# æ‹’ç»é€šé…ç¬¦ä¾èµ–
wildcards = "deny"

# æ‹’ç»ä½¿ç”¨çš„ crate
deny = [
    # å·²çŸ¥ä¸å®‰å…¨çš„ crate
    { name = "unsafe-crate", version = "*" },
]

# è·³è¿‡ç‰¹å®šä¾èµ–æ ‘
skip = []

# å…è®¸çš„é‡å¤ä¾èµ–ï¼ˆä¸´æ—¶ï¼‰
skip-tree = [
    # { name = "some-crate", version = "=0.1.0" },
]
```

---

## 5. ä¾èµ–æ›´æ–°ç­–ç•¥

### 5.1 è‡ªåŠ¨æ›´æ–°å·¥å…·

```bash
#!/bin/bash
# scripts/update-dependencies.sh

set -euo pipefail

echo "ğŸ“¦ å¼€å§‹ä¾èµ–æ›´æ–°æµç¨‹..."

# 1. å®‰è£…å¿…è¦å·¥å…·
echo "å®‰è£…å·¥å…·..."
cargo install cargo-edit cargo-outdated --locked

# 2. æ£€æŸ¥è¿‡æ—¶ä¾èµ–
echo "æ£€æŸ¥è¿‡æ—¶ä¾èµ–..."
cargo outdated --root-deps-only > outdated-report.txt
cat outdated-report.txt

# 3. åˆ†ç±»æ›´æ–°

echo "æ‰§è¡Œè¡¥ä¸çº§åˆ«æ›´æ–°..."
cargo update --precise-recursive

echo "æ‰§è¡Œæ¬¡è¦ç‰ˆæœ¬æ›´æ–°ï¼ˆå®‰å…¨ï¼‰..."
# ä»…æ›´æ–°å…¼å®¹ç‰ˆæœ¬
cargo upgrade --compatible

# 4. æ‰§è¡Œä¸»è¦ç‰ˆæœ¬æ›´æ–°ï¼ˆéœ€äººå·¥å®¡æ ¸ï¼‰
echo "ç”Ÿæˆä¸»è¦ç‰ˆæœ¬æ›´æ–°æŠ¥å‘Š..."
cargo upgrade --incompatible --dry-run > major-updates.txt

# 5. è¿è¡Œæµ‹è¯•
echo "è¿è¡Œæµ‹è¯•å¥—ä»¶..."
cargo test --all-features

# 6. è¿è¡ŒåŸºå‡†æµ‹è¯•
echo "è¿è¡ŒåŸºå‡†æµ‹è¯•..."
cargo bench --no-run

# 7. å®‰å…¨å®¡è®¡
echo "æ‰§è¡Œå®‰å…¨å®¡è®¡..."
./scripts/security-audit.sh

# 8. ç”Ÿæˆæ›´æ–°æŠ¥å‘Š
cat << EOF > dependency-update-report.md
# ä¾èµ–æ›´æ–°æŠ¥å‘Š - $(date +%Y-%m-%d)

## è¿‡æ—¶ä¾èµ–
\`\`\`
$(cat outdated-report.txt)
\`\`\`

## ä¸»è¦ç‰ˆæœ¬æ›´æ–°å»ºè®®
\`\`\`
$(cat major-updates.txt)
\`\`\`

## æµ‹è¯•ç»“æœ
âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡

## å®‰å…¨å®¡è®¡
$(cat audit-report.txt)

EOF

echo "âœ… ä¾èµ–æ›´æ–°å®Œæˆï¼è¯·æŸ¥çœ‹ dependency-update-report.md"
```

### 5.2 Renovate é…ç½®

```json
{
  "extends": ["config:base"],
  "packageRules": [
    {
      "matchManagers": ["cargo"],
      "matchUpdateTypes": ["patch"],
      "automerge": true,
      "automergeType": "pr",
      "schedule": ["before 3am on Monday"]
    },
    {
      "matchManagers": ["cargo"],
      "matchUpdateTypes": ["minor"],
      "groupName": "Rust minor updates",
      "schedule": ["before 3am on the first day of the month"]
    },
    {
      "matchManagers": ["cargo"],
      "matchUpdateTypes": ["major"],
      "groupName": "Rust major updates",
      "enabled": false,
      "schedule": ["at any time"]
    },
    {
      "matchPackageNames": ["opentelemetry", "opentelemetry_sdk", "opentelemetry-otlp"],
      "groupName": "OpenTelemetry packages",
      "automerge": false
    },
    {
      "matchPackageNames": ["tokio", "tokio-util", "tokio-stream"],
      "groupName": "Tokio packages",
      "automerge": false
    }
  ],
  "prConcurrentLimit": 5,
  "prHourlyLimit": 2,
  "labels": ["dependencies", "rust"],
  "assignees": ["@security-team"],
  "reviewers": ["@rust-team"],
  "vulnerabilityAlerts": {
    "enabled": true,
    "labels": ["security", "urgent"],
    "assignees": ["@security-team"]
  },
  "lockFileMaintenance": {
    "enabled": true,
    "schedule": ["before 3am on Monday"]
  }
}
```

---

## 6. ä¾›åº”é“¾å®‰å…¨

### 6.1 cargo-supply-chain å®¡è®¡

```bash
#!/bin/bash
# scripts/supply-chain-audit.sh

set -euo pipefail

echo "ğŸ”— å¼€å§‹ä¾›åº”é“¾å®¡è®¡..."

# 1. å®‰è£…å·¥å…·
cargo install cargo-supply-chain --locked

# 2. åˆ†æè´¡çŒ®è€…
echo "åˆ†æä¾èµ–è´¡çŒ®è€…..."
cargo supply-chain publishers > publishers-report.txt

# 3. è¯†åˆ«å•ä¸€è´¡çŒ®è€…é£é™©
echo "è¯†åˆ«å•ä¸€è´¡çŒ®è€… crate..."
cargo supply-chain publishers --json | \
    jq '[.crates[] | select(.publishers | length == 1)]' > single-publisher-crates.json

# 4. æ£€æŸ¥ crate æ‰€æœ‰è€…
echo "åˆ†æ crate æ‰€æœ‰è€…..."
cargo supply-chain update
cargo supply-chain crates > crates-report.txt

# 5. ç”Ÿæˆä¾›åº”é“¾å›¾
echo "ç”Ÿæˆä¾èµ–å›¾..."
cargo tree --format "{p} {f}" > dependency-tree.txt

# 6. è¯†åˆ«é«˜é£é™©ä¾èµ–
echo "è¯†åˆ«é«˜é£é™©ä¾èµ–..."
cat << 'SCRIPT' > analyze-risk.sh
#!/bin/bash
# åˆ†æé£é™©å› ç´ 
jq -r '.crates[] | 
    select(
        (.publishers | length == 1) or 
        (.downloads < 1000) or 
        (.recent_downloads < 100)
    ) | 
    "\(.name):\n  Publishers: \(.publishers | length)\n  Downloads: \(.downloads)\n  Recent: \(.recent_downloads)\n"' \
    single-publisher-crates.json
SCRIPT

chmod +x analyze-risk.sh
./analyze-risk.sh > high-risk-crates.txt

echo "âœ… ä¾›åº”é“¾å®¡è®¡å®Œæˆï¼"
echo "æŸ¥çœ‹ publishers-report.txt å’Œ high-risk-crates.txt"
```

---

## 7. ç‰ˆæœ¬é”å®šä¸å‘å¸ƒ

### 7.1 Cargo.lock ç®¡ç†

```bash
#!/bin/bash
# scripts/manage-lockfile.sh

# Cargo.lock æœ€ä½³å®è·µ

# 1. åº“é¡¹ç›®ï¼ˆlibraryï¼‰ï¼šä¸æäº¤ Cargo.lock
if [ -f "Cargo.lock" ] && grep -q "^crate-type.*lib" Cargo.toml; then
    echo "è­¦å‘Šï¼šåº“é¡¹ç›®ä¸åº”æäº¤ Cargo.lock"
    echo "æ·»åŠ åˆ° .gitignore:"
    echo "Cargo.lock" >> .gitignore
fi

# 2. äºŒè¿›åˆ¶é¡¹ç›®ï¼ˆbinaryï¼‰ï¼šå¿…é¡»æäº¤ Cargo.lock
if grep -q "^\[\[bin\]\]" Cargo.toml; then
    if [ ! -f "Cargo.lock" ]; then
        echo "ç”Ÿæˆ Cargo.lock..."
        cargo generate-lockfile
    fi
    
    # éªŒè¯ lockæ–‡ä»¶
    cargo verify-project --locked
    
    echo "âœ… Cargo.lock å·²å°±ç»ªï¼ˆäºŒè¿›åˆ¶é¡¹ç›®ï¼‰"
fi

# 3. æ›´æ–° lock æ–‡ä»¶ï¼ˆä¿æŒä¾èµ–ç‰ˆæœ¬ï¼‰
update_lockfile_conservative() {
    echo "ä¿å®ˆæ›´æ–° Cargo.lock..."
    cargo update --precise-recursive
}

# 4. å®Œå…¨é‡å»º lock æ–‡ä»¶
rebuild_lockfile() {
    echo "é‡å»º Cargo.lock..."
    rm -f Cargo.lock
    cargo generate-lockfile
    cargo check --all-features
}
```

### 7.2 è¯­ä¹‰åŒ–ç‰ˆæœ¬å‘å¸ƒ

```bash
#!/bin/bash
# scripts/release.sh

set -euo pipefail

# è·å–å½“å‰ç‰ˆæœ¬
CURRENT_VERSION=$(grep -m1 '^version' Cargo.toml | cut -d'"' -f2)

echo "å½“å‰ç‰ˆæœ¬: ${CURRENT_VERSION}"
echo "é€‰æ‹©å‘å¸ƒç±»å‹:"
echo "1. Patch (bugä¿®å¤): ${CURRENT_VERSION} -> $(semver bump patch ${CURRENT_VERSION})"
echo "2. Minor (æ–°ç‰¹æ€§): ${CURRENT_VERSION} -> $(semver bump minor ${CURRENT_VERSION})"
echo "3. Major (ç ´åæ€§å˜æ›´): ${CURRENT_VERSION} -> $(semver bump major ${CURRENT_VERSION})"

read -p "é€‰æ‹© (1/2/3): " choice

case $choice in
    1) NEW_VERSION=$(semver bump patch ${CURRENT_VERSION}) ;;
    2) NEW_VERSION=$(semver bump minor ${CURRENT_VERSION}) ;;
    3) NEW_VERSION=$(semver bump major ${CURRENT_VERSION}) ;;
    *) echo "æ— æ•ˆé€‰æ‹©"; exit 1 ;;
esac

echo "æ–°ç‰ˆæœ¬: ${NEW_VERSION}"

# 1. æ›´æ–°ç‰ˆæœ¬å·
echo "æ›´æ–°ç‰ˆæœ¬å·..."
sed -i "s/^version = \"${CURRENT_VERSION}\"/version = \"${NEW_VERSION}\"/" Cargo.toml

# 2. è¿è¡Œå®Œæ•´æµ‹è¯•
echo "è¿è¡Œæµ‹è¯•..."
cargo test --all-features
cargo clippy -- -D warnings
cargo fmt -- --check

# 3. æ›´æ–° CHANGELOG
echo "æ›´æ–° CHANGELOG.md..."
cat << EOF > CHANGELOG.md.new
# Changelog

## [${NEW_VERSION}] - $(date +%Y-%m-%d)

### Added
- 

### Changed
- 

### Fixed
- 

$(tail -n +2 CHANGELOG.md)
EOF
mv CHANGELOG.md.new CHANGELOG.md

# 4. æäº¤æ›´æ”¹
git add Cargo.toml Cargo.lock CHANGELOG.md
git commit -m "chore: bump version to ${NEW_VERSION}"
git tag -a "v${NEW_VERSION}" -m "Release version ${NEW_VERSION}"

# 5. å‘å¸ƒåˆ° crates.io
echo "å‘å¸ƒåˆ° crates.io..."
cargo publish --dry-run
read -p "ç¡®è®¤å‘å¸ƒ? (y/n) " confirm
if [ "$confirm" = "y" ]; then
    cargo publish
    git push origin main
    git push origin "v${NEW_VERSION}"
    echo "âœ… å‘å¸ƒå®Œæˆï¼"
fi
```

---

## 8. CI/CD é›†æˆ

### 8.1 GitHub Actions å·¥ä½œæµ

```yaml
# .github/workflows/dependency-check.yml

name: Dependency Security Check

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    # æ¯å‘¨ä¸€å‡Œæ™¨ 3 ç‚¹è¿è¡Œ
    - cron: '0 3 * * 1'

env:
  RUST_VERSION: '1.90'
  CARGO_TERM_COLOR: always

jobs:
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: ${{ env.RUST_VERSION }}
      
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Install cargo-audit
        run: cargo install cargo-audit --locked
      
      - name: Run security audit
        run: cargo audit --deny warnings
      
      - name: Upload audit report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: audit-report
          path: audit-report.json
  
  dependency-check:
    name: Dependency Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: ${{ env.RUST_VERSION }}
      
      - name: Install cargo-deny
        run: cargo install cargo-deny --locked
      
      - name: Check licenses
        run: cargo deny check licenses
      
      - name: Check advisories
        run: cargo deny check advisories
      
      - name: Check bans
        run: cargo deny check bans
      
      - name: Check sources
        run: cargo deny check sources
  
  outdated-check:
    name: Check Outdated Dependencies
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: ${{ env.RUST_VERSION }}
      
      - name: Install cargo-outdated
        run: cargo install cargo-outdated --locked
      
      - name: Check outdated dependencies
        run: cargo outdated --root-deps-only --exit-code 1
        continue-on-error: true
      
      - name: Create issue for outdated deps
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸ“¦ å‘ç°è¿‡æ—¶çš„ä¾èµ–',
              body: 'è‡ªåŠ¨ä¾èµ–æ£€æŸ¥å‘ç°è¿‡æ—¶çš„ä¾èµ–é¡¹ã€‚è¯·è¿è¡Œ `cargo outdated` æŸ¥çœ‹è¯¦æƒ…ã€‚',
              labels: ['dependencies', 'maintenance']
            })
```

---

## 9. æ¼æ´å“åº”æµç¨‹

### 9.1 åº”æ€¥å“åº”è„šæœ¬

```bash
#!/bin/bash
# scripts/emergency-patch.sh

set -euo pipefail

VULNERABLE_CRATE=$1
SAFE_VERSION=$2

echo "ğŸš¨ ç´§æ€¥ä¿®å¤æ¼æ´: ${VULNERABLE_CRATE}"

# 1. åˆ›å»ºä¿®å¤åˆ†æ”¯
BRANCH_NAME="security/fix-${VULNERABLE_CRATE}-$(date +%Y%m%d)"
git checkout -b "${BRANCH_NAME}"

# 2. æ›´æ–°åˆ°å®‰å…¨ç‰ˆæœ¬
echo "æ›´æ–° ${VULNERABLE_CRATE} åˆ° ${SAFE_VERSION}..."
cargo update -p "${VULNERABLE_CRATE}" --precise "${SAFE_VERSION}"

# 3. è¿è¡Œæµ‹è¯•
echo "è¿è¡Œæµ‹è¯•..."
cargo test --all-features || {
    echo "âŒ æµ‹è¯•å¤±è´¥ï¼éœ€è¦æ‰‹åŠ¨ä¿®å¤"
    exit 1
}

# 4. å®‰å…¨å®¡è®¡
echo "æ‰§è¡Œå®‰å…¨å®¡è®¡..."
cargo audit || {
    echo "âš ï¸  ä»å­˜åœ¨å®‰å…¨é—®é¢˜"
}

# 5. æäº¤æ›´æ”¹
git add Cargo.lock Cargo.toml
git commit -m "security: update ${VULNERABLE_CRATE} to ${SAFE_VERSION}

Addresses security vulnerability RUSTSEC-XXXX-XXXX"

# 6. åˆ›å»º PR
gh pr create \
    --title "ğŸ”’ Security: Update ${VULNERABLE_CRATE} to ${SAFE_VERSION}" \
    --body "## Security Fix

Vulnerability: RUSTSEC-XXXX-XXXX
Affected Package: ${VULNERABLE_CRATE}
Safe Version: ${SAFE_VERSION}

### Changes
- Updated ${VULNERABLE_CRATE} to ${SAFE_VERSION}

### Testing
- [x] All tests pass
- [x] Security audit clean

**Priority: URGENT**" \
    --label "security,urgent" \
    --assignee "@security-team"

echo "âœ… ç´§æ€¥ä¿®å¤ PR å·²åˆ›å»ºï¼"
```

---

## 10. å·¥å…·é“¾æ¨è

### 10.1 å¿…å¤‡å·¥å…·æ¸…å•

```bash
#!/bin/bash
# scripts/install-tools.sh

echo "å®‰è£… Rust ä¾èµ–ç®¡ç†å·¥å…·é“¾..."

# æ ¸å¿ƒå·¥å…·
cargo install --locked \
    cargo-audit \          # å®‰å…¨å®¡è®¡
    cargo-deny \           # ä¾èµ–ç­–ç•¥
    cargo-edit \           # ç¼–è¾‘ä¾èµ–
    cargo-outdated \       # æ£€æŸ¥è¿‡æ—¶ä¾èµ–
    cargo-tree \           # ä¾èµ–æ ‘
    cargo-update \         # æ›´æ–°å·¥å…·
    cargo-supply-chain \   # ä¾›åº”é“¾å®¡è®¡
    cargo-geiger \         # unsafe ä»£ç æ£€æµ‹
    cargo-machete \        # æœªä½¿ç”¨ä¾èµ–æ£€æµ‹
    cargo-license          # è®¸å¯è¯å®¡è®¡

echo "âœ… å·¥å…·å®‰è£…å®Œæˆï¼"
```

---

## ğŸ“Š æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **ç‰ˆæœ¬ç®¡ç†**: ä½¿ç”¨å·¥ä½œåŒºç»Ÿä¸€ä¾èµ–ç‰ˆæœ¬
2. **å®‰å…¨å®¡è®¡**: è‡ªåŠ¨åŒ– cargo-audit å’Œ cargo-deny
3. **ä¾›åº”é“¾**: å®šæœŸå®¡è®¡è´¡çŒ®è€…å’Œå‘å¸ƒè€…
4. **CI/CD**: å®Œæ•´çš„è‡ªåŠ¨åŒ–æ£€æŸ¥æµç¨‹
5. **åº”æ€¥å“åº”**: å¿«é€Ÿä¿®å¤å®‰å…¨æ¼æ´

### æœ€ä½³å®è·µæ¸…å•

âœ… **æ¨è**:

- å·¥ä½œåŒºç»Ÿä¸€ç®¡ç†ä¾èµ–ç‰ˆæœ¬
- CI/CD ä¸­é›†æˆå®‰å…¨æ£€æŸ¥
- å®šæœŸæ›´æ–°ä¾èµ–
- ä½¿ç”¨è¯­ä¹‰åŒ–ç‰ˆæœ¬
- æäº¤ Cargo.lockï¼ˆäºŒè¿›åˆ¶é¡¹ç›®ï¼‰

âŒ **é¿å…**:

- ä½¿ç”¨é€šé…ç¬¦ç‰ˆæœ¬
- Git ä¾èµ–åœ¨ç”Ÿäº§ç¯å¢ƒ
- å¿½ç•¥å®‰å…¨å‘Šè­¦
- æ‰‹åŠ¨ç®¡ç†å¤šç‰ˆæœ¬ä¾èµ–

---

**æ–‡æ¡£ç‰ˆæœ¬**: v2.5  
**æœ€åæ›´æ–°**: 2025å¹´10æœˆ11æ—¥  
**ç»´æŠ¤**: <security@example.com>  
**è®¸å¯è¯**: MIT OR Apache-2.0
