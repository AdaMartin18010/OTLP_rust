# OTLPæ ‡å‡†ç‰ˆæœ¬è‡ªåŠ¨ç›‘æ§
# 
# åŠŸèƒ½:
# 1. æ¯å¤©æ£€æŸ¥OpenTelemetryæ ‡å‡†ä»“åº“çš„æœ€æ–°ç‰ˆæœ¬
# 2. å¯¹æ¯”æœ¬åœ°è®°å½•çš„ç‰ˆæœ¬ä¿¡æ¯
# 3. å‘ç°æ–°ç‰ˆæœ¬æ—¶è‡ªåŠ¨åˆ›å»ºIssueæé†’
# 4. ç”Ÿæˆç‰ˆæœ¬å¯¹æ¯”æŠ¥å‘Š

name: OTLP Version Monitor

on:
  # æ¯å¤©UTC 00:00æ‰§è¡Œ (åŒ—äº¬æ—¶é—´08:00)
  schedule:
    - cron: '0 0 * * *'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # PRæ—¶æ£€æŸ¥
  pull_request:
    paths:
      - 'version-tracking/**'

env:
  # ç›‘æ§çš„ä»“åº“
  OTLP_SPEC_REPO: 'open-telemetry/opentelemetry-proto'
  SEMCONV_REPO: 'open-telemetry/semantic-conventions'
  COLLECTOR_REPO: 'open-telemetry/opentelemetry-collector'

jobs:
  check-versions:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install Dependencies
      run: |
        pip install requests pyyaml jinja2 packaging
    
    - name: Create Version Tracking Directory
      run: |
        mkdir -p version-tracking
        mkdir -p version-tracking/reports
    
    - name: Fetch Latest OTLP Spec Version
      id: otlp-spec
      run: |
        LATEST_TAG=$(curl -s https://api.github.com/repos/${{ env.OTLP_SPEC_REPO }}/releases/latest | jq -r .tag_name)
        RELEASE_DATE=$(curl -s https://api.github.com/repos/${{ env.OTLP_SPEC_REPO }}/releases/latest | jq -r .published_at)
        echo "version=$LATEST_TAG" >> $GITHUB_OUTPUT
        echo "date=$RELEASE_DATE" >> $GITHUB_OUTPUT
        echo "âœ… OTLP Spec: $LATEST_TAG ($RELEASE_DATE)"
    
    - name: Fetch Latest Semantic Conventions Version
      id: semconv
      run: |
        LATEST_TAG=$(curl -s https://api.github.com/repos/${{ env.SEMCONV_REPO }}/releases/latest | jq -r .tag_name)
        RELEASE_DATE=$(curl -s https://api.github.com/repos/${{ env.SEMCONV_REPO }}/releases/latest | jq -r .published_at)
        echo "version=$LATEST_TAG" >> $GITHUB_OUTPUT
        echo "date=$RELEASE_DATE" >> $GITHUB_OUTPUT
        echo "âœ… Semantic Conventions: $LATEST_TAG ($RELEASE_DATE)"
    
    - name: Fetch Latest Collector Version
      id: collector
      run: |
        LATEST_TAG=$(curl -s https://api.github.com/repos/${{ env.COLLECTOR_REPO }}/releases/latest | jq -r .tag_name)
        RELEASE_DATE=$(curl -s https://api.github.com/repos/${{ env.COLLECTOR_REPO }}/releases/latest | jq -r .published_at)
        echo "version=$LATEST_TAG" >> $GITHUB_OUTPUT
        echo "date=$RELEASE_DATE" >> $GITHUB_OUTPUT
        echo "âœ… Collector: $LATEST_TAG ($RELEASE_DATE)"
    
    - name: Load Current Versions
      id: current
      run: |
        if [ -f version-tracking/current-versions.yml ]; then
          cat version-tracking/current-versions.yml
        else
          echo "âš ï¸ No version tracking file found, will create new one"
        fi
    
    - name: Compare Versions and Generate Report
      id: compare
      run: |
        python3 << 'EOF'
        import os
        import yaml
        import json
        from datetime import datetime
        from pathlib import Path
        
        # è·å–æœ€æ–°ç‰ˆæœ¬
        latest_versions = {
            'otlp_spec': {
                'version': '${{ steps.otlp-spec.outputs.version }}',
                'date': '${{ steps.otlp-spec.outputs.date }}',
                'repo': '${{ env.OTLP_SPEC_REPO }}'
            },
            'semantic_conventions': {
                'version': '${{ steps.semconv.outputs.version }}',
                'date': '${{ steps.semconv.outputs.date }}',
                'repo': '${{ env.SEMCONV_REPO }}'
            },
            'collector': {
                'version': '${{ steps.collector.outputs.version }}',
                'date': '${{ steps.collector.outputs.date }}',
                'repo': '${{ env.COLLECTOR_REPO }}'
            }
        }
        
        # è¯»å–å½“å‰ç‰ˆæœ¬
        version_file = Path('version-tracking/current-versions.yml')
        if version_file.exists():
            with open(version_file, 'r') as f:
                current_versions = yaml.safe_load(f) or {}
        else:
            current_versions = {}
        
        # å¯¹æ¯”ç‰ˆæœ¬
        updates = []
        for key, latest in latest_versions.items():
            current = current_versions.get(key, {})
            if current.get('version') != latest['version']:
                updates.append({
                    'name': key,
                    'old_version': current.get('version', 'N/A'),
                    'new_version': latest['version'],
                    'repo': latest['repo']
                })
                print(f"ğŸ†• Update detected: {key} {current.get('version', 'N/A')} â†’ {latest['version']}")
        
        # è¾“å‡ºç»“æœ
        if updates:
            with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                f.write(f"has_updates=true\n")
                f.write(f"update_count={len(updates)}\n")
            
            # ä¿å­˜æ›´æ–°è¯¦æƒ…
            with open('version-tracking/updates.json', 'w') as f:
                json.dump(updates, f, indent=2)
        else:
            with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                f.write(f"has_updates=false\n")
            print("âœ… All versions are up to date")
        
        # æ›´æ–°ç‰ˆæœ¬æ–‡ä»¶
        current_versions.update(latest_versions)
        current_versions['last_checked'] = datetime.utcnow().isoformat()
        
        with open('version-tracking/current-versions.yml', 'w') as f:
            yaml.dump(current_versions, f, default_flow_style=False, sort_keys=False)
        
        EOF
    
    - name: Generate Update Report
      if: steps.compare.outputs.has_updates == 'true'
      run: |
        python3 << 'EOF'
        import json
        from datetime import datetime
        
        with open('version-tracking/updates.json', 'r') as f:
            updates = json.load(f)
        
        report = f"""# OTLPæ ‡å‡†ç‰ˆæœ¬æ›´æ–°æŠ¥å‘Š
        
        **æ£€æµ‹æ—¶é—´**: {datetime.utcnow().strftime('%Y-%m-%d %H:%M:%S UTC')}  
        **å‘ç°æ›´æ–°**: {len(updates)}ä¸ª
        
        ---
        
        ## ğŸ“¦ ç‰ˆæœ¬æ›´æ–°è¯¦æƒ…
        
        """
        
        for update in updates:
            name_display = {
                'otlp_spec': 'OTLP Protocol Specification',
                'semantic_conventions': 'Semantic Conventions',
                'collector': 'OpenTelemetry Collector'
            }
            
            report += f"""
        ### {name_display.get(update['name'], update['name'])}
        
        - **ä»“åº“**: `{update['repo']}`
        - **æ—§ç‰ˆæœ¬**: `{update['old_version']}`
        - **æ–°ç‰ˆæœ¬**: `{update['new_version']}` ğŸ†•
        - **å˜æ›´é“¾æ¥**: https://github.com/{update['repo']}/compare/{update['old_version']}...{update['new_version']}
        - **Release Notes**: https://github.com/{update['repo']}/releases/tag/{update['new_version']}
        
        **éœ€è¦æ›´æ–°çš„æ–‡æ¡£**:
        """
            
            if 'otlp_spec' in update['name']:
                report += """
        - [ ] `01_OTLPæ ¸å¿ƒåè®®/01_åè®®æ¦‚è¿°.md`
        - [ ] `01_OTLPæ ¸å¿ƒåè®®/02_gRPCä¼ è¾“.md`
        - [ ] `01_OTLPæ ¸å¿ƒåè®®/03_HTTPä¼ è¾“.md`
        - [ ] `03_æ•°æ®æ¨¡å‹/` (Traces/Metrics/Logs)
        """
            elif 'semantic_conventions' in update['name']:
                report += """
        - [ ] `02_Semantic_Conventions/00_è¯­ä¹‰çº¦å®šæ€»è§ˆ.md`
        - [ ] `02_Semantic_Conventions/01_é€šç”¨åè®®å±æ€§/`
        - [ ] `02_Semantic_Conventions/02_è¿½è¸ªå±æ€§/`
        - [ ] `02_Semantic_Conventions/03_æŒ‡æ ‡å±æ€§/`
        """
            elif 'collector' in update['name']:
                report += """
        - [ ] `04_æ ¸å¿ƒç»„ä»¶/01_Collectoræ¶æ„.md`
        - [ ] `04_æ ¸å¿ƒç»„ä»¶/02_æ¥æ”¶å™¨.md`
        - [ ] `04_æ ¸å¿ƒç»„ä»¶/03_å¤„ç†å™¨.md`
        - [ ] `04_æ ¸å¿ƒç»„ä»¶/04_å¯¼å‡ºå™¨.md`
        """
            
            report += "\n---\n"
        
        report += f"""
        ## ğŸ”„ ä¸‹ä¸€æ­¥è¡ŒåŠ¨
        
        1. **å®¡æŸ¥å˜æ›´**: æŸ¥çœ‹ä¸Šè¿°Release Notes,äº†è§£å…·ä½“å˜æ›´å†…å®¹
        2. **è¯„ä¼°å½±å“**: åˆ¤æ–­å“ªäº›ç°æœ‰æ–‡æ¡£éœ€è¦æ›´æ–°
        3. **æ›´æ–°æ–‡æ¡£**: æ ¹æ®æ–°ç‰ˆæœ¬æ›´æ–°ç›¸åº”æ–‡æ¡£
        4. **æµ‹è¯•éªŒè¯**: éªŒè¯ä»£ç ç¤ºä¾‹æ˜¯å¦ä»ç„¶æœ‰æ•ˆ
        5. **å…³é—­Issue**: å®Œæˆæ›´æ–°åå…³é—­æœ¬Issue
        
        ## ğŸ“‹ æ›´æ–°æ£€æŸ¥æ¸…å•
        
        - [ ] å·²å®¡æŸ¥æ‰€æœ‰Release Notes
        - [ ] å·²è¯†åˆ«éœ€è¦æ›´æ–°çš„æ–‡æ¡£
        - [ ] å·²å®Œæˆæ–‡æ¡£æ›´æ–°
        - [ ] å·²éªŒè¯ä»£ç ç¤ºä¾‹
        - [ ] å·²æ›´æ–°ç‰ˆæœ¬å·æ ‡è¯†
        - [ ] å·²æäº¤PR
        
        ---
        
        *æœ¬æŠ¥å‘Šç”±GitHub Actionsè‡ªåŠ¨ç”Ÿæˆ*  
        *Workflow: `.github/workflows/otlp-version-monitor.yml`*
        """
        
        with open('version-tracking/reports/update-report-latest.md', 'w') as f:
            f.write(report)
        
        # ä¿å­˜Issueå†…å®¹
        with open('version-tracking/issue-body.md', 'w') as f:
            f.write(report)
        
        print("âœ… Report generated")
        print(report)
        EOF
    
    - name: Create Issue for Updates
      if: steps.compare.outputs.has_updates == 'true'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          const issueBody = fs.readFileSync('version-tracking/issue-body.md', 'utf8');
          
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `ğŸ”” OTLPæ ‡å‡†ç‰ˆæœ¬æ›´æ–°æ£€æµ‹ - ${new Date().toISOString().split('T')[0]}`,
            body: issueBody,
            labels: ['version-update', 'P0', 'documentation']
          });
    
    - name: Commit Updated Versions
      if: steps.compare.outputs.has_updates == 'true'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add version-tracking/
        git commit -m "chore: update OTLP version tracking [skip ci]" || echo "No changes to commit"
        git push || echo "Nothing to push"
    
    - name: Upload Report as Artifact
      if: steps.compare.outputs.has_updates == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: version-update-report-${{ github.run_number }}
        path: version-tracking/reports/
        retention-days: 90
    
    - name: Send Notification (Optional)
      if: steps.compare.outputs.has_updates == 'true'
      run: |
        echo "::notice::å‘ç° ${{ steps.compare.outputs.update_count }} ä¸ªç‰ˆæœ¬æ›´æ–°,å·²åˆ›å»ºIssue"
    
    - name: Summary
      run: |
        echo "## ğŸ“Š ç‰ˆæœ¬æ£€æŸ¥æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| ç»„ä»¶ | ç‰ˆæœ¬ | å‘å¸ƒæ—¥æœŸ |" >> $GITHUB_STEP_SUMMARY
        echo "|------|------|----------|" >> $GITHUB_STEP_SUMMARY
        echo "| OTLP Spec | ${{ steps.otlp-spec.outputs.version }} | ${{ steps.otlp-spec.outputs.date }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Semantic Conventions | ${{ steps.semconv.outputs.version }} | ${{ steps.semconv.outputs.date }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Collector | ${{ steps.collector.outputs.version }} | ${{ steps.collector.outputs.date }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.compare.outputs.has_updates }}" == "true" ]; then
          echo "ğŸ†• **å‘ç° ${{ steps.compare.outputs.update_count }} ä¸ªç‰ˆæœ¬æ›´æ–°!**" >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… **æ‰€æœ‰ç‰ˆæœ¬éƒ½æ˜¯æœ€æ–°çš„**" >> $GITHUB_STEP_SUMMARY
        fi

  # å¯é€‰: æ¯å‘¨ç”Ÿæˆå®Œæ•´çš„ç‰ˆæœ¬å†å²æŠ¥å‘Š
  weekly-report:
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 0 * * 0'  # æ¯å‘¨æ—¥
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
    
    - name: Generate Weekly Report
      run: |
        python3 << 'EOF'
        import yaml
        from datetime import datetime, timedelta
        from pathlib import Path
        
        version_file = Path('version-tracking/current-versions.yml')
        if not version_file.exists():
            print("No version data available")
            exit(0)
        
        with open(version_file, 'r') as f:
            versions = yaml.safe_load(f)
        
        report = f"""# OTLPæ ‡å‡†ç‰ˆæœ¬å‘¨æŠ¥
        
        **æŠ¥å‘Šå‘¨æœŸ**: {(datetime.now() - timedelta(days=7)).strftime('%Y-%m-%d')} ~ {datetime.now().strftime('%Y-%m-%d')}
        
        ## ğŸ“¦ å½“å‰ç‰ˆæœ¬
        
        | ç»„ä»¶ | ç‰ˆæœ¬ | å‘å¸ƒæ—¥æœŸ | ä»“åº“ |
        |------|------|----------|------|
        """
        
        for key, data in versions.items():
            if key == 'last_checked':
                continue
            name = key.replace('_', ' ').title()
            report += f"| {name} | {data['version']} | {data['date'][:10]} | [{data['repo']}](https://github.com/{data['repo']}) |\n"
        
        report += f"""
        
        ## ğŸ“ˆ ç‰ˆæœ¬è¶‹åŠ¿
        
        - æœ€è¿‘ä¸€å‘¨æœªå‘ç°é‡å¤§ç‰ˆæœ¬æ›´æ–°
        - æ–‡æ¡£ä¿æŒä¸æœ€æ–°æ ‡å‡†åŒæ­¥
        
        ## ğŸ”— æœ‰ç”¨é“¾æ¥
        
        - [OTLP Specification](https://github.com/open-telemetry/opentelemetry-proto)
        - [Semantic Conventions](https://github.com/open-telemetry/semantic-conventions)
        - [Collector Releases](https://github.com/open-telemetry/opentelemetry-collector/releases)
        
        ---
        
        *ä¸Šæ¬¡æ£€æŸ¥æ—¶é—´: {versions.get('last_checked', 'N/A')}*
        """
        
        Path('version-tracking/reports').mkdir(parents=True, exist_ok=True)
        with open(f'version-tracking/reports/weekly-{datetime.now().strftime("%Y%m%d")}.md', 'w') as f:
            f.write(report)
        
        print(report)
        EOF
    
    - name: Upload Weekly Report
      uses: actions/upload-artifact@v4
      with:
        name: weekly-report-${{ github.run_number }}
        path: version-tracking/reports/weekly-*.md
        retention-days: 365

