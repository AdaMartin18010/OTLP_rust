# 通用资源属性 (Resource Attributes)

> **规范版本**: v1.30.0  
> **最后更新**: 2025年10月8日

---

## 目录

- [通用资源属性 (Resource Attributes)](#通用资源属性-resource-attributes)
  - [目录](#目录)
  - [1. 概述](#1-概述)
    - [1.1 什么是Resource](#11-什么是resource)
    - [1.2 Resource vs Span Attributes](#12-resource-vs-span-attributes)
  - [2. 服务资源属性](#2-服务资源属性)
  - [3. 部署环境属性](#3-部署环境属性)
  - [4. 进程属性](#4-进程属性)
  - [5. 主机属性](#5-主机属性)
  - [6. 操作系统属性](#6-操作系统属性)
  - [7. 容器属性](#7-容器属性)
  - [8. Kubernetes属性](#8-kubernetes属性)
  - [9. 云平台属性](#9-云平台属性)
  - [10. 自动检测](#10-自动检测)
  - [11. 实现示例](#11-实现示例)
  - [12. 最佳实践](#12-最佳实践)
  - [13. 参考资源](#13-参考资源)

---

## 1. 概述

### 1.1 什么是Resource

```text
Resource (资源):
描述遥测数据来源的实体

特点:
1. 不可变
   - 进程启动时确定
   - 运行期间不变

2. 全局共享
   - 所有Span/Metric/Log共享
   - 避免重复

3. 层次化
   - 服务 → 进程 → 主机 → 容器 → K8s → 云

用途:
- 标识服务
- 定位问题
- 聚合分析
- 成本分配
```

### 1.2 Resource vs Span Attributes

```text
┌─────────────────┬──────────────┬──────────────┐
│ 特性            │ Resource     │ Span Attr    │
├─────────────────┼──────────────┼──────────────┤
│ 生命周期        │ 进程级       │ Span级        │
│ 可变性          │ 不可变       │ 不可变        │
│ 作用域          │ 全局         │ 局部          │
│ 示例            │ service.name │ http.method  │
│ 用途            │ 标识来源     │ 描述事件       │
└─────────────────┴──────────────┴──────────────┘

示例:
Resource: {
  service.name: "checkout-service",
  service.version: "1.2.0",
  deployment.environment: "production"
}

Span Attributes: {
  http.method: "POST",
  http.route: "/api/checkout",
  http.status_code: 200
}
```

---

## 2. 服务资源属性

```text
必需属性:
┌──────────────────────┬─────────┬──────────────────────┐
│ 属性名                │ 类型    │ 示例                 │
├──────────────────────┼─────────┼──────────────────────┤
│ service.name         │ string  │ "checkout-service"   │
│ service.version      │ string  │ "1.2.0"              │
│ service.instance.id  │ string  │ "instance-abc123"    │
└──────────────────────┴─────────┴──────────────────────┘

可选属性:
┌──────────────────────┬─────────┬──────────────────────┐
│ service.namespace    │ string  │ "prod"               │
└──────────────────────┴─────────┴──────────────────────┘

完整示例:
{
  "service.name": "checkout-service",
  "service.version": "1.2.0",
  "service.instance.id": "checkout-abc123",
  "service.namespace": "ecommerce"
}

命名约定:
✅ service.name: 
   - 小写
   - 用连字符分隔
   - 唯一标识服务
   - 例: "order-service", "payment-api"

✅ service.version:
   - 语义化版本 (SemVer)
   - 格式: major.minor.patch
   - 例: "1.2.3", "2.0.0-beta.1"

✅ service.instance.id:
   - 唯一标识实例
   - 格式: hostname, UUID, 或容器ID
   - 例: "instance-123", "pod-abc-xyz"
```

**Go实现**:

```go
import (
    "go.opentelemetry.io/otel/sdk/resource"
    semconv "go.opentelemetry.io/otel/semconv/v1.24.0"
)

func createServiceResource() (*resource.Resource, error) {
    return resource.New(context.Background(),
        resource.WithAttributes(
            semconv.ServiceNameKey.String("checkout-service"),
            semconv.ServiceVersionKey.String("1.2.0"),
            semconv.ServiceInstanceIDKey.String(getInstanceID()),
            semconv.ServiceNamespaceKey.String("ecommerce"),
        ),
    )
}

func getInstanceID() string {
    // 从环境变量、主机名或生成UUID
    if id := os.Getenv("INSTANCE_ID"); id != "" {
        return id
    }
    
    hostname, _ := os.Hostname()
    return hostname
}
```

---

## 3. 部署环境属性

```text
核心属性:
┌──────────────────────────┬─────────┬──────────────┐
│ 属性名                    │ 类型    │ 示例         │
├──────────────────────────┼─────────┼──────────────┤
│ deployment.environment   │ string  │ "production" │
└──────────────────────────┴─────────┴──────────────┘

标准值:
- "production"  (生产环境)
- "staging"     (预发布)
- "development" (开发)
- "test"        (测试)

示例:
{
  "deployment.environment": "production"
}

用途:
1. 区分环境
   - 生产 vs 开发
   - 告警规则不同

2. 数据隔离
   - 不同环境分开存储
   - 避免混淆

3. 配置管理
   - 按环境应用配置
   - 采样率、保留期等
```

---

## 4. 进程属性

```text
进程属性:
┌────────────────────────┬─────────┬──────────────────┐
│ 属性名                  │ 类型    │ 示例             │
├────────────────────────┼─────────┼──────────────────┤
│ process.pid            │ int     │ 12345            │
│ process.parent_pid     │ int     │ 1                │
│ process.executable.name│ string  │ "java"           │
│ process.executable.path│ string  │ "/usr/bin/java"  │
│ process.command_line   │ string  │ "java -jar app"  │
│ process.command_args   │ array   │ ["java", "-jar"] │
│ process.owner          │ string  │ "appuser"        │
│ process.runtime.name   │ string  │ "OpenJDK"        │
│ process.runtime.version│ string  │ "11.0.1"         │
└────────────────────────┴─────────┴──────────────────┘

Go示例:
{
  "process.pid": 12345,
  "process.executable.name": "myapp",
  "process.executable.path": "/usr/local/bin/myapp",
  "process.runtime.name": "go",
  "process.runtime.version": "1.21.0"
}

Python示例:
{
  "process.pid": 67890,
  "process.runtime.name": "CPython",
  "process.runtime.version": "3.11.0"
}
```

**自动检测**:

```go
import "go.opentelemetry.io/otel/sdk/resource"

res, _ := resource.New(context.Background(),
    resource.WithProcess(), // 自动检测进程属性
)
```

---

## 5. 主机属性

```text
主机属性:
┌─────────────────┬─────────┬────────────────────────┐
│ 属性名           │ 类型    │ 示例                   │
├─────────────────┼─────────┼────────────────────────┤
│ host.id         │ string  │ "i-1234567890abcdef0"  │
│ host.name       │ string  │ "ip-10-0-1-42"         │
│ host.type       │ string  │ "t3.large"             │
│ host.arch       │ string  │ "amd64"                │
│ host.image.name │ string  │ "ubuntu-20.04"         │
│ host.image.id   │ string  │ "ami-0c55b159cbfafe1f0"│
└─────────────────┴─────────┴────────────────────────┘

示例:
{
  "host.id": "i-1234567890abcdef0",
  "host.name": "ip-10-0-1-42.ec2.internal",
  "host.type": "t3.large",
  "host.arch": "amd64"
}

自动检测:
res, _ := resource.New(context.Background(),
    resource.WithHost(), // 自动检测主机属性
)
```

---

## 6. 操作系统属性

```text
操作系统属性:
┌─────────────────┬─────────┬─────────────────┐
│ 属性名           │ 类型    │ 示例            │
├─────────────────┼─────────┼─────────────────┤
│ os.type         │ string  │ "linux"         │
│ os.description  │ string  │ "Ubuntu 20.04"  │
│ os.name         │ string  │ "Ubuntu"        │
│ os.version      │ string  │ "20.04"         │
└─────────────────┴─────────┴─────────────────┘

os.type标准值:
- "windows"
- "linux"
- "darwin" (macOS)
- "freebsd"
- "openbsd"
- "solaris"

示例:
{
  "os.type": "linux",
  "os.description": "Ubuntu 20.04.3 LTS",
  "os.name": "Ubuntu",
  "os.version": "20.04"
}

自动检测:
res, _ := resource.New(context.Background(),
    resource.WithOS(), // 自动检测OS属性
)
```

---

## 7. 容器属性

```text
容器属性:
┌───────────────────┬─────────┬──────────────────────────────┐
│ 属性名             │ 类型    │ 示例                         │
├───────────────────┼─────────┼──────────────────────────────┤
│ container.id      │ string  │ "1234567890abcdef"           │
│ container.name    │ string  │ "checkout-service-prod-abc"  │
│ container.runtime │ string  │ "docker"                     │
│ container.image.name│string │ "myapp"                      │
│ container.image.tag │string │ "1.2.0"                      │
└───────────────────┴─────────┴──────────────────────────────┘

示例:
{
  "container.id": "1234567890abcdef0123456789abcdef01234567",
  "container.name": "checkout-service-prod-abc",
  "container.runtime": "docker",
  "container.image.name": "myregistry/checkout-service",
  "container.image.tag": "1.2.0"
}

自动检测:
res, _ := resource.New(context.Background(),
    resource.WithContainer(), // 自动检测容器属性
)

获取容器ID:
// 从cgroup读取
func getContainerID() string {
    data, _ := os.ReadFile("/proc/self/cgroup")
    // 解析容器ID
    // ...
    return containerID
}
```

---

## 8. Kubernetes属性

```text
Kubernetes属性:
┌──────────────────────────┬─────────┬────────────────────┐
│ 属性名                    │ 类型    │ 示例               │
├──────────────────────────┼─────────┼────────────────────┤
│ k8s.cluster.name         │ string  │ "prod-cluster"     │
│ k8s.namespace.name       │ string  │ "default"          │
│ k8s.pod.name             │ string  │ "checkout-abc-xyz" │
│ k8s.pod.uid              │ string  │ "12345-67890-abc"  │
│ k8s.deployment.name      │ string  │ "checkout"         │
│ k8s.replicaset.name      │ string  │ "checkout-abc"     │
│ k8s.statefulset.name     │ string  │ "db"               │
│ k8s.daemonset.name       │ string  │ "node-exporter"    │
│ k8s.job.name             │ string  │ "batch-job"        │
│ k8s.cronjob.name         │ string  │ "daily-backup"     │
│ k8s.node.name            │ string  │ "node-1"           │
│ k8s.container.name       │ string  │ "app"              │
└──────────────────────────┴─────────┴────────────────────┘

完整示例:
{
  "k8s.cluster.name": "prod-us-west-2",
  "k8s.namespace.name": "ecommerce",
  "k8s.pod.name": "checkout-7d5f9c8b6-xhq2w",
  "k8s.pod.uid": "12345678-1234-1234-1234-123456789abc",
  "k8s.deployment.name": "checkout",
  "k8s.replicaset.name": "checkout-7d5f9c8b6",
  "k8s.node.name": "ip-10-0-1-42.ec2.internal",
  "k8s.container.name": "app"
}

从环境变量获取:
apiVersion: apps/v1
kind: Deployment
spec:
  template:
    spec:
      containers:
      - name: app
        env:
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: POD_UID
          valueFrom:
            fieldRef:
              fieldPath: metadata.uid
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
```

---

## 9. 云平台属性

**通用云属性**:

```text
┌────────────────────────┬─────────┬───────────────────┐
│ 属性名                  │ 类型    │ 示例              │
├────────────────────────┼─────────┼───────────────────┤
│ cloud.provider         │ string  │ "aws"             │
│ cloud.account.id       │ string  │ "123456789012"    │
│ cloud.region           │ string  │ "us-west-2"       │
│ cloud.availability_zone│ string  │ "us-west-2a"      │
│ cloud.platform         │ string  │ "aws_ec2"         │
└────────────────────────┴─────────┴───────────────────┘

cloud.provider标准值:
- "aws" (Amazon Web Services)
- "azure" (Microsoft Azure)
- "gcp" (Google Cloud Platform)
- "alibaba_cloud"
- "tencent_cloud"

cloud.platform标准值:
AWS:
- "aws_ec2"
- "aws_ecs"
- "aws_eks"
- "aws_lambda"
- "aws_elastic_beanstalk"

Azure:
- "azure_vm"
- "azure_container_instances"
- "azure_aks"
- "azure_functions"
- "azure_app_service"

GCP:
- "gcp_compute_engine"
- "gcp_kubernetes_engine"
- "gcp_cloud_run"
- "gcp_cloud_functions"
- "gcp_app_engine"
```

**AWS特定属性**:

```text
AWS EC2:
{
  "cloud.provider": "aws",
  "cloud.platform": "aws_ec2",
  "cloud.account.id": "123456789012",
  "cloud.region": "us-west-2",
  "cloud.availability_zone": "us-west-2a",
  "host.id": "i-1234567890abcdef0",
  "host.type": "t3.large"
}

AWS ECS:
{
  "cloud.provider": "aws",
  "cloud.platform": "aws_ecs",
  "cloud.account.id": "123456789012",
  "cloud.region": "us-west-2",
  "aws.ecs.cluster.arn": "arn:aws:ecs:us-west-2:123456789012:cluster/prod",
  "aws.ecs.task.arn": "arn:aws:ecs:us-west-2:123456789012:task/abc123",
  "aws.ecs.task.family": "checkout-service",
  "aws.ecs.task.revision": "5",
  "aws.ecs.container.arn": "arn:aws:ecs:...:container/xyz789",
  "aws.ecs.launchtype": "FARGATE"
}

AWS Lambda:
{
  "cloud.provider": "aws",
  "cloud.platform": "aws_lambda",
  "cloud.region": "us-west-2",
  "faas.name": "checkout-function",
  "faas.version": "$LATEST",
  "faas.instance": "2021/01/01/[$LATEST]abc123"
}
```

---

## 10. 自动检测

**Go完整示例**:

```go
import (
    "context"
    
    "go.opentelemetry.io/otel/sdk/resource"
    semconv "go.opentelemetry.io/otel/semconv/v1.24.0"
)

func createAutoDetectedResource() (*resource.Resource, error) {
    return resource.New(context.Background(),
        // 1. 从环境变量读取
        resource.WithFromEnv(),
        
        // 2. 自动检测进程信息
        resource.WithProcess(),
        
        // 3. 自动检测主机信息
        resource.WithHost(),
        
        // 4. 自动检测操作系统
        resource.WithOS(),
        
        // 5. 自动检测容器
        resource.WithContainer(),
        
        // 6. 自定义属性（高优先级）
        resource.WithAttributes(
            semconv.ServiceNameKey.String("checkout-service"),
            semconv.ServiceVersionKey.String(version),
            semconv.DeploymentEnvironmentKey.String(env),
        ),
    )
}

// 合并多个Resource
func mergeResources() (*resource.Resource, error) {
    base, _ := resource.New(context.Background(),
        resource.WithAttributes(
            semconv.ServiceNameKey.String("my-service"),
        ),
    )
    
    auto, _ := resource.New(context.Background(),
        resource.WithProcess(),
        resource.WithHost(),
    )
    
    // 合并（右侧覆盖左侧）
    return resource.Merge(base, auto)
}
```

---

## 11. 实现示例

**Python实现**:

```python
from opentelemetry.sdk.resources import Resource
from opentelemetry.semconv.resource import ResourceAttributes

# 基本Resource
resource = Resource.create({
    ResourceAttributes.SERVICE_NAME: "checkout-service",
    ResourceAttributes.SERVICE_VERSION: "1.2.0",
    ResourceAttributes.DEPLOYMENT_ENVIRONMENT: "production",
})

# 自动检测
from opentelemetry.sdk.resources import (
    ProcessResourceDetector,
    OTELResourceDetector,
)

resource = Resource.create().merge(
    ProcessResourceDetector().detect(),
    OTELResourceDetector().detect(),
)

# Kubernetes检测
from opentelemetry.sdk.resources import K8sResourceDetector

k8s_resource = K8sResourceDetector().detect()
```

**Java实现**:

```java
import io.opentelemetry.sdk.resources.Resource;
import io.opentelemetry.semconv.resource.attributes.ResourceAttributes;

// 创建Resource
Resource resource = Resource.builder()
    .put(ResourceAttributes.SERVICE_NAME, "checkout-service")
    .put(ResourceAttributes.SERVICE_VERSION, "1.2.0")
    .put(ResourceAttributes.DEPLOYMENT_ENVIRONMENT, "production")
    .build();

// 自动检测
Resource autoResource = Resource.getDefault()
    .merge(Resource.create(Attributes.of(
        ResourceAttributes.SERVICE_NAME, "my-service"
    )));
```

---

## 12. 最佳实践

```text
✅ DO (推荐)
1. 始终设置service.name
   - 唯一标识服务
   - 必需属性

2. 使用标准属性
   - 遵循语义约定
   - 便于工具解析

3. 自动检测
   - 使用SDK提供的检测器
   - 减少手动配置

4. 从环境变量读取
   - 便于配置管理
   - 支持CI/CD

5. 合理分层
   - 服务 → 实例 → 进程 → 容器 → K8s

❌ DON'T (避免)
1. 不要遗漏service.name
2. 不要使用自定义命名
3. 不要添加高基数属性
4. 不要包含敏感信息
5. 不要过多属性 (< 30个)

属性优先级:
1. 服务识别 (必需)
   - service.name
   - service.version
   - service.instance.id

2. 部署环境 (强烈推荐)
   - deployment.environment

3. 运行时环境 (推荐)
   - process.*
   - host.*
   - container.*
   - k8s.*

4. 云平台 (可选)
   - cloud.*

示例配置优先级:
# 1. 代码中设置（最高优先级）
resource.WithAttributes(
    semconv.ServiceNameKey.String("my-service"),
)

# 2. 环境变量
OTEL_RESOURCE_ATTRIBUTES="service.name=my-service"

# 3. 自动检测（最低优先级）
resource.WithProcess()
```

---

## 13. 参考资源

- **Resource规范**: <https://opentelemetry.io/docs/specs/semconv/resource/>
- **Kubernetes属性**: <https://opentelemetry.io/docs/specs/semconv/resource/k8s/>
- **云平台属性**: <https://opentelemetry.io/docs/specs/semconv/resource/cloud/>

---

**文档状态**: ✅ 完成  
**审核状态**: 待审核  
**相关文档**: [Resource模型](../../03_数据模型/04_Resource/01_Resource模型.md)
