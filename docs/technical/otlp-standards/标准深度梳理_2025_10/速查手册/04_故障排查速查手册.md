# 📘 OpenTelemetry故障排查速查手册

> **最后更新**: 2025年10月9日  
> **用途**: 快速诊断和解决OpenTelemetry常见问题

---

## 🎯 速查目录

- [📘 OpenTelemetry故障排查速查手册](#-opentelemetry故障排查速查手册)
  - [🎯 速查目录](#-速查目录)
  - [🔍 快速诊断流程](#-快速诊断流程)
  - [🔌 连接问题](#-连接问题)
    - [症状: 连接被拒绝](#症状-连接被拒绝)
      - [可能原因 \& 解决方案](#可能原因--解决方案)
      - [快速验证](#快速验证)
    - [症状: TLS握手失败](#症状-tls握手失败)
      - [解决方案](#解决方案)
      - [配置示例](#配置示例)
  - [📭 数据未到达](#-数据未到达)
    - [诊断清单](#诊断清单)
    - [逐层排查](#逐层排查)
      - [Layer 1: SDK层](#layer-1-sdk层)
      - [Layer 2: Collector层](#layer-2-collector层)
      - [Layer 3: 网络层](#layer-3-网络层)
  - [🐌 性能问题](#-性能问题)
    - [症状: 高延迟](#症状-高延迟)
      - [可能原因](#可能原因)
      - [优化配置](#优化配置)
    - [症状: 内存溢出 (OOM)](#症状-内存溢出-oom)
      - [排查步骤](#排查步骤)
      - [解决方案1](#解决方案1)
    - [症状: CPU占用高](#症状-cpu占用高)
      - [可能原因1](#可能原因1)
  - [❌ 错误码](#-错误码)
    - [HTTP错误码速查](#http错误码速查)
    - [gRPC错误码速查](#grpc错误码速查)
  - [🔧 Collector问题](#-collector问题)
    - [症状: Collector启动失败](#症状-collector启动失败)
      - [常见错误](#常见错误)
      - [解决步骤](#解决步骤)
    - [症状: Collector数据丢失](#症状-collector数据丢失)
      - [排查指标](#排查指标)
      - [数据丢失原因](#数据丢失原因)
    - [症状: Collector重启](#症状-collector重启)
      - [查看日志](#查看日志)
      - [OOM预防](#oom预防)
  - [📱 SDK问题](#-sdk问题)
    - [Go SDK常见问题](#go-sdk常见问题)
      - [问题1: 数据未导出](#问题1-数据未导出)
      - [问题2: 模块导入错误](#问题2-模块导入错误)
    - [Python SDK常见问题](#python-sdk常见问题)
      - [问题1: 依赖版本冲突](#问题1-依赖版本冲突)
      - [问题2: Span未创建](#问题2-span未创建)
    - [JavaScript/Node.js SDK常见问题](#javascriptnodejs-sdk常见问题)
      - [问题1: 浏览器端CORS错误](#问题1-浏览器端cors错误)
      - [问题2: 异步问题](#问题2-异步问题)
  - [🌐 网络问题](#-网络问题)
    - [DNS解析失败](#dns解析失败)
    - [防火墙问题](#防火墙问题)
    - [代理问题](#代理问题)
  - [🛠️ 调试工具](#️-调试工具)
    - [1. grpcurl (gRPC调试)](#1-grpcurl-grpc调试)
    - [2. curl (HTTP调试)](#2-curl-http调试)
    - [3. tcpdump (网络抓包)](#3-tcpdump-网络抓包)
    - [4. Collector自带工具](#4-collector自带工具)
      - [zPages (调试页面)](#zpages-调试页面)
      - [Logging Exporter (调试导出器)](#logging-exporter-调试导出器)
    - [5. Prometheus指标](#5-prometheus指标)
  - [📋 故障排查清单](#-故障排查清单)
    - [应用无法发送数据](#应用无法发送数据)
    - [Collector无法接收数据](#collector无法接收数据)
    - [Collector无法导出数据](#collector无法导出数据)
  - [🎯 最佳实践](#-最佳实践)
  - [📚 参考资源](#-参考资源)

---

## 🔍 快速诊断流程

```text
┌─────────────────────┐
│ 数据是否产生?        │
└──────┬──────────────┘
       │ 是
       ▼
┌─────────────────────┐
│ SDK配置正确?         │ → 否 → 检查SDK配置、Endpoint
└──────┬──────────────┘
       │ 是
       ▼
┌─────────────────────┐
│ 网络可达?            │ → 否 → 检查防火墙、DNS、端口
└──────┬──────────────┘
       │ 是
       ▼
┌─────────────────────┐
│ Collector运行?      │ → 否 → 启动Collector、查看日志
└──────┬──────────────┘
       │ 是
       ▼
┌─────────────────────┐
│ Pipeline配置正确?    │ → 否 → 检查receivers/processors/exporters
└──────┬──────────────┘
       │ 是
       ▼
┌─────────────────────┐
│ 后端可达?            │ → 否 → 检查后端连接、认证
└──────┬──────────────┘
       │ 是
       ▼
┌─────────────────────┐
│ 查看后端查询         │
└─────────────────────┘
```

---

## 🔌 连接问题

### 症状: 连接被拒绝

```text
Error: connection refused
Error: dial tcp: connect: connection refused
```

#### 可能原因 & 解决方案

| 原因 | 快速检查 | 解决方案 |
|-----|---------|---------|
| Collector未运行 | `docker ps \| grep collector` | 启动Collector |
| 端口未监听 | `netstat -tuln \| grep 4317` | 检查端口配置 |
| 错误的Endpoint | 查看应用配置 | 修正为`collector:4317` |
| 防火墙阻断 | `telnet collector 4317` | 开放端口4317/4318 |

#### 快速验证

```bash
# 1. 检查Collector是否运行
docker ps | grep otel

# 2. 检查端口监听
netstat -tuln | grep -E '4317|4318'

# 3. 测试连通性
telnet collector 4317

# 4. 测试HTTP端点
curl -v http://collector:4318/v1/traces
```

---

### 症状: TLS握手失败

```text
Error: tls: handshake failure
Error: certificate verify failed
```

#### 解决方案

| 场景 | 修复方法 |
|-----|---------|
| **开发环境** | 使用`insecure: true` (仅开发!) |
| **自签名证书** | 添加`ca_file: /path/to/ca.crt` |
| **证书过期** | 更新证书 |
| **主机名不匹配** | 使用正确的主机名或添加`insecure_skip_verify: true` |

#### 配置示例

```yaml
# 开发环境 (不安全,仅用于测试)
exporters:
  otlp:
    endpoint: collector:4317
    tls:
      insecure: true

# 生产环境 (使用自签名CA)
exporters:
  otlp:
    endpoint: collector:4317
    tls:
      ca_file: /etc/ssl/certs/ca.crt
      cert_file: /etc/ssl/certs/client.crt
      key_file: /etc/ssl/private/client.key
```

---

## 📭 数据未到达

### 诊断清单

```text
✅ SDK是否正确初始化?
✅ 数据是否真的产生? (添加日志确认)
✅ Exporter是否正确配置?
✅ BatchProcessor是否正常flush?
✅ Collector是否接收到数据? (查看Collector日志)
✅ Pipeline是否正确配置?
✅ Processor是否过滤了数据?
✅ 后端是否正常?
```

### 逐层排查

#### Layer 1: SDK层

```go
// Go: 启用调试日志
import "go.opentelemetry.io/otel"
otel.SetLogger(myLogger)

// 手动flush确认数据发送
defer tp.Shutdown(context.Background())  // 强制flush
```

```python
# Python: 启用调试日志
import logging
logging.basicConfig(level=logging.DEBUG)

# 手动flush
provider.force_flush()
```

#### Layer 2: Collector层

```bash
# 查看Collector日志
docker logs -f otel-collector

# 查看Collector指标
curl http://localhost:8888/metrics | grep otelcol_receiver

# 关键指标:
# - otelcol_receiver_accepted_spans   (接收的Span数)
# - otelcol_exporter_sent_spans       (发送的Span数)
# - otelcol_exporter_send_failed_spans (失败的Span数)
```

#### Layer 3: 网络层

```bash
# 抓包查看是否有数据传输
tcpdump -i any -A 'port 4317 or port 4318' -w otlp.pcap

# 分析抓包
tcpdump -r otlp.pcap -A | less
```

---

## 🐌 性能问题

### 症状: 高延迟

#### 可能原因

| 原因 | 检查方法 | 优化方案 |
|-----|---------|---------|
| 批处理不足 | 查看`batch_timeout` | 增加`send_batch_size` |
| 同步导出 | 查看SDK配置 | 使用`BatchSpanProcessor` |
| 网络慢 | `ping collector` | 启用压缩、优化网络 |
| Collector过载 | 查看CPU/内存 | 增加Collector副本 |
| 后端慢 | 查看后端延迟 | 优化后端或增加超时 |

#### 优化配置

```yaml
# 高性能配置
processors:
  batch:
    timeout: 10s
    send_batch_size: 2048     # 增大批次
    send_batch_max_size: 4096

exporters:
  otlp:
    endpoint: backend:4317
    compression: gzip          # 启用压缩
    sending_queue:
      enabled: true
      num_consumers: 20        # 增加并发
      queue_size: 10000
```

---

### 症状: 内存溢出 (OOM)

#### 排查步骤

```bash
# 1. 查看Collector内存使用
docker stats otel-collector

# 2. 查看内存限制器日志
docker logs otel-collector | grep "memory_limiter"

# 3. 查看队列积压
curl http://localhost:8888/metrics | grep queue_size
```

#### 解决方案1

```yaml
processors:
  memory_limiter:
    check_interval: 1s
    limit_mib: 512           # 设置内存上限
    spike_limit_mib: 128
  
  batch:
    timeout: 5s              # 减少批处理间隔
    send_batch_size: 1024    # 减小批次大小

exporters:
  otlp:
    sending_queue:
      queue_size: 2000       # 减小队列大小
```

---

### 症状: CPU占用高

#### 可能原因1

| 原因 | 检查方法 | 优化方案 |
|-----|---------|---------|
| 数据量过大 | 查看数据速率 | 启用采样 |
| 处理器过多 | 查看Pipeline配置 | 精简Processor |
| 正则表达式复杂 | 查看Attributes Processor | 优化正则 |
| 未启用批处理 | 查看配置 | 启用Batch Processor |

```yaml
# 优化配置
processors:
  # 启用尾部采样,减少数据量
  tail_sampling:
    policies:
      - name: sample-10pct
        type: probabilistic
        probabilistic:
          sampling_percentage: 10
  
  # 简化Attributes Processor
  attributes:
    actions:
      - key: http.url
        action: delete  # 简单操作,避免复杂正则
```

---

## ❌ 错误码

### HTTP错误码速查

| 状态码 | 含义 | 常见原因 | 解决方案 |
|--------|------|---------|---------|
| **400** | Bad Request | Protobuf解析失败、字段值非法 | 检查数据格式、字段类型 |
| **401** | Unauthorized | API Key错误、认证失败 | 检查`Authorization` header |
| **403** | Forbidden | 权限不足 | 检查API Key权限 |
| **404** | Not Found | 错误的端点路径 | 确认路径为`/v1/traces` |
| **413** | Payload Too Large | 请求体过大 | 减小`batch_size` |
| **415** | Unsupported Media Type | `Content-Type`错误 | 设置`application/x-protobuf` |
| **429** | Too Many Requests | 速率限制 | 启用重试、降低发送频率 |
| **500** | Internal Server Error | 服务端错误 | 查看服务端日志 |
| **502** | Bad Gateway | 网关错误 | 检查网络、代理配置 |
| **503** | Service Unavailable | 服务不可用 | 等待服务恢复、启用重试 |
| **504** | Gateway Timeout | 超时 | 增加超时时间 |

### gRPC错误码速查

| 错误码 | 含义 | 常见原因 | 解决方案 |
|--------|------|---------|---------|
| `UNAVAILABLE` | 服务不可用 | Collector未运行、网络问题 | 检查Collector状态 |
| `UNAUTHENTICATED` | 未认证 | 缺少认证信息 | 添加认证header |
| `PERMISSION_DENIED` | 权限被拒绝 | API Key权限不足 | 检查权限配置 |
| `RESOURCE_EXHAUSTED` | 资源耗尽 | 速率限制、队列满 | 降低发送速率 |
| `INVALID_ARGUMENT` | 参数无效 | 数据格式错误 | 检查数据格式 |
| `DEADLINE_EXCEEDED` | 超时 | 网络慢、后端慢 | 增加超时时间 |

---

## 🔧 Collector问题

### 症状: Collector启动失败

#### 常见错误

```text
Error: cannot load config
Error: unmarshal errors
Error: invalid configuration
```

#### 解决步骤

```bash
# 1. 验证配置文件语法
otelcol validate --config=config.yaml

# 2. 检查YAML缩进 (常见问题!)
yamllint config.yaml

# 3. 查看详细错误信息
otelcol --config=config.yaml --log-level=debug
```

---

### 症状: Collector数据丢失

#### 排查指标

```bash
# 访问Collector指标端点
curl http://localhost:8888/metrics

# 关键指标:
# 接收数据
otelcol_receiver_accepted_spans
otelcol_receiver_refused_spans

# 处理器
otelcol_processor_batch_batch_send_size_sum
otelcol_processor_dropped_spans

# 导出器
otelcol_exporter_sent_spans
otelcol_exporter_send_failed_spans
otelcol_exporter_queue_size
```

#### 数据丢失原因

| 指标异常 | 原因 | 解决方案 |
|---------|------|---------|
| `receiver_refused_spans` > 0 | 队列满 | 增加`queue_size` |
| `processor_dropped_spans` > 0 | Processor过滤 | 检查Filter/Sampling配置 |
| `exporter_send_failed_spans` > 0 | 后端错误 | 检查后端、启用重试 |
| `exporter_queue_size` 持续增长 | 导出速度慢 | 增加`num_consumers` |

---

### 症状: Collector重启

#### 查看日志

```bash
# Docker
docker logs otel-collector --tail 100

# Kubernetes
kubectl logs -n otel-system otel-collector-xxx --previous

# 常见崩溃原因:
# - OOM (内存溢出)
# - Panic (代码错误)
# - Configuration reload failed (配置重载失败)
```

#### OOM预防

```yaml
processors:
  memory_limiter:
    check_interval: 1s
    limit_mib: 512
    spike_limit_mib: 128

  batch:
    timeout: 5s
    send_batch_size: 1024

exporters:
  otlp:
    sending_queue:
      queue_size: 2000  # 限制队列大小
```

---

## 📱 SDK问题

### Go SDK常见问题

#### 问题1: 数据未导出

```go
// ❌ 错误: 没有调用Shutdown
func main() {
    tp := initTracer()
    // ... 业务逻辑
    // 程序退出,数据未flush!
}

// ✅ 正确: 确保Shutdown
func main() {
    tp := initTracer()
    defer tp.Shutdown(context.Background())  // 强制flush
    // ... 业务逻辑
}
```

#### 问题2: 模块导入错误

```bash
# 确保使用正确的模块路径
go get go.opentelemetry.io/otel@latest
go get go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracegrpc@latest
```

---

### Python SDK常见问题

#### 问题1: 依赖版本冲突

```bash
# 使用虚拟环境
python -m venv venv
source venv/bin/activate

# 安装最新稳定版
pip install opentelemetry-api opentelemetry-sdk
pip install opentelemetry-exporter-otlp-proto-grpc
```

#### 问题2: Span未创建

```python
# ❌ 错误: 未正确使用Context Manager
tracer = trace.get_tracer(__name__)
span = tracer.start_span("operation")
# ... 业务逻辑
# span未正确结束!

# ✅ 正确: 使用with语句
with tracer.start_as_current_span("operation") as span:
    # ... 业务逻辑
    pass  # 自动结束Span
```

---

### JavaScript/Node.js SDK常见问题

#### 问题1: 浏览器端CORS错误

```text
Error: CORS policy: No 'Access-Control-Allow-Origin' header
```

**解决方案: 配置Collector的CORS**:

```yaml
receivers:
  otlp:
    protocols:
      http:
        endpoint: 0.0.0.0:4318
        cors:
          allowed_origins:
            - http://localhost:3000
            - https://app.example.com
          allowed_headers:
            - Content-Type
            - Authorization
```

#### 问题2: 异步问题

```javascript
// ❌ 错误: 程序立即退出
const provider = new NodeTracerProvider();
provider.register();
// ... 业务逻辑
process.exit(0);  // BatchProcessor未flush!

// ✅ 正确: 等待flush
const provider = new NodeTracerProvider();
provider.register();
// ... 业务逻辑
await provider.shutdown();  // 等待flush完成
```

---

## 🌐 网络问题

### DNS解析失败

```bash
# 检查DNS
nslookup collector.example.com
dig collector.example.com

# 测试连接
ping collector.example.com
telnet collector.example.com 4317
```

### 防火墙问题

```bash
# Linux: 检查防火墙规则
sudo iptables -L -n | grep -E '4317|4318'

# 开放端口
sudo firewall-cmd --add-port=4317/tcp --permanent
sudo firewall-cmd --add-port=4318/tcp --permanent
sudo firewall-cmd --reload

# Kubernetes: 检查NetworkPolicy
kubectl get networkpolicies
```

### 代理问题

```bash
# 检查代理设置
echo $HTTP_PROXY
echo $HTTPS_PROXY

# gRPC不使用HTTP代理,需要特殊配置
# 建议: 将Collector域名加入NO_PROXY
export NO_PROXY=collector.example.com
```

---

## 🛠️ 调试工具

### 1. grpcurl (gRPC调试)

```bash
# 安装
brew install grpcurl  # macOS
apt install grpcurl   # Linux

# 列出服务
grpcurl -plaintext localhost:4317 list

# 列出方法
grpcurl -plaintext localhost:4317 list \
  opentelemetry.proto.collector.trace.v1.TraceService
```

### 2. curl (HTTP调试)

```bash
# 测试HTTP端点
curl -X POST http://localhost:4318/v1/traces \
  -H "Content-Type: application/json" \
  -d '{"resourceSpans":[]}'

# 测试健康检查
curl http://localhost:13133/health
```

### 3. tcpdump (网络抓包)

```bash
# 抓取OTLP流量
sudo tcpdump -i any -A 'port 4317 or port 4318' -w otlp.pcap

# 实时查看
sudo tcpdump -i any -A 'port 4317'
```

### 4. Collector自带工具

#### zPages (调试页面)

```yaml
extensions:
  zpages:
    endpoint: 0.0.0.0:55679
```

访问: <http://localhost:55679/debug/tracez>

#### Logging Exporter (调试导出器)

```yaml
exporters:
  logging:
    verbosity: detailed
    sampling_initial: 5

service:
  pipelines:
    traces:
      exporters: [logging, otlp]  # 同时导出到日志和后端
```

### 5. Prometheus指标

```bash
# 查看Collector指标
curl http://localhost:8888/metrics

# 关键指标查询
curl http://localhost:8888/metrics | grep -E \
  'otelcol_(receiver|exporter|processor)_.*_(spans|logs|metrics)'
```

---

## 📋 故障排查清单

### 应用无法发送数据

```text
□ 检查SDK是否正确初始化
□ 检查Endpoint配置 (collector:4317)
□ 检查网络连通性 (telnet/curl)
□ 检查防火墙规则
□ 检查TLS配置 (开发环境可临时禁用)
□ 启用SDK调试日志
□ 手动调用Shutdown/ForceFlush
□ 查看应用日志中的错误信息
```

### Collector无法接收数据

```text
□ 检查Collector是否运行
□ 检查端口监听 (netstat -tuln)
□ 检查receivers配置
□ 查看Collector日志
□ 查看Collector指标 (receiver_accepted_*)
□ 测试端点 (curl/grpcurl)
```

### Collector无法导出数据

```text
□ 检查exporters配置
□ 检查后端连通性
□ 检查认证信息 (API Key)
□ 查看Collector日志 (exporter errors)
□ 查看Collector指标 (exporter_send_failed_*)
□ 检查重试配置
□ 检查队列大小
```

---

## 🎯 最佳实践

```text
✅ 始终启用健康检查端点
✅ 配置合理的超时和重试
✅ 监控Collector自身指标
✅ 使用logging exporter调试
✅ 分层排查: SDK → Collector → Backend
✅ 查看日志时注意时间戳
✅ 生产环境启用详细日志 (至少INFO级别)
✅ 使用telnet/curl快速验证连通性
✅ 定期检查Collector内存和CPU使用
✅ 保留最近的配置版本备份
```

---

## 📚 参考资源

| 资源 | 链接 |
|------|------|
| **故障排查指南** | <https://opentelemetry.io/docs/collector/troubleshooting/> |
| **Collector日志** | <https://opentelemetry.io/docs/collector/troubleshooting/#logs> |
| **Collector指标** | <https://opentelemetry.io/docs/collector/observability/> |
| **常见问题** | <https://opentelemetry.io/docs/specs/otel/common/troubleshooting/> |

---

**最后更新**: 2025年10月9日  
**上一篇**: [Collector配置速查手册](./03_Collector配置速查手册.md)  
**下一篇**: [性能优化速查手册](./05_性能优化速查手册.md)
