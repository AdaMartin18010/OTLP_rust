# ğŸ“˜ OpenTelemetryæ•…éšœæ’æŸ¥é€ŸæŸ¥æ‰‹å†Œ

> **æœ€åæ›´æ–°**: 2025å¹´10æœˆ9æ—¥  
> **ç”¨é€”**: å¿«é€Ÿè¯Šæ–­å’Œè§£å†³OpenTelemetryå¸¸è§é—®é¢˜

---

## ğŸ¯ é€ŸæŸ¥ç›®å½•

- [ğŸ“˜ OpenTelemetryæ•…éšœæ’æŸ¥é€ŸæŸ¥æ‰‹å†Œ](#-opentelemetryæ•…éšœæ’æŸ¥é€ŸæŸ¥æ‰‹å†Œ)
  - [ğŸ¯ é€ŸæŸ¥ç›®å½•](#-é€ŸæŸ¥ç›®å½•)
  - [ğŸ” å¿«é€Ÿè¯Šæ–­æµç¨‹](#-å¿«é€Ÿè¯Šæ–­æµç¨‹)
  - [ğŸ”Œ è¿æ¥é—®é¢˜](#-è¿æ¥é—®é¢˜)
    - [ç—‡çŠ¶: è¿æ¥è¢«æ‹’ç»](#ç—‡çŠ¶-è¿æ¥è¢«æ‹’ç»)
      - [å¯èƒ½åŸå›  \& è§£å†³æ–¹æ¡ˆ](#å¯èƒ½åŸå› --è§£å†³æ–¹æ¡ˆ)
      - [å¿«é€ŸéªŒè¯](#å¿«é€ŸéªŒè¯)
    - [ç—‡çŠ¶: TLSæ¡æ‰‹å¤±è´¥](#ç—‡çŠ¶-tlsæ¡æ‰‹å¤±è´¥)
      - [è§£å†³æ–¹æ¡ˆ](#è§£å†³æ–¹æ¡ˆ)
      - [é…ç½®ç¤ºä¾‹](#é…ç½®ç¤ºä¾‹)
  - [ğŸ“­ æ•°æ®æœªåˆ°è¾¾](#-æ•°æ®æœªåˆ°è¾¾)
    - [è¯Šæ–­æ¸…å•](#è¯Šæ–­æ¸…å•)
    - [é€å±‚æ’æŸ¥](#é€å±‚æ’æŸ¥)
      - [Layer 1: SDKå±‚](#layer-1-sdkå±‚)
      - [Layer 2: Collectorå±‚](#layer-2-collectorå±‚)
      - [Layer 3: ç½‘ç»œå±‚](#layer-3-ç½‘ç»œå±‚)
  - [ğŸŒ æ€§èƒ½é—®é¢˜](#-æ€§èƒ½é—®é¢˜)
    - [ç—‡çŠ¶: é«˜å»¶è¿Ÿ](#ç—‡çŠ¶-é«˜å»¶è¿Ÿ)
      - [å¯èƒ½åŸå› ](#å¯èƒ½åŸå› )
      - [ä¼˜åŒ–é…ç½®](#ä¼˜åŒ–é…ç½®)
    - [ç—‡çŠ¶: å†…å­˜æº¢å‡º (OOM)](#ç—‡çŠ¶-å†…å­˜æº¢å‡º-oom)
      - [æ’æŸ¥æ­¥éª¤](#æ’æŸ¥æ­¥éª¤)
      - [è§£å†³æ–¹æ¡ˆ1](#è§£å†³æ–¹æ¡ˆ1)
    - [ç—‡çŠ¶: CPUå ç”¨é«˜](#ç—‡çŠ¶-cpuå ç”¨é«˜)
      - [å¯èƒ½åŸå› 1](#å¯èƒ½åŸå› 1)
  - [âŒ é”™è¯¯ç ](#-é”™è¯¯ç )
    - [HTTPé”™è¯¯ç é€ŸæŸ¥](#httpé”™è¯¯ç é€ŸæŸ¥)
    - [gRPCé”™è¯¯ç é€ŸæŸ¥](#grpcé”™è¯¯ç é€ŸæŸ¥)
  - [ğŸ”§ Collectoré—®é¢˜](#-collectoré—®é¢˜)
    - [ç—‡çŠ¶: Collectorå¯åŠ¨å¤±è´¥](#ç—‡çŠ¶-collectorå¯åŠ¨å¤±è´¥)
      - [å¸¸è§é”™è¯¯](#å¸¸è§é”™è¯¯)
      - [è§£å†³æ­¥éª¤](#è§£å†³æ­¥éª¤)
    - [ç—‡çŠ¶: Collectoræ•°æ®ä¸¢å¤±](#ç—‡çŠ¶-collectoræ•°æ®ä¸¢å¤±)
      - [æ’æŸ¥æŒ‡æ ‡](#æ’æŸ¥æŒ‡æ ‡)
      - [æ•°æ®ä¸¢å¤±åŸå› ](#æ•°æ®ä¸¢å¤±åŸå› )
    - [ç—‡çŠ¶: Collectoré‡å¯](#ç—‡çŠ¶-collectoré‡å¯)
      - [æŸ¥çœ‹æ—¥å¿—](#æŸ¥çœ‹æ—¥å¿—)
      - [OOMé¢„é˜²](#oomé¢„é˜²)
  - [ğŸ“± SDKé—®é¢˜](#-sdké—®é¢˜)
    - [Go SDKå¸¸è§é—®é¢˜](#go-sdkå¸¸è§é—®é¢˜)
      - [é—®é¢˜1: æ•°æ®æœªå¯¼å‡º](#é—®é¢˜1-æ•°æ®æœªå¯¼å‡º)
      - [é—®é¢˜2: æ¨¡å—å¯¼å…¥é”™è¯¯](#é—®é¢˜2-æ¨¡å—å¯¼å…¥é”™è¯¯)
    - [Python SDKå¸¸è§é—®é¢˜](#python-sdkå¸¸è§é—®é¢˜)
      - [é—®é¢˜1: ä¾èµ–ç‰ˆæœ¬å†²çª](#é—®é¢˜1-ä¾èµ–ç‰ˆæœ¬å†²çª)
      - [é—®é¢˜2: Spanæœªåˆ›å»º](#é—®é¢˜2-spanæœªåˆ›å»º)
    - [JavaScript/Node.js SDKå¸¸è§é—®é¢˜](#javascriptnodejs-sdkå¸¸è§é—®é¢˜)
      - [é—®é¢˜1: æµè§ˆå™¨ç«¯CORSé”™è¯¯](#é—®é¢˜1-æµè§ˆå™¨ç«¯corsé”™è¯¯)
      - [é—®é¢˜2: å¼‚æ­¥é—®é¢˜](#é—®é¢˜2-å¼‚æ­¥é—®é¢˜)
  - [ğŸŒ ç½‘ç»œé—®é¢˜](#-ç½‘ç»œé—®é¢˜)
    - [DNSè§£æå¤±è´¥](#dnsè§£æå¤±è´¥)
    - [é˜²ç«å¢™é—®é¢˜](#é˜²ç«å¢™é—®é¢˜)
    - [ä»£ç†é—®é¢˜](#ä»£ç†é—®é¢˜)
  - [ğŸ› ï¸ è°ƒè¯•å·¥å…·](#ï¸-è°ƒè¯•å·¥å…·)
    - [1. grpcurl (gRPCè°ƒè¯•)](#1-grpcurl-grpcè°ƒè¯•)
    - [2. curl (HTTPè°ƒè¯•)](#2-curl-httpè°ƒè¯•)
    - [3. tcpdump (ç½‘ç»œæŠ“åŒ…)](#3-tcpdump-ç½‘ç»œæŠ“åŒ…)
    - [4. Collectorè‡ªå¸¦å·¥å…·](#4-collectorè‡ªå¸¦å·¥å…·)
      - [zPages (è°ƒè¯•é¡µé¢)](#zpages-è°ƒè¯•é¡µé¢)
      - [Logging Exporter (è°ƒè¯•å¯¼å‡ºå™¨)](#logging-exporter-è°ƒè¯•å¯¼å‡ºå™¨)
    - [5. PrometheusæŒ‡æ ‡](#5-prometheusæŒ‡æ ‡)
  - [ğŸ“‹ æ•…éšœæ’æŸ¥æ¸…å•](#-æ•…éšœæ’æŸ¥æ¸…å•)
    - [åº”ç”¨æ— æ³•å‘é€æ•°æ®](#åº”ç”¨æ— æ³•å‘é€æ•°æ®)
    - [Collectoræ— æ³•æ¥æ”¶æ•°æ®](#collectoræ— æ³•æ¥æ”¶æ•°æ®)
    - [Collectoræ— æ³•å¯¼å‡ºæ•°æ®](#collectoræ— æ³•å¯¼å‡ºæ•°æ®)
  - [ğŸ¯ æœ€ä½³å®è·µ](#-æœ€ä½³å®è·µ)
  - [ğŸ“š å‚è€ƒèµ„æº](#-å‚è€ƒèµ„æº)

---

## ğŸ” å¿«é€Ÿè¯Šæ–­æµç¨‹

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ•°æ®æ˜¯å¦äº§ç”Ÿ?        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ æ˜¯
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SDKé…ç½®æ­£ç¡®?         â”‚ â†’ å¦ â†’ æ£€æŸ¥SDKé…ç½®ã€Endpoint
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ æ˜¯
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç½‘ç»œå¯è¾¾?            â”‚ â†’ å¦ â†’ æ£€æŸ¥é˜²ç«å¢™ã€DNSã€ç«¯å£
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ æ˜¯
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Collectorè¿è¡Œ?      â”‚ â†’ å¦ â†’ å¯åŠ¨Collectorã€æŸ¥çœ‹æ—¥å¿—
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ æ˜¯
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Pipelineé…ç½®æ­£ç¡®?    â”‚ â†’ å¦ â†’ æ£€æŸ¥receivers/processors/exporters
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ æ˜¯
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åç«¯å¯è¾¾?            â”‚ â†’ å¦ â†’ æ£€æŸ¥åç«¯è¿æ¥ã€è®¤è¯
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ æ˜¯
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æŸ¥çœ‹åç«¯æŸ¥è¯¢         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”Œ è¿æ¥é—®é¢˜

### ç—‡çŠ¶: è¿æ¥è¢«æ‹’ç»

```text
Error: connection refused
Error: dial tcp: connect: connection refused
```

#### å¯èƒ½åŸå›  & è§£å†³æ–¹æ¡ˆ

| åŸå›  | å¿«é€Ÿæ£€æŸ¥ | è§£å†³æ–¹æ¡ˆ |
|-----|---------|---------|
| Collectoræœªè¿è¡Œ | `docker ps \| grep collector` | å¯åŠ¨Collector |
| ç«¯å£æœªç›‘å¬ | `netstat -tuln \| grep 4317` | æ£€æŸ¥ç«¯å£é…ç½® |
| é”™è¯¯çš„Endpoint | æŸ¥çœ‹åº”ç”¨é…ç½® | ä¿®æ­£ä¸º`collector:4317` |
| é˜²ç«å¢™é˜»æ–­ | `telnet collector 4317` | å¼€æ”¾ç«¯å£4317/4318 |

#### å¿«é€ŸéªŒè¯

```bash
# 1. æ£€æŸ¥Collectoræ˜¯å¦è¿è¡Œ
docker ps | grep otel

# 2. æ£€æŸ¥ç«¯å£ç›‘å¬
netstat -tuln | grep -E '4317|4318'

# 3. æµ‹è¯•è¿é€šæ€§
telnet collector 4317

# 4. æµ‹è¯•HTTPç«¯ç‚¹
curl -v http://collector:4318/v1/traces
```

---

### ç—‡çŠ¶: TLSæ¡æ‰‹å¤±è´¥

```text
Error: tls: handshake failure
Error: certificate verify failed
```

#### è§£å†³æ–¹æ¡ˆ

| åœºæ™¯ | ä¿®å¤æ–¹æ³• |
|-----|---------|
| **å¼€å‘ç¯å¢ƒ** | ä½¿ç”¨`insecure: true` (ä»…å¼€å‘!) |
| **è‡ªç­¾åè¯ä¹¦** | æ·»åŠ `ca_file: /path/to/ca.crt` |
| **è¯ä¹¦è¿‡æœŸ** | æ›´æ–°è¯ä¹¦ |
| **ä¸»æœºåä¸åŒ¹é…** | ä½¿ç”¨æ­£ç¡®çš„ä¸»æœºåæˆ–æ·»åŠ `insecure_skip_verify: true` |

#### é…ç½®ç¤ºä¾‹

```yaml
# å¼€å‘ç¯å¢ƒ (ä¸å®‰å…¨,ä»…ç”¨äºæµ‹è¯•)
exporters:
  otlp:
    endpoint: collector:4317
    tls:
      insecure: true

# ç”Ÿäº§ç¯å¢ƒ (ä½¿ç”¨è‡ªç­¾åCA)
exporters:
  otlp:
    endpoint: collector:4317
    tls:
      ca_file: /etc/ssl/certs/ca.crt
      cert_file: /etc/ssl/certs/client.crt
      key_file: /etc/ssl/private/client.key
```

---

## ğŸ“­ æ•°æ®æœªåˆ°è¾¾

### è¯Šæ–­æ¸…å•

```text
âœ… SDKæ˜¯å¦æ­£ç¡®åˆå§‹åŒ–?
âœ… æ•°æ®æ˜¯å¦çœŸçš„äº§ç”Ÿ? (æ·»åŠ æ—¥å¿—ç¡®è®¤)
âœ… Exporteræ˜¯å¦æ­£ç¡®é…ç½®?
âœ… BatchProcessoræ˜¯å¦æ­£å¸¸flush?
âœ… Collectoræ˜¯å¦æ¥æ”¶åˆ°æ•°æ®? (æŸ¥çœ‹Collectoræ—¥å¿—)
âœ… Pipelineæ˜¯å¦æ­£ç¡®é…ç½®?
âœ… Processoræ˜¯å¦è¿‡æ»¤äº†æ•°æ®?
âœ… åç«¯æ˜¯å¦æ­£å¸¸?
```

### é€å±‚æ’æŸ¥

#### Layer 1: SDKå±‚

```go
// Go: å¯ç”¨è°ƒè¯•æ—¥å¿—
import "go.opentelemetry.io/otel"
otel.SetLogger(myLogger)

// æ‰‹åŠ¨flushç¡®è®¤æ•°æ®å‘é€
defer tp.Shutdown(context.Background())  // å¼ºåˆ¶flush
```

```python
# Python: å¯ç”¨è°ƒè¯•æ—¥å¿—
import logging
logging.basicConfig(level=logging.DEBUG)

# æ‰‹åŠ¨flush
provider.force_flush()
```

#### Layer 2: Collectorå±‚

```bash
# æŸ¥çœ‹Collectoræ—¥å¿—
docker logs -f otel-collector

# æŸ¥çœ‹CollectoræŒ‡æ ‡
curl http://localhost:8888/metrics | grep otelcol_receiver

# å…³é”®æŒ‡æ ‡:
# - otelcol_receiver_accepted_spans   (æ¥æ”¶çš„Spanæ•°)
# - otelcol_exporter_sent_spans       (å‘é€çš„Spanæ•°)
# - otelcol_exporter_send_failed_spans (å¤±è´¥çš„Spanæ•°)
```

#### Layer 3: ç½‘ç»œå±‚

```bash
# æŠ“åŒ…æŸ¥çœ‹æ˜¯å¦æœ‰æ•°æ®ä¼ è¾“
tcpdump -i any -A 'port 4317 or port 4318' -w otlp.pcap

# åˆ†ææŠ“åŒ…
tcpdump -r otlp.pcap -A | less
```

---

## ğŸŒ æ€§èƒ½é—®é¢˜

### ç—‡çŠ¶: é«˜å»¶è¿Ÿ

#### å¯èƒ½åŸå› 

| åŸå›  | æ£€æŸ¥æ–¹æ³• | ä¼˜åŒ–æ–¹æ¡ˆ |
|-----|---------|---------|
| æ‰¹å¤„ç†ä¸è¶³ | æŸ¥çœ‹`batch_timeout` | å¢åŠ `send_batch_size` |
| åŒæ­¥å¯¼å‡º | æŸ¥çœ‹SDKé…ç½® | ä½¿ç”¨`BatchSpanProcessor` |
| ç½‘ç»œæ…¢ | `ping collector` | å¯ç”¨å‹ç¼©ã€ä¼˜åŒ–ç½‘ç»œ |
| Collectorè¿‡è½½ | æŸ¥çœ‹CPU/å†…å­˜ | å¢åŠ Collectorå‰¯æœ¬ |
| åç«¯æ…¢ | æŸ¥çœ‹åç«¯å»¶è¿Ÿ | ä¼˜åŒ–åç«¯æˆ–å¢åŠ è¶…æ—¶ |

#### ä¼˜åŒ–é…ç½®

```yaml
# é«˜æ€§èƒ½é…ç½®
processors:
  batch:
    timeout: 10s
    send_batch_size: 2048     # å¢å¤§æ‰¹æ¬¡
    send_batch_max_size: 4096

exporters:
  otlp:
    endpoint: backend:4317
    compression: gzip          # å¯ç”¨å‹ç¼©
    sending_queue:
      enabled: true
      num_consumers: 20        # å¢åŠ å¹¶å‘
      queue_size: 10000
```

---

### ç—‡çŠ¶: å†…å­˜æº¢å‡º (OOM)

#### æ’æŸ¥æ­¥éª¤

```bash
# 1. æŸ¥çœ‹Collectorå†…å­˜ä½¿ç”¨
docker stats otel-collector

# 2. æŸ¥çœ‹å†…å­˜é™åˆ¶å™¨æ—¥å¿—
docker logs otel-collector | grep "memory_limiter"

# 3. æŸ¥çœ‹é˜Ÿåˆ—ç§¯å‹
curl http://localhost:8888/metrics | grep queue_size
```

#### è§£å†³æ–¹æ¡ˆ1

```yaml
processors:
  memory_limiter:
    check_interval: 1s
    limit_mib: 512           # è®¾ç½®å†…å­˜ä¸Šé™
    spike_limit_mib: 128
  
  batch:
    timeout: 5s              # å‡å°‘æ‰¹å¤„ç†é—´éš”
    send_batch_size: 1024    # å‡å°æ‰¹æ¬¡å¤§å°

exporters:
  otlp:
    sending_queue:
      queue_size: 2000       # å‡å°é˜Ÿåˆ—å¤§å°
```

---

### ç—‡çŠ¶: CPUå ç”¨é«˜

#### å¯èƒ½åŸå› 1

| åŸå›  | æ£€æŸ¥æ–¹æ³• | ä¼˜åŒ–æ–¹æ¡ˆ |
|-----|---------|---------|
| æ•°æ®é‡è¿‡å¤§ | æŸ¥çœ‹æ•°æ®é€Ÿç‡ | å¯ç”¨é‡‡æ · |
| å¤„ç†å™¨è¿‡å¤š | æŸ¥çœ‹Pipelineé…ç½® | ç²¾ç®€Processor |
| æ­£åˆ™è¡¨è¾¾å¼å¤æ‚ | æŸ¥çœ‹Attributes Processor | ä¼˜åŒ–æ­£åˆ™ |
| æœªå¯ç”¨æ‰¹å¤„ç† | æŸ¥çœ‹é…ç½® | å¯ç”¨Batch Processor |

```yaml
# ä¼˜åŒ–é…ç½®
processors:
  # å¯ç”¨å°¾éƒ¨é‡‡æ ·,å‡å°‘æ•°æ®é‡
  tail_sampling:
    policies:
      - name: sample-10pct
        type: probabilistic
        probabilistic:
          sampling_percentage: 10
  
  # ç®€åŒ–Attributes Processor
  attributes:
    actions:
      - key: http.url
        action: delete  # ç®€å•æ“ä½œ,é¿å…å¤æ‚æ­£åˆ™
```

---

## âŒ é”™è¯¯ç 

### HTTPé”™è¯¯ç é€ŸæŸ¥

| çŠ¶æ€ç  | å«ä¹‰ | å¸¸è§åŸå›  | è§£å†³æ–¹æ¡ˆ |
|--------|------|---------|---------|
| **400** | Bad Request | Protobufè§£æå¤±è´¥ã€å­—æ®µå€¼éæ³• | æ£€æŸ¥æ•°æ®æ ¼å¼ã€å­—æ®µç±»å‹ |
| **401** | Unauthorized | API Keyé”™è¯¯ã€è®¤è¯å¤±è´¥ | æ£€æŸ¥`Authorization` header |
| **403** | Forbidden | æƒé™ä¸è¶³ | æ£€æŸ¥API Keyæƒé™ |
| **404** | Not Found | é”™è¯¯çš„ç«¯ç‚¹è·¯å¾„ | ç¡®è®¤è·¯å¾„ä¸º`/v1/traces` |
| **413** | Payload Too Large | è¯·æ±‚ä½“è¿‡å¤§ | å‡å°`batch_size` |
| **415** | Unsupported Media Type | `Content-Type`é”™è¯¯ | è®¾ç½®`application/x-protobuf` |
| **429** | Too Many Requests | é€Ÿç‡é™åˆ¶ | å¯ç”¨é‡è¯•ã€é™ä½å‘é€é¢‘ç‡ |
| **500** | Internal Server Error | æœåŠ¡ç«¯é”™è¯¯ | æŸ¥çœ‹æœåŠ¡ç«¯æ—¥å¿— |
| **502** | Bad Gateway | ç½‘å…³é”™è¯¯ | æ£€æŸ¥ç½‘ç»œã€ä»£ç†é…ç½® |
| **503** | Service Unavailable | æœåŠ¡ä¸å¯ç”¨ | ç­‰å¾…æœåŠ¡æ¢å¤ã€å¯ç”¨é‡è¯• |
| **504** | Gateway Timeout | è¶…æ—¶ | å¢åŠ è¶…æ—¶æ—¶é—´ |

### gRPCé”™è¯¯ç é€ŸæŸ¥

| é”™è¯¯ç  | å«ä¹‰ | å¸¸è§åŸå›  | è§£å†³æ–¹æ¡ˆ |
|--------|------|---------|---------|
| `UNAVAILABLE` | æœåŠ¡ä¸å¯ç”¨ | Collectoræœªè¿è¡Œã€ç½‘ç»œé—®é¢˜ | æ£€æŸ¥CollectorçŠ¶æ€ |
| `UNAUTHENTICATED` | æœªè®¤è¯ | ç¼ºå°‘è®¤è¯ä¿¡æ¯ | æ·»åŠ è®¤è¯header |
| `PERMISSION_DENIED` | æƒé™è¢«æ‹’ç» | API Keyæƒé™ä¸è¶³ | æ£€æŸ¥æƒé™é…ç½® |
| `RESOURCE_EXHAUSTED` | èµ„æºè€—å°½ | é€Ÿç‡é™åˆ¶ã€é˜Ÿåˆ—æ»¡ | é™ä½å‘é€é€Ÿç‡ |
| `INVALID_ARGUMENT` | å‚æ•°æ— æ•ˆ | æ•°æ®æ ¼å¼é”™è¯¯ | æ£€æŸ¥æ•°æ®æ ¼å¼ |
| `DEADLINE_EXCEEDED` | è¶…æ—¶ | ç½‘ç»œæ…¢ã€åç«¯æ…¢ | å¢åŠ è¶…æ—¶æ—¶é—´ |

---

## ğŸ”§ Collectoré—®é¢˜

### ç—‡çŠ¶: Collectorå¯åŠ¨å¤±è´¥

#### å¸¸è§é”™è¯¯

```text
Error: cannot load config
Error: unmarshal errors
Error: invalid configuration
```

#### è§£å†³æ­¥éª¤

```bash
# 1. éªŒè¯é…ç½®æ–‡ä»¶è¯­æ³•
otelcol validate --config=config.yaml

# 2. æ£€æŸ¥YAMLç¼©è¿› (å¸¸è§é—®é¢˜!)
yamllint config.yaml

# 3. æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯
otelcol --config=config.yaml --log-level=debug
```

---

### ç—‡çŠ¶: Collectoræ•°æ®ä¸¢å¤±

#### æ’æŸ¥æŒ‡æ ‡

```bash
# è®¿é—®CollectoræŒ‡æ ‡ç«¯ç‚¹
curl http://localhost:8888/metrics

# å…³é”®æŒ‡æ ‡:
# æ¥æ”¶æ•°æ®
otelcol_receiver_accepted_spans
otelcol_receiver_refused_spans

# å¤„ç†å™¨
otelcol_processor_batch_batch_send_size_sum
otelcol_processor_dropped_spans

# å¯¼å‡ºå™¨
otelcol_exporter_sent_spans
otelcol_exporter_send_failed_spans
otelcol_exporter_queue_size
```

#### æ•°æ®ä¸¢å¤±åŸå› 

| æŒ‡æ ‡å¼‚å¸¸ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|---------|------|---------|
| `receiver_refused_spans` > 0 | é˜Ÿåˆ—æ»¡ | å¢åŠ `queue_size` |
| `processor_dropped_spans` > 0 | Processorè¿‡æ»¤ | æ£€æŸ¥Filter/Samplingé…ç½® |
| `exporter_send_failed_spans` > 0 | åç«¯é”™è¯¯ | æ£€æŸ¥åç«¯ã€å¯ç”¨é‡è¯• |
| `exporter_queue_size` æŒç»­å¢é•¿ | å¯¼å‡ºé€Ÿåº¦æ…¢ | å¢åŠ `num_consumers` |

---

### ç—‡çŠ¶: Collectoré‡å¯

#### æŸ¥çœ‹æ—¥å¿—

```bash
# Docker
docker logs otel-collector --tail 100

# Kubernetes
kubectl logs -n otel-system otel-collector-xxx --previous

# å¸¸è§å´©æºƒåŸå› :
# - OOM (å†…å­˜æº¢å‡º)
# - Panic (ä»£ç é”™è¯¯)
# - Configuration reload failed (é…ç½®é‡è½½å¤±è´¥)
```

#### OOMé¢„é˜²

```yaml
processors:
  memory_limiter:
    check_interval: 1s
    limit_mib: 512
    spike_limit_mib: 128

  batch:
    timeout: 5s
    send_batch_size: 1024

exporters:
  otlp:
    sending_queue:
      queue_size: 2000  # é™åˆ¶é˜Ÿåˆ—å¤§å°
```

---

## ğŸ“± SDKé—®é¢˜

### Go SDKå¸¸è§é—®é¢˜

#### é—®é¢˜1: æ•°æ®æœªå¯¼å‡º

```go
// âŒ é”™è¯¯: æ²¡æœ‰è°ƒç”¨Shutdown
func main() {
    tp := initTracer()
    // ... ä¸šåŠ¡é€»è¾‘
    // ç¨‹åºé€€å‡º,æ•°æ®æœªflush!
}

// âœ… æ­£ç¡®: ç¡®ä¿Shutdown
func main() {
    tp := initTracer()
    defer tp.Shutdown(context.Background())  // å¼ºåˆ¶flush
    // ... ä¸šåŠ¡é€»è¾‘
}
```

#### é—®é¢˜2: æ¨¡å—å¯¼å…¥é”™è¯¯

```bash
# ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„æ¨¡å—è·¯å¾„
go get go.opentelemetry.io/otel@latest
go get go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracegrpc@latest
```

---

### Python SDKå¸¸è§é—®é¢˜

#### é—®é¢˜1: ä¾èµ–ç‰ˆæœ¬å†²çª

```bash
# ä½¿ç”¨è™šæ‹Ÿç¯å¢ƒ
python -m venv venv
source venv/bin/activate

# å®‰è£…æœ€æ–°ç¨³å®šç‰ˆ
pip install opentelemetry-api opentelemetry-sdk
pip install opentelemetry-exporter-otlp-proto-grpc
```

#### é—®é¢˜2: Spanæœªåˆ›å»º

```python
# âŒ é”™è¯¯: æœªæ­£ç¡®ä½¿ç”¨Context Manager
tracer = trace.get_tracer(__name__)
span = tracer.start_span("operation")
# ... ä¸šåŠ¡é€»è¾‘
# spanæœªæ­£ç¡®ç»“æŸ!

# âœ… æ­£ç¡®: ä½¿ç”¨withè¯­å¥
with tracer.start_as_current_span("operation") as span:
    # ... ä¸šåŠ¡é€»è¾‘
    pass  # è‡ªåŠ¨ç»“æŸSpan
```

---

### JavaScript/Node.js SDKå¸¸è§é—®é¢˜

#### é—®é¢˜1: æµè§ˆå™¨ç«¯CORSé”™è¯¯

```text
Error: CORS policy: No 'Access-Control-Allow-Origin' header
```

**è§£å†³æ–¹æ¡ˆ: é…ç½®Collectorçš„CORS**:

```yaml
receivers:
  otlp:
    protocols:
      http:
        endpoint: 0.0.0.0:4318
        cors:
          allowed_origins:
            - http://localhost:3000
            - https://app.example.com
          allowed_headers:
            - Content-Type
            - Authorization
```

#### é—®é¢˜2: å¼‚æ­¥é—®é¢˜

```javascript
// âŒ é”™è¯¯: ç¨‹åºç«‹å³é€€å‡º
const provider = new NodeTracerProvider();
provider.register();
// ... ä¸šåŠ¡é€»è¾‘
process.exit(0);  // BatchProcessoræœªflush!

// âœ… æ­£ç¡®: ç­‰å¾…flush
const provider = new NodeTracerProvider();
provider.register();
// ... ä¸šåŠ¡é€»è¾‘
await provider.shutdown();  // ç­‰å¾…flushå®Œæˆ
```

---

## ğŸŒ ç½‘ç»œé—®é¢˜

### DNSè§£æå¤±è´¥

```bash
# æ£€æŸ¥DNS
nslookup collector.example.com
dig collector.example.com

# æµ‹è¯•è¿æ¥
ping collector.example.com
telnet collector.example.com 4317
```

### é˜²ç«å¢™é—®é¢˜

```bash
# Linux: æ£€æŸ¥é˜²ç«å¢™è§„åˆ™
sudo iptables -L -n | grep -E '4317|4318'

# å¼€æ”¾ç«¯å£
sudo firewall-cmd --add-port=4317/tcp --permanent
sudo firewall-cmd --add-port=4318/tcp --permanent
sudo firewall-cmd --reload

# Kubernetes: æ£€æŸ¥NetworkPolicy
kubectl get networkpolicies
```

### ä»£ç†é—®é¢˜

```bash
# æ£€æŸ¥ä»£ç†è®¾ç½®
echo $HTTP_PROXY
echo $HTTPS_PROXY

# gRPCä¸ä½¿ç”¨HTTPä»£ç†,éœ€è¦ç‰¹æ®Šé…ç½®
# å»ºè®®: å°†CollectoråŸŸååŠ å…¥NO_PROXY
export NO_PROXY=collector.example.com
```

---

## ğŸ› ï¸ è°ƒè¯•å·¥å…·

### 1. grpcurl (gRPCè°ƒè¯•)

```bash
# å®‰è£…
brew install grpcurl  # macOS
apt install grpcurl   # Linux

# åˆ—å‡ºæœåŠ¡
grpcurl -plaintext localhost:4317 list

# åˆ—å‡ºæ–¹æ³•
grpcurl -plaintext localhost:4317 list \
  opentelemetry.proto.collector.trace.v1.TraceService
```

### 2. curl (HTTPè°ƒè¯•)

```bash
# æµ‹è¯•HTTPç«¯ç‚¹
curl -X POST http://localhost:4318/v1/traces \
  -H "Content-Type: application/json" \
  -d '{"resourceSpans":[]}'

# æµ‹è¯•å¥åº·æ£€æŸ¥
curl http://localhost:13133/health
```

### 3. tcpdump (ç½‘ç»œæŠ“åŒ…)

```bash
# æŠ“å–OTLPæµé‡
sudo tcpdump -i any -A 'port 4317 or port 4318' -w otlp.pcap

# å®æ—¶æŸ¥çœ‹
sudo tcpdump -i any -A 'port 4317'
```

### 4. Collectorè‡ªå¸¦å·¥å…·

#### zPages (è°ƒè¯•é¡µé¢)

```yaml
extensions:
  zpages:
    endpoint: 0.0.0.0:55679
```

è®¿é—®: <http://localhost:55679/debug/tracez>

#### Logging Exporter (è°ƒè¯•å¯¼å‡ºå™¨)

```yaml
exporters:
  logging:
    verbosity: detailed
    sampling_initial: 5

service:
  pipelines:
    traces:
      exporters: [logging, otlp]  # åŒæ—¶å¯¼å‡ºåˆ°æ—¥å¿—å’Œåç«¯
```

### 5. PrometheusæŒ‡æ ‡

```bash
# æŸ¥çœ‹CollectoræŒ‡æ ‡
curl http://localhost:8888/metrics

# å…³é”®æŒ‡æ ‡æŸ¥è¯¢
curl http://localhost:8888/metrics | grep -E \
  'otelcol_(receiver|exporter|processor)_.*_(spans|logs|metrics)'
```

---

## ğŸ“‹ æ•…éšœæ’æŸ¥æ¸…å•

### åº”ç”¨æ— æ³•å‘é€æ•°æ®

```text
â–¡ æ£€æŸ¥SDKæ˜¯å¦æ­£ç¡®åˆå§‹åŒ–
â–¡ æ£€æŸ¥Endpointé…ç½® (collector:4317)
â–¡ æ£€æŸ¥ç½‘ç»œè¿é€šæ€§ (telnet/curl)
â–¡ æ£€æŸ¥é˜²ç«å¢™è§„åˆ™
â–¡ æ£€æŸ¥TLSé…ç½® (å¼€å‘ç¯å¢ƒå¯ä¸´æ—¶ç¦ç”¨)
â–¡ å¯ç”¨SDKè°ƒè¯•æ—¥å¿—
â–¡ æ‰‹åŠ¨è°ƒç”¨Shutdown/ForceFlush
â–¡ æŸ¥çœ‹åº”ç”¨æ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯
```

### Collectoræ— æ³•æ¥æ”¶æ•°æ®

```text
â–¡ æ£€æŸ¥Collectoræ˜¯å¦è¿è¡Œ
â–¡ æ£€æŸ¥ç«¯å£ç›‘å¬ (netstat -tuln)
â–¡ æ£€æŸ¥receiversé…ç½®
â–¡ æŸ¥çœ‹Collectoræ—¥å¿—
â–¡ æŸ¥çœ‹CollectoræŒ‡æ ‡ (receiver_accepted_*)
â–¡ æµ‹è¯•ç«¯ç‚¹ (curl/grpcurl)
```

### Collectoræ— æ³•å¯¼å‡ºæ•°æ®

```text
â–¡ æ£€æŸ¥exportersé…ç½®
â–¡ æ£€æŸ¥åç«¯è¿é€šæ€§
â–¡ æ£€æŸ¥è®¤è¯ä¿¡æ¯ (API Key)
â–¡ æŸ¥çœ‹Collectoræ—¥å¿— (exporter errors)
â–¡ æŸ¥çœ‹CollectoræŒ‡æ ‡ (exporter_send_failed_*)
â–¡ æ£€æŸ¥é‡è¯•é…ç½®
â–¡ æ£€æŸ¥é˜Ÿåˆ—å¤§å°
```

---

## ğŸ¯ æœ€ä½³å®è·µ

```text
âœ… å§‹ç»ˆå¯ç”¨å¥åº·æ£€æŸ¥ç«¯ç‚¹
âœ… é…ç½®åˆç†çš„è¶…æ—¶å’Œé‡è¯•
âœ… ç›‘æ§Collectorè‡ªèº«æŒ‡æ ‡
âœ… ä½¿ç”¨logging exporterè°ƒè¯•
âœ… åˆ†å±‚æ’æŸ¥: SDK â†’ Collector â†’ Backend
âœ… æŸ¥çœ‹æ—¥å¿—æ—¶æ³¨æ„æ—¶é—´æˆ³
âœ… ç”Ÿäº§ç¯å¢ƒå¯ç”¨è¯¦ç»†æ—¥å¿— (è‡³å°‘INFOçº§åˆ«)
âœ… ä½¿ç”¨telnet/curlå¿«é€ŸéªŒè¯è¿é€šæ€§
âœ… å®šæœŸæ£€æŸ¥Collectorå†…å­˜å’ŒCPUä½¿ç”¨
âœ… ä¿ç•™æœ€è¿‘çš„é…ç½®ç‰ˆæœ¬å¤‡ä»½
```

---

## ğŸ“š å‚è€ƒèµ„æº

| èµ„æº | é“¾æ¥ |
|------|------|
| **æ•…éšœæ’æŸ¥æŒ‡å—** | <https://opentelemetry.io/docs/collector/troubleshooting/> |
| **Collectoræ—¥å¿—** | <https://opentelemetry.io/docs/collector/troubleshooting/#logs> |
| **CollectoræŒ‡æ ‡** | <https://opentelemetry.io/docs/collector/observability/> |
| **å¸¸è§é—®é¢˜** | <https://opentelemetry.io/docs/specs/otel/common/troubleshooting/> |

---

**æœ€åæ›´æ–°**: 2025å¹´10æœˆ9æ—¥  
**ä¸Šä¸€ç¯‡**: [Collectoré…ç½®é€ŸæŸ¥æ‰‹å†Œ](./03_Collectoré…ç½®é€ŸæŸ¥æ‰‹å†Œ.md)  
**ä¸‹ä¸€ç¯‡**: [æ€§èƒ½ä¼˜åŒ–é€ŸæŸ¥æ‰‹å†Œ](./05_æ€§èƒ½ä¼˜åŒ–é€ŸæŸ¥æ‰‹å†Œ.md)
