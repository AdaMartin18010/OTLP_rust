name: Security Audit

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # æ¯å¤©UTC 00:00è¿è¡Œ (åŒ—äº¬æ—¶é—´ä¸Šåˆ8ç‚¹)
    - cron: '0 0 * * *'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  security_audit:
    name: Dependency Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£…Rustå·¥å…·é“¾
        uses: dtolnay/rust-toolchain@1.90

      - name: ç¼“å­˜Cargoä¾èµ–
        uses: Swatinem/rust-cache@v2

      - name: å®‰è£…cargo-audit
        run: cargo install cargo-audit --locked

      - name: è¿è¡Œå®‰å…¨å®¡è®¡
        run: |
          cargo audit --json > audit-report.json || true
          cargo audit

      - name: ç”Ÿæˆå®¡è®¡æ‘˜è¦
        if: always()
        run: |
          echo "## ðŸ”’ å®‰å…¨å®¡è®¡æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "audit-report.json" ]; then
            # æå–å…³é”®ä¿¡æ¯
            VULNERABILITIES=$(cat audit-report.json | grep -o '"vulnerabilities"' | wc -l || echo "0")
            
            if [ "$VULNERABILITIES" -eq "0" ]; then
              echo "âœ… **çŠ¶æ€**: æœªå‘çŽ°å·²çŸ¥å®‰å…¨æ¼æ´ž" >> $GITHUB_STEP_SUMMARY
            else
              echo "âš ï¸ **çŠ¶æ€**: å‘çŽ° $VULNERABILITIES ä¸ªæ½œåœ¨å®‰å…¨é—®é¢˜" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "è¯·æŸ¥çœ‹è¯¦ç»†æ—¥å¿—å¹¶åŠæ—¶æ›´æ–°ç›¸å…³ä¾èµ–" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âš ï¸ æ— æ³•ç”Ÿæˆå®¡è®¡æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**å®¡è®¡æ—¶é—´**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

      - name: ä¸Šä¼ å®¡è®¡æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-report
          path: audit-report.json
          retention-days: 30

  cargo_deny:
    name: Cargo Deny Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£…cargo-deny
        run: |
          wget https://github.com/EmbarkStudios/cargo-deny/releases/download/0.16.3/cargo-deny-0.16.3-x86_64-unknown-linux-musl.tar.gz
          tar -xzf cargo-deny-0.16.3-x86_64-unknown-linux-musl.tar.gz
          chmod +x cargo-deny
          sudo mv cargo-deny /usr/local/bin/

      - name: åˆ›å»ºcargo-denyé…ç½®
        run: |
          cat > deny.toml <<DENYEOF
          [advisories]
          version = 2
          ignore = []
          
          [licenses]
          version = 2
          allow = ["MIT", "Apache-2.0", "BSD-3-Clause", "ISC", "Unicode-DFS-2016"]
          confidence-threshold = 0.8
          
          [bans]
          multiple-versions = "warn"
          wildcards = "allow"
          
          [sources]
          unknown-registry = "warn"
          unknown-git = "warn"
          DENYEOF

      - name: è¿è¡Œcargo-denyæ£€æŸ¥
        run: |
          cargo deny check advisories --config deny.toml || true
          cargo deny check licenses --config deny.toml || true

      - name: Denyæ£€æŸ¥æ‘˜è¦
        if: always()
        run: |
          echo "## ðŸ“‹ Cargo Denyæ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… è®¸å¯è¯å’Œå®‰å…¨å»ºè®®æ£€æŸ¥å®Œæˆ" >> $GITHUB_STEP_SUMMARY

  unused_deps:
    name: Unused Dependencies Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£…Rust nightlyå·¥å…·é“¾
        uses: dtolnay/rust-toolchain@nightly

      - name: ç¼“å­˜Cargoä¾èµ–
        uses: Swatinem/rust-cache@v2

      - name: å®‰è£…cargo-udeps
        run: cargo install cargo-udeps --locked

      - name: æ£€æŸ¥æœªä½¿ç”¨çš„ä¾èµ–
        run: |
          cargo +nightly udeps --workspace --all-targets > udeps-report.txt 2>&1 || true
          cat udeps-report.txt

      - name: ç”Ÿæˆæœªä½¿ç”¨ä¾èµ–æ‘˜è¦
        if: always()
        run: |
          echo "## ðŸ“¦ æœªä½¿ç”¨ä¾èµ–æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "udeps-report.txt" ]; then
            UNUSED=$(grep "unused" udeps-report.txt | wc -l || echo "0")
            
            if [ "$UNUSED" -eq "0" ]; then
              echo "âœ… æœªå‘çŽ°æœªä½¿ç”¨çš„ä¾èµ–" >> $GITHUB_STEP_SUMMARY
            else
              echo "âš ï¸ å‘çŽ° $UNUSED ä¸ªå¯èƒ½æœªä½¿ç”¨çš„ä¾èµ–" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "å»ºè®®å®¡æŸ¥å¹¶æ¸…ç†æœªä½¿ç”¨çš„ä¾èµ–ä»¥å‡å°é¡¹ç›®ä½“ç§¯" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: ä¸Šä¼ æœªä½¿ç”¨ä¾èµ–æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unused-deps-report
          path: udeps-report.txt
          retention-days: 30

  security_summary:
    name: Security Summary
    needs: [security_audit, cargo_deny, unused_deps]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: ç”Ÿæˆå®‰å…¨æ£€æŸ¥æ€»ç»“
        run: |
          echo "## ðŸ” å®‰å…¨æ£€æŸ¥æ€»ç»“" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| æ£€æŸ¥é¡¹ | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ä¾èµ–å®‰å…¨å®¡è®¡ | ${{ needs.security_audit.result == 'success' && 'âœ… é€šè¿‡' || 'âš ï¸ éœ€å…³æ³¨' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Cargo Deny | ${{ needs.cargo_deny.result == 'success' && 'âœ… é€šè¿‡' || 'âš ï¸ éœ€å…³æ³¨' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| æœªä½¿ç”¨ä¾èµ– | ${{ needs.unused_deps.result == 'success' && 'âœ… é€šè¿‡' || 'âš ï¸ éœ€å…³æ³¨' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "è¯¦ç»†æŠ¥å‘Šè¯·æŸ¥çœ‹å„ä¸ªä»»åŠ¡çš„artifact" >> $GITHUB_STEP_SUMMARY
