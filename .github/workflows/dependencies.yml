name: Dependencies Check

on:
  schedule:
    # æ¯å‘¨ä¸€UTC 00:00è¿è¡Œ (åŒ—äº¬æ—¶é—´ä¸Šåˆ8ç‚¹)
    - cron: '0 0 * * 1'
  workflow_dispatch:
  pull_request:
    paths:
      - '**/Cargo.toml'
      - '**/Cargo.lock'

env:
  CARGO_TERM_COLOR: always

jobs:
  outdated:
    name: Check Outdated Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£…Rustå·¥å…·é“¾
        uses: dtolnay/rust-toolchain@1.90

      - name: ç¼“å­˜Cargoä¾èµ–
        uses: Swatinem/rust-cache@v2

      - name: å®‰è£…cargo-outdated
        run: cargo install cargo-outdated --locked

      - name: æ£€æŸ¥è¿‡æ—¶çš„ä¾èµ–
        run: |
          cargo outdated --workspace --format json > outdated-report.json || true
          cargo outdated --workspace

      - name: ç”Ÿæˆè¿‡æ—¶ä¾èµ–æ‘˜è¦
        if: always()
        run: |
          echo "## ðŸ“¦ ä¾èµ–æ›´æ–°æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "outdated-report.json" ]; then
            echo "**æ£€æŸ¥æ—¶é—´**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "è¯¦ç»†çš„è¿‡æ—¶ä¾èµ–åˆ—è¡¨è¯·æŸ¥çœ‹ä¸Šæ–¹æ—¥å¿—è¾“å‡º" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ æ— æ³•ç”Ÿæˆä¾èµ–æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ä¸Šä¼ è¿‡æ—¶ä¾èµ–æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: outdated-deps-report
          path: outdated-report.json
          retention-days: 30

  dependency_tree:
    name: Analyze Dependency Tree
    runs-on: ubuntu-latest
    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£…Rustå·¥å…·é“¾
        uses: dtolnay/rust-toolchain@1.90

      - name: ç¼“å­˜Cargoä¾èµ–
        uses: Swatinem/rust-cache@v2

      - name: ç”Ÿæˆä¾èµ–æ ‘
        run: |
          echo "## æ ¸å¿ƒä¾èµ–æ ‘åˆ†æž" > dep-tree-report.txt
          echo "" >> dep-tree-report.txt
          
          # åˆ†æžå…³é”®ä¾èµ–
          echo "### OpenTelemetryä¾èµ–" >> dep-tree-report.txt
          cargo tree -i opentelemetry >> dep-tree-report.txt 2>&1 || true
          echo "" >> dep-tree-report.txt
          
          echo "### Tokioä¾èµ–" >> dep-tree-report.txt
          cargo tree -i tokio >> dep-tree-report.txt 2>&1 || true
          echo "" >> dep-tree-report.txt
          
          echo "### Tonicä¾èµ–" >> dep-tree-report.txt
          cargo tree -i tonic >> dep-tree-report.txt 2>&1 || true
          
          cat dep-tree-report.txt

      - name: æ£€æŸ¥é‡å¤ä¾èµ–
        run: |
          echo "## ðŸ” é‡å¤ä¾èµ–æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          cargo tree --workspace --duplicates >> $GITHUB_STEP_SUMMARY 2>&1 || echo "æ— é‡å¤ä¾èµ–" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: ä¸Šä¼ ä¾èµ–æ ‘æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-tree-report
          path: dep-tree-report.txt
          retention-days: 30

  dependency_stats:
    name: Dependency Statistics
    runs-on: ubuntu-latest
    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£…Rustå·¥å…·é“¾
        uses: dtolnay/rust-toolchain@1.90

      - name: ç¼“å­˜Cargoä¾èµ–
        uses: Swatinem/rust-cache@v2

      - name: ç»Ÿè®¡ä¾èµ–ä¿¡æ¯
        run: |
          echo "## ðŸ“Š ä¾èµ–ç»Ÿè®¡ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # ç»Ÿè®¡å·¥ä½œåŒºä¾èµ–æ•°é‡
          WORKSPACE_DEPS=$(grep -c "^[a-z_-]* = " Cargo.toml || echo "0")
          echo "**å·¥ä½œåŒºå£°æ˜Žä¾èµ–**: $WORKSPACE_DEPS ä¸ª" >> $GITHUB_STEP_SUMMARY
          
          # ç»Ÿè®¡æ€»ä¾èµ–æ•°ï¼ˆåŒ…æ‹¬ä¼ é€’ä¾èµ–ï¼‰
          TOTAL_DEPS=$(cargo tree --workspace --depth 0 | wc -l || echo "0")
          echo "**æ€»ä¾èµ–æ•°(å«ä¼ é€’)**: $TOTAL_DEPS ä¸ª" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æŒ‰ç±»åˆ«ç»Ÿè®¡
          echo "### ä¾èµ–åˆ†ç±»ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| ç±»åˆ« | æ•°é‡ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          
          ASYNC_DEPS=$(grep -E "tokio|async|futures" Cargo.toml | grep -c "=" || echo "0")
          echo "| å¼‚æ­¥è¿è¡Œæ—¶ | $ASYNC_DEPS |" >> $GITHUB_STEP_SUMMARY
          
          WEB_DEPS=$(grep -E "axum|actix|hyper|reqwest" Cargo.toml | grep -c "=" || echo "0")
          echo "| Webæ¡†æž¶ | $WEB_DEPS |" >> $GITHUB_STEP_SUMMARY
          
          DB_DEPS=$(grep -E "sqlx|sea-orm|redis|rusqlite" Cargo.toml | grep -c "=" || echo "0")
          echo "| æ•°æ®åº“ | $DB_DEPS |" >> $GITHUB_STEP_SUMMARY
          
          OTEL_DEPS=$(grep -E "opentelemetry|tracing" Cargo.toml | grep -c "=" || echo "0")
          echo "| å¯è§‚æµ‹æ€§ | $OTEL_DEPS |" >> $GITHUB_STEP_SUMMARY

      - name: æ£€æŸ¥Cargo.lockå˜åŒ–
        if: github.event_name == 'pull_request'
        run: |
          if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -q "Cargo.lock"; then
            echo "## âš ï¸ Cargo.lock å·²æ›´æ”¹" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "æ­¤PRåŒ…å«ä¾èµ–å˜æ›´ï¼Œè¯·ç¡®ä¿:" >> $GITHUB_STEP_SUMMARY
            echo "- å˜æ›´æ˜¯å¿…è¦çš„" >> $GITHUB_STEP_SUMMARY
            echo "- å·²è¿è¡Œå®Œæ•´æµ‹è¯•" >> $GITHUB_STEP_SUMMARY
            echo "- æ›´æ–°äº†CHANGELOG" >> $GITHUB_STEP_SUMMARY
          fi

  license_check:
    name: License Compliance
    runs-on: ubuntu-latest
    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£…Rustå·¥å…·é“¾
        uses: dtolnay/rust-toolchain@1.90

      - name: å®‰è£…cargo-license
        run: cargo install cargo-license --locked

      - name: ç”Ÿæˆè®¸å¯è¯æŠ¥å‘Š
        run: |
          cargo license --workspace --json > license-report.json || true
          cargo license --workspace --tsv > license-report.tsv || true
          cargo license --workspace

      - name: è®¸å¯è¯åˆè§„æ€§æ‘˜è¦
        if: always()
        run: |
          echo "## âš–ï¸ è®¸å¯è¯åˆè§„æ€§æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "license-report.json" ]; then
            MIT_COUNT=$(grep -c "\"MIT\"" license-report.json || echo "0")
            APACHE_COUNT=$(grep -c "\"Apache-2.0\"" license-report.json || echo "0")
            
            echo "| è®¸å¯è¯ç±»åž‹ | æ•°é‡ |" >> $GITHUB_STEP_SUMMARY
            echo "|------------|------|" >> $GITHUB_STEP_SUMMARY
            echo "| MIT | $MIT_COUNT |" >> $GITHUB_STEP_SUMMARY
            echo "| Apache-2.0 | $APACHE_COUNT |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… æ‰€æœ‰ä¾èµ–è®¸å¯è¯å‡å·²æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ä¸Šä¼ è®¸å¯è¯æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: license-report
          path: |
            license-report.json
            license-report.tsv
          retention-days: 90

  dependencies_summary:
    name: Dependencies Summary
    needs: [outdated, dependency_tree, dependency_stats, license_check]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: ç”Ÿæˆä¾èµ–æ£€æŸ¥æ€»ç»“
        run: |
          echo "## ðŸ“¦ ä¾èµ–æ£€æŸ¥æ€»ç»“" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| æ£€æŸ¥é¡¹ | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| è¿‡æ—¶ä¾èµ–æ£€æŸ¥ | ${{ needs.outdated.result == 'success' && 'âœ… é€šè¿‡' || 'âš ï¸ éœ€å…³æ³¨' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ä¾èµ–æ ‘åˆ†æž | ${{ needs.dependency_tree.result == 'success' && 'âœ… é€šè¿‡' || 'âš ï¸ éœ€å…³æ³¨' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ä¾èµ–ç»Ÿè®¡ | ${{ needs.dependency_stats.result == 'success' && 'âœ… é€šè¿‡' || 'âš ï¸ éœ€å…³æ³¨' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| è®¸å¯è¯æ£€æŸ¥ | ${{ needs.license_check.result == 'success' && 'âœ… é€šè¿‡' || 'âš ï¸ éœ€å…³æ³¨' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "è¯¦ç»†æŠ¥å‘Šè¯·æŸ¥çœ‹å„ä¸ªä»»åŠ¡çš„artifact" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**å»ºè®®**: å®šæœŸæ›´æ–°ä¾èµ–ä»¥èŽ·å–å®‰å…¨ä¿®å¤å’Œæ€§èƒ½æ”¹è¿›" >> $GITHUB_STEP_SUMMARY
