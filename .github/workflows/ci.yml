name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  check:
    name: Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£…Rustå·¥å…·é“¾
        uses: dtolnay/rust-toolchain@1.90

      - name: ç¼“å­˜Cargoä¾èµ–
        uses: Swatinem/rust-cache@v2

      - name: æ£€æŸ¥ç¼–è¯‘
        run: cargo check --workspace --all-targets

  test:
    name: Test Suite
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        rust: [1.90]
    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£…Rustå·¥å…·é“¾
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}

      - name: ç¼“å­˜Cargoä¾èµ–
        uses: Swatinem/rust-cache@v2

      - name: è¿è¡Œæµ‹è¯•
        run: cargo test --workspace --all-features
        env:
          RUST_BACKTRACE: 1

      - name: è¿è¡Œæ–‡æ¡£æµ‹è¯•
        run: cargo test --workspace --doc

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£…Rustå·¥å…·é“¾
        uses: dtolnay/rust-toolchain@1.90
        with:
          components: clippy

      - name: ç¼“å­˜Cargoä¾èµ–
        uses: Swatinem/rust-cache@v2

      - name: è¿è¡ŒClippy
        run: cargo clippy --workspace --all-targets --all-features -- -D warnings

      - name: Clippyç»“æžœæ‘˜è¦
        if: failure()
        run: |
          echo "## âš ï¸ Clippyæ£€æŸ¥å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "è¯·ä¿®å¤ä¸Šè¿°Clippyè­¦å‘ŠåŽé‡æ–°æäº¤" >> $GITHUB_STEP_SUMMARY

  fmt:
    name: Rustfmt
    runs-on: ubuntu-latest
    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£…Rustå·¥å…·é“¾
        uses: dtolnay/rust-toolchain@1.90
        with:
          components: rustfmt

      - name: æ£€æŸ¥ä»£ç æ ¼å¼
        run: cargo fmt --all -- --check

      - name: æ ¼å¼æ£€æŸ¥å¤±è´¥æç¤º
        if: failure()
        run: |
          echo "## âš ï¸ ä»£ç æ ¼å¼æ£€æŸ¥å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "è¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤ä¿®å¤æ ¼å¼:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "cargo fmt --all" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  build:
    name: Build Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£…Rustå·¥å…·é“¾
        uses: dtolnay/rust-toolchain@1.90

      - name: ç¼“å­˜Cargoä¾èµ–
        uses: Swatinem/rust-cache@v2

      - name: æž„å»ºReleaseç‰ˆæœ¬
        run: cargo build --workspace --release

      - name: æ£€æŸ¥äºŒè¿›åˆ¶å¤§å°
        run: |
          echo "## ðŸ“¦ æž„å»ºäº§ç‰©å¤§å°" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          du -h target/release/* | grep -v "\.d$" | head -20 || true
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  doc:
    name: Documentation
    runs-on: ubuntu-latest
    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£…Rustå·¥å…·é“¾
        uses: dtolnay/rust-toolchain@1.90

      - name: ç¼“å­˜Cargoä¾èµ–
        uses: Swatinem/rust-cache@v2

      - name: ç”Ÿæˆæ–‡æ¡£
        run: cargo doc --workspace --all-features --no-deps
        env:
          RUSTDOCFLAGS: -D warnings

      - name: ä¸Šä¼ æ–‡æ¡£artifact
        uses: actions/upload-artifact@v4
        with:
          name: documentation
          path: target/doc/
          retention-days: 7

  ci-success:
    name: CI Success
    needs: [check, test, clippy, fmt, build, doc]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: æ£€æŸ¥æ‰€æœ‰ä»»åŠ¡çŠ¶æ€
        run: |
          if [[ "${{ needs.check.result }}" == "success" && \
                "${{ needs.test.result }}" == "success" && \
                "${{ needs.clippy.result }}" == "success" && \
                "${{ needs.fmt.result }}" == "success" && \
                "${{ needs.build.result }}" == "success" && \
                "${{ needs.doc.result }}" == "success" ]]; then
            echo "## âœ… CIæ£€æŸ¥å…¨éƒ¨é€šè¿‡" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "æ‰€æœ‰æ£€æŸ¥é¡¹ç›®å‡å·²é€šè¿‡ï¼Œä»£ç è´¨é‡è‰¯å¥½ï¼" >> $GITHUB_STEP_SUMMARY
            exit 0
          else
            echo "## âŒ CIæ£€æŸ¥å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "éƒ¨åˆ†æ£€æŸ¥é¡¹ç›®å¤±è´¥ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æ—¥å¿—" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
