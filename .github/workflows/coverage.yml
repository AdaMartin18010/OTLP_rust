name: Coverage

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # æ¯å‘¨ä¸€æ—©ä¸Š8ç‚¹è¿è¡Œ
    - cron: '0 8 * * 1'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£…Rustå·¥å…·é“¾
        uses: dtolnay/rust-toolchain@1.90

      - name: ç¼“å­˜Cargoä¾èµ–
        uses: Swatinem/rust-cache@v2

      - name: å®‰è£…cargo-tarpaulin
        run: |
          cargo install cargo-tarpaulin || true

      - name: ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
        run: |
          cargo tarpaulin \
            --workspace \
            --out Xml \
            --out Html \
            --out Lcov \
            --output-dir coverage/ \
            --exclude-files "*/tests/*" "*/benches/*" "*/examples/*" \
            --timeout 300 \
            --verbose

      # Upload coverage to Codecov using tokenless upload
      # For public repos, no token is required (GitHub OIDC is used automatically)
      # For private repos, add CODECOV_TOKEN to repository secrets and uncomment the env section below
      - name: ä¸Šä¼ è¦†ç›–ç‡åˆ°Codecov
        if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository
        uses: codecov/codecov-action@v4
        continue-on-error: true
        with:
          files: ./coverage/cobertura.xml
          fail_ci_if_error: false
          flags: unittests
          name: codecov-umbrella
          verbose: true
        # Uncomment below for private repos with CODECOV_TOKEN secret:
        # env:
        #   CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

      - name: ä¸Šä¼ HTMLæŠ¥å‘Šä¸ºartifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

      - name: è¦†ç›–ç‡æ‘˜è¦
        run: |
          echo "## ğŸ“Š æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f "coverage/tarpaulin-report.json" ]; then
            COVERAGE=$(grep -oP '"coverage":\s*\K[0-9.]+' coverage/tarpaulin-report.json | head -1)
            COVERAGE_PERCENT=$(echo "$COVERAGE * 100" | bc | cut -d. -f1)
            echo "**æ€»ä½“è¦†ç›–ç‡**: ${COVERAGE_PERCENT}%" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ $COVERAGE_PERCENT -ge 80 ]; then
              echo "âœ¨ **çŠ¶æ€**: ä¼˜ç§€" >> $GITHUB_STEP_SUMMARY
            elif [ $COVERAGE_PERCENT -ge 70 ]; then
              echo "âœ… **çŠ¶æ€**: è‰¯å¥½" >> $GITHUB_STEP_SUMMARY
            elif [ $COVERAGE_PERCENT -ge 60 ]; then
              echo "âš ï¸ **çŠ¶æ€**: åŠæ ¼" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ **çŠ¶æ€**: éœ€è¦æ”¹è¿›" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âš ï¸ æ— æ³•ç”Ÿæˆè¦†ç›–ç‡æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š: ä¸‹è½½ coverage-report artifact" >> $GITHUB_STEP_SUMMARY

      - name: è¯„è®ºPR (å¦‚æœæ˜¯PR)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            if (fs.existsSync('coverage/tarpaulin-report.json')) {
              const report = JSON.parse(fs.readFileSync('coverage/tarpaulin-report.json'));
              const coverage = (report.coverage * 100).toFixed(2);
              
              const status = coverage >= 80 ? 'âœ¨ ä¼˜ç§€' : 
                             coverage >= 70 ? 'âœ… è‰¯å¥½' : 
                             coverage >= 60 ? 'âš ï¸ åŠæ ¼' : 'âŒ éœ€è¦æ”¹è¿›';
              
              const comment = '## ğŸ“Š æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š\n\n' +
                              '**æ€»ä½“è¦†ç›–ç‡**: ' + coverage + '%\n\n' +
                              status + '\n\n' +
                              'è¯¦ç»†æŠ¥å‘Šè¯·æŸ¥çœ‹ CI artifactsã€‚';

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }
